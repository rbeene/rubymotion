<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title>Programming RubyMotion</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Helvetica,sans-serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: #666666;
  text-decoration: underline;
}
a:visited {
  color: #880009;
}

em {
  font-style: italic;
  color: #880009;
}

strong {
  font-weight: bold;
  color: #880009;
}

h1, h2, h3, h4, h5, h6 {
  color: #880009;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 1px solid #dddddd;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  color: #666666;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #4f4f4f; }
ul > li > * { color: #666666; }

.monospaced, code, pre {
  font-family: Inconsolata;
  font-size: inherit;
  color: #4d4d4c;
  padding: 0;
  margin: 0;
}


#author {
  color: #880009;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
  color: #666666;
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
  color: #666666;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding:: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #4f4f4f;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1.5px solid #dddddd;
  background: #f4f4f4;
  padding: 0.5em;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
  font-family: Inconsolata;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #f2f2f2;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #666666;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
  color: #4f4f4f;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #880009;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid red;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}

/*
  pygmentize filter
*/
.highlight .hll { border-left:solid 7px #880009; font-size:100%; font-family:Inconsolata; color:#4d4d4c; }
.highlight  { background: #f4f4f4; font-family: Inconsolata; }
.highlight .c { color: #8e908c; font-style: italic; font-family: Inconsolata; } /* Comment */
.highlight .err { border: 1px solid #FF0000; font-family: Inconsolata; } /* Error */
.highlight .k { color: #8959a8; font-family: Inconsolata; } /* Keyword */
.highlight .o { color: #666666; font-family: Inconsolata; } /* Operator */

.highlight .cm { color: #8e908c; font-style: italic; font-family: Inconsolata; } /* Comment.Multiline */
.highlight .cp { color: #8e908c; font-family: Inconsolata; } /* Comment.Preproc */
.highlight .c1 { color: #8e908c; font-style: italic; font-family: Inconsolata; } /* Comment.Single */
.highlight .cs { color: #8e908c; font-weight: bold; font-family: Inconsolata; } /* Comment.Special */
.highlight .gd { color: #A00000; font-family: Inconsolata; } /* Generic.Deleted */
.highlight .ge { font-style: italic; font-family: Inconsolata; } /* Generic.Emph */
.highlight .gr { color: #FF0000; font-family: Inconsolata; } /* Generic.Error */

.highlight .gh { color: #000080; font-weight: bold; font-family: Inconsolata; } /* Generic.Heading */
.highlight .gi { color: #00A000; font-family: Inconsolata; } /* Generic.Inserted */
.highlight .go { color: #808080; font-family: Inconsolata; } /* Generic.Output */
.highlight .gp { color: #4d4d4c; font-weight: bold; font-family: Inconsolata; } /* Generic.Prompt */
.highlight .gs { font-weight: bold; font-family: Inconsolata; } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold; font-family: Inconsolata; } /* Generic.Subheading */
.highlight .gt { color: #800080; font-family: Inconsolata; } /* Generic.Traceback */


.highlight .kc { color: #8959a8; font-family: Inconsolata; } /* Keyword.Constant */
.highlight .kd { color: #8959a8; font-family: Inconsolata; } /* Keyword.Declaration */
.highlight .kn { color: #8959a8; font-family: Inconsolata; } /* Keyword.Namespace */
.highlight .kp { color: #8959a8; font-family: Inconsolata; } /* Keyword.Pseudo */
.highlight .kr { color: #8959a8; font-family: Inconsolata; } /* Keyword.Reserved */
.highlight .kt { color: #8959a8; font-family: Inconsolata; } /* Keyword.Type */


.highlight .m { color: #666666; font-family: Inconsolata; } /* Literal.Number */
.highlight .s { color: #BB4444; font-family: Inconsolata; } /* Literal.String */

.highlight .na { color: #BB4444; font-family: Inconsolata; } /* Name.Attribute */
.highlight .nb { color: #718c00; font-family: Inconsolata; } /* Name.Builtin */
.highlight .nc { color: #c82829; font-family: Inconsolata; } /* Name.Class */
.highlight .no { color: #c82829; font-family: Inconsolata; } /* Name.Constant */
.highlight .nd { color: #AA22FF; font-family: Inconsolata; } /* Name.Decorator */
.highlight .ni { color: #999999; font-family: Inconsolata; } /* Name.Entity */
.highlight .ne { color: #D2413A; font-family: Inconsolata; } /* Name.Exception */
.highlight .nf { color: #4271ae; font-family: Inconsolata; } /* Name.Function */
.highlight .nl { color: #A0A000; font-family: Inconsolata; } /* Name.Label */
.highlight .nn { color: #0000FF; font-family: Inconsolata; } /* Name.Namespace */
.highlight .nt { color: #008000; font-family: Inconsolata; } /* Name.Tag */
.highlight .nv { color: #4d4d4c; font-family: Inconsolata; } /* Name.Variable */
.highlight .bp { color: #AA22FF; font-family: Inconsolata; } /* Name.Builtin.Pseudo */
.highlight .vc { color: #4d4d4c; font-family: Inconsolata; } /* Name.Variable.Class */
.highlight .vg { color: #3e999f; font-family: Inconsolata; } /* Name.Variable.Global */
.highlight .vi { color: #3e999f; font-family: Inconsolata; } /* Name.Variable.Instance */


.highlight .ow { color: #f5871f; font-family: Inconsolata; } /* Operator.Word */
.highlight .w { color: #f5871f; font-family: Inconsolata; } /* Text.Whitespace */
.highlight .mf { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Float */
.highlight .mh { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Hex */
.highlight .mi { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Integer */
.highlight .mo { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Oct */
.highlight .sb { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Backtick */
.highlight .sc { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Char */
.highlight .sd { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Doc */
.highlight .s2 { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Double */
.highlight .se { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Escape */
.highlight .sh { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Heredoc */
.highlight .si { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Interpol */
.highlight .sx { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Other */
.highlight .sr { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Regex */
.highlight .s1 { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Single */
.highlight .ss { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Symbol */


.highlight .il { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Programming RubyMotion</h1>
<span id="author">Norberto Ortigoza</span><br />
<span id="revnumber">version 0.1,</span>
<span id="revdate">Oct 01, 2012</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<h1 id="_day_1">Day 1</h1>
<h1 id="_chapter_02_first_application">Chapter 02 - First Application</h1>
<div class="sect1">
<h2 id="_time_zone_converter_app">Time Zone Converter App</h2>
<div class="sectionbody">
<div class="paragraph"><p>Time is one of the most precious resources that we have, and for travelers around the world it&#8217;s essential to keep synced between one place and another so they can accomplish goals and requirements on time.
So we are going to build and application for them, so they can check their local time and the time in the place where they are traveling. The app should cover the following functionality:</p></div>
<div class="ulist"><ul>
<li>
<p>
Display local time zone
</p>
</li>
<li>
<p>
Know time zone against any other time zone
</p>
</li>
</ul></div>
<div class="paragraph"><p>First at all we need to create our application with ruby motion so let&#8217;s run the following command in your terminal:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create TimeZoneConverter
</pre></div></div></div>
<div class="paragraph"><p>And then take a look inside</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>TimeZoneConverter

<span class="nv">$ </span>ls
</pre></div></div></div>
<div class="paragraph"><p>You will see the following directories created</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Rakefile app resources spec</code></pre>
</div></div>
<div class="paragraph"><p>Now feel free to execute the following command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>If everything goes well, you will see an ugly black window.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image1.png" alt="Empty Application" />
</div>
<div class="title">Figure 1. Empty Application</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Please add assets to the resources folder of your project. You can find them on resources folder, there is an <em>images</em> folder with the assets necessary for this chapter.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Please add the following ruby files to the app folder: root_view_utilities.rb and time_offset.rb which help us in this chapter.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_view_controller">View Controller</h3>
<div class="paragraph"><p>A view controller class provides a quite useful mechanism to manage views in iOS applications; it can coordinate efforts with the model and other view controllers in order to build an entire application.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_a_view_controller">Adding a View Controller</h3>
<div class="paragraph"><p>Open your file <strong>app_delegate.rb</strong> in app folder and add the following highlighted code:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Adding code ahead.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

 <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>
<span class="hll">    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
</span><span class="hll">    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="no">RootViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
</span>    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now create a new file named <strong>root_view_controller.rb</strong> in app folder and add the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RootViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and run the rake command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>You should see a gray styled view. Congratulations, you have added your first View Controller, it wasn&#8217;t really that hard, was it?</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image2.png" alt="View Controller Added" />
</div>
<div class="title">Figure 2. View Controller Added</div>
</div>
<div class="paragraph"><p>It&#8217;s time to take a look to the file named <strong>root_view_uitilities.rb</strong> which contains the following UI elements:</p></div>
<div class="ulist"><ul>
<li>
<p>
UILabel
</p>
</li>
<li>
<p>
UIButton
</p>
</li>
<li>
<p>
UITextField
</p>
</li>
<li>
<p>
UIStepper
</p>
</li>
</ul></div>
<div class="paragraph"><p>Each method receive the position where the UIControl should be display and return the UIcontrol.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UI_Elements</span>

  <span class="k">def</span> <span class="nf">time_label</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

    <span class="n">label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span><span class="p">;</span>
    <span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;UTC offset&quot;</span>
    <span class="n">label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span><span class="p">;</span>
    <span class="n">label</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">select_time_zone_Button</span> <span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

    <span class="n">button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeCustom</span><span class="p">)</span>
    <span class="n">button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">73</span><span class="p">)</span>
    <span class="n">button</span><span class="o">.</span><span class="n">setBackgroundImage</span> <span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnSelect.png&quot;</span><span class="p">),</span><span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Convert&quot;</span><span class="p">,</span><span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="n">button</span>

  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">time_zone_text_field</span> <span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

    <span class="n">textField</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">textField</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleRoundedRect</span>
    <span class="n">textField</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">systemFontOfSize</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="c1">#textField.setUserInteractionEnabled (false)</span>

    <span class="n">textField</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">ui_stepper</span> <span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

    <span class="n">stepper</span> <span class="o">=</span> <span class="no">UIStepper</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span> <span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">stepper</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span> <span class="p">,</span><span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;stepperPressed:&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventValueChanged</span><span class="p">)</span>

    <span class="n">stepper</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and compile the project to see if everything goes well, and then open file <strong>root_view_controller.rb</strong>. We need to add our controls, please replace all content with the following</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Replace code ahead.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RootViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="kp">include</span> <span class="no">UI_Elements</span>
  <span class="kp">include</span> <span class="no">TimeOffset</span>

  <span class="k">def</span> <span class="nf">set_current_time</span>

    <span class="n">calendar</span> <span class="o">=</span> <span class="no">NSCalendar</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCalendarIdentifier</span><span class="p">(</span><span class="no">NSGregorianCalendar</span><span class="p">)</span>
    <span class="vi">@offsetDate</span> <span class="o">=</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">components</span> <span class="p">(</span><span class="no">NSMinuteCalendarUnit</span><span class="p">,</span><span class="ss">fromDate</span><span class="p">:</span><span class="vi">@offsetDate</span><span class="p">)</span>

    <span class="vi">@stepper</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">minute</span>
    <span class="vi">@currentTimeLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">month_year_string</span><span class="p">(</span><span class="vi">@offsetDate</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_remote_time_zone</span>

    <span class="vi">@remoteTimeZoneTextField</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Europe/Zurich&quot;</span>
    <span class="vi">@remoteTimeZoneTextField</span><span class="o">.</span><span class="n">returnKeyType</span> <span class="o">=</span> <span class="no">UIReturnKeyDone</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_remote_time</span>

    <span class="n">convertZone</span> <span class="o">=</span> <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">timeZoneWithName</span><span class="p">(</span><span class="vi">@remoteTimeZoneTextField</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="no">NSDateFormatter</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">setDateFormat</span><span class="p">(</span><span class="s1">&#39;HH:mm&#39;</span><span class="p">)</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">setTimeZone</span><span class="p">(</span><span class="n">convertZone</span><span class="p">)</span>

    <span class="n">dateFormat</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">stringFromDate</span><span class="p">(</span><span class="vi">@offsetDate</span><span class="p">)</span>

    <span class="vi">@convertDate</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">dateFromString</span><span class="p">(</span><span class="n">dateFormat</span><span class="p">)</span>
    <span class="vi">@remoteTimeLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;UTC &quot;</span><span class="o">+</span><span class="p">(</span><span class="n">convertZone</span><span class="o">.</span><span class="n">secondsFromGMT</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span><span class="o">+</span> <span class="n">dateFormat</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="vi">@currentTimeLabel</span> <span class="o">=</span>  <span class="n">time_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">65</span><span class="p">)</span>
    <span class="vi">@stepper</span> <span class="o">=</span> <span class="n">ui_stepper</span> <span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span>

    <span class="vi">@remoteTimeZoneTextField</span> <span class="o">=</span> <span class="n">time_zone_text_field</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">185</span><span class="p">)</span>
    <span class="vi">@remoteTimeZoneTextField</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="vi">@remoteTimeLabel</span> <span class="o">=</span>  <span class="n">time_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">210</span><span class="p">)</span>

    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@currentTimeLabel</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@remoteTimeZoneTextField</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@remoteTimeLabel</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@stepper</span><span class="p">)</span>

    <span class="n">set_current_time</span>
    <span class="n">set_remote_time_zone</span>

    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your program and you should see at the top an UILabel with your current time zone also an UIStepper which will be useful to change this date, and finally and UITextField indicating the remote Time Zone in this case Zurich, feel free to put any other of the following know time zones</p></div>
<div class="ulist"><ul>
<li>
<p>
America/Cancun
</p>
</li>
<li>
<p>
Asia/Tokyo
</p>
</li>
<li>
<p>
Europe/Rome
</p>
</li>
<li>
<p>
Pacific/Fiji
</p>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image3.png" alt="Controls Added" />
</div>
<div class="title">Figure 3. Controls Added</div>
</div>
<div class="paragraph"><p>Let stop one moment right here, to see the properties of the "UILabel" that we just added. Without quitting the simulator, hold the ‘command’ key and hover the mouse on simulator screen. You can see a red-bordered box appears among the application elements, select the first Time Zone area, the interactive console should display the instance corresponding to that label.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt;</code></pre>
</div></div>
<div class="paragraph"><p>And then explore the text property of the UILabel</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; self.text</code></pre>
</div></div>
<div class="paragraph"><p>It should return a string</p></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; "America/Mexico_City"</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s say that we are extremely curious and we want to know the class of the "text" property from UILabel:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; self.text.class
=&gt; String</code></pre>
</div></div>
<div class="paragraph"><p>As we may expect its a String, but now what if we want to know the superclass of the "text" property from UILabel:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; self.text.superclass
=&gt; NSMutableString</code></pre>
</div></div>
<div class="paragraph"><p>Now what if we look for the "String" ancestors, type the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; String.ancestors</code></pre>
</div></div>
<div class="paragraph"><p>What are those classes that appears? Yes you are right those are from the Cocoa Framework.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; [String, NSMutableString, NSString, Comparable, NSObject, Kernel]</code></pre>
</div></div>
<div class="paragraph"><p>We also can see the available methods, type the following in your terminal:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; methods</code></pre>
</div></div>
<div class="paragraph"><p>Well, you can see many of them, but yes we can use grep, to find something more specific:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; methods.grep(/class/)</code></pre>
</div></div>
<div class="paragraph"><p>If you want to return to the main session, you can enter the following command:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9591580&gt;)&gt; quit</code></pre>
</div></div>
<div class="paragraph"><p>Type self, so you can be sure that you are in the main session:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; self
=&gt; main
(main)&gt;</code></pre>
</div></div>
<div class="paragraph"><p>So far we have discovered some interesting things, also we can find the instance variables of our RootViewController:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; RootViewController.instance_variables
=&gt; [:__classpath__]</code></pre>
</div></div>
<div class="paragraph"><p>And of course we can find out all the elements of the application</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; UIApplication.sharedApplication.keyWindow.rootViewController.view.subviews
=&gt; [#&lt;UILabel:0x95448e0&gt;, #&lt;UILabel:0x9544c30&gt;, #&lt;UIButton:0x9545110&gt;, #&lt;UILabel:0x9537eb0&gt;</code></pre>
</div></div>
<div class="paragraph"><p>and then recursive elements:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; UIApplication.sharedApplication.keyWindow.recursiveDescription</code></pre>
</div></div>
<div class="paragraph"><p>You can use <em>include</em>? from Array to ask if a method exists:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[].methods.include? :[]</code></pre>
</div></div>
<div class="paragraph"><p>And also to ask for an Objetive-C Method:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[].methods.include?(:'objectAtIndex:')</code></pre>
</div></div>
<div class="paragraph"><p>It’s time to add a button that shows time for remote time zone, open the <strong>root_view_controller.rb</strong> and add the following highlighted code on your <strong>viewDidLoadMethod</strong>:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Adding code ahead.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="vi">@currentTimeLabel</span> <span class="o">=</span>  <span class="n">time_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">65</span><span class="p">)</span>
    <span class="vi">@stepper</span> <span class="o">=</span> <span class="n">ui_stepper</span> <span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">75</span><span class="p">)</span>

    <span class="vi">@remoteTimeZoneTextField</span> <span class="o">=</span> <span class="n">time_zone_text_field</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">185</span><span class="p">)</span>
    <span class="vi">@remoteTimeZoneTextField</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="vi">@remoteTimeLabel</span> <span class="o">=</span>  <span class="n">time_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">210</span><span class="p">)</span>

<span class="hll">    <span class="n">chooseconvertButton</span> <span class="o">=</span> <span class="n">select_time_zone_Button</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">120</span><span class="p">)</span>
</span><span class="hll">    <span class="n">chooseconvertButton</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;set_remote_time&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@currentTimeLabel</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@remoteTimeZoneTextField</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@remoteTimeLabel</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@stepper</span><span class="p">)</span>
<span class="hll">    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">chooseconvertButton</span><span class="p">)</span>
</span>
    <span class="n">set_current_time</span>
    <span class="n">set_remote_time_zone</span>

    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now add the following method to your <strong>root_view_controller.rb</strong> file</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">stepperPressed</span> <span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">calendar</span> <span class="o">=</span> <span class="no">NSCalendar</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCalendarIdentifier</span><span class="p">(</span><span class="no">NSGregorianCalendar</span><span class="p">)</span>

  <span class="n">components</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">components</span> <span class="p">(</span><span class="no">NSMinuteCalendarUnit</span><span class="p">,</span><span class="ss">fromDate</span><span class="p">:</span><span class="vi">@offsetDate</span><span class="p">)</span>
  <span class="n">minute</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">minute</span>

  <span class="k">if</span> <span class="n">minute</span> <span class="o">&gt;</span> <span class="vi">@stepper</span><span class="o">.</span><span class="n">value</span>
    <span class="vi">@offsetDate</span> <span class="o">=</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTimeInterval</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="ss">sinceDate</span><span class="p">:</span><span class="vi">@offsetDate</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="vi">@offsetDate</span> <span class="o">=</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTimeInterval</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="ss">sinceDate</span><span class="p">:</span><span class="vi">@offsetDate</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">components</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">components</span> <span class="p">(</span><span class="no">NSMinuteCalendarUnit</span><span class="p">,</span><span class="ss">fromDate</span><span class="p">:</span><span class="vi">@offsetDate</span><span class="p">)</span>
  <span class="vi">@stepper</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">minute</span>
  <span class="vi">@currentTimeLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">month_year_string</span><span class="p">(</span><span class="vi">@offsetDate</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next compile your application; you should see a big black button, don’t hesitate and try it.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image4.png" alt="UIPicker Added" />
</div>
<div class="title">Figure 4. UIPicker Added</div>
</div>
</div>
<div class="sect2">
<h3 id="_styling_the_app">Styling the App</h3>
<div class="paragraph"><p>I think that the style of our application does not reflect the adventurous spirit that it should; maybe with some little improvements we can change that.</p></div>
<div class="paragraph"><p>Run the application with the rake command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>Now you should see REPL in your console:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>Create ./build/iPhoneSimulator-6.0-Development/TimeZoneConverter.dSYM
Simulate ./build/iPhoneSimulator-6.0-Development/TimeZoneConverter.app
<span class="o">(</span>main<span class="o">)</span>&gt;
</pre></div></div></div>
<div class="paragraph"><p>Now hold ‘command’ key and hover mouse on simulator screen. You can see a red-bordered box appears among the application elements, select the current date label the interactive console should display the instance corresponding to that label:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>Build ./build/iPhoneSimulator-6.0-Development
Simulate ./build/iPhoneSimulator-6.0-Development/TimeZoneConverter.app
<span class="o">(</span><span class="c">#&lt;UILabel:0x956a650&gt;)&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Now it&#8217;s time to add something fresh to our application as we see it running, yes you read that right! Type the following scrip in you REPL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;Noteworthy-Bold&quot;</span><span class="p">,</span><span class="ss">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image6.png" alt="UIPicker Added" />
</div>
<div class="title">Figure 5. UIPicker Added</div>
</div>
<div class="paragraph"><p>and hit enter, and voila !! The font has changed, but you may not like it, so try with different fonts and sizes. Here there are some of them:</p></div>
<div class="ulist"><ul>
<li>
<p>
Georgia-Italic
</p>
</li>
<li>
<p>
MarkerFelt-Thin
</p>
</li>
<li>
<p>
HelveticaNeue-Medium
</p>
</li>
</ul></div>
<div class="paragraph"><p>Since the creation of the apple store the are many apps to choose from, the app store is not the wild West that it used to be, so we are going to give some personality to our app:</p></div>
<div class="paragraph"><p>First, copy the assets from the chapter two directory, and put them into the Resources directory, and the in your <strong>root_view_controller.rb</strong> change the following line in your <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>
</pre></div></div></div>
<div class="paragraph"><p>for this one:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgApp.png&quot;</span><span class="p">))</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Replace code ahead.</td>
</tr></table>
</div>
<div class="paragraph"><p>We should add some personality to our buttons, open your file <strong>root_view_uitilities.rb</strong> and replace the <strong>time_label</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">time_label</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>
  <span class="n">label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span><span class="p">;</span>
  <span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;UTC offset&quot;</span>
  <span class="n">label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span><span class="p">;</span>
  <span class="n">label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;Noteworthy-Bold&quot;</span><span class="p">,</span><span class="ss">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">label</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image7.png" alt="Stylish App" />
</div>
<div class="title">Figure 6. Stylish App</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenge_dismiss_keyboard">Challenge - Dismiss KeyBoard</h3>
<div class="paragraph"><p>Well, I bet that you have tried to press the "Done" button on the keyboard, and well nothing happens, well you should blame apple for this, but don&#8217;t worry
apple want you to take care of it so they provides us a delegate method when "DONE" button A.K.A (Return key) it&#8217;s pressed, so you only have to add the following method
to your <strong>root_view_controller.rb</strong> file.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">textFieldShouldReturn</span> <span class="p">(</span><span class="n">textField</span><span class="p">)</span>
  <span class="vi">@remoteTimeZoneTextField</span><span class="o">.</span><span class="n">resignFirstResponder</span>
<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_challenge_dismiss_on_touch">Challenge - Dismiss on touch</h3>
<div class="paragraph"><p>How does that fancy app&#8217;s dismiss the keyboard when other area it&#8217;s touched ?, well as you may guess it not automatic, so you should add a "Tap Gesture Recognizer"
to sense when other area of the screen it&#8217;s touched, add the following lines which add a tap gesture to the RootViewController view to the <strong>viewDidLoad</strong> method</p></div>
<div class="listingblock">
<div class="content">
<pre><code>singleTap = UITapGestureRecognizer.alloc.initWithTarget(self, action: :'handleSingleTap')
self.view.addGestureRecognizer(singleTap)</code></pre>
</div></div>
<div class="paragraph"><p>So it&#8217;s up to you to implement the <strong>handleSingleTap</strong> method to dismiss the keyboard when the screen its touched.</p></div>
</div>
</div>
</div>
<h1 id="_chapter_03_objective_c_and_chapter_04_c">Chapter 03 - Objective C and Chapter 04 - C</h1>
<div class="sect1">
<h2 id="_estimator_app">Estimator App</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this exercise we will create an iOS app that exemplify the way many companies in the world estimate their projects, the "Estimator"</p></div>
<div class="sect2">
<h3 id="_create_project">Create Project</h3>
<div class="paragraph"><p>As a first step we will need to create a project, open your terminal application and run the following command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create estimator
</pre></div></div></div>
<div class="paragraph"><p>If we look at the new folder "Estimator", we will find a couple of new folders: "app", "resources", "spec".</p></div>
<div class="paragraph"><p>Next, lets copy our application images from <strong>(define deploy route)</strong> into the resources folder</p></div>
</div>
<div class="sect2">
<h3 id="_first_run">First Run</h3>
<div class="paragraph"><p>Just to make sure that everything is fine, we can test our new created project by executing the following line</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>estimator

<span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>This command will compile the project and run it on the simulator, like the following image:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/FirstRun.png" alt="First Run" />
</div>
<div class="title">Figure 7. First Run</div>
</div>
</div>
<div class="sect2">
<h3 id="_project_view_controller">Project View Controller</h3>
<div class="paragraph"><p>Let&#8217;s start coding our project, first we need to create a new file that will contain our Project View Controller Class</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch project_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s open it, and add the following lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open project_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProjectViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next we need to open the "AppDelegate" of the app, and load our controller into the UIWindow. This is done by inserting the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

  <span class="c1">#Create an instance of Project View Controller</span>
  <span class="n">project_view_controller</span> <span class="o">=</span> <span class="no">ProjectViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1">#Every window has a root view controller from which it will present its view</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">project_view_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>This part will load a new instance of our Project View Controller and insert its view into the UIWindow. Please note that the UIWindow receives a controller as rootViewController, instead of a view.</p></div>
<div class="paragraph"><p>If we run the project it should look like the following image:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/ProjectViewController.png" alt="Project View Controller" />
</div>
<div class="title">Figure 8. Project View Controller</div>
</div>
</div>
<div class="sect2">
<h3 id="_project_view">Project View</h3>
<div class="paragraph"><p>Next we need to add some controls for the user to select the number of screens of the project, complexity, methodology, etc. For this is required to add the following method to the project_view_controller.rb file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_view</span>

  <span class="c1"># Initialize a new view for the controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">902</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">902</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">902</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

  <span class="c1"># The following is an initialization and add of controls into the view</span>


  <span class="c1"># First create an instance of UIImageView, this control will present an Image into the view</span>
  <span class="c1"># for this case a black header</span>
  <span class="vi">@header_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
  <span class="vi">@header_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgHeader.png&quot;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@header_image_view</span><span class="p">)</span>


  <span class="c1"># Next we create an instance of UILabel, tellling it the position on the screen that</span>
  <span class="c1"># we want it to be drawn. For this we use a c struct called CGFrame</span>
  <span class="vi">@title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Project Estimator&quot;</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="c1"># To specify a custom Font we need to tell the proper name of it and the size that we want</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">25</span><span class="p">)</span>

  <span class="c1"># Then we add it to the view like this way</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>


  <span class="vi">@number_of_screens_text_field</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleRoundedRect</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">keyboardType</span> <span class="o">=</span> <span class="no">UIKeyboardTypeNumbersAndPunctuation</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTextField.png&quot;</span><span class="p">)</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleNone</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;Number of Screens&quot;</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">451</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">451</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">451</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-DemiBold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">25</span><span class="p">)</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">contentVerticalAlignment</span> <span class="o">=</span> <span class="no">UIControlContentVerticalAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@number_of_screens_text_field</span><span class="p">)</span>


  <span class="vi">@complexity_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Complexity&quot;</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-DemiBold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@complexity_label</span><span class="p">)</span>


  <span class="c1"># For the UISegmentedControl to work, we need to pass him the possible values</span>
  <span class="c1"># in this case a NSArray do the trick</span>
  <span class="vi">@complexity_values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@complexity_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">)</span>
  <span class="vi">@complexity_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;High&quot;</span><span class="p">)</span>

  <span class="c1"># We create an instance of a UISegmentedControl, setting the allowed values for it</span>
  <span class="vi">@complexity_segmented_control</span> <span class="o">=</span> <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithItems</span><span class="p">(</span><span class="vi">@complexity_values</span><span class="p">)</span>
  <span class="vi">@complexity_segmented_control</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>


  <span class="c1"># Its not required to set a selected index, but for this example we select the first segment</span>
  <span class="vi">@complexity_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@complexity_segmented_control</span><span class="p">)</span>


  <span class="vi">@outsourced_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Outsourced&quot;</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-DemiBold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@outsourced_label</span><span class="p">)</span>


  <span class="vi">@outsourced_values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@outsourced_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;No&quot;</span><span class="p">)</span>
  <span class="vi">@outsourced_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span><span class="p">)</span>

  <span class="vi">@outsourced_segmented_control</span> <span class="o">=</span> <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithItems</span><span class="p">(</span><span class="vi">@outsourced_values</span><span class="p">)</span>
  <span class="vi">@outsourced_segmented_control</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
  <span class="vi">@outsourced_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@outsourced_segmented_control</span><span class="p">)</span>


  <span class="vi">@methodology_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Methodology&quot;</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-DemiBold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@methodology_label</span><span class="p">)</span>


  <span class="vi">@methodology_values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@methodology_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Waterfall&quot;</span><span class="p">)</span>
  <span class="vi">@methodology_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Agile&quot;</span><span class="p">)</span>

  <span class="vi">@methodology_segmented_control</span> <span class="o">=</span> <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithItems</span><span class="p">(</span><span class="vi">@methodology_values</span><span class="p">)</span>
  <span class="vi">@methodology_segmented_control</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
  <span class="vi">@methodology_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@methodology_segmented_control</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also for this to work, we need to change the loadView method to look as the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

<span class="hll">  <span class="n">layout_view</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s run the application:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/ProjectView.png" alt="Project View" />
</div>
<div class="title">Figure 9. Project View</div>
</div>
<div class="paragraph"><p>The segmented controls does not look that pretty right?, lets customize their apperance adding the following method to the project_view_controller.rb file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method to customize the appearance of the UISegmentedControl</span>
<span class="k">def</span> <span class="nf">customize_segmented_control</span>

  <span class="c1"># Lets load the images from their respective files</span>
  <span class="n">segmented_control_normal_background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgSegmentedControlNormal.png&quot;</span><span class="p">)</span>
  <span class="n">segmented_control_selected_background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgSegmentedControlSelected.png&quot;</span><span class="p">)</span>
  <span class="n">segmented_control_separator</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgSegmentedControlSeparator.png&quot;</span><span class="p">)</span>


  <span class="c1"># Apply the image for the background when the segment is not selected</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="n">segmented_control_normal_background</span><span class="p">,</span>
                                                   <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">,</span>
                                                   <span class="ss">barMetrics</span><span class="p">:</span> <span class="no">UIBarMetricsDefault</span><span class="p">)</span>

  <span class="c1"># Apply the image for the background when the segment is selected</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="n">segmented_control_selected_background</span><span class="p">,</span>
                                                   <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateSelected</span><span class="p">,</span>
                                                   <span class="ss">barMetrics</span><span class="p">:</span> <span class="no">UIBarMetricsDefault</span><span class="p">)</span>


  <span class="c1"># Apply the image for the divider of the control</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setDividerImage</span><span class="p">(</span><span class="n">segmented_control_separator</span><span class="p">,</span>
                                                <span class="ss">forLeftSegmentState</span><span class="p">:</span> <span class="no">UIControlStateNormal</span><span class="p">,</span>
                                                <span class="ss">rightSegmentState</span><span class="p">:</span><span class="no">UIControlStateSelected</span><span class="p">,</span>
                                                <span class="ss">barMetrics</span><span class="p">:</span><span class="no">UIBarMetricsDefault</span><span class="p">)</span>



  <span class="c1"># Also we need to change the font of the titles, the first step is to load the font into the memory</span>
  <span class="n">segmented_control_title_font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>


  <span class="c1"># To apply certain visual attributes to Apple&#39;s default controls, we need to use a iOS 5 technology</span>
  <span class="c1"># called Skins. To work with screens we must create a dictionary with the key of the property we want</span>
  <span class="c1"># to change and the proper value</span>
  <span class="n">normal_title_text_attributes</span> <span class="o">=</span> <span class="no">NSMutableDictionary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">normal_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">segmented_control_title_font</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">UITextAttributeFont</span><span class="p">)</span>

  <span class="n">normal_title_text_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">545</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">749</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">349</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">normal_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">normal_title_text_color</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span> <span class="no">UITextAttributeTextColor</span><span class="p">)</span>

  <span class="n">normal_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span> <span class="no">UITextAttributeTextShadowColor</span><span class="p">)</span>

  <span class="c1"># Using Skins you can change the visual properties of all the same kind of controls at the same time,</span>
  <span class="c1"># no matter if they were created on another class or in another excecution time. To archive this</span>
  <span class="c1"># only send the messages to the class</span>
  <span class="c1">#</span>
  <span class="c1"># On the other side if you want only to modify one particular control, the following like will work</span>
  <span class="c1"># on the instance instead of the class</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setTitleTextAttributes</span><span class="p">(</span><span class="n">normal_title_text_attributes</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>



  <span class="n">selected_title_text_attributes</span> <span class="o">=</span> <span class="no">NSMutableDictionary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">selected_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">segmented_control_title_font</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">UITextAttributeFont</span><span class="p">)</span>

  <span class="n">selected_title_text_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">200</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">200</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">200</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">selected_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">selected_title_text_color</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">UITextAttributeTextColor</span><span class="p">)</span>

  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setTitleTextAttributes</span><span class="p">(</span><span class="n">selected_title_text_attributes</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateSelected</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And also we will need to change our loadView method again, lo look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

<span class="hll">  <span class="n">customize_segmented_control</span>
</span>  <span class="n">layout_view</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>This time, if we run the application you should see the following in your simulator:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/ProjectViewWithCustomSegmentedControls.png" alt="Project View with Custom Segmented Controls" />
</div>
<div class="title">Figure 10. Project View with Custom Segmented Controls</div>
</div>
<div class="paragraph"><p>If you select the Number of Screens UITextField you will notice that the keyboard does not hide when the return button is touched. To make this happen we need resign the UITextField as the first responder:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># UITextField delegate</span>

<span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textfield</span><span class="p">)</span>
<span class="err"> </span>
  <span class="n">textfield</span><span class="o">.</span><span class="n">resignFirstResponder</span>
  <span class="k">return</span> <span class="kp">true</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The <strong>textFieldShouldReturn</strong> method is called when the user selects the <strong>return</strong> button in the keyboard. So if you run the app the keyboard should hide properly.</p></div>
</div>
<div class="sect2">
<h3 id="_project_model">Project Model</h3>
<div class="paragraph"><p>First create a JSON file to contain all the estimated historical data (Fake one ;):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>cd..

<span class="nv">$ </span><span class="nb">cd </span>resources

<span class="nv">$ </span>touch historical_data.json
</pre></div></div></div>
<div class="paragraph"><p>Then add the following line to the file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open historical_data.json
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;Complexity&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;Low&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>

    <span class="nt">&quot;High&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">20</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nt">&quot;Outsourced&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;No&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>

    <span class="nt">&quot;Yes&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nt">&quot;Methodology&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;Waterfall&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">15</span>
    <span class="p">},</span>

    <span class="nt">&quot;Agile&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we need a object that make the estimation calculus, this object will be called "Project", let&#8217;s create the file that will contain it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>mkdir models

<span class="nv">$ </span><span class="nb">cd </span>models

<span class="nv">$ </span>touch project.rb
</pre></div></div></div>
<div class="paragraph"><p>Add the next lines to it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project</span>

  <span class="c1">#Constants representing Keys in the JSON</span>
  <span class="no">COMPLEXITY_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Complexity&#39;</span>
  <span class="no">OUTSOURCED_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Outsourced&#39;</span>
  <span class="no">METHODOLOGY_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Methodology&#39;</span>
  <span class="no">TOTAL_EFFORT_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;TotalEffort&#39;</span>
  <span class="no">VARIATION_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Variation&#39;</span>

  <span class="kp">attr_accessor</span> <span class="ss">:number_of_screens</span>
  <span class="kp">attr_accessor</span> <span class="ss">:complexity</span>
  <span class="kp">attr_accessor</span> <span class="ss">:outsourced</span>
  <span class="kp">attr_accessor</span> <span class="ss">:methodology</span>

  <span class="kp">attr_reader</span> <span class="ss">:total_effort</span>
  <span class="kp">attr_reader</span> <span class="ss">:variation</span>
  <span class="kp">attr_reader</span> <span class="ss">:delivery_year</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great!, Now we need to add the logic to read our JSON File, insert the following method in the class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_historical_estimates</span>

  <span class="c1"># Get the path of our JSON File inside the bundle</span>
  <span class="n">historical_data_file</span>  <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">pathForResource</span><span class="p">(</span><span class="s1">&#39;historical_data&#39;</span><span class="p">,</span> <span class="ss">ofType</span><span class="p">:</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>

  <span class="c1"># For us to load the file, we need to pass a pointer. So if something goes wrong we can print</span>
  <span class="c1"># the error</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Lets load the file into a NSData</span>
  <span class="n">historical_data</span> <span class="o">=</span> <span class="no">NSData</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithContentsOfFile</span><span class="p">(</span><span class="n">historical_data_file</span><span class="p">,</span>                                                                   <span class="ss">options</span><span class="p">:</span><span class="no">NSDataReadingUncached</span><span class="p">,</span>
                                                <span class="ss">error</span><span class="p">:</span><span class="n">error_pointer</span><span class="p">)</span>

  <span class="k">unless</span> <span class="n">historical_data</span>

    <span class="k">if</span> <span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">code</span> <span class="o">==</span> <span class="no">NSFileReadNoSuchFileError</span>

      <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Error: Missing File Error&quot;</span>

    <span class="k">else</span>

      <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">end</span>

    <span class="k">return</span> <span class="kp">nil</span>

  <span class="k">end</span>


  <span class="c1"># Serialize the NSData into something we can work with, in this case a Hash</span>
  <span class="n">historical_estimates</span> <span class="o">=</span> <span class="no">NSJSONSerialization</span><span class="o">.</span><span class="n">JSONObjectWithData</span><span class="p">(</span><span class="n">historical_data</span><span class="p">,</span>
                                                                  <span class="ss">options</span><span class="p">:</span> <span class="no">NSDataReadingUncached</span><span class="p">,</span>
                                                                  <span class="ss">error</span><span class="p">:</span> <span class="n">error_pointer</span><span class="p">)</span>

  <span class="k">unless</span> <span class="n">historical_estimates</span>

    <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span>


  <span class="n">historical_estimates</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we have read our JSON file, the next thing is to extract the historical data into something we can use to make the calculus. This following methods should be added to the class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">obtain_historical_complexity</span>

  <span class="vi">@complexity_total_effort</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@complexity_variation</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">historical_complexity</span> <span class="o">=</span> <span class="vi">@historical_estimates</span><span class="o">[</span><span class="no">COMPLEXITY_DATA_KEY</span><span class="o">]</span>

  <span class="c1"># We use the user selection as a Key</span>
  <span class="k">unless</span> <span class="n">historical_complexity</span><span class="o">[</span><span class="vi">@complexity</span><span class="o">].</span><span class="n">nil?</span>

    <span class="n">selected_historical_complexity</span> <span class="o">=</span> <span class="n">historical_complexity</span><span class="o">[</span><span class="vi">@complexity</span><span class="o">]</span>

    <span class="vi">@complexity_total_effort</span> <span class="o">=</span> <span class="n">selected_historical_complexity</span><span class="o">[</span><span class="no">TOTAL_EFFORT_DATA_KEY</span><span class="o">]</span>
    <span class="vi">@complexity_variation</span> <span class="o">=</span> <span class="n">selected_historical_complexity</span><span class="o">[</span><span class="no">VARIATION_DATA_KEY</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">obtain_historical_outsourced</span>

  <span class="vi">@outsourced_total_effort</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@outsourced_variation</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">historical_outsourced</span> <span class="o">=</span> <span class="vi">@historical_estimates</span><span class="o">[</span><span class="no">OUTSOURCED_DATA_KEY</span><span class="o">]</span>

  <span class="c1"># We use the user selection as a Key</span>
  <span class="k">unless</span> <span class="n">historical_outsourced</span><span class="o">[</span><span class="vi">@outsourced</span><span class="o">].</span><span class="n">nil?</span>

    <span class="n">selected_historical_outsourced</span> <span class="o">=</span> <span class="n">historical_outsourced</span><span class="o">[</span><span class="vi">@outsourced</span><span class="o">]</span>

    <span class="vi">@outsourced_total_effort</span> <span class="o">=</span> <span class="n">selected_historical_outsourced</span><span class="o">[</span><span class="no">TOTAL_EFFORT_DATA_KEY</span><span class="o">]</span>
    <span class="vi">@outsourced_variation</span> <span class="o">=</span> <span class="n">selected_historical_outsourced</span><span class="o">[</span><span class="no">VARIATION_DATA_KEY</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">obtain_historical_methodology</span>

  <span class="vi">@methodology_total_effort</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@methodology_variation</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">historical_methodology</span> <span class="o">=</span> <span class="vi">@historical_estimates</span><span class="o">[</span><span class="no">METHODOLOGY_DATA_KEY</span><span class="o">]</span>

  <span class="c1"># We use the user selection as a Key</span>
  <span class="k">unless</span> <span class="n">historical_methodology</span><span class="o">[</span><span class="vi">@methodology</span><span class="o">].</span><span class="n">nil?</span>

    <span class="n">selected_historical_methodology</span> <span class="o">=</span> <span class="n">historical_methodology</span><span class="o">[</span><span class="vi">@methodology</span><span class="o">]</span>

    <span class="vi">@methodology_total_effort</span> <span class="o">=</span> <span class="n">selected_historical_methodology</span><span class="o">[</span><span class="no">TOTAL_EFFORT_DATA_KEY</span><span class="o">]</span>
    <span class="vi">@methodology_variation</span> <span class="o">=</span> <span class="n">selected_historical_methodology</span><span class="o">[</span><span class="no">VARIATION_DATA_KEY</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Almost there! Lets add the algorithm to make the calculus, inserting the following methods:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">calculate_total_effort</span>

  <span class="c1"># We add all the possible total effort that the user selected</span>
  <span class="n">total_effort_data</span> <span class="o">=</span> <span class="vi">@complexity_total_effort</span> <span class="o">+</span> <span class="vi">@outsourced_total_effort</span> <span class="o">+</span> <span class="vi">@methodology_total_effort</span>

  <span class="c1"># Generate a random with the minimum value of a half of the total effort</span>
  <span class="n">total_effort</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="n">total_effort_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_effort_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

  <span class="c1"># Calculate the effort plus the number of screens as percentage</span>
  <span class="n">total_effort</span> <span class="o">*</span> <span class="p">((</span><span class="vi">@number_of_screens</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">calculate_variation</span>

  <span class="c1"># We add all the possible variation that the user selected</span>
  <span class="n">variation_data</span> <span class="o">=</span> <span class="vi">@complexity_variation</span> <span class="o">+</span> <span class="vi">@outsourced_variation</span> <span class="o">+</span> <span class="vi">@methodology_variation</span>

  <span class="nb">rand</span><span class="p">(</span><span class="n">variation_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">variation_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">calculate_delivery_year</span>

  <span class="c1"># Calculate the total effort plus the posible variation</span>
  <span class="n">total_effort_with_variation</span> <span class="o">=</span> <span class="vi">@total_effort</span> <span class="o">*</span> <span class="p">(</span><span class="vi">@variation</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

  <span class="c1"># Transform the hours into working weeks</span>
  <span class="n">total_effort_days</span> <span class="o">=</span> <span class="n">total_effort_with_variation</span> <span class="o">/</span> <span class="mi">8</span>
  <span class="n">total_effort_weeks</span> <span class="o">=</span> <span class="n">total_effort_days</span> <span class="o">/</span> <span class="mi">5</span>


  <span class="c1"># In the following part we add the calculated weeks to the current date</span>
  <span class="n">weekComponent</span> <span class="o">=</span> <span class="no">NSDateComponents</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">weekComponent</span><span class="o">.</span><span class="n">week</span> <span class="o">=</span> <span class="n">total_effort_weeks</span>

  <span class="n">calendar</span> <span class="o">=</span> <span class="no">NSCalendar</span><span class="o">.</span><span class="n">currentCalendar</span>

  <span class="n">delivery_date</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">dateByAddingComponents</span><span class="p">(</span><span class="n">weekComponent</span><span class="p">,</span>
                                                     <span class="ss">toDate</span><span class="p">:</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                                     <span class="ss">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>


  <span class="c1"># Of the resulting date we only need the year, in the following section is extracted</span>
  <span class="n">yearComponent</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">components</span><span class="p">(</span><span class="no">NSYearCalendarUnit</span><span class="p">,</span> <span class="ss">fromDate</span><span class="p">:</span> <span class="n">delivery_date</span><span class="p">)</span>

  <span class="n">yearComponent</span><span class="o">.</span><span class="n">year</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Last part! A method that will execute the calculus, this method will be called by the Project View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">estimate</span>

  <span class="vi">@historical_estimates</span> <span class="o">=</span> <span class="n">load_historical_estimates</span>


  <span class="n">obtain_historical_complexity</span>
  <span class="n">obtain_historical_outsourced</span>
  <span class="n">obtain_historical_methodology</span>


  <span class="vi">@total_effort</span> <span class="o">=</span>  <span class="n">calculate_total_effort</span>
  <span class="vi">@variation</span> <span class="o">=</span> <span class="n">calculate_variation</span>
  <span class="vi">@delivery_year</span> <span class="o">=</span> <span class="n">calculate_delivery_year</span>

<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_project_view_controller_and_project_model">Project View Controller and Project Model</h3>
<div class="paragraph"><p>We need to add a button to execute the estimation process, insert this lines on the button of the <em>layout_view</em> method, in the project_view_controller.rb file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>open project_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="c1"># This control initialization is radically different from the other ones, this is because</span>
<span class="c1"># UIButton provides different types and styles of buttons. The default one is Rounded Rect</span>
<span class="vi">@estimate_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
<span class="vi">@estimate_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

<span class="c1"># Sometimes when we work with controls we can change the title or image based on different states of</span>
<span class="c1"># it. (Normal, Selected, Highlighted)</span>
<span class="vi">@estimate_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnEstimate.png&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
<span class="c1">#@estimate_button.setTitle(&quot;Estimate this project&quot;, forState: UIControlStateNormal)</span>

<span class="c1"># Lets tell the button who is going to call and where, when the user touch it</span>
<span class="vi">@estimate_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                           <span class="ss">action</span><span class="p">:</span> <span class="s2">&quot;estimate_project:&quot;</span><span class="p">,</span>
                           <span class="ss">forControlEvents</span><span class="p">:</span> <span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

<span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@estimate_button</span><span class="p">)</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">The method is called estimate_project:, with the two dots</td>
</tr></table>
</div>
<div class="paragraph"><p>Please pay special attention to the <em>addTarget</em> method, this is used to tell the button who and in which method it should call when the user touches it. In this case we are telling it to call the Project View Controller in the method "estimate_project:", lets add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">estimate_project</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="c1"># Create a new instance of Project</span>
  <span class="n">project</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">new</span>

  <span class="n">project</span><span class="o">.</span><span class="n">number_of_screens</span> <span class="o">=</span> <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">intValue</span>


  <span class="c1"># We need the selected index to extract the string value from the segmented allowed</span>
  <span class="c1"># values array</span>
  <span class="n">selected_complexity_index</span> <span class="o">=</span> <span class="vi">@complexity_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span>
  <span class="n">project</span><span class="o">.</span><span class="n">complexity</span> <span class="o">=</span> <span class="vi">@complexity_values</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">selected_complexity_index</span><span class="p">)</span>


  <span class="n">selected_outsourced_index</span> <span class="o">=</span> <span class="vi">@outsourced_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span>
  <span class="n">project</span><span class="o">.</span><span class="n">outsourced</span> <span class="o">=</span> <span class="vi">@outsourced_values</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">selected_outsourced_index</span><span class="p">)</span>


  <span class="n">selected_methodology_index</span> <span class="o">=</span> <span class="vi">@methodology_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span>
  <span class="n">project</span><span class="o">.</span><span class="n">methodology</span> <span class="o">=</span> <span class="vi">@methodology_values</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">selected_methodology_index</span><span class="p">)</span>


  <span class="n">project</span><span class="o">.</span><span class="n">estimate</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In this method we implement the creation of a new Project instance, setting the user input and finally we ask it to calculate the estimation</p></div>
</div>
<div class="sect2">
<h3 id="_estimation_view_controller">Estimation View Controller</h3>
<div class="paragraph"><p>Now we need to add some place to show our calculated values, for this we need to create a new view controller called "Estimation View Controller":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch estimation_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Add the following lines to the "estimation_view_controller.rb":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EstimationViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="n">layout_view</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">layout_view</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">298</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">298</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">298</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

    <span class="vi">@header_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
    <span class="vi">@header_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgHeader.png&quot;</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@header_image_view</span><span class="p">)</span>


    <span class="vi">@title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Estimation&quot;</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">25</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>


    <span class="vi">@total_effort_title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Total effort&quot;</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-DemiBold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">35</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@total_effort_title_label</span><span class="p">)</span>


    <span class="vi">@total_effort_value_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">120</span><span class="p">)</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">minimumFontSize</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">adjustsFontSizeToFitWidth</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@total_effort_value_label</span><span class="p">)</span>


    <span class="vi">@total_effort_unit_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;HRS&quot;</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">671</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">353</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">72</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@total_effort_unit_label</span><span class="p">)</span>


    <span class="vi">@variation_title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Variation&quot;</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@variation_title_label</span><span class="p">)</span>


    <span class="vi">@variation_value_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">85</span><span class="p">))</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;52&quot;</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">80</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@variation_value_label</span><span class="p">)</span>


    <span class="vi">@variation_unit_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">310</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">671</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">353</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@variation_unit_label</span><span class="p">)</span>


    <span class="vi">@delivery_year_title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">370</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Delivery year&quot;</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@delivery_year_title_label</span><span class="p">)</span>


    <span class="vi">@delivery_year_value_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;2040&quot;</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentRight</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@delivery_year_value_label</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We just implement the logic for our new view controller, also we add some labels to draw on the screen the values generated by the Project estimation</p></div>
</div>
<div class="sect2">
<h3 id="_estimation_view_controller_and_project_model">Estimation View Controller and Project Model</h3>
<div class="paragraph"><p>The last part of our implementation is to add a way to bind the values of the Project Model into our labels, the following method does the trick (Insert it on the estimation_view_controller.rb):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method to bind the values in the Project Object into proper UILabels</span>
<span class="k">def</span> <span class="nf">bind_project</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

  <span class="c1">#Using an NSString we set the text into the label, when we are using %@ we tell the object</span>
  <span class="c1">#to print it description as a string</span>
  <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">total_effort</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">variation</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">delivery_year</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take note that in this specific case we are using Objective-C strings (NSStrings) instead of ruby strings</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_project_view_controller_and_estimation_view_controller">Project View Controller and Estimation View Controller</h3>
<div class="paragraph"><p>Final task! We need to show our new controller, the way to do this is to perform a transition from the Project View Controller to the Estimation View Controller</p></div>
<div class="paragraph"><p>Insert the following lines into the estimate_project(sender) method on the class project_view_controller.rb:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Now we need a new instance of the Estimation View Controller for show the</span>
<span class="c1"># results of the Project estimation</span>
<span class="vi">@estimation_view_controller</span> <span class="o">=</span> <span class="no">EstimationViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

<span class="vi">@estimation_view_controller</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>

<span class="c1"># Lets tell it to bind our project instance</span>
<span class="vi">@estimation_view_controller</span><span class="o">.</span><span class="n">bind_project</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>


<span class="c1"># To show the Estimation View Controller view, we can use a transition.</span>
<span class="c1"># From our current view, to the Estimation View Controller&#39;s view</span>
<span class="no">UIView</span><span class="o">.</span><span class="n">transitionFromView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">,</span>
                          <span class="ss">toView</span><span class="p">:</span> <span class="vi">@estimation_view_controller</span><span class="o">.</span><span class="n">view</span><span class="p">,</span>
                          <span class="ss">duration</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span>
                          <span class="ss">options</span><span class="p">:</span> <span class="no">UIViewAnimationOptionTransitionFlipFromLeft</span><span class="p">,</span>
                          <span class="ss">completion</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_run_and_enjoy">Run and Enjoy</h3>
<div class="paragraph"><p>Lets run our estimator app!</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/FinishedProjectViewController.png" alt="Finished Project View Controller" />
</div>
<div class="title">Figure 11. Finished Project View Controller</div>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/FinishedEstimationViewController.png" alt="Finished Estimation View Controller" />
</div>
<div class="title">Figure 12. Finished Estimation View Controller</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenges">Challenges</h3>
<div class="paragraph"><p>1.- The UISegmentedControlls in the project_view_controller.rb are bound to a static array, move that logic to the Project Model. So it can provide the allowed values for the estimation.</p></div>
<div class="paragraph"><p>2.- Now that the allowed values are in the Project Model, lets make it dynamic by retrieving them from the JSON File.</p></div>
</div>
</div>
</div>
<h1 id="_chapter_05_cocoa_overview">Chapter 05 - Cocoa Overview</h1>
<div class="sect1">
<h2 id="_the_cocoaheads_app">The Cocoaheads app</h2>
<div class="sectionbody">
<div class="paragraph"><p>Cocoaheads is a community of OSX/iOS programmers. There are many Cocoaheads communities around the world and they meet periodically (normally on a monthly basis) to discuss the latest topics for Apple-related technologies.</p></div>
<div class="paragraph"><p>We want to build an iPhone app for this community. The app should cover the next functionality:</p></div>
<div class="ulist"><ul>
<li>
<p>
Show the complete schedule for the next Cocoaheads meetings.
</p>
</li>
<li>
<p>
Show the information about the next meeting. This information could include the map to the venue, the list of the talks, etc.
</p>
</li>
<li>
<p>
Registration and login of users.
</p>
</li>
<li>
<p>
Allow users to register for the next meeting.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We are going to build this app for several chapters, one step a time. In this chapter we are going to focus in creating the first screen: the Next Event screen that shows the information related to the next meeting:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_01_app.png" alt="Chapter 5 app" />
</span></p></div>
<div class="sect2">
<h3 id="_creating_the_app">Creating the app</h3>
<div class="paragraph"><p>Let&#8217;s start by creating the Cocoaheads rubymotion app. You have already know how to create RubyMotion apps from previous chapters, in the command line type:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Cocoaheads
</pre></div></div></div>
<div class="paragraph"><p>As we have seen, this command creates an empty application with the following folder structure:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview//ch05_02_folder_structure.png" alt="Folder structure" />
</span></p></div>
<div class="paragraph"><p>We&#8217;ll be using a structure based on Rails for this Course. Thus, you need to create a folrder named "controllers" inside the "app" folder. Inside "controllers". create an empty file called "next_event_view_controller.rb".</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview//ch05_03_folder_controllers.png" alt="Controllers folder" />
</span></p></div>
<div class="paragraph"><p>As we have seen in previous chapters, the vanilla app created by the motion command only creates an empty app. We need to add a Window to it. Thus, open the app_delegate.rb class and inside the method</p></div>
<div class="paragraph"><p>copy this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

  <span class="n">next_event_view_controller</span> <span class="o">=</span> <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">next_event_view_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember that this method is called once iOS has finished creating your app. In that moment, the <strong>UIAppDelegate</strong> is notified using this method so you can initiliaze the app.</p></div>
<div class="paragraph"><p>This is what we are doing inside the method:</p></div>
<div class="ulist"><ul>
<li>
<p>
Create a <strong>UIWindow</strong>.
</p>
</li>
<li>
<p>
Assigning a <strong>UIViewController</strong> as the <strong>rootViewController</strong> of the window.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Notice that we are creating the <strong>UIWindow</strong> with the same Frame as <strong>UIScreen.mainScreen</strong>. <strong>UIScreen</strong> is a convenient class to access the size of a screen device. So basically we are setting the size of the app&#8217;s window to be the full screen.</p></div>
</div>
<div class="sect2">
<h3 id="_creating_the_view_controller">Creating the View Controller</h3>
<div class="paragraph"><p>Now, we are going  create our View Controller. Open the <strong>next_event_view_controller.rb</strong> file and create a child of UIViewController:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NextEventViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="nb">p</span> <span class="s1">&#39;Initializing NextEventViewController&#39;</span>
    <span class="k">super</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">p</span> <span class="s1">&#39;loading view&#39;</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span> <span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In Cocoa, there is no <strong>initialize</strong> metod. There is the <strong>init</strong> method with the responsbility of creating the instance of the class. It is mandatory that you call <strong>super</strong> and then, return <strong>self</strong>.</p></div>
<div class="paragraph"><p>The other method we are creating is <strong>loadView</strong>. The responsibility of this method is to actually create the view of this Controller. So we are basically creating a view that covers all the screen and switching its background color to white. <strong>UIColor</strong> is the  class we use in Cocoa to handle colors, it has some convenient class methods with predefined colors (such as <strong>whiteColor</strong>) but it also allows you to create custom colors.</p></div>
<div class="paragraph"><p>Use the command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>to test the application, you will see a white screen. And in the console you will notice that first the init method was invoked and then the loadView.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="s2">&quot;Initializing NextEventViewController&quot;</span>
<span class="s2">&quot;loading view&quot;</span>
<span class="o">(</span>main<span class="o">)</span>&gt;
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_using_uiimageview">Using UIImageView</h3>
<div class="paragraph"><p>Now it&#8217;s time to begin to stylish our app. We are going to add a header and a background image with a nice gradient.</p></div>
<div class="paragraph"><p>We have placed the assets for the app in the 05-CocoaOverview/resources/images folder. Copy them into the <strong>resources</strong> folder of our app.</p></div>
<div class="paragraph"><p>Now inside our View Controller, add these lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">imageViewWithHeader</span>

  <span class="n">header_imageview</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTitleBar&#39;</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">header_imageview</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">imageViewWithBackground</span>

  <span class="n">background_imageview</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgApp&#39;</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">background_imageview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">396</span><span class="p">)</span>
  <span class="n">background_imageview</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">imageViewWithTitleBackground</span>

  <span class="n">title_background_imageview</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgEventTitle&#39;</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">title_background_imageview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">103</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">103</span><span class="o">]]</span>
  <span class="n">title_background_imageview</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The method <strong>viewDidLoad</strong> is called once the view of the Controller is loaded into memory. It&#8217;s safe, then, to initialize the view inside this method.</p></div>
<div class="paragraph"><p>Basically, we are adding three images using the <strong>addSubview</strong> method of <strong>UIView</strong>. In the <strong>imageViewWithHeader</strong> method, we are creating the first image: the header image. In CocoaTouch we have the <strong>UIImageView</strong> class to add images to our apps. We are using its initializer method called <strong>initWithImage</strong> that receives a <strong>UIImage</strong>. <strong>UIImage</strong> is the image itself, and <strong>UIImageView</strong> is only a convenient <strong>UIView</strong> that simplifies the process of painting an image on screen.</p></div>
<div class="paragraph"><p><strong>UIImage</strong> can be created with its class method <strong>imageNamed</strong> that receives an <strong>NSString</strong> with the name of the image file. If the image is a PNG, you don&#8217;t need to specify its extension.</p></div>
<div class="paragraph"><p>In the <strong>imageViewWithBackground</strong> method we are creating the <strong>UIImageView</strong> with the background image. Notice that we are changing the frame of this image. The frame is a property of type <strong>CGRect</strong> that the class <strong>UIView</strong> uses to specify the location of the view inside its superview and its size.</p></div>
<div class="paragraph"><p>We are using the <strong>CGRectMake</strong> function to create our frame. The first two arguments define the location coordinates of the object from the top left corner of the superview. For the background we are specifying an X coordinate of 0, thus the object will be at the left-most location of the screen; and a Y coordinate of 64, thus the object will be placed below the header image. The second  and third argument specifies its size.</p></div>
<div class="paragraph"><p>RubyMotion has another way to create a <strong>CGRect</strong>. In the <strong>imageViewWithBackground</strong> Try to change the <strong>CGRectMake</strong> line to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">background_imageview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">396</span><span class="o">]]</span>
</pre></div></div></div>
<div class="paragraph"><p>RubyMotion allow us to use an array of two arrays to define *CGRect*s. The first array specifies the location of the object and the second its size.</p></div>
<div class="paragraph"><p>When you run the app you will something like this:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_05_uiimage.png" alt="Console output" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_creating_labels">Creating labels</h3>
<div class="paragraph"><p>The next step is to create the labels with the Event information. Add this two methods to your View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">labelWithNextEventName</span>

  <span class="n">next_event_name_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">130</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">275</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span> <span class="p">)</span>

  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AmericanTypewriter-CondensedBold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">30</span><span class="p">)</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">shadowColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">darkGrayColor</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">shadowOffset</span> <span class="o">=</span> <span class="o">[-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
  <span class="n">next_event_name_label</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">labelWithDaysLeft</span>

  <span class="n">days_left_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">220</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">275</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span> <span class="p">)</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Light&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">shadowColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">darkGrayColor</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">shadowOffset</span> <span class="o">=</span> <span class="o">[-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
  <span class="n">days_left_label</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The object used in CocoaTouch to display lines of text is <strong>UILabel</strong>. We are creating two <strong>UILabel</strong> using the initializer method <strong>initWithFrame</strong> to specify their size and location.</p></div>
<div class="paragraph"><p>Then, we are changing its font and size. An <strong>UILabel</strong> has a property named <strong>font</strong> that allow us to do that. To create a Font, we are using the <strong>UIFont</strong> class and its method <strong>fontWithName:size</strong>. As you can see, you specify the font using a NSString with the Font Family name. If you want to see the available Fonts in CocoaTouch, try to print the array returned by <strong>UIFont.familyNames</strong>.</p></div>
<div class="paragraph"><p>Next, we are changing the color of the label using the <strong>textColor</strong> property and the text alignment. By default a <strong>UILabel</strong> has a white background color, we are changing this to clearColor. This is a special color to specify transparencies. So, basically we are defining that the background of this <strong>UILabel</strong> should be transparent.</p></div>
<div class="paragraph"><p>Finally, we are adding a shadow to the label. With <strong>shadowColor</strong> you specify its color and with <strong>shadowOffset</strong> its location. This offset is the number of points that the shadow will be offset from the label. It is a <strong>CGSize</strong> object so you can specify it with the <strong>CGSizeMake</strong> function, but we prefer to use the more convenient RubyMotion way of using an array of two elements, one for width and the other one for height. With <strong>[-1, -1]</strong> we are defining that the shadow will be 1 point offset to the left and 1 point offset up from the label.</p></div>
<div class="paragraph"><p>We have the methods to create our labels, is time to add them to our view. Inside the viewDidLoad method add this lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>

  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>
  <span class="vi">@days_left_label</span> <span class="o">=</span> <span class="n">labelWithDaysLeft</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@next_event_name_label</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@days_left_label</span> <span class="p">)</span>

  <span class="vi">@days_left_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">DAYS_LEFT_TEXT</span>
  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">EVENT_NAME_TEXT</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And create this other method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidUnload</span>

  <span class="k">super</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@days_left_label</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are adding the labels to instance variables. This is recommended if you need to access them later to change its properties. In this case we are changing the text of the labels to some constants. Finally add this two constants to your View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NextEventViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">DAYS_LEFT_TEXT</span> <span class="o">=</span> <span class="s2">&quot;(20 Days Left)&quot;</span>
  <span class="no">EVENT_NAME_TEXT</span> <span class="o">=</span> <span class="s2">&quot;November meeting.&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>When you keep <strong>UIViews</strong> in instance variables, it is recommended to set this variables to <strong>nil</strong> inside the <strong>viewDidUnload</strong> method. Prior to iOS 6, this method was invoked when the device was running out of memory. Then, we are freeing the memory allocated for the UILabels for low memory scenarios.</p></div>
<div class="paragraph"><p>Run your app and you should see that the labels appeared with the data for the next Cocoaheads event:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_06_uilabel.png" alt="Labels" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_adding_buttons">Adding buttons</h3>
<div class="paragraph"><p>Finally, we are going to add two buttons to our app: for sign-up and for sign-in.</p></div>
<div class="paragraph"><p>Add these methods to the View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">buttonForSignIn</span>

  <span class="n">sign_in_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">280</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">295</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;I have an account, sign-in to book&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;is Highlighted&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Light&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_in:&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="n">sign_in_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">buttonForSignUp</span>

  <span class="n">sign_up_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">350</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">295</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Don&#39;t have an account, sign-up&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Light&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_up&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">sign_up_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span> <span class="n">button</span> <span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;sign in button pressed </span><span class="si">#{</span><span class="n">button</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">sign_up</span>

  <span class="nb">p</span> <span class="s2">&quot;sign-up button pressed&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And don&#8217;t forget to add the buttons to the view in the "viewDidLoad" method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>

  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>
  <span class="vi">@days_left_label</span> <span class="o">=</span> <span class="n">labelWithDaysLeft</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@next_event_name_label</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@days_left_label</span> <span class="p">)</span>

  <span class="vi">@days_left_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">DAYS_LEFT_TEXT</span>
  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">EVENT_NAME_TEXT</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignIn</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignUp</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s review what&#8217;s going on in those methods. First, we are creating a <strong>UIButton</strong> with the line.</p></div>
<div class="paragraph"><p><strong>UIButton.buttonWithType(UIButtonTypeRoundedRect)</strong></p></div>
<div class="paragraph"><p>As you may expect, there are other types of UIButtons that you can specify, such as:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>UIButtonTypeRoundedRect</strong>. Standard white button with rounded corners.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeCustom</strong>. Defines a button with no style, very useful when you have your own set of images to use as a button.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeDetailDisclosure</strong>. The standard button that appear in tables: a small blue circle with an arrow on it.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeInfoLight</strong>. A small gray circle with an "i" on it.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeInfoDark</strong>. A small dark gray circle with an "i" on it.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeContactAdd</strong>. A small blue circle with the plus sign on it.
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can try these types in the app.</p></div>
<div class="paragraph"><p>The second thing you have to notice is how to add text to the button (this only works if the type is Round Rect or Custom):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">sign_in_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;I have an account, sign-in to book&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>We do that with the method <strong>setTitle:forState</strong>. The first argument is a <strong>NSString</strong> with the text, the second one specifies in which state should the text appear. A <strong>UIButton</strong> has the following states:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>UIControlStateNormal</strong>. The default state of the button.
</p>
</li>
<li>
<p>
<strong>UIControlStateHighlighted</strong>. When the button is pressed.
</p>
</li>
<li>
<p>
<strong>UIControlStateDisabled</strong>. When the button is disabled (its enabled property is set to false).
</p>
</li>
</ul></div>
<div class="paragraph"><p>As you can see, for the Sign-In button we are specifying a title for the highlight state, when you run the app and press that button you will se that the title changes to the one for the highlighted state.</p></div>
<div class="paragraph"><p>We are also changing the default font of the button:</p></div>
<div class="paragraph"><p><strong>sign_in_button.titleLabel.font = UIFont.fontWithName("HelveticaNeue-Light", size:18)</strong></p></div>
<div class="paragraph"><p>Finally we are connecting the UIButton to our View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">sign_in_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                         <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_in:&#39;</span><span class="p">,</span>
                         <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The method <strong>addTarget:action:forControlEvents</strong> is the standard way to communicate a <strong>UIControl</strong> with a <strong>UIViewController</strong>. This method specifies which object and which method inside that object should be notified when an specific Event happens in such <strong>UIControl</strong>.</p></div>
<div class="paragraph"><p>In this case we are saying that <strong>self</strong> (the current <strong>UIViewController</strong> instance) should be notified through the <strong>sign_in:</strong> method when the <strong>UIButton</strong> is pressed and released (<strong>UIControlEventTouchUpInside</strong>). The action is actually a <strong>selector</strong> in CocoaTouch: a <strong>NSString</strong> with the name of the method. This name will be resolved into a concrete method in Runtime. In this example, this method will be called:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span> <span class="n">button</span> <span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;sign in button pressed </span><span class="si">#{</span><span class="n">button</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, the name of the method has a ":", because it has one argument. Using this target-selector approach to communicate, the UIControl that triggers the communication can be passed as an argument. In this example, it is the UIButton.</p></div>
<div class="paragraph"><p>In the other button, the sign-up one, we are not passing any argument:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">sign_up_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                         <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_up&#39;</span><span class="p">,</span>
                         <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Then, the selector method must be declared with no arguments:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_up</span>

  <span class="nb">p</span> <span class="s2">&quot;sign-up button pressed&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and try the buttons. If both of them are appearing and invoke the specified methods, you have finished this workshop.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_07_uibuttons.png" alt="UIButtons" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_challenge">Challenge</h3>
<div class="paragraph"><p>We included two standard buttons in our app, but our designer have made a really cool button. You can see it in the resources dir, is the image named <strong>btnBrown.png</strong>.</p></div>
<div class="paragraph"><p>Change the sign-up button to show this image. Tips: you will need to change the type of the button to a Custom one and need to use the <strong>setBackgroundImage:forState</strong> method.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_08_challenge.png" alt="Challenge" />
</span></p></div>
</div>
</div>
</div>
<h1 id="_day_2">Day 2</h1>
<h1 id="_chapter_06_delegate_amp_chapter_07_mapkit">Chapter 06 - Delegate &amp; Chapter 07 - MapKit</h1>
<div class="paragraph"><p>The basis of many apps are the Location Services, that help to exploit the location capabilities of the devices and the ability to use maps. We will review in this chapter how to use these two features of CocoaTouch to improve our CocoaHeads app.</p></div>
<div class="paragraph"><p>Our app needs to show the location of the events in a map. We will add this feature on this chapter. We will also show you how to retrieve the current location of the device using a <strong>CoreLocationManager</strong>.</p></div>
<div class="sect1">
<h2 id="_preparing_the_app">Preparing the app</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the last chapter, you learnt the basics for building <strong>UIViewControllers</strong> and their related <strong>UIViews</strong> using RubyMotion. In this chapter we are going to focus in covering how to use the localization features of CocoaTouch as well as the Maps.</p></div>
<div class="paragraph"><p>We have started the project for you, building empty UIViewControllers to which we are going to add functionality. Open the folder <strong>07-MapKit/resources/code</strong> you will find a folder named <strong>Cocoaheads</strong> with the app. From the command line, run it with the <strong>rake</strong> command. You will see the main screen with the details of an event:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_01_app.png" alt="Chapter 7 app" />
</span></p></div>
<div class="paragraph"><p>When you tap on the <strong>View Map</strong> button a view that will contain the map appears:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_02_map.png" alt="Chapter 7 empty map view" />
</span></p></div>
<div class="paragraph"><p>Now open the Rakefile and examine the configuration. In this lab we are going to use the Location functionalities of CocoaTouch and the Maps. In order to do this we have to import some frameworks:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">frameworks</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;CoreLocation&#39;</span><span class="p">,</span> <span class="s1">&#39;MapKit&#39;</span><span class="o">]</span>
</pre></div></div></div>
<div class="paragraph"><p>CoreLocation is the framework that allows you to access the geo location and heading of the device. MapKit, on the other hand, provides an interface to embed maps into your applications as well as other advanced functionality such as adding custom annotations, reverse-geocoding lookups, etc.</p></div>
<div class="sect2">
<h3 id="_adding_a_location_manager">Adding A Location Manager</h3>
<div class="paragraph"><p>The first thing we are going to add to our View Controller is a <strong>CLLocationManager</strong> to determine the device location and show how the delegation pattern works in CocoaTouch.</p></div>
<div class="paragraph"><p>In order to do this, open the <strong>event_detail_view_controller.rb</strong> file and locate the method named <strong>requestUserCurrentLocation</strong> Add the following lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="no">CLLocationManager</span><span class="o">.</span><span class="n">locationServicesEnabled</span><span class="p">)</span>

 <span class="vi">@location_manager</span> <span class="o">=</span> <span class="no">CLLocationManager</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1">#Play with other possible values: KCLLocationAccuracyBest, KCLLocationAccuracyHundredMeters, etc.</span>
  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">desiredAccuracy</span> <span class="o">=</span> <span class="no">KCLLocationAccuracyKilometer</span>

  <span class="c1">#Set the current view controller as the delegate of the Location Manager,</span>
  <span class="c1">#the location manager will notify of any changes in the location.</span>
  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">purpose</span> <span class="o">=</span> <span class="s2">&quot;To provide functionality based on user&#39;s current location&quot;</span>
  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">startUpdatingLocation</span>

<span class="k">else</span>

  <span class="n">showAlertWithTitle</span><span class="p">(</span><span class="s1">&#39;Location Error&#39;</span><span class="p">,</span> <span class="s1">&#39;Please enable the Location Services for this app in Settings.&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>First, we are checking if the user allow the device to use the location services. If not, we are showing an UIAlertView. Review the showAlertWithTitle method to learn how to present alerts in CocoaTouch.</p></div>
<div class="paragraph"><p>Then, we create our CLLocationManager. The first thing we set, is the <strong>desiredAccuracy</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@location_manager</span><span class="o">.</span><span class="n">desiredAccuracy</span> <span class="o">=</span> <span class="no">KCLLocationAccuracyKilometer</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>CLLocationManager</strong> supports a wide range of accuracies. This property specifies which method will be used to determine the current device location. By instance, an accuracy set to <strong>KCLLocationAccuracyBest</strong> will prompt iOS to use the GPS to determine the location and thus will spent more battery. Wheter an accuracy set to KCLLocationAccuracyKilometer will be more conservative in the use of the device&#8217;s resources.</p></div>
<div class="paragraph"><p>Remember that an iOS device can use up to 3 ways to determine its location:</p></div>
<div class="ulist"><ul>
<li>
<p>
GPS. For devices with that functionality such as iPhones or iPads with GSM/LTE.
</p>
</li>
<li>
<p>
Cell towers triangulation. For devices with GSM/LTE.
</p>
</li>
<li>
<p>
WiFi hotspots.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The accuracy goes from best to worse in that order. You should choose carefully the desired accuracy according to your app functionality. A <strong>KCLLocationAccuracyBest</strong> accuracy is best suited to navigation apps or running apps where you need the best possible value for the current location. On the other hand, an app such as the Cocoaheads apps can work with an accuracy of <strong>KCLLocationAccuracyKilometer</strong>. We only need to know if the user is close to the meeting venue.</p></div>
<div class="paragraph"><p>Next, we set the View Controller as a delegate to the location manager:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@location_manager</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
</pre></div></div></div>
<div class="paragraph"><p>Thus, the <strong>CLLocationManager</strong> instance will notifiy us when a change in the device&#8217;s location occurs.</p></div>
<div class="paragraph"><p>With the line</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@location_manager</span><span class="o">.</span><span class="n">purpose</span> <span class="o">=</span> <span class="s2">&quot;To provide functionality based on user&#39;s current location&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>We define the message that the device will show to the user when it ask permission to access the location data.</p></div>
<div class="paragraph"><p>And, finally with <strong>@location_manager.startUpdatingLocation</strong> we start the tracking for the device&#8217;s location.</p></div>
<div class="paragraph"><p>But, how are we going to be notified when the CLLocationManager determines the device&#8217;s current location? We need to implement some methods from the <strong>CLLocationManagerDelegate</strong> protocol. Write this methods in the View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#CLLocationManagerDelegate methods</span>

<span class="k">def</span> <span class="nf">locationManager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="ss">didUpdateToLocation</span><span class="p">:</span><span class="n">newLocation</span><span class="p">,</span> <span class="ss">fromLocation</span><span class="p">:</span><span class="n">oldLocation</span><span class="p">)</span>

  <span class="vi">@location_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Latitude:</span><span class="si">#{</span><span class="n">newLocation</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">latitude</span><span class="si">}</span><span class="s2"> Longitude:</span><span class="si">#{</span><span class="n">newLocation</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">longitude</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">locationManager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="ss">didFailWithError</span><span class="p">:</span><span class="n">error</span><span class="p">)</span>

  <span class="n">showAlertWithTitle</span><span class="p">(</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="ss">andMessage</span><span class="p">:</span><span class="n">error</span><span class="o">.</span><span class="n">description</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>CLLocationManager will invoke the method <strong>locationManager:didUpdateToLocation:fromLocation</strong> of its delegate when it can determine a change in the device&#8217;s location. In this case we are updating in a UILabel the coordinates of the device. The object for both newLocation and oldLocation arguments is <strong>CLLocation</strong>. This class gives you access to values such as latitude, longitude and some other variables like altitude and speed.</p></div>
<div class="paragraph"><p>If an error occurs, the second method <strong>locationManager:didFailWithError</strong> will be called.</p></div>
<div class="paragraph"><p>Run the example, and try changing the simulator location in the Debug menu using the Location option. There are some predifined locations and you can specify a custom one by entering its latitude and longitude:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_09_locationMenu.png" alt="Chapter 7 location menu" />
</span></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_03_location.png" alt="Chapter 7 location" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_creating_a_small_map">Creating a small Map</h3>
<div class="paragraph"><p>The next step is to add a small map just below the label where our location is being drawn. In CocoaTouch we use the <strong>MKMapView</strong> class to render maps. Locate the method named <strong>mapViewForEvent</strong> in the <strong>event_detail_view_controller.rb</strong> file. Copy this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mapViewForEvent</span>

  <span class="n">map_view_for_event</span> <span class="o">=</span> <span class="no">MKMapView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">25</span><span class="p">,</span><span class="mi">210</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">270</span><span class="p">,</span> <span class="mi">80</span><span class="o">]]</span> <span class="p">)</span>
  <span class="n">map_view_for_event</span><span class="o">.</span><span class="n">mapType</span> <span class="o">=</span> <span class="no">MKMapTypeStandard</span>
  <span class="n">map_view_for_event</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, there is nothing special about creating a <strong>MKMapView</strong> You just use the old <strong>initWithFrame</strong> initializer method. The second line, though, is more interesting. In that we specify the type of map we want to render. <strong>MKMapView</strong> supports three types of maps:</p></div>
<div class="ulist"><ul>
<li>
<p>
MKMapTypeStandard. Displays a street map that shows the position of all roads and some road names.
</p>
</li>
<li>
<p>
MKMapTypeSatellite. Displays satellite imagery of the area.
</p>
</li>
<li>
<p>
MKMapTypeHybrid. Displays a satellite image of the area with road and road name information layered on top.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Look at the <strong>viewDidLoad</strong> method of our <strong>event_detail_view_controller</strong> you will see that we are already calling the <strong>mapViewForEvent</strong> method and assigning the result in an instance variable:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@map_view_for_event</span> <span class="o">=</span> <span class="n">mapViewForEvent</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we need add the map view to the main view in the <strong>viewDidLoad</strong> method add this line:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@map_view_for_event</span> <span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app, you should see a small map view in the middle</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_04_smallmap.png" alt="Chapter 7 small map" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_creating_a_map_with_annotations">Creating a map with annotations</h3>
<div class="paragraph"><p>When you tap on the <strong>View Map</strong> button, currently is showing an empty view. We are going to fix this. Open the <strong>event_map_view_controller.rb</strong> file and locate the method called <strong>mapViewWithEventLocation</strong> That method should return a mapview with its type set to MKMapTypeStandard, just as the <strong>mapViewForEvent</strong> we implemented in the previous controller.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mapViewWithEventLocation</span>

  <span class="n">map_view_for_event</span> <span class="o">=</span> <span class="no">MKMapView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span> <span class="p">)</span>
  <span class="n">map_view_for_event</span><span class="o">.</span><span class="n">mapType</span> <span class="o">=</span> <span class="no">MKMapTypeStandard</span>
  <span class="n">map_view_for_event</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Once you have done that, add the view to the main view in the <strong>viewDidLoad</strong> adding the following line before inserting any other view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span>
  <span class="vi">@map_view_for_event</span> <span class="o">=</span> <span class="n">mapViewWithEventLocation</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@map_view_for_event</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">segmentedControlWithMapOptions</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonToCloseScreen</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example, you should see something like this:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_05_bigmap.png" alt="Chapter 7 big map" />
</span></p></div>
<div class="paragraph"><p>The next step is to show a Pin in the location of the next meeting and to center the map near that spot. First, we are going to center the map around the event location. You can see that this View Controller has an instance variable named <strong>event</strong> of type <strong>Event</strong>. This class has a location attribute, with the latitude and longitude of the venue. We are going to use that property to extract the location around the map will be centered.</p></div>
<div class="paragraph"><p><strong>MapKit</strong> uses a special structure called <strong>MKCoordinateRegion</strong> that has a <strong>CLLocationCoordinate2D</strong> - a structure which latitude and longitude values - and a <strong>MKCoordinateSpan</strong>, that represents the amount of map to display in the vertical and horizontal space. You can see this Span as the zoom that the map will have.</p></div>
<div class="paragraph"><p>Let&#8217;s create a method that returns our <strong>MKCoordinateRegion</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">regionForEventLocation</span>

  <span class="n">region</span> <span class="o">=</span> <span class="no">MKCoordinateRegionMake</span><span class="p">(</span><span class="vi">@event</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="no">MKCoordinateSpanMake</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="p">))</span>
  <span class="n">region</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are using the function MKCoordinateRegionMake, that takes 2 arguments: the <strong>CLLocationCoordinate2D</strong> that we retrieve from the <strong>@event</strong> variable and a <strong>MKCoordinateSpan</strong> that we are creating using another function: <strong>MKCoordinateSpanMake</strong> with the vertical and horizontal values.</p></div>
<div class="paragraph"><p>Now, add this region to the <strong>@map_view_for_event</strong> in the <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@map_view_for_event</span><span class="o">.</span><span class="n">setRegion</span><span class="p">(</span><span class="n">regionForEventLocation</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and you should see that the maps is centered and zoomed in around San José, California (the event has as its location the Apple HQ in Cupertino.):</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_06_mapregion.png" alt="Chapter 7 map region" />
</span></p></div>
<div class="paragraph"><p>Finally, we are going to add a Pin -Annotations in MapKit terms. in the venue location. To add an Annotation in Objective-C you must create a class that explicitly implements the MKAnnotation protocol. In RubyMotion you only need to create a class with the same methods defined in the protocol. These methods are:</p></div>
<div class="ulist"><ul>
<li>
<p>
coordinate. Returns a CLLocationCoordinate
</p>
</li>
<li>
<p>
title. NSString with the main title of the Annotation.
</p>
</li>
<li>
<p>
subtitle. Optional, returns an NSString with the subtitle of the annotation.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Open the file inside the <strong>models</strong> folder named <strong>event_annotation.rb</strong>. Copy this code inside:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EventAnnotation</span>

  <span class="k">def</span> <span class="nf">initWithCoordinate</span><span class="p">(</span> <span class="n">coordinate</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="n">title</span><span class="p">,</span> <span class="ss">andSubTitle</span><span class="p">:</span><span class="n">subtitle</span><span class="p">)</span>

    <span class="vi">@coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
    <span class="vi">@subtitle</span> <span class="o">=</span> <span class="n">subtitle</span>

    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">coordinate</span>

    <span class="vi">@coordinate</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">title</span>

    <span class="vi">@title</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">subtitle</span>

    <span class="vi">@subtitle</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are only defining an initializer method that receives the coordinate, the title and the subtitle and the methods defined in the <strong>MKAnnotation</strong> protocol. Now we are ready to add our annotation to the Map.</p></div>
<div class="paragraph"><p>Open the <strong>EventMapViewController</strong> class and add this method that creates an instance of our custom annotation:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">annotationForEvent</span>
  <span class="no">EventAnnotation</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCoordinate</span><span class="p">(</span><span class="vi">@event</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="vi">@event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">andSubTitle</span><span class="p">:</span><span class="vi">@event</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the <strong>viewDidLoad</strong> method, add the annotation to the map:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">annotation</span> <span class="o">=</span> <span class="n">annotationForEvent</span>
<span class="vi">@map_view_for_event</span><span class="o">.</span><span class="n">addAnnotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the example and you should see a red pin in the event&#8217;s location, if you tap on it you will see the title and subtitle displayed inside a callout:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_07_annotation.png" alt="Chapter 7 map annotation" />
</span></p></div>
<div class="paragraph"><p>If you see the annotation displayed correctly, you have finished this lab.</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_2">Challenge</h3>
<div class="paragraph"><p>As you can see in the app, we are displaying a toggle buttons to change the type of the map. If you are curious about how do you create such controls, review the <strong>segmentedControlWithMapOptions</strong> method. This control is called <strong>UISegmentedControl</strong> and you only need to specify the options that will have in order to create it. We are also defining a target-selector that will be notified when the user taps in a button. The selector is the method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">switch_map_type</span><span class="p">(</span><span class="n">segmented_control</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Your challenge is to implement the logic to change the map type. A tip that will help you: with <strong>segmented_control.selectedSegmentIndex</strong> you can access the current button selected index. Using this you&#8217;ll be able to determine which map type you should set to the <strong>@map_view_for_event.type</strong> variable.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch06-Delegate-ch07-MapKit/ch07_08_challenge.png" alt="Chapter 7 map challenge" />
</span></p></div>
</div>
</div>
</div>
<h1 id="_chapter_08_uiviews">Chapter 08 - UIViews</h1>
<div class="paragraph"><p>Our designer has came up with a better design for our first screen, the one we develop during Chapter 5. He thought that we could present the days left until the next meeting with a custom view representing a flip calendar rather than using a simple text label:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_01_app.png" alt="Chapter 8 final app" />
</span></p></div>
<div class="paragraph"><p>So we have deleted the old label with the days left, open the folder 08-UIViews/resources/code/Cocoaheads you will find our base project. Run it, you should see our old view without the days left information:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_02_starting_app.png" alt="Chapter 8 starting app" />
</span></p></div>
<div class="sect1">
<h2 id="_creating_a_custom_uiview">Creating a custom UIView</h2>
<div class="sectionbody">
<div class="paragraph"><p>When you face the challenge of creating a custom component such as this flip calendar, is often required to create a custom UIView. Custom UIViews give you complete control over the look and functionality of a UIView.</p></div>
<div class="paragraph"><p>To implement them, you begin creating a class that inherits from UIView. Create a new file named <strong>flipcount_view.rb</strong>. Inside this file, declare a new class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FlipCountView</span> <span class="o">&lt;</span> <span class="no">UIView</span>

  <span class="kp">attr_accessor</span> <span class="ss">:days_left</span>

  <span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Until now, we have only declared the class and one public attribute called <strong>days_left</strong>. We are also overwriting the <strong>initWithFrame:</strong> initializer. Remember that this method is used to create UIViews. We are just setting the background color of the UIView to white. Let&#8217;s test it. In the <strong>next_event_view_controller.rb</strong> file create this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewWithDaysLeft</span>
  <span class="n">days_left_view</span> <span class="o">=</span> <span class="no">FlipCountView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">120</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">68</span><span class="p">,</span> <span class="mi">74</span><span class="o">]]</span> <span class="p">)</span>
  <span class="n">days_left_view</span><span class="o">.</span><span class="n">days_left</span> <span class="o">=</span> <span class="vi">@days_left</span>
  <span class="n">days_left_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating a FlipCountView with a frame that places it to the left of the event&#8217;s name label. Now add it to your view in the <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="k">def</span> <span class="nf">viewDidLoad</span>
  <span class="k">super</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@next_event_name_label</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignIn</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignUp</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonToChangeDaysLeft</span> <span class="p">)</span>
  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">EVENT_NAME_TEXT</span>

<span class="hll">  <span class="vi">@days_left_view</span> <span class="o">=</span> <span class="n">viewWithDaysLeft</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@days_left_view</span> <span class="p">)</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember that always that you add a UIView to an instance variable, you must set it to <strong>nil</strong> in the <strong>viewDidUnload</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidUnload</span>

  <span class="k">super</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@days_left_view</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now test the application. You will see a white rectangle:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_03_rectangle.png" alt="Chapter 8 rectangle" />
</span></p></div>
<div class="sect2">
<h3 id="_drawing_text">Drawing text</h3>
<div class="paragraph"><p>Now, we have to add the text for the <strong>@days_left</strong> attribute. We have seen that we can use a <strong>UILabel</strong> to render text on the screen. However, we are going to see a different low-level approach: to draw the text inside the view.</p></div>
<div class="paragraph"><p>Every <strong>UIView</strong> knows how to draw itself in the screen. If you want to implement your custom drawing logic, you should override the method <strong>drawRect:</strong> It is very important that you handle this method very carefully. This method is called directly by iOS every time that the screen needs to be rendered: the first time it is displayed or when part of the view is invalidated. So it is not recommended to do some heavy computations inside the method, that will reduce the performance of your app.</p></div>
<div class="paragraph"><p>Lets implement the <strong>drawRect:</strong> method that draws the days left:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">drawDaysLeftInRect</span> <span class="n">rect</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">drawDaysLeftInRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">big_font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Bold&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">48</span><span class="p">)</span>
  <span class="vi">@days_left</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">drawAtPoint</span><span class="p">(</span><span class="o">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span> <span class="o">]</span><span class="p">,</span> <span class="ss">withFont</span><span class="p">:</span><span class="n">big_font</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Inside the <strong>drawDaysLeftInRect:</strong> method we are creating a UIFont and then we are rendering directly the days_left. This attribute is an <strong>Integer</strong>, thus we need to converting to <strong>String</strong> with <strong>to_s</strong>. In RubyMotion traditional <strong>String</strong> class of Ruby inherits from <strong>NSMutableString</strong> that is why we could use the method <strong>drawAtPoint</strong>. This method is actually rendering the String inside the view at the given point using the font passed as an argument.</p></div>
<div class="paragraph"><p>Run the example and you should see the "0" rendered inside the custom view:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_04_zero.png" alt="Chapter 8 drawn label" />
</span></p></div>
<div class="paragraph"><p>Now we are going to render the legend  "days left" at the bottom. In order to this we are going to calculate the Y coordinate using the <strong>rect</strong> of the view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawDaysLeftLegendInRect</span><span class="p">(</span> <span class="n">rect</span> <span class="p">)</span>

  <span class="n">small_font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
  <span class="s2">&quot;days left&quot;</span><span class="o">.</span><span class="n">drawAtPoint</span><span class="p">(</span><span class="o">[</span><span class="mi">11</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">]</span><span class="p">,</span> <span class="ss">withFont</span><span class="p">:</span><span class="n">small_font</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember to call this method from the <strong>drawRect:</strong> one:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">drawDaysLeftInRect</span> <span class="n">rect</span>
  <span class="n">drawDaysLeftLegendInRect</span> <span class="n">rect</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the example and you sould see the legend rendered at the bottom:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_05_legend.png" alt="Chapter 8 drawn legend" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_drawing_images">Drawing images</h3>
<div class="paragraph"><p>Our designer has created a background image to use in our view. The image is called <strong>flipDateImage.png</strong> We have seen that we could insert a UIImageView into our view to render images. But, this time we are going to use a low-level approach: we are going to render the image directly in our <strong>drawRect:</strong> method.</p></div>
<div class="paragraph"><p>Create this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawBackgroundImageInRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span> <span class="s2">&quot;flipDateImage&quot;</span> <span class="p">)</span>
  <span class="n">backgroundImage</span><span class="o">.</span><span class="n">drawInRect</span><span class="p">(</span> <span class="n">rect</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, a UIImage also knows how to render itself using the <strong>drawInRect:</strong> method. In this case, we want the image to be drawn in the full view, that is why we are passing the whole <strong>rect</strong> as a parameter.</p></div>
<div class="paragraph"><p>Now, invoke this method from inside the <strong>drawRect:</strong> method. You should render the image before drawing the texts, otherwise the image will be drawn covering the texts:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">drawBackgroundImageInRect</span> <span class="n">rect</span>
  <span class="n">drawDaysLeftLegendInRect</span> <span class="n">rect</span>
  <span class="n">drawDaysLeftInRect</span> <span class="n">rect</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, let&#8217;s change the view color to <strong>clearColor</strong> so the image will be the only thing acting as a background.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app and you should see the image rendered in the background of the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_06_image.png" alt="Chapter 8 drawn image" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_invalidating_a_view">Invalidating a view</h3>
<div class="paragraph"><p>As you can see, we have a <strong>UIButton</strong> with the title "Increase days left". We want to use it to test our custom view by changing the days left attribute. Open the <strong>NextEventViewController</strong> file and locate the method named <strong>change_days_left</strong> and implement the logic to increase the <strong>@days_left</strong> property and update it in our custom view instance:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">change_days_left</span>

  <span class="vi">@days_left</span> <span class="o">=</span> <span class="vi">@days_left</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="vi">@days_left_view</span><span class="o">.</span><span class="n">days_left</span> <span class="o">=</span> <span class="vi">@days_left</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are increasing the value of the variable by 1, and then we are updating that value in our custom view instance. It seems right, isn&#8217;t it? Run the example and tap the "Increase days left" button.</p></div>
<div class="paragraph"><p>Nothing happens. Why? because our custom <strong>UIView</strong> only renders the days left in its <strong>drawRect:</strong> method. This method is called by CocoaTouch when the view is first rendered (in this case, when we add it to our main view) and when the view is invalidated so it has to be rendered again. In this case, neither of those scenarios happens. So the view is never updated with the new value. You may feel tempted to just call the <strong>drawRect:</strong> method directly, but that is something you should never do. CocoaTouch is responsible of calling that method in the appropiate moment. Instead of that, we need to invalidate the view and CocoaTouch will call the <strong>drawRect:</strong> method in the next drawing cycle. So just add this line at the end of the <strong>change_days_left</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">change_days_left</span>
  <span class="vi">@days_left</span> <span class="o">=</span> <span class="vi">@days_left</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="vi">@days_left_view</span><span class="o">.</span><span class="n">days_left</span> <span class="o">=</span> <span class="vi">@days_left</span>
<span class="hll">  <span class="vi">@days_left_view</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>setNeedsDisplay</strong> is the method of <strong>UIView</strong> to mark that it needs to be redrawn. CocoaTouch will call the <strong>drawRect:</strong> and that method will draw the days left with the updated value:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_07_needdisplay.png" alt="Chapter 8 need display" />
</span></p></div>
<div class="paragraph"><p>If you see the view being updated when you tap on the button, you have finished this lab.</p></div>
</div>
</div>
</div>
<h1 id="_chapter_09_testing">Chapter 09 - Testing</h1>
<div class="paragraph"><p>Testing is a fundamental part of any application, and it is also a hard task for developers. However, RubyMotion provides us with one tool that will ease the task of testing our apps: <strong>MacBacon</strong>, a special flavour of the Ruby tool <strong>Bacon</strong> prepared to test iOS apps.</p></div>
<div class="paragraph"><p>In this chapter we will add automated tests for the Cocoaheads app. You will learn how to test isolated logic and how to automate UI tests.</p></div>
<div class="sect1">
<h2 id="_app_setup">App Setup</h2>
<div class="sectionbody">
<div class="paragraph"><p>Before we begin testing our app, we actually need an app. Open the folder 09-Testing/resources/code. We have placed a version of the CocoaHeads app ready to be tested.. Run the app with the command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>As you can see, is the same app that we did during Chapter 7:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_01_app.png" alt="Chapter 7 app" />
</div>
<div class="title">Figure 13. Chapter 7 app</div>
</div>
<div class="paragraph"><p>We have added an extra functionality to the app, if you tap the <strong>Book Event</strong> button the title of the button changes to <strong>Event Booked</strong> and is disabled:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_02_book_event.png" alt="Book Event" />
</div>
<div class="title">Figure 14. Book Event</div>
</div>
<div class="paragraph"><p>Besides that, we have added a method to the <strong>event.rb</strong> model class. Open that file and locate the method called <strong>days_left_until:</strong> that gives you the number of days until a future date. If the date is not a future date but is in the past, it will return a 0. This method will be used to paint the correct days left in our Custom View we did in the previous workshop.</p></div>
<div class="paragraph"><p>You can check how we are calculating the number of days between two dates in the <strong>days_between:and:</strong> method. We are using the <strong>NSDateComponents</strong> class. That class is the one we used in CocoaTouch to make <strong>NSDate</strong> operations. Remember that the traditional Ruby class <strong>Time</strong> inherits from NSDate so we can use it in its place.</p></div>
<div class="sect2">
<h3 id="_functional_testing">Functional Testing</h3>
<div class="paragraph"><p>The first thing we are going to test is the <strong>days_left_until:</strong> method. We want to be sure that it works in these three cases:</p></div>
<div class="ulist"><ul>
<li>
<p>
When given a future date, it calculates accurately the number of days until that date.
</p>
</li>
<li>
<p>
When given the current date, it returns a 0.
</p>
</li>
<li>
<p>
When given a past date, it returns a 0 (we don&#8217;t want negative numbers in our view).
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first step is to create a <strong>Spec</strong> for our <strong>Event</strong> class. In the Cocoaheads folder, create a folder named <strong>spec</strong>. It should be placed at the same level of the <strong>app</strong> folder. Open it and create a folder named <strong>models</strong> and inside a file named <strong>event_spec.rb</strong></p></div>
<div class="paragraph"><p>To define the Spec, write this lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Event&quot;</span> <span class="k">do</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>"Event"</strong> is the class that you want to test. Next, we&#8217;ll create some constants of the values we are going to use for our tests and to initialize our <strong>Event</strong> instance:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">DAYS_LEFT</span> <span class="o">=</span> <span class="mi">10</span>

<span class="no">NEGATIVE_PAST_DAYS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

<span class="n">before</span> <span class="k">do</span>

  <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">mock_event</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are creating a mock <strong>Event</strong> using a class method. This <strong>before</strong> block, is executed before any test, and is helpful to initialize values required by your tests.</p></div>
<div class="paragraph"><p>Let&#8217;s write our first test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should count days left until future date&quot;</span> <span class="k">do</span>

  <span class="n">future_date</span> <span class="o">=</span> <span class="n">date_adding_days</span><span class="p">(</span> <span class="no">DAYS_LEFT</span> <span class="p">)</span>
  <span class="n">days_left_until_future_date</span> <span class="o">=</span> <span class="vi">@event</span><span class="o">.</span><span class="n">days_left_until</span><span class="p">(</span> <span class="n">future_date</span> <span class="p">)</span>
  <span class="n">days_left_until_future_date</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="no">DAYS_LEFT</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">date_adding_days</span><span class="p">(</span> <span class="n">days_to_add</span> <span class="p">)</span>

  <span class="n">components</span> <span class="o">=</span> <span class="no">NSDateComponents</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">components</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">days_to_add</span>
  <span class="n">gregorian</span> <span class="o">=</span> <span class="no">NSCalendar</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCalendarIdentifier</span><span class="p">(</span> <span class="no">NSGregorianCalendar</span> <span class="p">)</span>
  <span class="n">gregorian</span><span class="o">.</span><span class="n">dateByAddingComponents</span><span class="p">(</span> <span class="n">components</span><span class="p">,</span> <span class="ss">toDate</span><span class="p">:</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="mi">0</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>With the <strong>it</strong> block, we define specs that our classes should comply with. The string should represent in a written and descriptive form the spec. In the spec, we are creating a date 10 days in the future using our helper method <strong>date_adding_days:</strong>.</p></div>
<div class="paragraph"><p>We pass that date to our model class and evaluate the returned result with <strong>should.equal</strong> MacBacon adds <strong>should</strong> and <strong>equals</strong> methods. You have several more that you can use to evaluate results inside your specs. If the evaluation is not satisfactory, the test will fail.</p></div>
<div class="paragraph"><p>Now run the spec with the command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake spec
</pre></div></div></div>
<div class="paragraph"><p>You should see the output with the specifications passed:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> Event
  -should count days left <span class="k">until </span>future date

  1 specifications <span class="o">(</span>1 requirements<span class="o">)</span>, 0 failures, 0 errors
</pre></div></div></div>
<div class="paragraph"><p>Try to change the expected value in the <strong>should.equal</strong> evaluation to see how MacBacon displays an error message when the spec is broken.</p></div>
<div class="paragraph"><p>Let&#8217;s cover another functional requirement, when the date passed as an argument to the method <strong>days_left_until:</strong> is in the past, we don&#8217;t want to display a negative number but a zero instead:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should count days left as 0 for past date&quot;</span> <span class="k">do</span>

  <span class="n">past_date</span> <span class="o">=</span> <span class="n">date_adding_days</span><span class="p">(</span> <span class="no">NEGATIVE_PAST_DAYS</span> <span class="p">)</span>
  <span class="n">days_left_until_past_date</span> <span class="o">=</span> <span class="vi">@event</span><span class="o">.</span><span class="n">days_left_until</span><span class="p">(</span> <span class="n">past_date</span> <span class="p">)</span>
  <span class="n">days_left_until_past_date</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example.</p></div>
</div>
<div class="sect2">
<h3 id="_testing_our_ui">Testing our UI</h3>
<div class="paragraph"><p>One of the main problems while developing apps, is to test its UI. It&#8217;s hard to test the UI of an iOS application programmatically, even when some tools exists, they are difficult to use. RubyMotion has added support to MacBacon to write specs for visual elements with the same simplicity of our functional tests. Let&#8217;s try this feature.</p></div>
<div class="paragraph"><p>Create a file in the folder <strong>specs/controllers</strong> named <strong>event_detail_view_controller_spec.rb</strong> and add this code to create our spec:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;The Event Details view controller&quot;</span> <span class="k">do</span>

  <span class="n">tests</span> <span class="no">EventDetailViewController</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are specifiyng the class we are going to test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">tests</span> <span class="no">EventDetailViewController</span>
</pre></div></div></div>
<div class="paragraph"><p>MacBacon will instantiate our <strong>EventDetailViewController</strong> and will add it to a <strong>UIWindow</strong>, to display it. MacBacon will take care of initializing our app and creating the appropiate objects needed it to display the View of our View Controller. Thus, we need to let MacBacon to handle this for us. If you remember, we normally create our <strong>UIWindow</strong> and its <strong>rootView</strong> in the <strong>AppDelegate</strong>. Open it and add this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

    <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="no">RUBYMOTION_ENV</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span>
    <span class="n">event_detail_view_controller</span> <span class="o">=</span> <span class="no">EventDetailViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">event_detail_view_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating our own <strong>UIWindow</strong> only if we are not testing the app, in that case MacBacon will handle that.</p></div>
<div class="paragraph"><p>So, what do we want to test? The <strong>Book Event</strong> button. Our first step is to actually verify that the button exists, open the <strong>event_detail_view_controller_spec.rb</strong> file and write the following spec:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;has book button&quot;</span> <span class="k">do</span>

  <span class="n">view</span><span class="p">(</span><span class="s1">&#39;Book Event&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">equal</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The <strong>view</strong> method allows us to select views with a given title. In this case we are selecting the <strong>UIButton</strong> with the "Book Event" title, and testing that is not nil. Run the example, verifiy that the <strong>EventDetailsViewController</strong> is briefly shown in the simulator and that the spec is succesfully satisfied:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> The Event Details view controller
  - has book button

 Event
  - should count days left <span class="k">until </span>future date
  - should count days left as 0 <span class="k">for </span>past date

3 specifications <span class="o">(</span>3 requirements<span class="o">)</span>, 0 failures, 0 errors
</pre></div></div></div>
<div class="paragraph"><p>The next step is to test if when you tap on the button, its state changes to disabled and its title to "Event Booked". You will see that the idiom of MacBacon allows us to write such a test very easilly:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;book event&quot;</span> <span class="k">do</span>

  <span class="n">button_to_evaluate</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="s1">&#39;Book Event&#39;</span><span class="p">)</span>
  <span class="n">tap</span> <span class="s1">&#39;Book Event&#39;</span>
  <span class="c1">#wait for 2 seconds</span>
  <span class="n">proper_wait</span> <span class="mi">2</span>
  <span class="n">button_to_evaluate</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="s2">&quot;Event Booked&quot;</span>
  <span class="n">button_to_evaluate</span><span class="o">.</span><span class="n">isEnabled</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are using the method <strong>tap</strong> to tap our button. MacBacon has methods to apply all the standard CocoaTouch gestures to UIViews, such as pinch, zoom, drag, etc. You can review how to use each of them in the <a href="http://www.rubymotion.com/developer-center/articles/testing/#_view_events">online documentation.</a> Then we evaluate the title and the <strong>isEnabled</strong> property to check if the state of the <strong>UIButton</strong> changed.</p></div>
<div class="paragraph"><p>Run your example and this time, because of the 2 seconds wait, you should see how the title changed in the button. You may be prompted to allow the Location services in this app the first time you run the test, in that case, select "Accept" and then run it again.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_05_ui_running.png" alt="UI spec passed" />
</div>
<div class="title">Figure 15. UI Spec Passed</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenge_3">Challenge</h3>
<div class="ulist"><ul>
<li>
<p>
We have created specs for the <strong>days_left_until</strong> method of the class <strong>Event</strong>. But we are currently missing one test, write the spec to test that when you pass the current date to that method, it should return a "0".
</p>
</li>
</ul></div>
</div>
</div>
</div>
<h1 id="_chapter_10_interface_builder">Chapter 10 - Interface Builder</h1>
<div class="paragraph"><p>In this workshop, you are going to learn how to use the Interface Builder, the tool to build User Interfaces without coding them from Apple. This tool is integrated in Xcode, the IDE used to build iOS apps using Objective-C. However, you can use it in your RubyMotion projects.</p></div>
<div class="paragraph"><p>In the previous chapters we have been programmatically creating our views, suchs as buttons or even maps. The Interface Builder will allow us to separate the task of building visual components to specialized files called <strong>nib</strong> files.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_app">Setting up the app</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open the folder <strong>ch10-InterfaceBuilder/resources/code/Cocoaheads</strong>. Inside it is the Cocoaheads app. Run the app using the <strong>rake</strong> command. You will notice that displays our old Next EventView:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_01_app.png" alt="Chapter 10 app" />
</span></p></div>
<div class="paragraph"><p>We want to implement the Sign in and the Sign up views, but this time will use the Interface Builder to help us.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_our_xcode_project">Setting up our Xcode project</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Interface Builder is integrated into Xcode, the IDE for building iOS projects using Objective-C. Although is technically possible to just create a <strong>Nib</strong> file without a project, is easier to create it inside a project. And having your Nib files integrated into one project is helpful to keep them organized.</p></div>
<div class="paragraph"><p>If you don&#8217;t have Xcode installed, download it from the Mac App Store. Open it and you&#8217;ll be prompted to create a new project. Choose in the side menu iOS &gt; Application and the Single View Application template:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_02_xcode_project.png" alt="Chapter 10 xcode project" />
</span></p></div>
<div class="paragraph"><p>Next, enter this data in the project creation wizard. Notice that we are unselecting the <strong>Use Storyboards</strong> option.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_03_xcode_options.png" alt="Chapter 10 xcode options" />
</span></p></div>
<div class="paragraph"><p>Save the project in the same folder where the Cocoaheads Rubymotion project is located.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_sign_in_view">Creating the Sign In View</h2>
<div class="sectionbody">
<div class="paragraph"><p>You will see that Xcode have created an <strong>Xib</strong> file called <strong>RBMViewController.xib</strong></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_04_project_files.png" alt="Chapter 10 xcode files" />
</span></p></div>
<div class="paragraph"><p>Open it, Xcode opens this kind of files in the Interface Builder Editor.</p></div>
<div class="paragraph"><p>In the right side panel we have two main sections:</p></div>
<div class="ulist"><ul>
<li>
<p>
Placeholders
</p>
</li>
<li>
<p>
Objects
</p>
</li>
</ul></div>
<div class="paragraph"><p>In the center panel, we have our view. In the right side panel we have two main sections:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Inspectors</strong> We use them to modify the attributes of the view selected in the left panel&#8217;s sections.
</p>
</li>
<li>
<p>
<strong>Libraries</strong>. We use them to select CocoaTouch components, Objects, etc. and drag them into our view.
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_05_xcode.png" alt="Chapter 10 xcode" />
</span></p></div>
<div class="paragraph"><p>The Interface Builder can link the objects that we create in the <strong>Xib</strong> file to other objects in our app. In the Placeholder section, select the <strong>File&#8217;s Owner</strong> object. and in the Inspectors select the <strong>Identity</strong> inspector (the third tab):</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_06_identity.png" alt="Chapter 10 identity" />
</span></p></div>
<div class="paragraph"><p>You will notice that this object is a <strong>RBMViewController</strong> a UIViewController subclass that Xcode has created for us. You already know that a UIViewController needs to create its own view, we&#8217;ve been doing this task in the <strong>loadView</strong> method. When you use InterfaceBuilder the view is created inside the Xib file and you link it to the <strong>File&#8217;s owner</strong> that should be a UIViewController.</p></div>
<div class="paragraph"><p>Because this <strong>Xib</strong> was created by the Xcode template, it already has this link defined. Ctrl + click in the File&#8217;s Owner object and you will see the its list of <strong>Outlets</strong></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_07_outlets.png" alt="Chapter 10 outlets" />
</span></p></div>
<div class="paragraph"><p>The outlets are the variables of an object that can be bound to a component created in the Interface Builder. Select the one named <strong>view</strong> and you will see that the UIView is highligthed. The UIViewController has bound its <strong>view</strong> variable to the UIView created in the Editor.</p></div>
<div class="paragraph"><p>Let&#8217;s start creating our Sign-in view. First, we are going to modify the size of the UIView. Select the View in the <strong>Objects</strong> panel. Now in the <strong>Inspectors</strong> panel select the <strong>Attributes</strong> inspector: the fourth tab. You will notice that Xcode set the size for the iPhone 5&#8217;s 4" screen. Change it to a standard 3.5":</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_08_view_size.png" alt="Chapter 10 view size" />
</span></p></div>
<div class="paragraph"><p>Now choose the first tab, the <strong>Identity</strong> tab and unselect the <strong>Use AutoLayout</strong> option. AutoLayouts is a new feature in iOS6 that helps you to build Interfaces that adapt themselves to different screen sizes. We&#8217;ll cover that topic in the Chapter 16.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_09_autolayout.png" alt="Chapter 10 autolayout" />
</span></p></div>
<div class="paragraph"><p>Lets start creating our view. As you may recall, the views of our Cocoaheads app have a header image with a Cocoa-like texture and below a red gradient background image. We are going to start by creating these objects.</p></div>
<div class="paragraph"><p>In the right panel, go to the bottom panel and select the <strong>Objects</strong> tab, the third one:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_10_objects_panel.png" alt="Chapter 10 objects panel" />
</span></p></div>
<div class="paragraph"><p>In the search field type <strong>UIImageView</strong>, the objects will be filtered according to that criteria and only a UIImageView object will appear:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_11_imageview.png" alt="Chapter 10 image view filter" />
</span></p></div>
<div class="paragraph"><p>Drag the object to your view. The next step is to resize the background, this is going to be our header image. You can adjust the size with your mouse or you can use the <strong>Size</strong> Inspector. Select your UIImageView and in the right panel, in the top panel (<strong>Inspectors</strong>) panel, select the <strong>Size</strong> tab (the fifth one). You will see that you can enter the Frame data in this tab. Enter this values: x:0, y:0, width:320, height:64:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_12_imageview_frame.png" alt="Chapter 10 image view frame" />
</span></p></div>
<div class="paragraph"><p>The next step is to create below this header image our background image. Drag another UIImageView. Set its frame to: x:0, y:64, width:320, height:396.</p></div>
<div class="paragraph"><p>Now, we are going to create our UIControls. Let&#8217;s start with the TextFields. Drag a UITextField from the <strong>Objects</strong> panel into your view.</p></div>
<div class="paragraph"><p>Select the <strong>Attributes</strong> inspector (the fourth tab in the Inspectors panel) and enter <strong>email</strong> in the placeholder attribute. In the Border Style select the first option (No border) and in the Keyboard attribute select <strong>Email</strong>. This option will show a keyboard customized for entering email addresses:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_13_textfield_attributes.png" alt="Chapter 10 text field attributes" />
</span></p></div>
<div class="paragraph"><p>Next, adjust the size and location of the textfield using your mouse. Another option is to select the  Text Field and in the <strong>Inspector</strong> section, in the Fifth tab (<strong>Size</strong>) you can type the absolute values for its Frame. For this field we&#8217;ll enter x: 20, y: 130, width 289 and height 44. Don&#8217;t worry if the Textfield is almost invisible, we&#8217;ll add a background image programmatically later.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_14_textfield_frame.png" alt="Chapter 10 text field attributes" />
</span></p></div>
<div class="paragraph"><p>Add another Textfield In the <strong>Attributes</strong> tab enter <strong>password</strong> as its placeholder, with no border  and in the bottom select the <strong>Secure</strong> option.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_15_password_attributes.png" alt="Chapter 10 password field attributes" />
</span></p></div>
<div class="paragraph"><p>In the <strong>Size</strong> inspector set its frame to x:20, y:190, width:289 and height:44.</p></div>
<div class="paragraph"><p>Now, we are going to add two buttons: one to close the Sign in view and other to sign in. In the <strong>Objects</strong> section type Round Rect Button and drag a UIButton to the View.</p></div>
<div class="paragraph"><p>In the <strong>Attributes</strong> inspector:</p></div>
<div class="ulist"><ul>
<li>
<p>
Change its type to <strong>Custom</strong>
</p>
</li>
<li>
<p>
In the title delete <strong>Button</strong> and leave it blank.
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_16_button_attributes.png" alt="Chapter 10 button attributes" />
</span></p></div>
<div class="paragraph"><p>Now, set the frame of the object in the <strong>Size</strong> inspector to x:14, y:10, width:56, height:41.</p></div>
<div class="paragraph"><p>The next step is to add our Sign In button. Drag another Round Rect Button into the View. In the <strong>Attributes</strong> Inspector set its properties to:</p></div>
<div class="ulist"><ul>
<li>
<p>
Type: Custom
</p>
</li>
<li>
<p>
Title: SignIn
</p>
</li>
<li>
<p>
Font: Helvetica Neue Medium 18
</p>
</li>
<li>
<p>
TextColor: White
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_17_button_font.png" alt="Chapter 10 button font" />
</span></p></div>
<div class="paragraph"><p>The frame of the button should be x:25, y:396 and the size should have width:270, height:44. Your UIView should look like this:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_18_view_design.png" alt="Chapter 10 view design" />
</span></p></div>
<div class="sect2">
<h3 id="_wiring_our_uiview_to_a_view_controller">Wiring our UIView to a View Controller</h3>
<div class="paragraph"><p>Once we have created our view, we should wire it to our View Controller. The easiest way to do this is to use its <strong>Tag</strong> attribute. <strong>Tag</strong> is an integer property of <strong>UIView</strong> that you can use to identify your views. Basically, you have to set a unique integer for each UIView you need to access from your UIViewController. We are going to start with the Header Image View.</p></div>
<div class="paragraph"><p>Select the UIImageView in the <strong>Objects</strong> section and in the Inspectors select the <strong>Attributes</strong> inspector (the 4th tab). Set its Tag property to 1:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_19_tag.png" alt="Chapter 10 tag attribute" />
</span></p></div>
<div class="paragraph"><p>Do the same for all the other objects using these numbers as its tags:</p></div>
<div class="ulist"><ul>
<li>
<p>
Background Image View: 2
</p>
</li>
<li>
<p>
Close button: 3
</p>
</li>
<li>
<p>
Email textfield: 4
</p>
</li>
<li>
<p>
Password textfield: 5
</p>
</li>
<li>
<p>
SignIn button: 6
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now we are ready to import our Xib file into our RubyMotion project.</p></div>
<div class="paragraph"><p>Open in <strong>Finder</strong> the folder of the Xcode Project and locate the <strong>RBMViewController.xib</strong> (hint: it&#8217;s inside a folder named en.lproj) copy it into the <strong>resources</strong> folder of your RubyMotion project.</p></div>
<div class="paragraph"><p>Run</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>rake
</pre></div></div></div>
<div class="paragraph"><p>and you should notice that it compiles the <strong>Xib</strong> file into a <strong>Nib</strong> file.</p></div>
<div class="paragraph"><p>Now let&#8217;s create our Sign In View Controller. Create a file called <strong>sign_in_viewcontroller.rb</strong> in the app/controllers folder. Copy this code</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SignInViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">HEADER_IMAGE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="no">BACKGROUND_IMAGE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="no">CLOSE_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="no">EMAIL_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="no">PASSWORD_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="no">SIGN_IN_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">6</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are declaring our UIViewController subclass and initializing some constants with the tags that we assigned in Interface Builder, we&#8217;ll use them to wire our variables to those components.</p></div>
<div class="paragraph"><p>Now we are going to add the code to setup our views:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="n">setupHeaderImageView</span>
  <span class="n">setupBackgroundImageView</span>
  <span class="n">setupEmailTextField</span>
  <span class="n">setupPasswordTextField</span>
  <span class="n">setupCloseButton</span>
  <span class="n">setupSignInButton</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupHeaderImageView</span>

  <span class="n">header_image_view</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">HEADER_IMAGE_VIEW_TAG</span><span class="p">)</span>
  <span class="n">header_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTitleBar&#39;</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupBackgroundImageView</span>

  <span class="n">background_image_view</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">BACKGROUND_IMAGE_VIEW_TAG</span><span class="p">)</span>
  <span class="n">background_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgApp&#39;</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupEmailTextField</span>

  <span class="vi">@email_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">EMAIL_TEXTFIELD_TAG</span><span class="p">)</span>
  <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTextField&#39;</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupPasswordTextField</span>

  <span class="vi">@password_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">PASSWORD_TEXTFIELD_TAG</span><span class="p">)</span>
  <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTextField&#39;</span><span class="p">)</span>
  <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupCloseButton</span>

  <span class="vi">@close_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CLOSE_BUTTON_TAG</span><span class="p">)</span>
  <span class="vi">@close_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnCancel&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="vi">@close_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupSignInButton</span>

  <span class="vi">@sign_in_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">SIGN_IN_BUTTON_TAG</span><span class="p">)</span>
  <span class="vi">@sign_in_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_in&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="vi">@sign_in_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnBrown&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The first thing you should notice is that we are using the method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">EMAIL_TEXTFIELD_TAG</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>To retrieve a subview from self.view based on its tag. Next, we are doing some additional setup. For instance, we are setting the background image to our image view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">background_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgApp&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And assigning the Target-Selector to our Buttons:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@close_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Practically, we have removed all the code related to creating the views and setting their frames.</p></div>
<div class="paragraph"><p>Let&#8217;s try it. Before we could run the example we have to create our new view controller in the <strong>next_event_view_controller.rb</strong>. Open it and locate the method <strong>sign_in</strong> , add this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>

    <span class="n">signin_controller</span> <span class="o">=</span> <span class="no">SignInViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithNibName</span><span class="p">(</span><span class="s2">&quot;RBMViewController&quot;</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
    <span class="n">presentModalViewController</span><span class="p">(</span><span class="n">signin_controller</span><span class="p">,</span> <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating the View Controller with an initializer called <strong>initWithNibName:bundle</strong> that receives as a parameter the new of the Nib file that has the view of the View Controller. This initializer has the responsibility of instantiate the Nib file and wire the View declared there to the view property of the View Controller. Exactly what we used to do by hand in the <strong>loadView</strong> method.</p></div>
<div class="paragraph"><p>The <strong>presentModalViewController</strong> method shows the view of the controller passed as an argument, as a modal view with an animation appearing from the bottom to the top of the screen.</p></div>
<div class="paragraph"><p>Run the app and tap in the <strong>Sign in</strong> button.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_20_signin.png" alt="Chapter 10 tag sign in screen" />
</span></p></div>
<div class="paragraph"><p>Now let&#8217;s implement the logic for the close and sign in methods in the <strong>sign_in_view_controller.rb</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span>

  <span class="k">if</span> <span class="n">isFormValid</span>

    <span class="n">close</span>
  <span class="k">else</span>

    <span class="n">showAlert</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="s2">&quot;Please, fill all the fields.&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">close</span>

  <span class="n">dismissModalViewControllerAnimated</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">isFormValid</span>

  <span class="ow">not</span> <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">and</span> <span class="ow">not</span> <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">showAlert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="n">title</span><span class="p">)</span>

  <span class="n">alert</span> <span class="o">=</span> <span class="no">UIAlertView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span>
                      <span class="ss">message</span><span class="p">:</span><span class="n">message</span><span class="p">,</span>
                      <span class="ss">delegate</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span>
                      <span class="ss">cancelButtonTitle</span><span class="p">:</span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
                      <span class="ss">otherButtonTitles</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">alert</span><span class="o">.</span><span class="n">show</span>
<span class="k">end</span>


<span class="c1">#uitextfield delegate methods</span>
<span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textField</span><span class="p">)</span>

  <span class="n">textField</span><span class="o">.</span><span class="n">resignFirstResponder</span>
  <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the close method we are calling the method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="ss">dismissModalViewControllerAnimated</span><span class="p">:</span>
</pre></div></div></div>
<div class="paragraph"><p>This method is used to close modal views, such as this sign in view.</p></div>
<div class="paragraph"><p>For the sign in, we are validating that the user input some data in both text fields using the <strong>isFormValid</strong> method.</p></div>
<div class="paragraph"><p>Another interesting method is <strong>textFieldShouldReturn:</strong> Before we explain what it does, run the example. Type an email and a password. As you can see, the keyboard is hiding the "Sign In" Button:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_21_keyboard.png" alt="Chapter 10 keyboard" />
</span></p></div>
<div class="paragraph"><p>When you press the <strong>Return</strong> button in the keyboard, the keyboard is hidden. That&#8217;s the work of the <strong>textFieldShouldReturn</strong> method. This method is called by the TextField when the user taps on the <strong>Return</strong> button. Inside we are sending the message <strong>resignFirstResponder</strong> to the text field. That message is the one that quits the focus from the text field hidding the keyboard. Without this method, the <strong>Sign in</strong> button could never be tapped.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_sign_up_view">Creating the Sign Up View</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now let&#8217;s create our SignUp View. Go back to the Xcode project. Select in the Main Menu: File &#8594; New &#8594; File. In the Template Dialog, choose iOS User Interface in the left panel and View in the Main Panel:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_22_new_file_dialog.png" alt="Chapter 10 new file dialog" />
</span></p></div>
<div class="paragraph"><p>Type <strong>SignUpView.xib</strong> as the file name. In the Interface Builder, change the Size of the View in the <strong>Attributes</strong> Inspector tab to
<strong>Retina 3.5 Full Screen</strong> and in the <strong>File</strong> Inspector unselect the <strong>Use AutoLayout</strong> option.</p></div>
<div class="ulist"><ul>
<li>
<p>
Add an UIImageView for the header with a <strong>tag</strong> of 1 and a frame of x:0, y:0, width:320, height:64
</p>
</li>
<li>
<p>
Add an UIImageView to the view with a <strong>tag</strong> of 2 and a frame of x:0, y:64, width:320, height:396
</p>
</li>
<li>
<p>
Add a Round Rect Button. Set its type to Custom and its title to blank. Set its frame to x:14, y:10, width:56, height:41. Set its <strong>tag</strong> to 3.
</p>
</li>
<li>
<p>
Add a UITextField with the placeholder set to <strong>email</strong>, its border set to No border. Its frame should be of x:20, y:94, width:289, height:44. Set its <strong>tag</strong> to 4 and its keyboard to <strong>email adreess</strong>.
</p>
</li>
<li>
<p>
Add a UITextField with the placeholder set to <strong>name</strong>, its border set to No border. Its frame set to x:20, y:159, width:289, height:44. Set its <strong>tag</strong> to 5.
</p>
</li>
<li>
<p>
Add a UITextField with the placeholder set to <strong>password</strong>, its border set to No border. Set its frame to x:20, y:224, width:289, height:44. Set its <strong>Secure</strong> attribute to true in the <strong>Attributes</strong> inspector. Set its <strong>tag</strong> to 6.
</p>
</li>
<li>
<p>
Add a Round Rect Button. Set its type to Custom, its title to <strong>Register</strong>, its font to Helvetica Neue Medium 18 and its text color to white. Its frame should be x:25, y:396, width:270 and height:44. Assign it a <strong>tag</strong> with the number 7.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Because we created this <strong>Xib</strong> file from the scratch, we have to set its <strong>File&#8217;s Owner</strong>. Select the File&#8217;s Owner in the left panel, then select the <strong>Identity</strong> tab in the Inspectors panel. In the Class field type <strong>UIViewController</strong></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_23_change_identity.png" alt="Chapter 10 change identity" />
</span></p></div>
<div class="paragraph"><p>Now Ctrl+click on the file owner to show its outlets. Drag the <strong>view</strong> outlet to the view in the <strong>Objects</strong> panel. The outlet should appear as linked to a view:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_23_set_outlet.png" alt="Chapter 10 set outlet" />
</span></p></div>
<div class="paragraph"><p>Ok now we have our UIView created in our Xib file. But before we added to our RubyMotion project we&#8217;ll do something extra. In the Sign In view, we added the images programmatically in the View Controller, now we are going to do it using Xcode.</p></div>
<div class="paragraph"><p>Go to your RubyMotion project and copy the following images that are located in the <strong>resources</strong> folder:</p></div>
<div class="ulist"><ul>
<li>
<p>
bgApp.png
</p>
</li>
<li>
<p>
btnBrown.png
</p>
</li>
<li>
<p>
bgTitleBar.png
</p>
</li>
<li>
<p>
btnCancel.png
</p>
</li>
<li>
<p>
bgTextField.png
</p>
</li>
</ul></div>
<div class="paragraph"><p>Copy them to the folder of your Xcode project:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_24_files_copied.png" alt="Chapter 10 files copied" />
</span></p></div>
<div class="paragraph"><p>Now we need to import them to our project. In Xcode, the left panel - the one that shows the files of the project- is the <strong>Project Navigator</strong> If you can not see it, go to the Menu View &#8594; Navigators &#8594; Show project navigator. Ctrl + click on the Folder named <strong>CocoaheadsViews</strong> and choose the <strong>Add files</strong> option. Select the images in the dialog and leave all the options with their default value:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_25_add_files_dialog.png" alt="Chapter 10 add files dialog" />
</span></p></div>
<div class="paragraph"><p>Now back to your View, select the Background UIImageView in the <strong>Objects</strong> panel and in the <strong>Attributes</strong> inspector in the <strong>Image</strong> property, select the bgApp.png image:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_26_set_image.png" alt="Chapter 10 set image" />
</span></p></div>
<div class="paragraph"><p>Select the header image view and set its <strong>Image</strong> attribute to <strong>bgTitleBar</strong>
For the textfields, select each one of them and set its <strong>Background</strong> attribute to <strong>bgTextField.png</strong>
Next, select the cancel Button and set its <strong>Background</strong> attribute to <strong>btnCancel.png</strong>
Finally, select the <strong>Register</strong> button and set its <strong>Background</strong> attribute to the <strong>btnBrown.png</strong> image.</p></div>
<div class="paragraph"><p>Now you have a more accurate design view of your screen in Interface Builder:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_27_design_view.png" alt="Chapter 10 design view" />
</span></p></div>
<div class="paragraph"><p>It&#8217;s important to notice that the images are not inserted into the Xib file, we are only setting references to some image files. As long as you include images with the same name in your RubyMotion Project, this approach will work.</p></div>
<div class="sect2">
<h3 id="_creating_the_sign_up_view_controller">Creating the Sign Up View Controller</h3>
<div class="paragraph"><p>Copy the <strong>SignUpView.xib</strong> into the resources folder of your RubyMotion project. Then create a new file in the controllers folder named <strong>sign_up_view_controller.rb</strong>. The code is very similar to the one we did for the <strong>SignInViewController</strong> :</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SignUpViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">CLOSE_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="no">EMAIL_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="no">NAME_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="no">PASSWORD_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">6</span>
  <span class="no">SIGN_UP_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">7</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="vi">@email_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">EMAIL_TEXTFIELD_TAG</span><span class="p">)</span>
    <span class="vi">@name_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">NAME_TEXTFIELD_TAG</span><span class="p">)</span>
    <span class="vi">@password_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">PASSWORD_TEXTFIELD_TAG</span><span class="p">)</span>
    <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

    <span class="n">setupCloseButton</span>
    <span class="n">setupSignUpButton</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupCloseButton</span>

    <span class="vi">@close_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CLOSE_BUTTON_TAG</span><span class="p">)</span>
    <span class="vi">@close_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupSignUpButton</span>
    <span class="vi">@sign_up_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">SIGN_UP_BUTTON_TAG</span><span class="p">)</span>
    <span class="vi">@sign_up_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_up&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">sign_up</span>

    <span class="k">if</span> <span class="n">isFormValid</span>

      <span class="n">close</span>
    <span class="k">else</span>

      <span class="n">showAlert</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="s2">&quot;Please, fill all the fields.&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">close</span>

    <span class="n">dismissModalViewControllerAnimated</span> <span class="kp">true</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">isFormValid</span>

    <span class="ow">not</span> <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">and</span> <span class="ow">not</span> <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">and</span> <span class="ow">not</span> <span class="vi">@name_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">showAlert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="n">title</span><span class="p">)</span>
    <span class="n">alert</span> <span class="o">=</span> <span class="no">UIAlertView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span>
                        <span class="ss">message</span><span class="p">:</span><span class="n">message</span><span class="p">,</span>
                        <span class="ss">delegate</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span>
                        <span class="ss">cancelButtonTitle</span><span class="p">:</span><span class="s1">&#39;OK&#39;</span><span class="p">,</span>
                        <span class="ss">otherButtonTitles</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
    <span class="n">alert</span><span class="o">.</span><span class="n">show</span>
  <span class="k">end</span>


  <span class="c1">#uitextfield delegate methods</span>
  <span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textField</span><span class="p">)</span>

    <span class="n">textField</span><span class="o">.</span><span class="n">resignFirstResponder</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The main difference is that we no longer need to access the background view, because is already fully initialized in the Xib file and the same with the Sign Up button, we are only setting its target-selector because it already has its background image defined.</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_4">Challenge</h3>
<div class="paragraph"><p>In the <strong>next_view_controller.rb</strong> modify the <strong>sign_up</strong> method to show our SignUpViewController as a modal view, remember that you should pass the name of the Xib file to use as the view in the <strong>initWithNibName</strong> method.</p></div>
<div class="paragraph"><p>Test it, you should see the SignUp screen:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_28_sign_up_screen.png" alt="Chapter 10 sign up screen" />
</span></p></div>
<div class="paragraph"><p>Modify the <strong>isFormValid</strong> method in the SignUpViewController to validate that the name has at least 10 characters.</p></div>
</div>
</div>
</div>
<h1 id="_day_3">Day 3</h1>
<h1 id="_chapter_11_view_controllers">Chapter 11 - View Controllers</h1>
<div class="paragraph"><p>In this chapter we are going to review some basic concepts about the lifecycle of UIViewControllers and we will introduce the <strong>UITabBarController</strong> a special UIViewController that helps you to build Tab-based interfaces.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project">Setting up the project</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open the folder ch11-ViewControllers/resources/code/Cocoaheads. It contains our Cocoaheads app that we will use as a base for this exercise:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_01_app.png" alt="Chapter 11 app" />
</span></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_our_tabbarcontroller">Creating our TabBarController</h2>
<div class="sectionbody">
<div class="paragraph"><p>Our first task is to create a <strong>UITabBarController</strong> This component creates a tabbar in the bottom of the application and is used to implement a Tab-based navigation in your apps. You can see it in action in the AppStore app or in the Twitter app.</p></div>
<div class="paragraph"><p>Tab-based navigation is very useful, it allows users to have the main sections of your app always at a glance (at the bottom of the screen). But it has a constraint: it can only have up to 5 tabs. So if your app has more than 5 main sections, you should consider other alternatives for the main menu.</p></div>
<div class="sect2">
<h3 id="_creating_our_missing_sections">Creating our missing sections</h3>
<div class="paragraph"><p>Our Cocoaheads apps will have 3 main sections:</p></div>
<div class="ulist"><ul>
<li>
<p>
Calendar
</p>
</li>
<li>
<p>
Next Event
</p>
</li>
<li>
<p>
News
</p>
</li>
</ul></div>
<div class="paragraph"><p>Until now, we have only created our Next Event screen. So, we are going to start creating the two other sections.</p></div>
<div class="paragraph"><p>Inside the <strong>controller</strong> folder, create two files:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>news_view_controller.rb</strong>
</p>
</li>
<li>
<p>
<strong>calendar_view_controller.rb</strong>
</p>
</li>
</ul></div>
<div class="paragraph"><p>For the first one type this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;News&quot;</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>For the Calendar View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CalendarViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Calendar&quot;</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_creating_a_basic_tab_bar_controller">Creating a basic Tab Bar Controller</h3>
<div class="paragraph"><p>Now we can create our Tab Bar Controller. Open the <strong>app_delegate.rb</strong>, as you can see we are creating our NextEventViewController and assigning it to the <strong>window</strong> as its root controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">next_event_view_controller</span> <span class="o">=</span> <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
<span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">next_event_view_controller</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
</pre></div></div></div>
<div class="paragraph"><p>We need to change that and pass, instead, a Tab Bar Controller. Change that code to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">appTabBarController</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
</pre></div></div></div>
<div class="paragraph"><p>Now, implement the <strong>appTabBarController</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="o">]</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>A <strong>UITabBarController</strong> needs an array of UIViewControllers. Each one of them will became a Tab in the <strong>UITabBar</strong>. This controller will render a <strong>UITabBar</strong> in the bottom of the screen of 44 pixels of height. For each UIViewController it will put a tab, that is actually a <strong>UITabBarItem</strong>. The Tab Bar Controller will use the <strong>title</strong> property of the UIViewController as the name of the tab.</p></div>
<div class="paragraph"><p>Run the app, you will see 3 tabs each one labeled with the title of its UIViewController:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_02_basic_tabbar.png" alt="Chapter 11 basic tab bar" />
</span></p></div>
<div class="paragraph"><p>This is the most basic tab bar that you can build. But we will customize it to make it look better.</p></div>
</div>
<div class="sect2">
<h3 id="_customizing_the_uitabbar">Customizing the UITabBar</h3>
<div class="paragraph"><p>Our designer has made a custom tab bar background, you can see it in the resources folder with the name <strong>bgTabBar.png</strong>. We are going to add it as a custom background for our TabBar. Open the AppDelegate class and modify the <strong>appTabBarController</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="o">]</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">tabBar</span><span class="o">.</span><span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span> <span class="s2">&quot;bgTabBar&quot;</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_03_tabbar_background.png" alt="Chapter 11 custom tabbar" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_customizing_the_uitabbaritems">Customizing the UITabBarItems</h3>
<div class="paragraph"><p>The designer has also made some cool icons for our tabs, we are going to add them to the tab bar.</p></div>
<div class="paragraph"><p>As we have said, the <strong>tabs</strong> are instance of <strong>UITabBarItem</strong>. Each UIViewController has a property called <strong>tabBarItem</strong>. We can easily create our own. Let&#8217;s try it with the Calendar View Controller.</p></div>
<div class="paragraph"><p>Open the <strong>calendar_view_controller.rb</strong> file and add this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CalendarViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Calendar&quot;</span>
    <span class="n">setupTabBarItem</span>
    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupTabBarItem</span>

    <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="ss">image</span><span class="p">:</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCalendar&quot;</span><span class="p">),</span> <span class="ss">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the <strong>setupTabBarItem</strong> we are creating a UITabBarItem and passing and empty title and a UIImage with our icon. Run the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_04_gray_tabitem.png" alt="Chapter 11 gray tab bar item" />
</span></p></div>
<div class="paragraph"><p>What happened? The icon is blueish. The UITabBarItem, by default, will put all the images that you passed with a blue gradient, discarding the color information of the image and using the alpha channel (transparency) information to know where to apply the gradient. This is enough for basic apps but we want our shinny custom icons with its full color.</p></div>
<div class="paragraph"><p>To do this, we should use a new method added in iOS5, type in the <strong>setupTabBarItem</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupTabBarItem</span>

  <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">image</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCalendar&quot;</span><span class="p">),</span> <span class="ss">withFinishedUnselectedImage</span><span class="p">:</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCalendar&quot;</span><span class="p">))</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are passing a <strong>nil</strong> image in the Initializer, but then we are setting the <strong>FinishedSelectedImage</strong> and the <strong>FinishedUnselectedImage</strong>. Run the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_05_calendar_icon.png" alt="Chapter 11 calendar icon" />
</span></p></div>
<div class="paragraph"><p>Now our icon is in full color. Lets add their icons to each View Controller. Open the <strong>next_event_view_controller.rb</strong> and add this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupTabBarItem</span>

  <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="ss">image</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCurrent&quot;</span><span class="p">),</span> <span class="ss">withFinishedUnselectedImage</span><span class="p">:</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCurrent&quot;</span><span class="p">))</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Call it from the init:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">super</span>
  <span class="vi">@days_left</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Next Event&quot;</span>
  <span class="n">setupTabBarItem</span>
  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next, open the <strong>news_view_controller.rb</strong> and add this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;News&quot;</span>
    <span class="n">setupTabBarITem</span>
    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupTabBarITem</span>

    <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="ss">image</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">),</span> <span class="ss">withFinishedUnselectedImage</span><span class="p">:</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and you should see the three tabs with color icons:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_06_all_icons.png" alt="Chapter 11 all icons" />
</span></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_uiviewcontroller_lifecycle">The UIViewController lifecycle</h2>
<div class="sectionbody">
<div class="paragraph"><p>We have reviewed the lifecycle of view controllers, but now lets watch it in action. We are going to use our <strong>CalendarViewController</strong> as a playground for this. Open that class.</p></div>
<div class="paragraph"><p>First, lets add a <strong>UITextView</strong>. This component allows you to have multiline texts on your screen, moreover, it adds a Scroll to the text if the text goes beyond the bounds of the component.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="vi">@text_view</span> <span class="o">=</span> <span class="n">text_view_for_messages</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@text_view</span><span class="p">)</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> viewDidLoad</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">text_view_for_messages</span>

  <span class="n">text_view</span> <span class="o">=</span> <span class="no">UITextView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="o">]]</span><span class="p">)</span>
  <span class="n">text_view</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span>
  <span class="n">text_view</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">text_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are setting the <strong>editable</strong> property to false, because by default this control allows to the user to type text inside. In this case we only want to put some log messages on it.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_07_text_view.png" alt="Chapter 11 text view" />
</span></p></div>
<div class="paragraph"><p>Now let&#8217;s add some other methods on the same controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view did appear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view did disappear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view will appear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewWillDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view will disappear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and try changing between tabs and watching the messages in our log text view.</p></div>
<div class="paragraph"><p>When the app is first opened, this log appears:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_08_initial_log.png" alt="Chapter 11 initial log" />
</span></p></div>
<div class="paragraph"><p>As you can see, first the <strong>viewDidLoad</strong> is called, then the <strong>viewWillAppear</strong> and finally the <strong>viewDidAppear</strong>. As their name implies, the viewWillAppear method is called before the view is rendered and the viewDidAppear once the views has been rendered.</p></div>
<div class="paragraph"><p>Now if you change the tab and then come back to the Calendar section, you should see this message:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_09_after_tab_log.png" alt="Chapter 11 initial log" />
</span></p></div>
<div class="paragraph"><p>As you can see the methods <strong>viewWillDissapear</strong> and <strong>viewDidDissapear</strong> were called when you change the tab. When you return, the <strong>viewWillAppear</strong> and <strong>viewDidAppear</strong> methods were called again, but the <strong>viewDidLoad</strong> method was never called.</p></div>
<div class="paragraph"><p>What can we learn from this?</p></div>
<div class="ulist"><ul>
<li>
<p>
The viewDidLoad method is only called once, after the view is loaded into memory. You can use this method to initialize elements that depend o the <strong>view</strong>, such as subviews.
</p>
</li>
<li>
<p>
the viewWillAppear method is called before the UIView is rendered, you can use this method to initialize values that need to be refreshed every time the view will be rendered, such as our "days left until next meeting" view that we have in the next event view controller.
</p>
</li>
<li>
<p>
the viewDidAppear method is called once the UIView was rendered. You can use this method to setup logic that required that the user is actually viewing the view, such as starting animations in that view.
</p>
</li>
<li>
<p>
the viewWillDissapear method is called just before the view disappears from the screen. You can use it to do logic that require that view is rendered and make no sense to leave it running, such as stoping animations.
</p>
</li>
<li>
<p>
the viewDidDissapear method is called after the view disappeared from the screen.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_5">Challenge</h2>
<div class="sectionbody">
<div class="paragraph"><p>Create the viewWillAppear and viewDidAppear methods in the NextEventViewController. Remember that these methods should call <strong>super</strong>. In the viewWillAppear method, initialize the variable <strong>@days_left</strong> with the value returned from the method <strong>@event.days_left_until(@event.date)</strong>.</p></div>
<div class="paragraph"><p>Now in the <strong>viewDidAppear</strong> update our @days_left_view with that value, remember to call the <strong>setNeedsDisplay</strong>.</p></div>
<div class="paragraph"><p>You should see the screen updated with the days left until the meeting:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_10_challenge.png" alt="Chapter 11 challenge" />
</span></p></div>
</div>
</div>
<h1 id="_chapter_12_table_views">Chapter 12 - Table Views</h1>
<div class="paragraph"><p>During this workshop, we are going to work with table views and table views controllers. Tables are a common way to organize information in iOS apps, they provide a nice scroll and a vertical layout that makes them very easy to navigate through for looking information on small screens.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project_2">Setting up the project</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open the folder ch12-TableViews/resources/code/Cocoaheads, inside you will find our App from the previous chapter plus a new <strong>News</strong> model class that we will review later:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_01_app.png" alt="Chapter 12 app" />
</span></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_the_news_screen">Implementing the News Screen</h2>
<div class="sectionbody">
<div class="paragraph"><p>During this exercise, we are going to create our News Screen. This screen will present the latest news of Cocoaheads in a list. This kind of interfaces are well suited for using a <strong>UITableView</strong>.</p></div>
<div class="paragraph"><p>The easiest way to use a <strong>UITableView</strong> is to use a <strong>UITableViewController</strong>, thus, we are going to do exactly that.</p></div>
<div class="paragraph"><p>Open the <strong>news_view_controller.rb</strong> file and the first thing we are going to do is to change the Parent class of the file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="hll"><span class="k">class</span> <span class="nc">NewsViewController</span> <span class="o">&lt;</span> <span class="no">UITableViewController</span>
</span>
  <span class="k">def</span> <span class="nf">initWithStyle</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;News&quot;</span>
    <span class="n">setupTabBarItem</span>
    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupTabBarItem</span>

    <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="ss">image</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">),</span> <span class="ss">withFinishedUnselectedImage</span><span class="p">:</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We also removed the <strong>loadView</strong> method. A UITableViewController creates its own view as a UITableView so we don&#8217;t need to create it anymore. Finally, we change our code to use the initializer named <strong>initWithStyle:</strong> This is the initializer method used to create instances of UITableViewController.</p></div>
<div class="paragraph"><p>Now let&#8217;s call this initializer from the <strong>app_delegate.rb</strong>. Change the <strong>appTabBarController</strong> method to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
<span class="hll">    <span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewStylePlain</span><span class="p">)</span>
</span>  <span class="o">]</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">tabBar</span><span class="o">.</span><span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span> <span class="s2">&quot;bgTabBar&quot;</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>UITableViews support two styles:</p></div>
<div class="ulist"><ul>
<li>
<p>
UITableViewStylePlain. A plain table view.
</p>
</li>
<li>
<p>
UITableViewStyleGrouped. A Table with sections in aggrouped in rows. Like the ones you can find in the <strong>Settings</strong> app of an iPhone.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Run your app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_02_empty_table.png" alt="Chapter 12 empty table view" />
</span></p></div>
<div class="paragraph"><p>Right now our table is empty, we need to fill it with the latest news.</p></div>
<div class="paragraph"><p>We have seen that is wise to update data in the <strong>viewWillAppear</strong> method, because that method will be called every time the view is shown. Thus, the user will see the updated news. We have implemented a model class named <strong>News</strong> with a class method called "news_mock". With these in mind we can implement our method to retrieve the news in out <strong>NewsViewController</strong> as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewWillAppear</span>

  <span class="n">load_latest_news</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">load_latest_news</span>

  <span class="vi">@news</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">news_mock</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="sect2">
<h3 id="_the_plist_files">The plist files</h3>
<div class="paragraph"><p>From where is the News class taking its data? If you open the class you will see this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">news_mock</span>

  <span class="n">mock_data</span> <span class="o">=</span> <span class="n">news_mock_data</span>
  <span class="n">news_mock</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
  <span class="n">mock_data</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="n">news</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">new</span>
    <span class="n">news</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">brief</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;brief&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;index&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span>
    <span class="n">news_mock</span> <span class="o">&lt;&lt;</span> <span class="n">news</span>
  <span class="p">}</span>
  <span class="n">news_mock</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">news_mock_data</span>

  <span class="n">mock_data_path</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">pathForResource</span><span class="p">(</span><span class="s2">&quot;news_mock&quot;</span><span class="p">,</span> <span class="ss">ofType</span><span class="p">:</span><span class="s2">&quot;plist&quot;</span><span class="p">)</span>
  <span class="n">news_mock_data</span> <span class="o">=</span> <span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithContentsOfFile</span> <span class="n">mock_data_path</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the method <strong>self.news_mock_data</strong> we are loading a file called <strong>news_mock.plist</strong>. <strong>plist</strong> files, or Property list files, are are files that store serialized objects. Objective-C supports these files natively. Locate inside the resources folder the news_mock.plist file, if you double click it to open it, you will see that the file is opened in Xcode. Xcode provides a UI to edit this kind of files:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_03_plist_editor.png" alt="Chapter 12 plist editor" />
</span></p></div>
<div class="paragraph"><p>But if you open the file in a text editor, you will notice that is a simple XML file with a custom format. So it&#8217;s very easy to create this kind of files and to store constants into them.</p></div>
<div class="paragraph"><p>Another advantage is that plist files are very easy to load from RubyMotion, because the Foundation classes of Objective-C support them. In this case we can load it to an Array with a single line:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithContentsOfFile</span> <span class="n">mock_data_path</span>
</pre></div></div></div>
<div class="paragraph"><p>This is useful in tests. We can add or delete items to our table by just modifying that file.</p></div>
</div>
<div class="sect2">
<h3 id="_implementing_a_table_view_datasource">Implementing a Table View DataSource</h3>
<div class="paragraph"><p>How do we pass data to our empty table view? As we have seen in the course, by implementing the methods of the protocol <strong>UITableViewDataSource</strong>. The first step is to tell how many rows should be in the Table View. Add this method in the <strong>NewsViewController</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">numberOfRowsInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

    <span class="vi">@news</span><span class="o">.</span><span class="n">length</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The content of the rows of a UITableView are called <strong>cells</strong> and should be subclasses of <strong>UITableViewCell</strong>. So what basically occurs is that the UITableView asks its DataSource (our NewsViewController) how many rows we want in the table using the <strong>tableView:numberOfRowsInSection:</strong> method. Once we answer that question, starts to ask us for the cell for each one of the rows using this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">NEWS_CELL_REUSE_ID</span> <span class="o">=</span> <span class="s2">&quot;NewsCellId&quot;</span>

<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span> <span class="o">||</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleSubtitle</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span> <span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
  <span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">]</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">title</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">brief</span>
  <span class="n">cell</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>This method is called for each one of the rows in a Table View. Inside you should build your UITableViewCell and return it. There is a catch, the Table View can reuse the same instance to improve the performance of the table. Remember that this component is used to show many rows, literally you can show thousands of them. That is the reason why we are first trying to retrieve a cached cell:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Only if the table view can not find a cached cell with that identifier, we build it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleSubtitle</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span> <span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>After that, we simple set the textLabel and the detailLabel of the cell with the title and the brief of the news item:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">]</span>
<span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">title</span>
<span class="n">cell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">brief</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example and you should see the list of news item:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_04_news_in_table.png" alt="Chapter 12 news in table" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_implementing_a_table_view_delegate">Implementing a Table View Delegate</h3>
<div class="paragraph"><p>The DataSource tells a UITableView which data to display, but a UITableView is more powerful than a simple List. The UITableViewDelegate protocol defines some other methods that you can implement to manage more functionality of the Table View.</p></div>
<div class="paragraph"><p>We are going to start by handle taps on the rows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;row </span><span class="si">#{</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="si">}</span><span class="s2"> selected&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and tap on a row, you will see the message appearing on the console.</p></div>
<div class="paragraph"><p>Our next step is to add a header to our table. Remember that we have been using a header image in our other views. To do that implement this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">viewForHeaderInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

  <span class="n">header_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTitleBar&quot;</span><span class="p">))</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">44</span><span class="o">]]</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">setUserInteractionEnabled</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">header_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Using this <strong>tableView:viewForHeaderInSection:</strong> method, you can add any view as header. In this case we are adding an UIImageView with our header image, we are also setting the <strong>userInteractionEnabled</strong> to true because we will need that to add some buttons to that header later.</p></div>
<div class="paragraph"><p>To add a header is not enough, we need to change the height of the header implementing this other UITableViewDelegate method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">heightForHeaderInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

  <span class="mi">64</span><span class="o">.</span><span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app, you should see the header:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_05_header.png" alt="Chapter 12 header" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_adding_and_removing_rows">Adding and removing rows</h3>
<div class="paragraph"><p>One interesting thing about Table Views, is that you can program a lot of interactions with them. It even have animation support to provide a smoother interaction with the user. In this case we are going to implement the logic to delete selected rows and to add new rows.</p></div>
<div class="paragraph"><p>The first step is to add two buttons to our header:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">deleteButton</span>
  <span class="n">delete_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeCustom</span><span class="p">)</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Delete&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">41</span><span class="o">]]</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnBarRed&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="ss">action</span><span class="p">:</span><span class="s2">&quot;delete_selected_cell&quot;</span><span class="p">,</span>
    <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">delete_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">addButton</span>
  <span class="n">add_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeCustom</span><span class="p">)</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">12</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">41</span><span class="o">]]</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnBarRed&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="ss">action</span><span class="p">:</span><span class="s2">&quot;add_cell&quot;</span><span class="p">,</span>
    <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">add_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">delete_selected_cell</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">add_cell</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>With this code we are creating our Delete and our Add buttons. Now lets add them to our header:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">viewForHeaderInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

  <span class="n">header_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTitleBar&quot;</span><span class="p">))</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">44</span><span class="o">]]</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">setUserInteractionEnabled</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="hll">  <span class="n">header_view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">deleteButton</span><span class="p">)</span>
</span><span class="hll">  <span class="n">header_view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">addButton</span><span class="p">)</span>
</span>  <span class="n">header_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example and you should see the buttons:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_05_buttons_header.png" alt="Chapter 12 buttons header" />
</span></p></div>
<div class="paragraph"><p>Now let&#8217;s implement the delete functionality:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">delete_selected_cell</span>

  <span class="n">selected_cell_index_path</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">indexPathForSelectedRow</span>

  <span class="k">if</span> <span class="n">selected_cell_index_path</span>

    <span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span><span class="n">selected_cell_index_path</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>
    <span class="vi">@news</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">news_item</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">deleteRowsAtIndexPaths</span><span class="p">(</span><span class="o">[</span><span class="n">selected_cell_index_path</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">withRowAnimation</span><span class="p">:</span><span class="no">UITableViewRowAnimationMiddle</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>First, we are retrieving the indexPath of the current selected cell. If there is actually a selected cell, we remove the associated news_item from the array. You should be very careful doing this, when you remove cells from a Table View, the Table will ask again for the <strong>tableView:numberOfRowsInSection:</strong> method and it should reflect that are less number of rows than before the deletion.</p></div>
<div class="paragraph"><p>Then we are deleting the cell with <strong>deleteRowsAtIndexPaths:withRowAnimation</strong>. This is to have a smoother effect. After we remove the element from the <strong>@news</strong> array we could simple refresh the Table View with</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@tableView</span><span class="o">.</span><span class="n">reloadData</span>
</pre></div></div></div>
<div class="paragraph"><p>And see the row gone, but we wouldn&#8217;t have a nice animation. We are defining the animation to use with the constant <strong>UITableViewRowAnimationMiddle</strong> You can check the UITableView documentation to view more animations that you can use.</p></div>
<div class="paragraph"><p>Now run your app, select a cell and tap the <strong>Delete</strong> button to watch it disappear.</p></div>
<div class="paragraph"><p>Finally, let&#8217;s implement the add functionality:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_cell</span>

  <span class="n">random_item</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">self</span><span class="o">.</span><span class="n">news_mock</span><span class="o">[</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sample</span><span class="o">]</span>
  <span class="n">index_path</span> <span class="o">=</span> <span class="no">NSIndexPath</span><span class="o">.</span><span class="n">indexPathForRow</span><span class="p">(</span><span class="vi">@news</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="ss">inSection</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@news</span> <span class="o">&lt;&lt;</span> <span class="n">random_item</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">insertRowsAtIndexPaths</span><span class="p">(</span><span class="o">[</span><span class="n">index_path</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">withRowAnimation</span><span class="p">:</span><span class="no">UITableViewRowAnimationRight</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>First we are retrieving a random news item from the original list. Then we are creating a NSIndexPath with the correct row of the new cell (we are adding it at the end of the table). We need to add the news item to our @news array. Remember that is importat to keep the consistency of our DataSource, the Table View will ask it again for the number of rows and for the cell.</p></div>
<div class="paragraph"><p>Finally, we insert the row with an animation.</p></div>
<div class="paragraph"><p>Run your app and tap the <strong>Add</strong> button, you should see rows added with an animation to the bottom of the table:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_06_add_row.png" alt="Chapter 12 add row" />
</span></p></div>
</div>
</div>
</div>
<h1 id="_chapter_13_custom_cells">Chapter 13 - Custom Cells</h1>
<div class="paragraph"><p>In the last chapter we build our News section using a <strong>UITableView</strong>. In this section we are going to improve that section using Custom Cells. Our Designer has send us an improved design to display our news.</p></div>
<div class="paragraph"><p>We used a standard <strong>UITableViewCell</strong> to display the news item information, but when you need something more customizable, you should create a subclass of <strong>UITableViewCell</strong>.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project_3">Setting up the project</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open the 13-CustomCells/resources/code/Cocoaheads folder., run the app and you will see that we have the app as we leave it in last chapter.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_01_app.png" alt="Current Application" />
</div>
</div>
<div class="paragraph"><p>We will use it as a base for this workshop.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_subclass_of_uitableviewcell">Creating a subclass of UITableViewCell</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the <strong>views</strong> folder create a file called <strong>news_table_view_cell.rb</strong> with this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsTableViewCell</span> <span class="o">&lt;</span> <span class="no">UITableViewCell</span>

  <span class="kp">attr_accessor</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:subtitle</span><span class="p">,</span> <span class="ss">:image_name</span>

  <span class="no">NEWS_CELL_REUSE_ID</span> <span class="o">=</span> <span class="s2">&quot;NewsTableViewCell&quot;</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating a UITableViewCell subclass named <strong>NewsTableViewCell</strong> with three properties: title, subtitle, and image_name. Those are the data that our cell is going to display. We are also adding a constant to store the reuse identifier of the cell.</p></div>
<div class="paragraph"><p>If you remember, in the last chapter we creatwd the cell in the NewsViewController, specifically in the <strong>tableView:cellForRowAtIndexPath:</strong> method. Now we are going to put that logic inside our cell. Thus, decoupling it from our View Controller. Add this class method to the NewsTableViewCell:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">cellForNewsItem</span><span class="p">(</span><span class="n">news_item</span><span class="p">,</span> <span class="ss">inTableView</span><span class="p">:</span><span class="n">tableView</span><span class="p">)</span>

  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span> <span class="o">||</span> <span class="no">NewsTableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">title</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">brief</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">image_name</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">image</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">selectionStyle</span> <span class="o">=</span> <span class="no">UITableViewCellSelectionStyleNone</span>
  <span class="n">cell</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are dequeuing our cell from the table view, if there is not a cached cell, we create it. Then, we are extracting the news item information from the <strong>news_item</strong> object passed as argument and filling our cell with that data.</p></div>
<div class="paragraph"><p>Now, in the <strong>NewsViewController</strong>, change the method <strong>tableView:cellForRowAtIndexPath:</strong> to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>
  <span class="no">NewsTableViewCell</span><span class="o">.</span><span class="n">cellForNewsItem</span><span class="p">(</span><span class="n">news_item</span><span class="p">,</span> <span class="ss">inTableView</span><span class="p">:</span><span class="n">tableView</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_02_empty_cell.png" alt="Empty Cell" />
</div>
<div class="title">Figure 16. Empty Cell</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_visual_components">Adding visual components</h2>
<div class="sectionbody">
<div class="paragraph"><p>The table is empty. Why? Because we need to create the components of our cell to display the data. A UITableViewCell is an UIView. We have seen that we can create custom views and take advantage of their <strong>drawRect:</strong> method to draw visual components inside our view. Although we can do the same inside a cell, is better to use composition of UIViews with the <strong>addSubview</strong> method, remember that a cell is reused for all rows in a table so we need to be able to refresh the components without the need of calling <strong>setNeedDisplay</strong>.</p></div>
<div class="paragraph"><p>UIView has a method called <strong>layoutSubviews</strong> that method can be used to create and layout its subviews. We are going to use it to display the news item information:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layoutSubviews</span>

  <span class="k">if</span> <span class="vi">@background_image</span><span class="o">.</span><span class="n">nil?</span>

    <span class="vi">@background_image</span> <span class="o">=</span> <span class="n">imageViewWithBackground</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@background_image</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">imageViewWithBackground</span>

<span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgNewsCell&quot;</span><span class="p">))</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are adding an image as a background. Notice that we are checking if the <strong>@background_image</strong> does not exist. Why? Remember that there is only one instance of the cell in our table and we don&#8217;t want to add N background images, is enough to add it once.</p></div>
<div class="paragraph"><p>Run the app.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_03_cell_background.png" alt="Cell Background" />
</div>
<div class="title">Figure 17. Cell Background</div>
</div>
<div class="paragraph"><p>It really looks bad. Our designer has gave us a background image with a height of 200px. And the default height of a Cell is of 44px. That is the reason that the images overlap. Let&#8217;s fix it. Open the NewsViewController and we are going to add another <strong>UITableViewDelegate</strong> method to define a new  height for the cells:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">heightForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>
  <span class="mi">200</span><span class="o">.</span><span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now you&#8217;ll see all the cells with their correct background:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_04_cell_height.png" alt="Cell Height" />
</div>
<div class="title">Figure 18. Cell Height</div>
</div>
<div class="paragraph"><p>It&#8217;s time to add more components. We are going to start with the title, in our <strong>NewsTableViewCell</strong> class, change the layoutSubviews method to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layoutSubviews</span>

  <span class="k">if</span> <span class="vi">@background_image</span><span class="o">.</span><span class="n">nil?</span>
    <span class="vi">@background_image</span> <span class="o">=</span> <span class="n">imageViewWithBackground</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@background_image</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="vi">@title_label</span> <span class="o">=</span> <span class="n">labelWithTitle</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">labelWithTitle</span>

  <span class="n">title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span><span class="p">)</span>
  <span class="n">title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span>
  <span class="n">title_label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span>
  <span class="n">title_label</span><span class="o">.</span><span class="n">adjustsFontSizeToFitWidth</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="vi">@title</span>
  <span class="n">title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="n">title_label</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are inserting a label with the title in Red color. Run your app:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_05_cell_title.png" alt="Cell Title" />
</div>
<div class="title">Figure 19. Cell Title</div>
</div>
<div class="paragraph"><p>Wow, the titles are all messed up. Again, there is only one instance of the cell and if you just add views to it, you will end with a lot of subviews. We can do two thing to fix this:
- Do not create a UILabel every time, just once and modify it later for each news title.
- Remove the previous UILabel.</p></div>
<div class="paragraph"><p>We are going to do the second option. Create this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">removePreviousViews</span>

  <span class="k">if</span> <span class="vi">@title_label</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">removeFromSuperview</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And call it from <strong>layoutSubviews</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layoutSubviews</span>

  <span class="n">removePreviousViews</span>

  <span class="k">if</span> <span class="vi">@background_image</span><span class="o">.</span><span class="n">nil?</span>

    <span class="vi">@background_image</span> <span class="o">=</span> <span class="n">imageViewWithBackground</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@background_image</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@title_label</span> <span class="o">=</span> <span class="n">labelWithTitle</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app, now the titles do not overlap:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_06_cell_title_right.png" alt="Cell Titles" />
</div>
<div class="title">Figure 20. Cell Titles</div>
</div>
<div class="paragraph"><p>Now we can add the other data: the subtitle and the image (if any) on the news item:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">imageViewWithNewsImage</span>

  <span class="n">news_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="vi">@image_name</span><span class="p">))</span>
  <span class="n">news_image_view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="o">[[</span><span class="mi">10</span><span class="p">,</span><span class="mi">60</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">115</span><span class="p">,</span><span class="mi">115</span><span class="o">]]</span><span class="p">)</span>
  <span class="n">news_image_view</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">labelWithSubtitle</span>

  <span class="k">unless</span> <span class="vi">@image_name</span><span class="o">.</span><span class="n">empty?</span>

    <span class="n">subtitle_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">140</span><span class="p">,</span> <span class="mi">60</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">170</span><span class="p">,</span> <span class="mi">115</span><span class="o">]]</span><span class="p">)</span>
  <span class="k">else</span>

    <span class="n">subtitle_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">60</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">115</span><span class="o">]]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subtitle_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">subtitle_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="vi">@subtitle</span>
  <span class="n">subtitle_label</span><span class="o">.</span><span class="n">numberOfLines</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">subtitle_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="n">subtitle_label</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now update the <strong>layoutSubviews</strong> to call these methods. Notice that we are only adding the image view if the news item has an image. Not all news items have an associated image:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layoutSubviews</span>

  <span class="n">removePreviousViews</span>

  <span class="k">if</span> <span class="vi">@background_image</span><span class="o">.</span><span class="n">nil?</span>

    <span class="vi">@background_image</span> <span class="o">=</span> <span class="n">imageViewWithBackground</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@background_image</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">unless</span> <span class="vi">@image_name</span><span class="o">.</span><span class="n">empty?</span>

    <span class="vi">@image_view</span> <span class="o">=</span> <span class="n">imageViewWithNewsImage</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@image_view</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@title_label</span> <span class="o">=</span> <span class="n">labelWithTitle</span>
  <span class="vi">@subtitle_label</span> <span class="o">=</span> <span class="n">labelWithSubtitle</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@subtitle_label</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And, finally, update the <strong>removePreviousViews</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">removePreviousViews</span>

  <span class="k">if</span> <span class="vi">@title_label</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">removeFromSuperview</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="vi">@image_view</span>
    <span class="vi">@image_view</span><span class="o">.</span><span class="n">removeFromSuperview</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="vi">@subtitle_label</span>
    <span class="vi">@subtitle_label</span><span class="o">.</span><span class="n">removeFromSuperview</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app, now we have a custom cell to display our news items:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch13-CustomCells/ch13_07_final_app.png" alt="Custom Cell Completed" />
</div>
<div class="title">Figure 21. Custom Cell Completed</div>
</div>
</div>
</div>
<h1 id="_chapter_14_navigation_controllers">Chapter 14 - Navigation Controllers</h1>
<div class="paragraph"><p>Last chapter we added custom cells to our news table. In this chapter we will add navigation to it. Our table view is showing us a list of news items, and that&#8217;s it. We need to add a way to navigate from that list to the full detail of the news item.</p></div>
<div class="paragraph"><p>We will do that using a navigation controller.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project_4">Setting up the project.</h2>
<div class="sectionbody">
<div class="paragraph"><p>As usual, we will begin by setting up our project. Open the <strong>14-NavigationController/resources/code/</strong> folder. You will find the project as we finished in chapter 13 in the <strong>Cocoaheads</strong> folder and the Xcode project we did in chapter 10 inside the <strong>CocoaheadsViews</strong> folder.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_01_app.png" alt="Current Application" />
</div>
<div class="title">Figure 22. Current Application</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_our_navigation_controller">Creating our Navigation Controller</h2>
<div class="sectionbody">
<div class="paragraph"><p>The first step is to show the NewsViewController inside a Navigation Controller. Open the file <strong>app_delegate.rb</strong>. In the method <strong>appTabBarController</strong> is where we are creating our Tab Bar and the view controllers of the app. Change it so the third tab will present a Navigation Controller with the NewsViewController in it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewStylePlain</span><span class="p">))</span>
  <span class="o">]</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">tabBar</span><span class="o">.</span><span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span> <span class="s2">&quot;bgTabBar&quot;</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember that a UINavigationController keeps a stack of view controllers. Thus, we should initialize the controller with a <strong>root</strong> that will be the first controller to be presented.</p></div>
<div class="paragraph"><p>Run the app</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_02_navcontrol.png" alt="Navigation Controller" />
</div>
<div class="title">Figure 23. Navigation Controller</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_the_navigation_bar">Customizing the Navigation Bar</h2>
<div class="sectionbody">
<div class="paragraph"><p>We have two problems:
1. The Table header looks weird below the Navigation Bar.
2. The Navigation Bar has its default blueish color that does not match the look and feel of the app.</p></div>
<div class="paragraph"><p>To solve these problems we will remove the table header and customize the Navigation Bar.</p></div>
<div class="paragraph"><p>First, <strong>delete</strong> these methods from the NewsViewController class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">viewForHeaderInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

  <span class="n">buttonsView</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">heightForHeaderInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

  <span class="mi">64</span><span class="o">.</span><span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now let&#8217;s add our background image to the navigation bar. <strong>Create</strong> this method in the NewsViewController.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupNavigationBar</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">navigationBar</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTitleBar&quot;</span><span class="p">),</span>
    <span class="ss">forBarMetrics</span><span class="p">:</span><span class="no">UIBarMetricsDefault</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>For the Navigation Bar we can specify a background image for two different types of metrics:</p></div>
<div class="ulist"><ul>
<li>
<p>
UIBarMetricsDefault. Portrait mode, thus the image for the iPhone should have a width of 320px.
</p>
</li>
<li>
<p>
UIBarMetricsLandscapePhone. Landscape mode, the image must have 480px. of width.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Call this method from the <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="n">setupNavigationBar</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_03_navbar.png" alt="Navigation Bar" />
</div>
<div class="title">Figure 24. Navigation Bar</div>
</div>
<div class="paragraph"><p>Our final step is to add the Add and Delete buttons to the bar. A Navigation Bar can only have two buttons, one to the left and one to right. Moreover, the buttons should be instances of <strong>UIBarButtonItem</strong> not of UIButton. If you remember, we have the methods deleteButton and  addButton to build UIButtons. We can use these buttons as a base to generate our Bar Button Items. <strong>Modify</strong> the setupNavigationBar method to add the buttons to the navigation bar:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupNavigationBar</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">navigationBar</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTitleBar&quot;</span><span class="p">),</span>
    <span class="ss">forBarMetrics</span><span class="p">:</span><span class="no">UIBarMetricsDefault</span><span class="p">)</span>
  <span class="n">right_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCustomView</span><span class="p">(</span><span class="n">addButton</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">setRightBarButtonItem</span><span class="p">(</span><span class="n">right_button_item</span><span class="p">)</span>
  <span class="n">left_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCustomView</span><span class="p">(</span><span class="n">deleteButton</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">setLeftBarButtonItem</span><span class="p">(</span><span class="n">left_button_item</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Your app should show the buttons on the Navigation Bar:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_04_barbuttons.png" alt="Navigation Bar Button Items" />
</div>
<div class="title">Figure 25. Navigation Bar Button Items</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_news_detail_controller">Creating the News Detail Controller</h2>
<div class="sectionbody">
<div class="paragraph"><p>We have setup our Navigation Controller, now we are going to create the controller to which we are going to navigate to. This controller will show the full text of the news item. We are going to use the Interface Builder to create the View of this controller.</p></div>
<div class="paragraph"><p>Open the CocoaheadsViews.xcodeproj that is inside the <strong>CocoaheadsViews</strong> folder. Add a new file, in the Wizard select a <strong>View</strong>  and set its name to <strong>NewsItemDetailView</strong>:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_05_view_creation.png" alt="View Creation" />
</div>
<div class="title">Figure 26. View Creation</div>
</div>
<div class="paragraph"><p>Setup the view in the Interface Builder as usual:</p></div>
<div class="ulist"><ul>
<li>
<p>
Select the File&#8217;s Owner and in the Identity Inspector to UIViewController. Now Control + click on the File&#8217;s Owner to display its outlets, link the <strong>view</strong> outlet to the View.
</p>
</li>
<li>
<p>
Select the view, in the <strong>Attributes</strong> inspector set its size to <strong>Retina 3.5" full screen</strong>. In the <strong>File</strong> inspector unselect the <strong>Use Autolayout</strong> option.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We will display 3 things in our View: the title of the news item, the image and the full text of the news item.</p></div>
<div class="ulist"><ul>
<li>
<p>
Drag a UILabel to the view, in the <strong>Attributes</strong> inspector set its font to Hoefler of 20 points and its alignment to <strong>Center</strong>, set its tag to 1. In the <strong>Size</strong> inspector, set the frame to x:25, y:13, width:275 and height:44.
</p>
</li>
<li>
<p>
Drag a UIImageView, set its Frame to x:20, y:67, width:80 and height:80. Set its tag to 2 in the <strong>Attributes</strong> inspector.
</p>
</li>
<li>
<p>
Drag a UITextView and in the <strong>Attributes</strong> inspector unselect the <strong>Editable</strong> option and set its tag to 3. In the <strong>Size</strong> inspector set its frame to x:113, y:63, width:187 and height:310.
</p>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_06_interface_builder.png" alt="Interface Builder" />
</div>
<div class="title">Figure 27. Interface Builder</div>
</div>
<div class="paragraph"><p>Our View is ready. Copy the NewsItemDetailView.xib file into the <strong>resources</strong> folder of the RubyMotion project.</p></div>
<div class="paragraph"><p>Back in our RubyMotion Project, create a file in the <strong>controllers</strong> folder named <strong>news_item_view_controller.rb</strong>. This controller is very simple: it receives a news item and displays it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsItemViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="kp">attr_accessor</span> <span class="ss">:news_item</span>

  <span class="no">TITLE_LABEL_TAG</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="no">IMAGE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">2</span>

  <span class="no">NOTE_TEXTVIEW_TAG</span> <span class="o">=</span> <span class="mi">3</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="n">setup_title_label</span>
    <span class="n">setup_image_view</span>
    <span class="n">setup_note_text_view</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setup_title_label</span>

    <span class="n">title_label</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">TITLE_LABEL_TAG</span><span class="p">)</span>
    <span class="n">title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="vi">@news_item</span><span class="o">.</span><span class="n">title</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setup_image_view</span>

    <span class="k">if</span> <span class="vi">@news_item</span><span class="o">.</span><span class="n">image</span>

      <span class="n">image_view</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">IMAGE_VIEW_TAG</span><span class="p">)</span>
      <span class="n">image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span> <span class="vi">@news_item</span><span class="o">.</span><span class="n">image</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setup_note_text_view</span>

    <span class="n">note_text_view</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">NOTE_TEXTVIEW_TAG</span><span class="p">)</span>
    <span class="n">note_text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="vi">@news_item</span><span class="o">.</span><span class="n">note</span>
    <span class="k">unless</span> <span class="vi">@news_item</span><span class="o">.</span><span class="n">image</span>
      <span class="n">note_text_view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">20</span><span class="p">,</span><span class="mi">63</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">280</span><span class="p">,</span> <span class="mi">310</span><span class="o">]]</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now let&#8217;s go back to our NewsViewController, let&#8217;s change the implementation of our method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;row </span><span class="si">#{</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="si">}</span><span class="s2"> selected&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now when the user taps on a News item we will navigate to our detail view controller to show the full text. We accomplish that using the <strong>pushViewController:animated:</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>
  <span class="n">news_item_controller</span> <span class="o">=</span> <span class="no">NewsItemViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithNibName</span><span class="p">(</span><span class="s2">&quot;NewsItemDetailView&quot;</span><span class="p">,</span>
    <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">news_item_controller</span><span class="o">.</span><span class="n">news_item</span> <span class="o">=</span> <span class="n">news_item</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">news_item_controller</span><span class="p">,</span>
    <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Try it, when you tap on a news item, this view should be displayed:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_07_detail.png" alt="Detail Controller" />
</div>
<div class="title">Figure 28. Detail Controller</div>
</div>
<div class="paragraph"><p>As you can see, the navigation controller adds a smooth transition to navigate and a a back button to go back to return to the previous view controller.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_6">Challenge</h2>
<div class="sectionbody">
<div class="paragraph"><p>We&#8217;ve been using the bgTitle.png header image as our navigation bar background. But it looks weird, the navigation bar should have a height of 44 px. and the image is 64 px. that is why the <strong>Cancel</strong> and <strong>Save</strong> buttons look like they are too aligned to the top of the view. Our designer has corrected this situation and created a <strong>bgNavigationBar.png</strong> image of 44 px. Replace it.</p></div>
<div class="paragraph"><p>In the news_detail_view_controller.rb we need to change the default <strong>back</strong> button. Our designer has made an asset to replace it: <strong>btnBack.png</strong>. Create a UIButton with that image and replace the leftItem of <strong>navigationItem</strong> with that button. The button should call a method called <strong>back</strong>. We have seen that with the method <strong>pushViewController:animated:</strong> we push views to the Navigation Controller View&#8217;s stack, research the method needed to pop them from the stack. That is the method that you should call in the <strong>back</strong> method:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch14-NavigationController/ch14_08_detail.png" alt="Back Button" />
</div>
<div class="title">Figure 29. Back Button</div>
</div>
</div>
</div>
<h1 id="_chapter_15_notification_center">Chapter 15 - Notification Center</h1>
<div class="sect1">
<h2 id="_digital_photo_frame">Digital Photo Frame</h2>
<div class="sectionbody">
<div class="paragraph"><p>Time travel has not been invented yet, so we most preserve our mosts precious memories in one way or another, have done said that, for the next series of chapters we are going to build an application that help us to doing so.
For this chapter we are going to build the main screen the "photo frame", but in a more fashion way of course on an iDevice.</p></div>
<div class="paragraph"><p>First at all we have to remember that objects are always sending messages one each other, but some times all objects may be interested in what just one object hast to say, but keep all the objects connected may be not a good strategy, for this reason we have a very handful tool, the notification center.</p></div>
<div class="paragraph"><p>Now its time to create our ViewController that will hold our photo, run the rake command and give "PhotoFrame" as name of the application</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create PhotoFrame
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Please add the assets to the resources folder of your project. You can find them under the resources folder and inside there is a folder images with the assets necessary for the chapter.</td>
</tr></table>
</div>
<div class="paragraph"><p>Now create a new file named <strong>photo_frame_view_controller.rb</strong> in app folder and add the following code.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoFrameViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and run the rake command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>Don&#8217;t forget to set it as rootViewController in your <strong>app_delegate.rb</strong> file because this ViewController will be useful for present our photo and also use the photo that comes in chapter 15 directory and paste it in your resources folder.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="no">PhotoFrameViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The next step is add an UIImage to our PhotoFrameViewController feel free to create a file for the UIElements like <strong>photo_view_utilities.rb</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">photoUIImageView</span>

  <span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;me.png&quot;</span><span class="p">)</span>
  <span class="n">photoView</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span>  <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
  <span class="n">photoView</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Don&#8217;t forget to add the image to the view in the PhotoFrameViewController</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoFrameViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
    <span class="vi">@imageView</span> <span class="o">=</span> <span class="n">photoUIImageView</span><span class="p">;</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@imageView</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and compile the project to see if everything goes well, You will be able to see a wild cat:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_PictureFrame.png" alt="Picture Frame" />
</div>
<div class="title">Figure 30. Picture Frame</div>
</div>
<div class="paragraph"><p>Now Rotate the simulator or the device.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_LandscapeFrame.png" alt="Landscape Frame" />
</div>
<div class="title">Figure 31. Landscape Frame</div>
</div>
<div class="paragraph"><p>What just happened here? Everything indicates that the image did not adjust accordingly to the orientation.
It may be useful if the device can tell us when it rotates so we can act in response; guess what actually it tell us, we just have to listen carefully or in this case subscribe our view controller to this notification.</p></div>
<div class="sect2">
<h3 id="_uidevice_notification">UIDevice Notification</h3>
<div class="paragraph"><p>Let&#8217;s add register our photocontroller to receive notifications when the orientation of the device changes, add the following methods in your <strong>photo_frame_view_controller.rb</strong> file</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">orientationChanged</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="n">notification</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">orientation</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">registerDeviceNotification</span>

    <span class="c1"># Get the device object</span>
    <span class="n">device</span> <span class="o">=</span> <span class="no">UIDevice</span><span class="o">.</span><span class="n">currentDevice</span>
    <span class="c1"># Tell it to start monitoring the accelerometer for orientation</span>
    <span class="n">device</span><span class="o">.</span><span class="n">beginGeneratingDeviceOrientationNotifications</span>
    <span class="c1"># Get the notification center for the app</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="no">NSNotificationCenter</span><span class="o">.</span><span class="n">defaultCenter</span>
    <span class="c1"># Add yourself as an observer</span>
    <span class="n">nc</span><span class="o">.</span><span class="n">addObserver</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">selector</span><span class="p">:</span> <span class="ss">:&#39;orientationChanged:&#39;</span><span class="p">,</span><span class="nb">name</span><span class="ss">:UIDeviceOrientationDidChangeNotification</span> <span class="p">,</span><span class="ss">object</span><span class="p">:</span><span class="n">device</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In order to listen notification, call register notification on your <strong>viewDidLoad</strong> method.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>class PhotoFrameViewController &lt; UIViewController

  def viewDidLoad

    view.backgroundColor = UIColor.lightGrayColor
    @imageView = photoUIImageView;
    view.addSubview(@imageView)
    registerDeviceNotification
  end

end</code></pre>
</div></div>
<div class="paragraph"><p>You can rotate tour simulator by holding the <em>command</em> key and use the directions arrows, you will notice a series of number form 1 to 4 printed on your console, but that number means? In fact there are an enumeration:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
   <span class="n">UIDeviceOrientationUnknown</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationPortrait</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationPortraitUpsideDown</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationLandscapeLeft</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationLandscapeRight</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationFaceUp</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationFaceDown</span>
<span class="p">}</span> <span class="n">UIDeviceOrientation</span><span class="p">;</span>
</pre></div></div></div>
<div class="paragraph"><p>After know that, we can make a little improvements to our method  <strong><strong>orientationChanged</strong></strong> in our <strong>photo_frame_view_controller.rb</strong> file.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">orientationChanged</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

  <span class="n">deviceOrientation</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">orientation</span>
    <span class="k">if</span> <span class="n">deviceOrientation</span> <span class="o">==</span> <span class="no">UIDeviceOrientationLandscapeLeft</span> <span class="o">||</span> <span class="n">deviceOrientation</span> <span class="o">==</span> <span class="no">UIDeviceOrientationLandscapeRight</span>

      <span class="vi">@imageView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>

    <span class="k">else</span>
      <span class="vi">@imageView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your application and rotate the device, and watch carefully the landscape mode</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_LandscapePicture.png" alt="Landscape Picture" />
</div>
<div class="title">Figure 32. Landscape Picture</div>
</div>
</div>
<div class="sect2">
<h3 id="_autorotation">Autorotation</h3>
<div class="paragraph"><p>Rotation it’s a very common task between iOS applications, you can use UIDevice Notification, but this may be a lot of work, instead we can use auto rotation for this purpose.</p></div>
<div class="paragraph"><p>We can achieve this if the view is controlled by an UIViewController, we ask to a view controller if its okay to rotate the view, if the view controller agrees, the view it&#8217;s rotated and resized also it&#8217;s sub-views.</p></div>
<div class="paragraph"><p>For this purpose we need to add the following method to our <strong>photo_frame_view_controller.rb</strong>, and don&#8217;t subscribe to the UIDevice Notifications in the viewDidLoad Method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
  <span class="vi">@imageView</span> <span class="o">=</span> <span class="n">photoUIImageView</span><span class="p">;</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@imageView</span><span class="p">)</span>
  <span class="c1">#registerDeviceNotification</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">shouldAutorotateToInterfaceOrientation</span><span class="p">(</span><span class="n">interfaceOrientation</span><span class="p">)</span>

  <span class="c1"># Return YES if incoming orientation is Portrait</span>
  <span class="c1">#  or either of the Landscapes, otherwise, return NO</span>
  <span class="n">shouldRotate</span> <span class="o">=</span> <span class="no">NO</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">interfaceOrientation</span> <span class="o">==</span> <span class="no">UIInterfaceOrientationPortrait</span><span class="p">)</span> <span class="o">||</span> <span class="no">UIInterfaceOrientationIsLandscape</span><span class="p">(</span><span class="n">interfaceOrientation</span><span class="p">)</span>
    <span class="n">shouldRotate</span> <span class="o">=</span> <span class="no">YES</span>
  <span class="k">end</span>

  <span class="n">shouldRotate</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>At this point it seems that our previous work has disappeared, and its because we did not tell how the UIImage should be resized, let&#8217;s modified the methods that return the UIImageView whit the following auto resizing mask:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">photoUIImageView</span>

  <span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;me.png&quot;</span><span class="p">)</span>
  <span class="n">photoView</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span>  <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
  <span class="c1">#The view resizes by expanding or shrinking its width.</span>
  <span class="c1">#The view resizes by expanding or shrinking its height.</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">setAutoresizingMask</span><span class="p">(</span><span class="no">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="no">UIViewAutoresizingFlexibleHeight</span><span class="p">)</span>
  <span class="n">photoView</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save and then run your application, now all the previous work has returned
,as you can see the view  adjusts it&#8217;s size automatically when devices rotates, fortunately we have additional resize masks</p></div>
<div class="ulist"><ul>
<li>
<p>
UIViewAutoresizingFlexibleLeftMargin
</p>
</li>
<li>
<p>
UIViewAutoresizingFlexibleRightMargin
</p>
</li>
<li>
<p>
UIViewAutoresizingFlexibleTopMargin
</p>
</li>
<li>
<p>
UIViewAutoresizingFlexibleBottomMargin
</p>
</li>
</ul></div>
<div class="paragraph"><p>The only thing left its add a more fancy frame so we can get rid off that ugly gray background, open your <strong>photo_view_utilities.rb</strong> file and add the following method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">frameUIImageView</span>

  <span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;frame.png&quot;</span><span class="p">)</span>
  <span class="n">photoView</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span>  <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">460</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">setAutoresizingMask</span><span class="p">(</span><span class="no">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="no">UIViewAutoresizingFlexibleHeight</span><span class="p">)</span>
  <span class="n">photoView</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now in your <strong>photo_frame_view_controller.rb</strong> add the frame image just before adding the picture image</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="vi">@imageView</span> <span class="o">=</span> <span class="n">photoUIImageView</span><span class="p">;</span>
  <span class="n">frameView</span> <span class="o">=</span> <span class="n">frameUIImageView</span><span class="p">;</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">frameView</span><span class="p">)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@imageView</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_PhotoFrameApp.png" alt="Photo Frame App" />
</div>
<div class="title">Figure 33. Photo Frame App</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenge_status_bar">Challenge - Status Bar</h3>
<div class="paragraph"><p>It seems that the only element that not fits right on this picture, its the status bar, try to remove it so we can appreciate in all the screen, add the following line at the beginning of your viewDidLoad method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">UIApplication</span><span class="o">.</span><span class="n">sharedApplication</span><span class="o">.</span><span class="n">setStatusBarHidden</span><span class="p">(</span><span class="kp">true</span> <span class="p">,</span><span class="ss">animated</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_challenge_battery_level">Challenge - Battery Level</h3>
<div class="paragraph"><p>It will be nice if our digital photo frame could tell us the battery level, subscribe to UIDeviceBatteryLevelDidChangeNotification and enable batteryMonitoringEnabled.
Add a label that indicates the level of the battery, green when its above 10% and red when get lower or equal than 10%</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_lock_portrait">Challenge - Lock Portrait</h3>
<div class="paragraph"><p>Allow only portrait mode for the app, because in land scape we may look a little bit stretch</p></div>
</div>
</div>
</div>
<h1 id="_chapter_16_collection_views">Chapter 16 - Collection Views</h1>
<div class="sect1">
<h2 id="_photo_album">Photo Album</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this chapter we are going to build our photo album, because there is no reason to have only a photo frame when we can have an entire album.</p></div>
<div class="paragraph"><p>For this propose we have to build a more serious interface, so we can show our photo album to anyone and even better say that we have built it.</p></div>
<div class="paragraph"><p>For our photo album we&#8217;ll have two sections, our photo frame in the first one and the photo album in the second</p></div>
<div class="paragraph"><p>Let start creating our project, run the rake command an name it "PhotoAlbum"</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create PhotoAlbum
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Please add the assets to the resources folder of your project. You can find them under the resources folder and inside there is a folder images with the assets necessary for the chapter.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_album_view_controller">Album View Controller</h3>
<div class="paragraph"><p>We are going to begin with the controller that will hold the entire application, so create an file named album_view_controller.rb and the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AlbumViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>
    <span class="k">super</span> <span class="p">()</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also in your <strong>appdelegate.rb</strong> file set it as rootViewController</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="no">AlbumViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>When you see the loadView method you should guess that we are going to use a nib file to build our application, open your Xcode and in the menu select file&gt;new&gt;file select user interface and choose the empty template then click on next and chose iPhone family give the name "AlbumView" to the file and save it to your resources folder of your application.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image1.png" alt="AlbumView Nib file" />
</div>
<div class="title">Figure 34. Create xib file</div>
</div>
<div class="paragraph"><p>Now in your xib editor select a UIView from the right bottom list and drag it to the grid.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image2.png" alt="Adding UIView" />
</div>
<div class="title">Figure 35. Adding UIView</div>
</div>
<div class="paragraph"><p>Now select the view an in the attributes inspector set size to retina 3.5 full screen and save the file</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image3.png" alt="Adding UIView" />
</div>
<div class="title">Figure 36. Adding UIView</div>
</div>
<div class="paragraph"><p>But of course we need to set the nib file to the view controller, modify the loadView method as follow:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="k">super</span> <span class="p">()</span>
  <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;AlbumView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now run your project, and you may not notice a difference, so open you xib editor (Xcode) and change the background color to red in the attributes inspector, save your file an run your application again.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image4.png" alt="Change color from nib" />
</div>
<div class="title">Figure 37. Change color</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image5.png" alt="UIView from xib" />
</div>
<div class="title">Figure 38. Change color</div>
</div>
<div class="paragraph"><p>Now its a good idea to add a menu bar, so we can choose from "photo frame" and "gallery frame" please return the background color to white, and add an UITableView to the view that will serve as a menu.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image6.png" alt="UITableView" />
</div>
<div class="title">Figure 39. Adding UITableView</div>
</div>
<div class="paragraph"><p>Once you added the UITableView, you need to set it&#8217;s tag number to "1" in the inspector view so we can a have reference to that view.</p></div>
<div class="paragraph"><p>Open the file <strong>album_view_controller.rb</strong> and add reference to the tableView also its' delegate and dataSource.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AlbumViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">MENU_TABLE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1">#Method that returns the sections of menu</span>
  <span class="k">def</span> <span class="nf">menuSections</span>

    <span class="n">bugs</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Photo Frame&quot;</span><span class="p">,</span> <span class="s2">&quot;Album&quot;</span><span class="o">]</span>
  <span class="k">end</span>


  <span class="c1">#Table View Data Source</span>
  <span class="k">def</span> <span class="nf">numberOfSectionsInTableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">)</span>

    <span class="mi">1</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span><span class="ss">numberOfRowsInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

    <span class="n">menuSections</span><span class="o">.</span><span class="n">count</span>
  <span class="k">end</span>


  <span class="c1">#Table View Delegate</span>
  <span class="no">CELLID</span> <span class="o">=</span> <span class="s2">&quot;CELLID&quot;</span>

  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="no">CELLID</span><span class="p">)</span> <span class="o">||</span>

    <span class="k">begin</span>
      <span class="n">cell</span> <span class="o">=</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="no">CELLID</span><span class="p">)</span>
      <span class="n">cell</span>
    <span class="k">end</span>

    <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">menuSections</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>
    <span class="n">cell</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="k">super</span> <span class="p">()</span>
    <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;AlbumView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="vi">@tableView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span> <span class="no">MENU_TABLE_VIEW_TAG</span> <span class="p">)</span>
    <span class="vi">@tableView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="vi">@tableView</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You&#8217;ll will notice a method named <strong>menuSections</strong> that returns an array with the name of the sections, feel free to run the application.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image7.png" alt="Application menu" />
</div>
<div class="title">Figure 40. Application menu</div>
</div>
<div class="paragraph"><p>We definitely need to change the appearance of the menu&#8217;s cell, we can use a NIB File for this purpose, the elements that we are going to use are the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
BackGroundView (UIIView)
</p>
</li>
<li>
<p>
MenuIcon (UIImageView)
</p>
</li>
<li>
<p>
TitleLabel (UILabel)
</p>
</li>
<li>
<p>
CellSeparator (UIImageView)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Form your Xcode select file&gt;new&gt;file select user interface and choose the empty template then click on next and chose iPhone family give the name "MenuCellView" to the file and save it to your resources folder of your application, then add a UITableViewCell to editor.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image8.png" alt="Adding Custom Cell" />
</div>
<div class="title">Figure 41. Adding Custom Cell</div>
</div>
<div class="paragraph"><p>Well now we need a class in ruby witch match the one that we set on the interface builder, inside your app folder create a file named <strong>menu_cell.rb</strong> and add the following code to it.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MenuCell</span> <span class="o">&lt;</span> <span class="no">UITableViewCell</span>

  <span class="no">CELL_ICON_IMAGE</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="no">CELL_TITLE_LABEL</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="no">CELL_SEPARATOR_IMAGE</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="k">def</span> <span class="nf">customizeUnSelectedCell</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span>    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgGreyTexture&quot;</span><span class="p">))</span>
    <span class="n">titleLabel</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span> <span class="no">CELL_TITLE_LABEL</span><span class="p">)</span>
    <span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">sectionName</span>
    <span class="n">titleLabel</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
    <span class="n">separatorImageView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CELL_SEPARATOR_IMAGE</span><span class="p">)</span>
    <span class="n">separatorImageView</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;separatorLine&quot;</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">customizeSelectedCell</span><span class="p">(</span><span class="n">sectionName</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgGreyTextureEnabled&quot;</span><span class="p">))</span>
    <span class="n">titleLabel</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span> <span class="no">CELL_TITLE_LABEL</span><span class="p">)</span>
    <span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">sectionName</span>
    <span class="n">titleLabel</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="n">separatorImageView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CELL_SEPARATOR_IMAGE</span><span class="p">)</span>
    <span class="n">separatorImageView</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;separatorLine&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now its time to add the elements to the cell View, first at all you need to add a UIView so it will serve as backgroundView, set its background color to gray.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image9.png" alt="Adding UIView" />
</div>
<div class="title">Figure 42. Adding UIView</div>
</div>
<div class="paragraph"><p>But how the cell possibly know that the previous inserted view its it own backgroundView, it couldn&#8217;t. But don&#8217;t worry not everything it&#8217;s lost, select the UITableViewCell element and open the connections inspector, and connect the backgroundView property to the UIView</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image10.png" alt="Connecting Background Property" />
</div>
<div class="title">Figure 43. Connecting Background</div>
</div>
<div class="paragraph"><p>Now it&#8217;s time to add the missing elements, add an UIImageView that will serve as icon and set its tag to number 3, also we need and UILabel for the section name set its tag to 4 at last add another UIImageView that will serve as tableDivider set its tag to 5</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image11.png" alt="Custom Cell" />
</div>
<div class="title">Figure 44. Custom Cell</div>
</div>
<div class="paragraph"><p>From Xcode we should set custom class to the UITableViewCell and Cell identifier, we can change this on the identity inspector, put the custom class as <strong>MenuCell</strong> finally in the attributes inspector set the reuse identifier as <strong>MenuCellView</strong></p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/customClass.png" alt="Setting custom class" />
</div>
<div class="title">Figure 45. Set Custom Class</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/reuseID.png" alt="Setting reuse identifier" />
</div>
<div class="title">Figure 46. Set Reusable Identifier</div>
</div>
<div class="paragraph"><p>Now we need to tell to the table view that use our custom cell instead of its own, for this propose we need to change the <strong>tableView(tableView, cellForRowAtIndexPath:indexPath)</strong> with the following code also we have to register this NIB file in the view load method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#Table View Delegate</span>
<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="c1"># Check for a reusable cell first, use that if it exists</span>
  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="s1">&#39;MenuCellView&#39;</span><span class="p">)</span>

  <span class="c1">#if the cell has selected customize with select style otherwise customize with unselected style</span>
  <span class="k">if</span> <span class="vi">@selectedRows</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>

    <span class="n">cell</span><span class="o">.</span><span class="n">customizeSelectedCell</span><span class="p">(</span><span class="n">menuSections</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span><span class="p">)</span>
  <span class="k">else</span>

    <span class="n">cell</span><span class="o">.</span><span class="n">customizeUnSelectedCell</span><span class="p">(</span><span class="n">menuSections</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">cell</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span><span class="p">()</span>
  <span class="c1"># Load the NIB file</span>
  <span class="n">nib</span> <span class="o">=</span> <span class="no">UINib</span><span class="o">.</span><span class="n">nibWithNibName</span><span class="p">(</span><span class="s1">&#39;MenuCellView&#39;</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="c1"># Register this NIB which contains the cell</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">registerNib</span><span class="p">(</span><span class="n">nib</span><span class="p">,</span> <span class="ss">forCellReuseIdentifier</span><span class="p">:</span><span class="s1">&#39;MenuCellView&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also we need to implement the delegate method that takes responsibility when a cell its selected <strong>tableView tableView,didSelectRowAtIndexPath:indexPath</strong> , in this method we need to set the selected style to the current selected cell, and deselected the previous that was selected, we are going to take advantage of a ruby hash to store the cell that is currently selected.
Notice that in the <strong>viewDidLoad</strong> method we set segment that we want to be selected when the application launch</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#return height for the current cell</span>
<span class="k">def</span> <span class="nf">tableView</span> <span class="n">tableView</span><span class="p">,</span><span class="ss">heightForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span>

  <span class="mi">85</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span> <span class="n">tableView</span><span class="p">,</span><span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span>

  <span class="c1">#if we tap in the selected row do nothing</span>
  <span class="k">if</span> <span class="vi">@currentSection</span> <span class="o">==</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span>

    <span class="k">return</span>
  <span class="k">end</span>

  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">cellForRowAtIndexPath</span> <span class="n">indexPath</span>
  <span class="c1">#customize selected cell</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">customizeSelectedCell</span><span class="p">(</span><span class="n">menuSections</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span><span class="p">)</span>

<span class="c1">#clean all previous cells</span>
  <span class="vi">@selectedRows</span><span class="o">.</span><span class="n">each_key</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="o">|</span>
    <span class="vi">@selectedRows</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">loadFrameView</span>

  <span class="k">elsif</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">loadCollectionView</span>
  <span class="k">end</span>

  <span class="n">removePreviousLayer</span>

  <span class="c1">#set selected cell</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">loadView</span>

  <span class="k">super</span> <span class="p">()</span>
  <span class="vi">@selectedRows</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
  <span class="c1">#Load the nib file</span>
  <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;AlbumView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
  <span class="c1">#Assing the first View from the nib file</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="vi">@tableView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span> <span class="no">MENU_TABLE_VIEW_TAG</span> <span class="p">)</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgGreyTexture&quot;</span><span class="p">))</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="vi">@tableView</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="n">loadFrameView</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now its time to bring back our photo frame from the chapter 15, copy the file <strong>photo_frame_view_controller.rb</strong> to the app folder and add the following method at the end of the of the <strong>album_view_controller.rb</strong> file, also copy the <strong>photo_frame_utilities.rb</strong> to the same folder.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadFrameView</span>

  <span class="c1">#avoid to create the same instance of the controllers more than once</span>
  <span class="k">if</span> <span class="o">!</span><span class="vi">@photoFrameViewController</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@photoFrameNavigationViewController</span>

    <span class="vi">@photoFrameViewController</span> <span class="o">=</span> <span class="no">PhotoFrameViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@photoFrameNavigationViewController</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@photoFrameViewController</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@photoFrameNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@photoFrameNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
  <span class="c1">#set the current section</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="vi">@currentSection</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your changes and run your application with the rake command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>You should see the wild cat from the previous chapter but with a top blue bar</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image12.png" alt="Navigation Bar" />
</div>
<div class="title">Figure 47. Navigation Bar</div>
</div>
<div class="paragraph"><p>But where did our menu go? , don&#8217;t worry it&#8217;s still there but we need a mechanism to show them again, now open your  <strong>photo_frame_view_controller.rb</strong> and add the following code</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">showMenu</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">frameView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>
  <span class="n">frameView</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">78</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frameView</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;hideMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">hideMenu</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">frameView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>
  <span class="n">frameView</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frameView</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">styleNavigationBar</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">navigationBar</span><span class="o">.</span><span class="n">setBackgroundImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;navBar.png&quot;</span><span class="p">)</span> <span class="p">,</span><span class="ss">forBarMetrics</span><span class="p">:</span> <span class="no">UIToolbarPositionAny</span>
  <span class="vi">@buttonWithImage</span> <span class="o">=</span> <span class="n">menuButtonItem</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">barButton</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCustomView</span><span class="p">(</span><span class="vi">@buttonWithImage</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">leftBarButtonItem</span> <span class="o">=</span> <span class="n">barButton</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also replace the <strong>viewDidLoad</strong> method with the following code</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="no">UIApplication</span><span class="o">.</span><span class="n">sharedApplication</span><span class="o">.</span><span class="n">setStatusBarHidden</span><span class="p">(</span><span class="kp">true</span> <span class="p">,</span><span class="ss">animated</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
  <span class="vi">@imageView</span> <span class="o">=</span> <span class="n">photoUIImageView</span><span class="p">;</span>
  <span class="n">frameView</span> <span class="o">=</span> <span class="n">frameUIImageView</span><span class="p">;</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">frameView</span><span class="p">)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@imageView</span><span class="p">)</span>
  <span class="n">styleNavigationBar</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You will need an UITabBarButton for show and hide the menu, open your <strong>photo_frame_utilities.rb</strong> and add the following method that return an UIButton</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">menuButtonItem</span>

  <span class="n">buttonWithImage</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span> <span class="no">UIButtonTypeCustom</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setFrame</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnMenuEnabled&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateSelected</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnMenuEnabled&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnMenuDisabled&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span>
  <span class="n">buttonWithImage</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save and run your application with the rake command, you should see a quite more beautiful navigation bar and the button should show and hide the menu, notice that the first row of the application its selected.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image13.png" alt="Hide Menu" />
</div>
<div class="title">Figure 48. Hide Menu</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image14.png" alt="Show Menu" />
</div>
<div class="title">Figure 49. Show Menu</div>
</div>
</div>
<div class="sect2">
<h3 id="_collection_view">Collection View</h3>
<div class="paragraph"><p>For this section of the album we need a grid to present a set of photos, but I have good news for you, since iOS 6 we have a component "UICollectionView" that resolves this approach quite well.</p></div>
<div class="paragraph"><p>Create a file named <strong>album_collection_view_controller.rb</strong> and add the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoCollectionViewController</span> <span class="o">&lt;</span> <span class="no">UICollectionViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are going to use a Nib file also for this controller, from your Xcode select file&gt;new&gt;file select user interface and choose the empty template then click on next and chose iPhone family give the name "AlbumCollectionView" to the file and save it to your resources folder of your application.</p></div>
<div class="paragraph"><p>The next step its add an UICollectionView to the editor.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image15.png" alt="Adding a collection view" />
</div>
<div class="title">Figure 50. Adding a collection view</div>
</div>
<div class="paragraph"><p>Now we are going to tell to our UICollectionViewController that its collection view comes from an nib file, add the following code to the <strong>loadView</strong> method also add the methods that customize the Navigation Bar</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;AlbumCollectionView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
  <span class="c1">#Assign the first View from the nib file</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="n">styleNavigationBar</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">showMenu</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">frameView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>
  <span class="n">frameView</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">78</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frameView</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;hideMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">hideMenu</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">frameView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>
  <span class="n">frameView</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frameView</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">styleNavigationBar</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">navigationBar</span><span class="o">.</span><span class="n">setBackgroundImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;navBar.png&quot;</span><span class="p">)</span> <span class="p">,</span><span class="ss">forBarMetrics</span><span class="p">:</span> <span class="no">UIToolbarPositionAny</span>
  <span class="vi">@buttonWithImage</span> <span class="o">=</span> <span class="n">menuButtonItem</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">barButton</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCustomView</span><span class="p">(</span><span class="vi">@buttonWithImage</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">leftBarButtonItem</span> <span class="o">=</span> <span class="n">barButton</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we want to see our collection view we need to make some modifications to <strong>album_view_controller.rb</strong> file in order to load the appropriate controller for each menu section, the first step its create a navigation controller that loads the collection view, just add the following method at the end of your file</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadCollectionView</span>

  <span class="c1">#avoid to create the same instance of the controllers more than once</span>
  <span class="k">if</span> <span class="o">!</span><span class="vi">@photoCollectionViewControllerr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@photoCollectionNavigationViewController</span>

    <span class="vi">@photoCollectionViewController</span> <span class="o">=</span> <span class="no">PhotoCollectionViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@photoCollectionNavigationViewController</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@photoCollectionViewController</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@photoCollectionNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@photoCollectionNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
  <span class="c1">#set the current section</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="vi">@currentSection</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also we need to modify the <strong>loadFrameView</strong> method in order to have the same behavior</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadFrameView</span>

  <span class="c1">#avoid to create the same instance of the controllers more than once</span>
  <span class="k">if</span> <span class="o">!</span><span class="vi">@photoFrameViewController</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@photoFrameNavigationViewController</span>

    <span class="vi">@photoFrameViewController</span> <span class="o">=</span> <span class="no">PhotoFrameViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@photoFrameNavigationViewController</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@photoFrameViewController</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@photoFrameNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@photoFrameNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
  <span class="c1">#set the current section</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="vi">@currentSection</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are almost done with the <strong>album_view_controller.rb</strong> file, please modify the loadView method and add the <strong>removePreviousLayer</strong> method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">removePreviousLayer</span>

  <span class="n">views</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">subviews</span>
  <span class="n">previousView</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
  <span class="n">previousView</span><span class="o">.</span><span class="n">removeFromSuperview</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">loadView</span>

  <span class="vi">@selectedRows</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
  <span class="c1">#Load the nib file</span>
  <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;AlbumView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
  <span class="c1">#Assignee the first View from the nib file</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="vi">@tableView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span> <span class="no">MENU_TABLE_VIEW_TAG</span> <span class="p">)</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgGreyTexture&quot;</span><span class="p">))</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="vi">@tableView</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="n">loadFrameView</span>
  <span class="vi">@tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now run the rake command and you will be able to switch between sections.</p></div>
</div>
<div class="sect2">
<h3 id="_collection_view_adding_content">Collection View - Adding Content</h3>
<div class="paragraph"><p>Until here you have done a magnificent work, the next step its populate the Collection View
and for this part we are going to add content, in order to do so we should study the components of a UIViewCollection</p></div>
</div>
<div class="sect2">
<h3 id="_uicollectionview">UICollectionView</h3>
<div class="paragraph"><p>This its the main view in which the content its presented, and not necessarily needs to fill all the screen</p></div>
</div>
<div class="sect2">
<h3 id="_uicollectionviewcell">UICollectionViewCell</h3>
<div class="paragraph"><p>Similarly with a cell from a UITableView it takes the responsibility of present content.</p></div>
</div>
<div class="sect2">
<h3 id="_supplementary_views">Supplementary Views</h3>
<div class="paragraph"><p>When we have extra information that we don&#8217;t want to be displayed in the cells we can take advantage of it</p></div>
</div>
<div class="sect2">
<h3 id="_decoration_view">Decoration View</h3>
<div class="paragraph"><p>We have another helpful view for decoration purposes outside of the cells</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">We also have non visual elements that help us laying the content</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_uicollectionviewlayout">UICollectionViewLayout</h3>
<div class="paragraph"><p>UICollectionView does not have a clue of how the cells should be displayed, instead it uses a UICollectionViewLayout class to handle it.
It uses a set delegates methods to position every single cell on the collectionView</p></div>
</div>
<div class="sect2">
<h3 id="_collectionview_data_source">CollectionView Data Source</h3>
<div class="paragraph"><p>We can start adding the data source for our collection view, open your <strong>album_collection_view_controller.rb</strong> file and modified the <strong>loadView</strong> method additionally add a method that return a set of images names for our album</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

    <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;AlbumCollectionView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
    <span class="c1">#Assign the first View from the nib file</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="c1">#Set Data Source</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="n">styleNavigationBar</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">phothos</span>

  <span class="n">bugs</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;me.png&quot;</span><span class="p">,</span> <span class="s2">&quot;misa.png&quot;</span><span class="p">,</span> <span class="s2">&quot;juan.png&quot;</span> <span class="p">,</span> <span class="s2">&quot;juwe.png&quot;</span><span class="o">]</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we should continue with the data source methods</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#UICollectionView Datasource</span>

<span class="k">def</span> <span class="nf">collectionView</span><span class="p">(</span><span class="n">collectionView</span><span class="p">,</span> <span class="ss">numberOfItemsInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>
  <span class="n">phothos</span><span class="o">.</span><span class="n">count</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">numberOfSectionsInCollectionView</span><span class="p">(</span><span class="n">collectionView</span><span class="p">)</span>
  <span class="mi">1</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">collectionView</span><span class="p">(</span><span class="n">collectionView</span><span class="p">,</span> <span class="ss">cellForItemAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>
  <span class="n">cell</span> <span class="o">=</span> <span class="n">collectionView</span><span class="o">.</span><span class="n">dequeueReusableCellWithReuseIdentifier</span><span class="p">(</span><span class="s1">&#39;PhotoCollectionCellView&#39;</span> <span class="p">,</span><span class="ss">forIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">customizeCollectionCell</span><span class="p">(</span><span class="n">phothos</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span><span class="p">)</span>
  <span class="n">cell</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We need a CollectionViewCell, for this propose we can use a nib file, open your Xcode and in the menu select file&gt;new&gt;file select user interface and choose the empty template then click on next and chose iPhone family give the name "PhotoCollectionCellView" to the file and save it to your resources folder of your application.</p></div>
<div class="paragraph"><p>We should follow the same process as we did for UITableViewCell, set custom class to the UICollectionViewCell and Cell identifier, we can change this on the identity inspector, put the custom class as <strong>CollectionViewCell</strong> finally in the attributes inspector set the reuse identifier as <strong>PhotoCollectionCellView</strong></p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/collectionCustomClass.png" alt="Collection View Custom Class" />
</div>
<div class="title">Figure 51. Collection View Custom Class</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image17.png" alt="Collection View Cells Reuse Identifier" />
</div>
<div class="title">Figure 52. Collection View Cells Reuse Identifier</div>
</div>
<div class="paragraph"><p>Now we have to add the image component to the xib file, add an UIImageView that will be our component for display the photo.</p></div>
<div class="paragraph"><p>It&#8217;s time to see our album photo come to live, run the app with rake command:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image18.png" alt="Plain Collection View" />
</div>
<div class="title">Figure 53. Plain Collection View</div>
</div>
<div class="paragraph"><p>I know I know it looks awful we still need add the delegate layout methods in your <strong>album_collection_view_controller.rb</strong> add the following code, also in the <strong>viewDidLoad</strong> method change the background color.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#UICollectionView Delegate</span>

<span class="k">def</span> <span class="nf">collectionView</span><span class="p">(</span><span class="n">collectionView</span> <span class="p">,</span> <span class="ss">layout</span><span class="p">:</span><span class="n">collectionViewLayout</span><span class="p">,</span><span class="ss">sizeForItemAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="no">CGSizeMake</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">collectionView</span><span class="p">(</span><span class="n">collectionView</span><span class="p">,</span> <span class="ss">layout</span><span class="p">:</span><span class="n">collectionViewLayout</span><span class="p">,</span><span class="ss">insetForSectionAtIndex</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>

  <span class="no">UIEdgeInsetsMake</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span><span class="p">()</span>
  <span class="c1"># Load the NIB file</span>
  <span class="n">nib</span> <span class="o">=</span> <span class="no">UINib</span><span class="o">.</span><span class="n">nibWithNibName</span><span class="p">(</span><span class="s1">&#39;PhotoCollectionCellView&#39;</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="c1"># Register this NIB which contains the cell</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">registerNib</span><span class="p">(</span><span class="n">nib</span><span class="p">,</span> <span class="ss">forCellWithReuseIdentifier</span><span class="p">:</span><span class="s1">&#39;PhotoCollectionCellView&#39;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTile&quot;</span><span class="p">))</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image19.png" alt="Collection View" />
</div>
<div class="title">Figure 54. Collection View</div>
</div>
</div>
<div class="sect2">
<h3 id="_autolayout">AutoLayout</h3>
<div class="paragraph"><p>In this section of the workbook we are going to add a new section <strong>"Camera"</strong> , It would be nice if we can capture images in our own app.</p></div>
</div>
<div class="sect2">
<h3 id="_camera_controls">Camera Controls</h3>
<div class="paragraph"><p>Let&#8217;s start creating a new file <strong>album_camera_view_controller.rb</strong> in our app folder:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CameraViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;CameraView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
    <span class="c1">#Assign the first View from the nib file</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>For this chapter we are going to use a new feature that comes in iOS6 <strong>AutoLayout</strong>, as we have seen on chapter 15 Auto Rotation help us to handle size of the components when the device rotates, we let the view take care of everything by setting its auto resizing masks, but when the arrival of the new iDevices "iPhone 5" we may need another set of constrains to maintain the visual look in our apps.</p></div>
<div class="paragraph"><p>Now its time to create the nib file for the view of this section, open Xcode and in the menu select file&gt;new&gt;file select user interface and choose the empty template then click on next and chose iPhone family give the name "CameraView" to the file and save it to your resources folder of your application.</p></div>
<div class="paragraph"><p>Once you created the file add an UIView to the editor, also add two buttons one with the legend "take" and another with "choose".</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image20.png" alt="AutoLayout" />
</div>
<div class="title">Figure 55. AutoLayout</div>
</div>
<div class="paragraph"><p>We must agree that it&#8217;s good idea to have the same width for the buttons, we ca use autoLayout for this propose and Interface Builder has a shortcut menu in the bottom-right corner:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image21.png" alt="Interface Builder menu" />
</div>
<div class="title">Figure 56. Interface Builder menu</div>
</div>
<div class="paragraph"><p>Now if we want buttons have same width, we first should select both buttons by holding the <em>command</em> key and select the center item of the interface builder menu and select equals width, a new constrain it&#8217;s added to buttons.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image22.png" alt="Width" />
</div>
<div class="title">Figure 57. Equal Width</div>
</div>
<div class="paragraph"><p>I&#8217;m sure that you want to see this in action, wait no more and open <strong>album_view_controller.rb</strong> file and add the following method that will load our Camera View</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadCameraView</span>

  <span class="c1">#avoid to create the same instance of the controllers more than once</span>
  <span class="k">if</span> <span class="o">!</span><span class="vi">@cameraViewController</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@cameraNavigationViewController</span>

    <span class="vi">@cameraViewController</span> <span class="o">=</span> <span class="no">CameraViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@cameraNavigationViewController</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@cameraViewController</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@cameraNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@cameraNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
  <span class="c1">#set the current section</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="vi">@currentSection</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And now in the same file change the following methods:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#Method that returns the sections of menu</span>
<span class="k">def</span> <span class="nf">menuSections</span>

  <span class="n">sections</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Frame&quot;</span><span class="p">,</span> <span class="s2">&quot;Album&quot;</span><span class="p">,</span><span class="s2">&quot;Camera&quot;</span><span class="o">]</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span> <span class="n">tableView</span><span class="p">,</span><span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span>

  <span class="c1">#if we tap in the selected row do nothing</span>
  <span class="k">if</span> <span class="vi">@currentSection</span> <span class="o">==</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span>

    <span class="k">return</span>
  <span class="k">end</span>

  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">cellForRowAtIndexPath</span> <span class="n">indexPath</span>
  <span class="c1">#customize selected cell</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">customizeSelectedCell</span><span class="p">(</span><span class="n">menuSections</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span><span class="p">)</span>
  <span class="c1">#clean all previous cells</span>
  <span class="vi">@selectedRows</span><span class="o">.</span><span class="n">each_key</span> <span class="p">{</span><span class="o">|</span><span class="n">key</span><span class="o">|</span>
    <span class="vi">@selectedRows</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">loadFrameView</span>

  <span class="k">elsif</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">loadCollectionView</span>

  <span class="k">elsif</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">loadCameraView</span>
  <span class="k">end</span>

  <span class="n">removePreviousLayer</span>

  <span class="c1">#set selected cell</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We have done with the album view controller, now we are going customize Navigation Bar and provide the mechanism to dismiss the camera controller, open your <strong>album_camera_view_controller.rb</strong> and add the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="n">views</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">loadNibNamed</span> <span class="s2">&quot;CameraView&quot;</span><span class="p">,</span> <span class="ss">owner</span><span class="p">:</span><span class="nb">self</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="kp">nil</span>
  <span class="c1">#Assign the first View from the nib file</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">views</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="n">styleNavigationBar</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span><span class="p">()</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTile&quot;</span><span class="p">))</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">showMenu</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">frameView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>
  <span class="n">frameView</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">78</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frameView</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;hideMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">hideMenu</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">frameView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>
  <span class="n">frameView</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frameView</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">styleNavigationBar</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">navigationBar</span><span class="o">.</span><span class="n">setBackgroundImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;navBar.png&quot;</span><span class="p">)</span> <span class="p">,</span><span class="ss">forBarMetrics</span><span class="p">:</span> <span class="no">UIToolbarPositionAny</span>
  <span class="vi">@buttonWithImage</span> <span class="o">=</span> <span class="n">menuButtonItem</span>
  <span class="vi">@buttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;showMenu:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">barButton</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCustomView</span><span class="p">(</span><span class="vi">@buttonWithImage</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">leftBarButtonItem</span> <span class="o">=</span> <span class="n">barButton</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save you changes and run the the application with the rake command, feel free to rotate the device in the new section that we just added:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image23.png" alt="Camera Portrait" />
</div>
<div class="title">Figure 58. Camera Portrait</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image24.png" alt="Camera Landscape" />
</div>
<div class="title">Figure 59. Camera Landscape</div>
</div>
<div class="paragraph"><p>Now we have our buttons in the same with even if we rotate the device, but we need to add more visual elements to the camera section:</p></div>
<div class="ulist"><ul>
<li>
<p>
UIImageView (image placeholder)<strong>set its background color to white</strong>
</p>
</li>
<li>
<p>
UITextField (image name)
</p>
</li>
<li>
<p>
UILabel (label)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Open your <strong>CameraView.xib</strong> file and add the missing elements, we want for this section that the UImageView and the UILabel always be left aligned we can achieve this by selecting the Interface Menu the most left item and select left edges.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image25.png" alt="Camera Portrait" />
</div>
<div class="title">Figure 60. Left Edges</div>
</div>
<div class="paragraph"><p>Save your changes and run application with the rake command, take a very especial look to the landscape orientation</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image26.png" alt="UIImageView" />
</div>
<div class="title">Figure 61. UIImageView</div>
</div>
<div class="paragraph"><p>What went wrong for this part? actually nothing, UIImageView are just following orders, we can change this by selecting the UIImageView and make it bigger, but this of course its not enough, while the UIImageView its selected choose the center button of the Interface Builder Menu and select <strong>Top Space to SuperView</strong> and <strong>Bottom Space to SuperView</strong></p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image27.png" alt="Top Space" />
</div>
<div class="title">Figure 62. Top Space</div>
</div>
<div class="paragraph"><p>Now the UIImageView are going to resize depending on the size of the its super view, doing so we have a unwanted constrain "UIImageView Vertical Size" as we may know one can no be serve two masters, for this reason we have to eliminate one, on the left section under UIIMageView remove  <strong>Height constrain</strong> <em>Height (423) - Image View</em>, save your changes an run the app.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image28.png" alt="Remove Constrain" />
</div>
<div class="title">Figure 63. Remove Constrain</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenge_collection_view">Challenge - Collection View</h3>
<div class="paragraph"><p>Choose another set of photos and modify the <strong>collectionView(collectionView , layout:collectionViewLayout,sizeForItemAtIndexPath:indexPath)</strong> and return the proportional size for each photo</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_auto_layout">Challenge - Auto Layout</h3>
<div class="paragraph"><p>Add another set of constrains to UIImageView and UITextLabel in order to keep the visual appeal on landscape orientation</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch16-CollectionViews/image29.png" alt="Constrains landscape" />
</div>
<div class="title">Figure 64. Constrains landscape</div>
</div>
</div>
</div>
</div>
<h1 id="_day_4">Day 4</h1>
<h1 id="_chapter_17_camera">Chapter 17 - Camera</h1>
<div class="sect1">
<h2 id="_camera">Camera</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this chapter we are going to use camera and photo roll for capture moments that we want to save.</p></div>
<div class="sect2">
<h3 id="_photo_album_2">Photo Album</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Please add the assets to the resources folder of your project. You can find them under the resources folder and inside there is a folder images with the assets necessary for the chapter.</td>
</tr></table>
</div>
<div class="paragraph"><p>Bring the project for the chapter 16 <em>Photo Album</em> and open the file <strong>album_camera_view_controller.rb</strong> and a add the following code that will serve to connect the Graphics elements, also don&#8217;t forget to assign the correspondent tag numbers on the <strong>CameraView.xib</strong> file.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">CHOOSE_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">1</span>
<span class="no">TAKE_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">2</span>
<span class="no">IMAGE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">choosePicture</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">imagePicker</span> <span class="o">=</span> <span class="no">UIImagePickerController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="c1">#pick from photo library</span>
  <span class="n">imagePicker</span><span class="o">.</span><span class="n">setSourceType</span><span class="p">(</span><span class="no">UIImagePickerControllerSourceTypePhotoLibrary</span><span class="p">)</span>
  <span class="n">imagePicker</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">presentViewController</span><span class="p">(</span><span class="n">imagePicker</span><span class="p">,</span><span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">,</span> <span class="ss">completion</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">takePicture</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">imagePicker</span> <span class="o">=</span> <span class="no">UIImagePickerController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1">#ask if camera is available</span>
  <span class="k">if</span> <span class="no">UIImagePickerController</span><span class="o">.</span><span class="n">isSourceTypeAvailable</span><span class="p">(</span><span class="no">UIImagePickerControllerSourceTypeCamera</span><span class="p">)</span>

    <span class="c1">#pick from photo camera</span>
    <span class="n">imagePicker</span><span class="o">.</span><span class="n">setSourceType</span><span class="p">(</span><span class="no">UIImagePickerControllerSourceTypeCamera</span><span class="p">)</span>
    <span class="n">imagePicker</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">presentViewController</span><span class="p">(</span><span class="n">imagePicker</span><span class="p">,</span><span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">,</span> <span class="ss">completion</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">else</span>

    <span class="nb">puts</span> <span class="s2">&quot;Unavailable&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">bindGraphicElements</span>

  <span class="vi">@chooseButton</span> <span class="o">=</span>  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CHOOSE_BUTTON_TAG</span><span class="p">)</span>
  <span class="vi">@chooseButton</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;choosePicture:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="vi">@takeButton</span> <span class="o">=</span>  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">TAKE_BUTTON_TAG</span><span class="p">)</span>
  <span class="vi">@takeButton</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;takePicture:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="vi">@imageView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">IMAGE_VIEW_TAG</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>There is only one thing left, call the <strong>bindGraphicElements</strong> method at the end of your <strong>loadView</strong> method</p></div>
<div class="listingblock">
<div class="content">
<pre><code>def loadView
  views = NSBundle.mainBundle.loadNibNamed "CameraView", owner:self, options:nil
  #Assign the first View from the nib file
  self.view = views[0]
  styleNavigationBar
  bindGraphicElements
end</code></pre>
</div></div>
<div class="paragraph"><p>Now run your application with the <em>rake</em> command and if you are running the application on the simulator you will be able to take picture and see attached to the imageView.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch17-Camera/image1.png" alt="Take Photo" />
</div>
<div class="title">Figure 65. Take Photo</div>
</div>
</div>
<div class="sect2">
<h3 id="_camera_picker_delegate">Camera Picker Delegate</h3>
<div class="paragraph"><p>How can we know when the photo its selected well, UIMagePickerController has a delegate method when the picture its selected and when is not selected A.K.A. (cancel)</p></div>
<div class="ulist"><ul>
<li>
<p>
imagePickerController:didFinishPickingMediaWithInfo:
</p>
</li>
<li>
<p>
imagePickerControllerDidCancel:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># UIImagePickerController Delegate</span>
<span class="k">def</span> <span class="nf">imagePickerController</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="ss">didFinishPickingMediaWithInfo</span><span class="p">:</span><span class="n">info</span><span class="p">)</span>

  <span class="c1">#Get picked image from info dictionary</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">objectForKey</span><span class="p">(</span><span class="no">UIImagePickerControllerOriginalImage</span><span class="p">)</span>
  <span class="c1">#Put that image onto the screen in our image view</span>
  <span class="vi">@imageView</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
  <span class="c1">#You must call this dismiss method</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">dismissViewControllerAnimated</span><span class="p">(</span><span class="kp">true</span><span class="p">,</span><span class="ss">completion</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_modal_view_controllers">Modal View Controllers</h3>
<div class="paragraph"><p>You may notice two new methods</p></div>
<div class="ulist"><ul>
<li>
<p>
self.presentViewController(imagePicker,animated:true, completion:nil)
</p>
</li>
<li>
<p>
self.dismissViewControllerAnimated(true,completion:nil)
</p>
</li>
</ul></div>
<div class="paragraph"><p>From a UIViewController we ca present another view controllers modally, specially if we want to perform a new functionality for our app, and we can dismiss it when we were done.</p></div>
</div>
</div>
</div>
<h1 id="_chapter_18_application_sandbox_and_memory_warnings">Chapter 18 - Application Sandbox and Memory Warnings</h1>
<div class="sect1">
<h2 id="_file_system_structure">File System Structure</h2>
<div class="sectionbody">
<div class="paragraph"><p>We are going to learn in this chapter how to save our photos to disk, and when the application finish for any reason, the photos remains, have done say that which is the perfect place for store our files? Well we have more than one option, but for now we are going to use the application sandbox.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Please add the assets to the resources folder of your project. You can find them under the resources folder and inside there is a folder images with the assets necessary for the chapter.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Bring files from chapter 17 <em>Camera</em>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_sandbox">Application Sandbox</h2>
<div class="sectionbody">
<div class="paragraph"><p>An application sandbox its a directory enclosed and protected so no one ca access to it but the application itself. Inside of it we have the following directories:</p></div>
<div class="sect2">
<h3 id="_application_bundle">application bundle</h3>
<div class="paragraph"><p>This directory contains all the resources and the executable file and its read only</p></div>
</div>
<div class="sect2">
<h3 id="_library_preferences">Library/Preferences/</h3>
<div class="paragraph"><p>We have a directory in which store the preferences are saved, this directory is managed by the class <strong>NSUserDefaults</strong> and its backed up when the device synchronizes with iTunes or iCloud</p></div>
</div>
<div class="sect2">
<h3 id="_tmp">tmp/</h3>
<div class="paragraph"><p>You have a directory where you can can store temporal data during run time and you are responsible for erase it when you are done with it, also the operating system may purge data when the application its not running. An important think to remember its that this information its not backed up, you get access to this directory using, the function <strong>NSTemporaryDirectory</strong>.</p></div>
</div>
<div class="sect2">
<h3 id="_documents">Documents/</h3>
<div class="paragraph"><p>In this directory you can save store data that your application generates during run time and want to persist. This information its synchronized with iTunes or iCloud.</p></div>
</div>
<div class="sect2">
<h3 id="_library_caches">Library/Caches/</h3>
<div class="paragraph"><p>In essence it has the same functionality as documents directory, but its <strong>NOT</strong> synchronized or backed up, also this data can be deleted when the operating system requires the space, so you should have a mechanism to regenerate this info.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_photo_model">Photo Model</h2>
<div class="sectionbody">
<div class="paragraph"><p>We are going to create an object <em>photo</em> that takes the responsibility of code and decode the attributes of the photo, bring back the files from the previous chapter and add the the file named <strong>photo.rb</strong> to the app folder</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Photo</span>

  <span class="kp">attr_accessor</span> <span class="ss">:photoName</span>
  <span class="kp">attr_accessor</span> <span class="ss">:photoImage</span>

  <span class="k">def</span> <span class="nf">encodeWithCoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">)</span>

    <span class="n">encoder</span><span class="o">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="vi">@photoName</span><span class="p">,</span><span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;photoName&quot;</span><span class="p">)</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">encodeObject</span><span class="p">(</span><span class="vi">@photoImage</span><span class="p">,</span><span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;photoImage&quot;</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">initWithCoder</span><span class="p">(</span><span class="n">decoder</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@photoName</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decodeObjectForKey</span><span class="p">(</span><span class="s2">&quot;photoName&quot;</span><span class="p">)</span>
    <span class="vi">@photoImage</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">decodeObjectForKey</span><span class="p">(</span><span class="s2">&quot;photoImage&quot;</span><span class="p">)</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You may wondering why do we need to <em>code</em> the attributes of the object, well its because we are going store the object in a binary format, in the documents directory.</p></div>
<div class="paragraph"><p>Once we set up our photo object, we are going to create another object that saves and retrieves photos from the library, now create a file named <strong>photo_library.rb</strong> and add the following code</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoLibrary</span>

  <span class="kp">attr_accessor</span> <span class="ss">:photos</span>


  <span class="k">def</span> <span class="nf">photosArchivePath</span>

    <span class="n">documentDirectories</span> <span class="o">=</span> <span class="no">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="no">NSDocumentDirectory</span><span class="p">,</span><span class="no">NSUserDomainMask</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
    <span class="c1">#Get one and only document directory from that list</span>
    <span class="n">documentDirectory</span> <span class="o">=</span> <span class="n">documentDirectories</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">documentDirectory</span><span class="o">.</span><span class="n">stringByAppendingPathComponent</span><span class="p">(</span><span class="s2">&quot;photos.archive&quot;</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">saveChanges</span> <span class="p">(</span><span class="n">photo</span><span class="p">)</span>

    <span class="n">allPhotos</span> <span class="o">=</span> <span class="n">storedPhotos</span>
    <span class="n">allPhotos</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>
    <span class="vi">@photos</span> <span class="o">=</span> <span class="n">allPhotos</span>
    <span class="no">NSKeyedArchiver</span><span class="o">.</span><span class="n">archiveRootObject</span><span class="p">(</span><span class="vi">@photos</span> <span class="p">,</span> <span class="ss">toFile</span><span class="p">:</span><span class="n">photosArchivePath</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">storedPhotos</span>

    <span class="n">finalArray</span> <span class="o">=</span> <span class="no">NSKeyedUnarchiver</span><span class="o">.</span><span class="n">unarchiveObjectWithFile</span><span class="p">(</span><span class="n">photosArchivePath</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">finalArray</span>

      <span class="n">finalArray</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="k">end</span>

    <span class="n">finalArray</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we should save photo once it have been taken, open the album_camera_view_controller.rb and add the following methods</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">savePhoto</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="s2">&quot;saving&quot;</span>

  <span class="n">library</span> <span class="o">=</span> <span class="no">PhotoLibrary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">photoObject</span> <span class="o">=</span> <span class="no">Photo</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">photoObject</span><span class="o">.</span><span class="n">photoName</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
  <span class="n">photoObject</span><span class="o">.</span><span class="n">photoImage</span> <span class="o">=</span> <span class="vi">@imageView</span><span class="o">.</span><span class="n">image</span>

  <span class="n">library</span><span class="o">.</span><span class="n">saveChanges</span><span class="p">(</span><span class="n">photoObject</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setSaveButton</span>

  <span class="vi">@savebuttonWithImage</span> <span class="o">=</span> <span class="n">saveButtonItem</span>
  <span class="vi">@savebuttonWithImage</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:&#39;savePhoto:&#39;</span><span class="p">,</span><span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">barButton</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCustomView</span><span class="p">(</span><span class="vi">@savebuttonWithImage</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">barButton</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Dont forget to call this method on your <strong>viewDidLoad</strong> method</p></div>
<div class="listingblock">
<div class="content">
<pre><code>def viewDidLoad
  super()
  self.view.backgroundColor = UIColor.colorWithPatternImage(UIImage.imageNamed("bgTile"))
  setSaveButton
end</code></pre>
</div></div>
<div class="paragraph"><p>The <em>menuButtonItem</em> should be created somewhere in this case in the <strong>album_utilities.rb</strong> so open the file and add the following method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">saveButtonItem</span>

  <span class="n">buttonWithImage</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span> <span class="no">UIButtonTypeCustom</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setFrame</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;sendEnabled&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateSelected</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;sendEnabled&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span>
  <span class="n">buttonWithImage</span><span class="o">.</span><span class="n">setImage</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;sendDisabled&quot;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span>
  <span class="n">buttonWithImage</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the application to make sure that everything it&#8217;s going well, now we can store photos, but we do not have a place to show them, wait a minute we have
<em>Photo Album</em>, we are saved !! we just need to set collection view <em>dataSource</em> to get the photos from the library, in order to do that open the <strong>album_collection_view_controller.rb</strong> file and replace the following methods</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span><span class="p">()</span>
  <span class="c1"># Load the NIB file</span>
  <span class="n">nib</span> <span class="o">=</span> <span class="no">UINib</span><span class="o">.</span><span class="n">nibWithNibName</span><span class="p">(</span><span class="s1">&#39;PhotoCollectionCellView&#39;</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="c1"># Register this NIB which contains the cell</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">registerNib</span><span class="p">(</span><span class="n">nib</span><span class="p">,</span> <span class="ss">forCellWithReuseIdentifier</span><span class="p">:</span><span class="s1">&#39;PhotoCollectionCellView&#39;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTile&quot;</span><span class="p">))</span>

  <span class="vi">@library</span> <span class="o">=</span> <span class="no">PhotoLibrary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">phothos</span>

  <span class="n">photosArray</span> <span class="o">=</span> <span class="vi">@library</span><span class="o">.</span><span class="n">storedPhotos</span>
  <span class="n">photosArray</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">collectionView</span><span class="p">(</span><span class="n">collectionView</span><span class="p">,</span> <span class="ss">cellForItemAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>

  <span class="n">cell</span> <span class="o">=</span> <span class="n">collectionView</span><span class="o">.</span><span class="n">dequeueReusableCellWithReuseIdentifier</span><span class="p">(</span><span class="s1">&#39;PhotoCollectionCellView&#39;</span> <span class="p">,</span><span class="ss">forIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">customizeCollectionCell</span><span class="p">(</span><span class="n">phothos</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span><span class="p">)</span>
  <span class="n">cell</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also we have to create a method that refresh the content in the collectionView</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">updateCollectionView</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">collectionView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We should not forget to modify the custom cell to accept the object from the library, modify <strong>collection_view_cell.rb</strong> file and replace the <em>customizeCollectionCell</em> method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">customizeCollectionCell</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>

  <span class="vi">@photoImageView</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CELL_IMAGE_VIEW</span><span class="p">)</span>
  <span class="vi">@photoImageView</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">photoImage</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>At last we need to modify the <strong>album_view_controller.rb</strong> file for reload the collection view</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadCollectionView</span>

<span class="c1">#avoid to create the same instance of the controllers more than once</span>
  <span class="k">if</span> <span class="o">!</span><span class="vi">@photoCollectionViewControllerr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="vi">@photoCollectionNavigationViewController</span>

    <span class="vi">@photoCollectionViewController</span> <span class="o">=</span> <span class="no">PhotoCollectionViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@photoCollectionNavigationViewController</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@photoCollectionViewController</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="vi">@photoCollectionNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@photoCollectionNavigationViewController</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
  <span class="vi">@photoCollectionViewController</span><span class="o">.</span><span class="n">updateCollectionView</span>

  <span class="c1">#set the current section</span>
  <span class="vi">@selectedRows</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="vi">@currentSection</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now once that you take a photo press the save button and you will be able to see it on the album view</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch18-Sandbox/image1.png" alt="Save Photo" />
</div>
<div class="title">Figure 66. Save Photo</div>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch18-Sandbox/image2.png" alt="Photo Added" />
</div>
<div class="title">Figure 67. Photo Added</div>
</div>
<div class="sect2">
<h3 id="_challenge_set_photo_frame">Challenge - Set Photo Frame</h3>
<div class="paragraph"><p>Use the UICollectionView delegate <strong>collectionView:didSelectItemAtIndexPath:</strong> in order to set the selected photo in the photo frame section</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_name_property">Challenge - Name Property</h3>
<div class="paragraph"><p>Connect the name property to the model in order save tha name of the picture, and add it as a label on the UICollectionView (Album)</p></div>
</div>
</div>
</div>
<h1 id="_chapter_19_multitouch">Chapter 19 - Multitouch</h1>
<div class="paragraph"><p>One of the best features of the iPhone or iPad is the touch screen, in this chapter we will use it to make a app for drawing on the screen</p></div>
<div class="sect1">
<h2 id="_kanji_master">Kanji Master</h2>
<div class="sectionbody">
<div class="paragraph"><p>One of the most difficult languages to learn is Japanese because they use one symbol (Kanji) to express full concepts. This is different than most of the languages, because they use words (Multiple symbols: letters) for the same purpose.</p></div>
<div class="paragraph"><p>In this exercise we will create a app that will teach the user how to draw a Kanji, allowing him to paint the shape with his fingers on the screen.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_Kanji.png" alt="Kanji" />
</div>
<div class="title">Figure 68. Kanji</div>
</div>
<div class="sect2">
<h3 id="_preparing_the_canvas">Preparing the Canvas</h3>
<div class="paragraph"><p>Lets start creating a new project called <strong>KanjiMaster</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create KanjiMaster
</pre></div></div></div>
<div class="paragraph"><p>Please copy the resources from <strong>resources/images</strong> folder into the project resources folder, after that create the following file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>KanjiMaster/app

<span class="nv">$ </span>mkdir views

<span class="nv">$ </span>touch kanji_view.rb

<span class="nv">$ </span>open kanji_view.rb
</pre></div></div></div>
<div class="paragraph"><p>Now add the following to our <strong>kanji_view.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">KanjiView</span> <span class="o">&lt;</span> <span class="no">UIView</span>

  <span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="c1"># In order to does not hide the background image on</span>
      <span class="c1"># the controllers view, we need to set the background color on</span>
      <span class="c1"># this view as transparent</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>

      <span class="c1"># We need to set multipleTouchEnabled to true if we want to handle</span>
      <span class="c1"># more than one finger touching the screen</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">multipleTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>

      <span class="c1"># Instance an Array for storing the user touches</span>
      <span class="vi">@touch_points</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="k">end</span>

    <span class="nb">self</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Lets create a controller for our new view with the name <strong>KanjiViewController</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch kanji_view_controller.rb

<span class="nv">$ </span>open kanji_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Insert the following into the <strong>kanji_view_controller.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">KanjiViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Create a new UIImageView to draw our background image</span>
    <span class="n">background_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Set our background image into the UIImageView</span>
    <span class="n">background_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgKanji&quot;</span><span class="p">)</span>

    <span class="c1"># Add the UIImageView instance into the view</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_image_view</span><span class="p">)</span>

    <span class="c1"># Load our custom UIView (KanjiView)</span>
    <span class="n">kanjiView</span> <span class="o">=</span> <span class="no">KanjiView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Add it to our view controller&#39;s view</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">kanjiView</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally lets open our <strong>app_delegate.rb</strong> and add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

    <span class="c1">#Create an instance of Kanji View Controller</span>
    <span class="n">kanji_view_controller</span> <span class="o">=</span> <span class="no">KanjiViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1">#Every window has a root view controller from which it will present its view</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">kanji_view_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run the app, you should see the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_InitialApplication.png" alt="Initial Application" />
</div>
<div class="title">Figure 69. Initial Application</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_responder_chain">The Responder Chain</h3>
<div class="paragraph"><p>If you look closely on the project that we just create, we have to implement a custom view called <strong>KanjiView</strong>. The purpose of this is that we can catch the touch events on it. But why on a UIView?</p></div>
<div class="paragraph"><p>When the user touch the screen a new event is created and send as a message to the first responder (The most foremost view in the hierarchy), if it cannot handle the message, is forwarded to the "next responder" and so on. This linked series is called <strong>Responder Chain</strong></p></div>
<div class="paragraph"><p>In iOS (not as same as Mac) both UIViews and UIViewControllers are part of the <strong>Responder Chain</strong>, but typically just the Views can handle the touch events, this happens because by default the UIViewControllers can not become fist responders</p></div>
<div class="paragraph"><p>According to the above we need a object that can become first responder and be in the responder chain so it can handle the touch events, this object generally is a UIView</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you need by any reason to handle the touch events on your controller, you can override the method <strong>canBecomeFirstResponder</strong> to allow it to become first responder</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_handling_the_touches">Handling the Touches</h3>
<div class="paragraph"><p>Now that we understand the Responder Chain, How to handle the touches? The response is implementing the following methods on our view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers) touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

<span class="c1"># This method is called when the finger (or fingers) are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

<span class="c1"># This method is called when the finger (or fingers) leave the screen</span>
<span class="k">def</span> <span class="nf">touchesEnded</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span><span class="n">event</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>For testing proposes lets implement it on our <strong>KanjiView</strong> the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="no">NSLog</span><span class="p">(</span><span class="s2">&quot;Touch %@ starting on %@&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSStringFromCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

<span class="k">end</span>

<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="no">NSLog</span><span class="p">(</span><span class="s2">&quot;Touch %@ moving to %@&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSStringFromCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

<span class="k">end</span>

<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># leave the screen</span>
<span class="k">def</span> <span class="nf">touchesEnded</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span><span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="no">NSLog</span><span class="p">(</span><span class="s2">&quot;Touch %@ ended at %@&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSStringFromCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run the application we should see the following when we touch the screen:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>&gt; Touch 1 starting on <span class="o">{</span>147, 305<span class="o">}</span>
&gt; Touch 2 starting on <span class="o">{</span>117, 205<span class="o">}</span>
&gt; Touch 1 moving to <span class="o">{</span>151, 297<span class="o">}</span>
&gt; Touch 2 moving to <span class="o">{</span>179, 327<span class="o">}</span>
&gt; Touch 1 moving to <span class="o">{</span>153, 294<span class="o">}</span>
&gt; Touch 2 moving to <span class="o">{</span>178, 323<span class="o">}</span>
&gt; Touch 1 moving to <span class="o">{</span>155, 289<span class="o">}</span>
&gt; Touch 2 moving to <span class="o">{</span>179, 326<span class="o">}</span>
&gt; Touch 1 ended at <span class="o">{</span>178, 319<span class="o">}</span>
&gt; Touch 2 ended at <span class="o">{</span>198, 119<span class="o">}</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Are you using the iOS Simulator? No problem! You can also simulate multiple touches pressing <strong>alt</strong> and if you need to move the multiple touches together press <strong>alt + shift</strong></td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_painting_the_touches">Painting the Touches</h3>
<div class="paragraph"><p>Now that we have detected the touches, its time to paint them on the screen. For that we will use a technology called CoreGraphics, but before we use it we need to understand some key concepts:</p></div>
<div class="ulist"><ul>
<li>
<p>
If we want to draw on a UIView using CoreGraphics we need to do it in a method called <strong>drawRect</strong>, its a override and you shouldn&#8217;t implemented unless your will draw something (It affects performance when its not drawing)
</p>
</li>
<li>
<p>
The drawing on a UIView using Core Graphics its not additive, what this means is that I can&#8217;t draw a line and then later when the user touches the screen draw another (I can&#8217;t  call <strong>drawRect</strong> manually). For that purpose we need to store which lines will be painted and then call <strong>setNeedsDisplay</strong>, this method will clear the entire view and then call <strong>drawRect</strong> again, forcing repainting everything again.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Using the above information lets implement the user touches on the screen:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method where we need to do the Core Graphics drawing</span>
<span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="c1"># Get the Core Graphics current context</span>
  <span class="n">context</span> <span class="o">=</span> <span class="no">UIGraphicsGetCurrentContext</span><span class="p">()</span>

  <span class="c1"># Set a color for drawing the touch points</span>
  <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set</span>

  <span class="c1"># Iterate the touch points</span>
  <span class="vi">@touch_points</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch_point</span> <span class="o">|</span>

    <span class="c1"># Move the context to the touch point</span>
    <span class="no">CGContextMoveToPoint</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Create a rect in which want to the ellipse be drawn</span>
    <span class="n">point_rect</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="mi">20</span><span class="p">,</span>
                            <span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Add the ellipse using the rect into the context</span>
    <span class="no">CGContextAddEllipseInRect</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">point_rect</span><span class="p">)</span>

    <span class="c1"># Draw the context into the view</span>
    <span class="no">CGContextFillPath</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="c1"># Add the point to our array, but because is a structure (CGPoint)</span>
    <span class="c1"># we need to store it on a NSValue</span>
<span class="hll">    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
</span>  <span class="p">}</span>

<span class="hll">  <span class="c1"># Ask the view to redraw again</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_InitialTouches.png" alt="Initial Touches" />
</div>
<div class="title">Figure 70. Initial Touches</div>
</div>
<div class="paragraph"><p>Great! Now we are really seeing where the user touches began, lets continue adding the touch movements:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you are using a simulator probably you will notice that the dot is painted down right of the cursor. This is normal because iOS handle the mouse click as the top left corner of a finger</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

<span class="hll">    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
</span>  <span class="p">}</span>

<span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_InitialLines.png" alt="Initial Lines" />
</div>
<div class="title">Figure 71. Initial Lines</div>
</div>
<div class="paragraph"><p>Now we are drawing the initial touches and the movement in the screen, it looks like a line but if we move the finger faster will become more like a dotted line right? No problem we will fix that later</p></div>
</div>
<div class="sect2">
<h3 id="_kanji_drawing">Kanji Drawing</h3>
<div class="paragraph"><p>We just play a bit with the touches and drawing for us to feel comfortable about how it works, lets do something more challenging:</p></div>
<div class="paragraph"><p>If we look on our background picture, we have a Kanji with traces marked with numbers. The objective is create a little game for the user to draw the Kanji, so our first task is to determinate if the user is following the traces or not</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_StartingPoints.png" alt="Starting Points" />
</div>
<div class="title">Figure 72. Starting Points</div>
</div>
<div class="paragraph"><p>The first thing we can do is to have an array of the trace starting coordinates, that will enable us to evaluate if the touch was on the beginning. Lets do a little experiment to test this part:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># In order to does not hide the background image on</span>
    <span class="c1"># the controllers view, we need to set the background color on</span>
    <span class="c1"># this view as transparent</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>

    <span class="c1"># Instance an Array for storing the user touches</span>
    <span class="vi">@touch_points</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

<span class="hll">    <span class="n">load_kanji_traces</span>
</span>  <span class="k">end</span>

  <span class="nb">self</span>

<span class="k">end</span>

<span class="k">def</span> <span class="nf">load_kanji_traces</span>

  <span class="c1"># Create an array to store our Kanji Paths</span>
  <span class="vi">@kanji_traces</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># As a experiment lets add only the starting point of</span>
  <span class="c1"># the trace number three</span>
  <span class="n">kanji_starting_trace_three</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>


  <span class="c1"># Add the point to the Kanji Paths array</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">kanji_starting_trace_three</span><span class="p">))</span>
<span class="k">end</span>



<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1"># We need to ask the touch for his location according</span>
  <span class="c1"># to the current view</span>
  <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>


<span class="hll">  <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Iterate through all the Kanji Paths available</span>
</span><span class="hll">  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">kanji_trace</span> <span class="o">|</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># If the touched point is equal to any Kanji Trace starting</span>
</span><span class="hll">    <span class="c1"># point</span>
</span><span class="hll">    <span class="k">if</span> <span class="no">CGPointEqualToPoint</span><span class="p">(</span><span class="n">kanji_trace</span><span class="o">.</span><span class="n">CGPointValue</span><span class="p">,</span> <span class="n">pointInView</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">      <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="hll">    <span class="k">end</span>
</span><span class="hll">  <span class="p">}</span>
</span>

<span class="hll">  <span class="c1"># If the touch was at the beginning of any Kanji Trace</span>
</span><span class="hll">  <span class="k">unless</span> <span class="n">touch_at_beginning</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add the point to our array, but because is a structure (CGPoint)</span>
</span><span class="hll">    <span class="c1"># we need to store it on a NSValue</span>
</span><span class="hll">    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Ask the view to redraw again</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Impossible do it with the first touch (Without moving the touch), right? This is because we are comparing a small point in the screen with a wide of a finger, making it difficult to touch with precision. The solution to this is creating a rectangle surrounding the starting trace point, so it will be more easy to hit it with the finger.</p></div>
<div class="paragraph"><p>Actually also we need to evaluate if the user is following the trace, and if it the trace ended where it should, for this we will use rectangles as well. In the light of this is better to create a object for all this variables.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Remember it does not matter if it is a point, rectangle or a button, it needs to be bigger enough for the user to touch</td>
</tr></table>
</div>
<div class="paragraph"><p>Lets create our new class <strong>KanjiTrace</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>mkdir models

<span class="nv">$ </span><span class="nb">cd </span>models

<span class="nv">$ </span>touch kanji_trace.rb

<span class="nv">$ </span>open kanji_trace.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">KanjiTrace</span>

  <span class="no">SURROUND_SIZE</span> <span class="o">=</span> <span class="mi">40</span>

  <span class="kp">attr_accessor</span> <span class="ss">:starting_point</span>
  <span class="kp">attr_accessor</span> <span class="ss">:end_point</span>


  <span class="k">def</span> <span class="nf">initial_rectangle</span>

    <span class="no">CGRectMake</span><span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="n">starting_point</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">final_rectangle</span>

    <span class="no">CGRectMake</span><span class="p">(</span><span class="n">end_point</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="n">end_point</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great! Now we have a object containing the trace start and end points and it return the surrounding rectangles. Lets implement the <strong>KanjiTrace</strong> class into our <strong>kanji_view.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>open kanji_view.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_kanji_traces</span>

  <span class="c1"># Create an array to store our Kanji Paths</span>
  <span class="vi">@kanji_traces</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


<span class="hll">  <span class="c1"># Continuing the experiment create only a Kanji Trace</span>
</span><span class="hll">  <span class="c1"># for the trace number three</span>
</span><span class="hll">  <span class="n">trace_three</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">trace_three</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the point to the Kanji Paths array</span>
</span><span class="hll">  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_three</span><span class="p">)</span>
</span><span class="k">end</span>



<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1"># We need to ask the touch for his location according</span>
  <span class="c1"># to the current view</span>
  <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>


  <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Iterate through all the Kanji Paths available</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">kanji_trace</span> <span class="o">|</span>

    <span class="c1"># If the touched point is equal to any Kanji Trace starting</span>
    <span class="c1"># point</span>
    <span class="k">if</span> <span class="no">CGRectContainsPoint</span><span class="p">(</span><span class="n">kanji_trace</span><span class="o">.</span><span class="n">initial_rectangle</span><span class="p">,</span> <span class="n">pointInView</span><span class="p">)</span>

<span class="hll">      <span class="c1"># Assign the trace that the user is currently</span>
</span><span class="hll">      <span class="c1"># drawing</span>
</span><span class="hll">      <span class="vi">@current_trace</span> <span class="o">=</span> <span class="n">kanji_trace</span>
</span>      <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="p">}</span>


<span class="hll">  <span class="c1"># If the touch was at the beginning of any Kanji Trace</span>
</span><span class="hll">  <span class="k">if</span> <span class="n">touch_at_beginning</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add the point to our array, but because is a structure (CGPoint)</span>
</span><span class="hll">    <span class="c1"># we need to store it on a NSValue</span>
</span><span class="hll">    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Ask the view to redraw again</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</span><span class="hll">
</span><span class="hll">  <span class="k">else</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># If there is no touch at the beginning means</span>
</span><span class="hll">    <span class="c1"># that the user is not drawing a new trace</span>
</span><span class="hll">    <span class="vi">@current_trace</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_StartTrace3.png" alt="Start Trace #3" />
</div>
<div class="title">Figure 73. Start Trace #3</div>
</div>
<div class="paragraph"><p>Is working now! Is more easy for the user to touch the start of the trace, so lets continue adding the all the Kanji Traces:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_kanji_traces</span>

  <span class="c1"># Create an array to store our Kanji Paths</span>
  <span class="vi">@kanji_traces</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


  <span class="n">trace_one</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_one</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
  <span class="n">trace_one</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">273</span><span class="p">,</span> <span class="mi">282</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_one</span><span class="p">)</span>


  <span class="n">trace_two</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_two</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">155</span><span class="p">,</span> <span class="mi">285</span><span class="p">)</span>
  <span class="n">trace_two</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">289</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_two</span><span class="p">)</span>


  <span class="c1"># Continuing the experiment create only a Kanji Trace</span>
  <span class="c1"># for the trace number three</span>
  <span class="n">trace_three</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_three</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>
  <span class="n">trace_three</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">152</span><span class="p">,</span> <span class="mi">367</span><span class="p">)</span>

  <span class="c1"># Add the point to the Kanji Paths array</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_three</span><span class="p">)</span>


  <span class="n">trace_four</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_four</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
  <span class="n">trace_four</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">294</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_four</span><span class="p">)</span>


  <span class="n">trace_five</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_five</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">225</span><span class="p">,</span> <span class="mi">175</span><span class="p">)</span>
  <span class="n">trace_five</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">140</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_five</span><span class="p">)</span>


  <span class="n">trace_six</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_six</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">219</span><span class="p">,</span> <span class="mi">202</span><span class="p">)</span>
  <span class="n">trace_six</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">277</span><span class="p">,</span> <span class="mi">237</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_six</span><span class="p">)</span>


  <span class="n">trace_seven</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_seven</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">69</span><span class="p">,</span> <span class="mi">191</span><span class="p">)</span>
  <span class="n">trace_seven</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_seven</span><span class="p">)</span>


  <span class="n">trace_eight</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_eight</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">211</span><span class="p">)</span>
  <span class="n">trace_eight</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">247</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_eight</span><span class="p">)</span>


  <span class="n">trace_nine</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_nine</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">109</span><span class="p">,</span> <span class="mi">171</span><span class="p">)</span>
  <span class="n">trace_nine</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">185</span><span class="p">,</span> <span class="mi">159</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_nine</span><span class="p">)</span>


  <span class="n">trace_ten</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_ten</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">171</span><span class="p">)</span>
  <span class="n">trace_ten</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">186</span><span class="p">,</span> <span class="mi">241</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_ten</span><span class="p">)</span>


  <span class="n">trace_eleven</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_eleven</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">175</span><span class="p">,</span> <span class="mi">227</span><span class="p">)</span>
  <span class="n">trace_eleven</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_eleven</span><span class="p">)</span>


  <span class="n">trace_twelve</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_twelve</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">223</span><span class="p">)</span>
  <span class="n">trace_twelve</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">181</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_twelve</span><span class="p">)</span>


  <span class="n">trace_thirteen</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_thirteen</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">161</span><span class="p">)</span>
  <span class="n">trace_thirteen</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">129</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_thirteen</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_AllStartingTraces.png" alt="All Starting Traces" />
</div>
<div class="title">Figure 74. All Starting Traces</div>
</div>
<div class="paragraph"><p>Yes! We can start painting on any trace now, so lets continue adding a method to our <strong>KanjiTrace</strong> for evaluate if the user is following the line and assigning a score for the drawing:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>models

<span class="nv">$ </span>open <span class="s2">&quot;kanji_trace.rb&quot;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kp">attr_reader</span> <span class="ss">:accurate_points</span>

<span class="k">def</span> <span class="nf">evaluate_point</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

  <span class="c1"># Lets create properties to store the accurate touches of</span>
  <span class="c1"># the user and the missing ones</span>
  <span class="vi">@accurate_points</span> <span class="o">||=</span> <span class="mi">0</span>
  <span class="vi">@missing_points</span> <span class="o">||=</span> <span class="mi">0</span>

  <span class="c1"># The next step is creating a surrounding rectangle for the</span>
  <span class="c1"># trace, make it more easy for the user to touch</span>
  <span class="n">trace_rect</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="o">[</span><span class="n">starting_point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end_point</span><span class="o">.</span><span class="n">x</span><span class="o">].</span><span class="n">min</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
                          <span class="o">[</span><span class="n">starting_point</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">end_point</span><span class="o">.</span><span class="n">y</span><span class="o">].</span><span class="n">min</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">end_point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span> <span class="o">+</span> <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">end_point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span> <span class="o">+</span> <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>


  <span class="c1"># If the point is in the trace</span>
  <span class="k">if</span> <span class="no">CGRectContainsPoint</span><span class="p">(</span><span class="n">trace_rect</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

    <span class="c1"># Add one to the accurate points</span>
    <span class="vi">@accurate_points</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">else</span>

    <span class="c1"># Add one to the missing points</span>
    <span class="vi">@missing_points</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Our <strong>KanjiTrace</strong> is now evaluating and recording the score, next step is to used in our <strong>kanji_view.rb</strong> on the touchesMoved method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>views

<span class="nv">$ </span>open kanji_view.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1"># We need to ask the touch for his location according</span>
  <span class="c1"># to the current view</span>
  <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>


<span class="hll">  <span class="c1"># If the user is drawing a trace</span>
</span><span class="hll">  <span class="k">unless</span> <span class="vi">@current_trace</span><span class="o">.</span><span class="n">nil?</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add the touch point into the array, so it can be</span>
</span><span class="hll">    <span class="c1"># drawing later</span>
</span><span class="hll">    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Evaluate how accurate is the touch in relationship</span>
</span><span class="hll">    <span class="c1"># to the trace</span>
</span><span class="hll">    <span class="vi">@current_trace</span><span class="o">.</span><span class="n">evaluate_point</span><span class="p">(</span><span class="n">pointInView</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Ask for repainting</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Yeah now we are keeping a score about how accurate is the user drawing, but we are not doing nothing with it! Our next step is just about that!</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_PaintedTrace.png" alt="Painted Trace" />
</div>
<div class="title">Figure 75. Painted Trace</div>
</div>
</div>
<div class="sect2">
<h3 id="_high_score">High Score!</h3>
<div class="paragraph"><p>So as the Kanji description tell us is that is a technique for building cups of tea, so what about adding some disable cups on the top of the app to symbolize the score of the user (3 disable cups mean 0 right?)</p></div>
<div class="paragraph"><p>So the first thing will be copy the images in <strong>resources/images</strong> folder into our app resource&#8217;s folder, next add the follow to the <strong>kanji_view.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># In order to does not hide the background image on</span>
    <span class="c1"># the controllers view, we need to set the background color on</span>
    <span class="c1"># this view as transparent</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>

    <span class="c1"># Instance an Array for storing the user touches</span>
    <span class="vi">@touch_points</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

<span class="hll">    <span class="n">layout_cups</span>
</span>    <span class="n">load_kanji_traces</span>

  <span class="k">end</span>

  <span class="nb">self</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_cups</span>

  <span class="n">first_cup_frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

  <span class="vi">@first_cup_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">first_cup_frame</span><span class="p">)</span>

  <span class="vi">@first_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOff1.png&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@first_cup_image_view</span><span class="p">)</span>


  <span class="n">second_cup_frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

  <span class="vi">@second_cup_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">second_cup_frame</span><span class="p">)</span>

  <span class="vi">@second_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOff2.png&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@second_cup_image_view</span><span class="p">)</span>


  <span class="n">thrid_cup_frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

  <span class="vi">@thrid_cup_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">thrid_cup_frame</span><span class="p">)</span>

  <span class="vi">@thrid_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOff3.png&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@thrid_cup_image_view</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_ScoreBoard.png" alt="Score Board" />
</div>
<div class="title">Figure 76. Score Board</div>
</div>
<div class="paragraph"><p>The last part of the exercise consist of analyzing the score of all the traces and according to that change the images of the cups. Making a little scoreboard!</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method where we need to do the Core Graphics drawing</span>
<span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

<span class="hll">  <span class="n">update_score_board</span>
</span>
  <span class="c1"># Get the Core Graphics current context</span>
  <span class="n">context</span> <span class="o">=</span> <span class="no">UIGraphicsGetCurrentContext</span><span class="p">()</span>

  <span class="c1"># Set a color for drawing the touch points</span>
  <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">set</span>

  <span class="c1"># Iterate the touch points</span>
  <span class="vi">@touch_points</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch_point</span> <span class="o">|</span>

    <span class="c1"># Move the context to the touch point</span>
    <span class="no">CGContextMoveToPoint</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

  <span class="c1"># Create a rect in which want to the ellipse be drawen</span>
  <span class="n">point_rect</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                          <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                          <span class="mi">20</span><span class="p">,</span>
                          <span class="mi">20</span><span class="p">)</span>

  <span class="c1"># Add the ellipse using the rect into the context</span>
  <span class="no">CGContextAddEllipseInRect</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">point_rect</span><span class="p">)</span>

  <span class="c1"># Draw the context into the view</span>
  <span class="no">CGContextFillPath</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">update_score_board</span>

  <span class="n">total_accurate_points</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">kanji_trace</span> <span class="o">|</span>

      <span class="k">unless</span> <span class="n">kanji_trace</span><span class="o">.</span><span class="n">accurate_points</span><span class="o">.</span><span class="n">nil?</span>

        <span class="n">total_accurate_points</span> <span class="o">+=</span> <span class="n">kanji_trace</span><span class="o">.</span><span class="n">accurate_points</span>
      <span class="k">end</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">total_accurate_points</span> <span class="o">&gt;=</span> <span class="mi">100</span>

    <span class="vi">@first_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOn1.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">total_accurate_points</span> <span class="o">&gt;=</span> <span class="mi">300</span>

    <span class="vi">@second_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOn2.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">total_accurate_points</span> <span class="o">&gt;=</span> <span class="mi">500</span>

    <span class="vi">@thrid_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOn3.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_HighScore.png" alt="High Score" />
</div>
<div class="title">Figure 77. High Score</div>
</div>
<div class="paragraph"><p>Now is finished! It looks like it will need some animations for the cups to look amazing, in the next chapters we will see how to make animations</p></div>
</div>
<div class="sect2">
<h3 id="_challenges_2">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Restart the game when the user double tap the screen (Hint: tapCount)
</p>
</li>
<li>
<p>
Implement a point subtraction of the trace score, when the user draws outside the trace, but without loosing the ability to  get the maximum score
</p>
</li>
<li>
<p>
The current implementation is drawing every point into the view, the challenge is change that into drawing just one line starting in the first touch and ending when the user removes the finger (Hint: CGContextAddLineToPoint)
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="_chapter_20_calayers">Chapter 20 - CALayers</h1>
<div class="paragraph"><p>In this chapter we will use a Cocoa Touch Framework called Core Animation. This framework is has two main purposes: Composition and Animation, taking this as base we will look into the Composition part first.</p></div>
<div class="sect1">
<h2 id="_composition">Composition</h2>
<div class="sectionbody">
<div class="paragraph"><p>Speaking in terms of Visual Arts, the term <strong>Composition</strong> is the placement or arrangement of visual elements to integrate a work of art. The Visual Artists (Most of them Graphical Designers) execute this technique in Photographs, Paints, or Designs.</p></div>
<div class="paragraph"><p>Until this part of the course we just have seen an object used to draw something in the screen: The <strong>UIView</strong>. Speaking in terms of memory and performance the UIView is a heavyweight champion, what this means is that it takes a lot of resources to animate it or display multiple of them on the screen. (You can try it! Load more than 50 UIViews with different colors on any project).</p></div>
<div class="paragraph"><p>Because of this if we want to create a complex composition we need a more light object, and it is called "CALayer". If the UIViews are a 1 Dollar in terms of memory and performance, the CALayer is 15 Cents.</p></div>
<div class="paragraph"><p>So the next question will be, why we are still using UIViews? The correct answer is that the CALayers have less features like the support for gestures, easy custom drawing using Core Graphics (You can do it on the CALayer but is more complex to implement), auto resizing masks. Besides what you will see in terms of implementation in the following exercises.</p></div>
<div class="paragraph"><p>Said this its a great time to start coding:</p></div>
<div class="sect2">
<h3 id="_initial_project">Initial Project</h3>
<div class="paragraph"><p>As we have seen through the course, the way to create a new Project is the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Layers
</pre></div></div></div>
<div class="paragraph"><p>For us to use the Core Animation Framework first we need to add it to the app, open the <strong>Rake File</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>Layers

<span class="nv">$ </span>open Rakefile
</pre></div></div></div>
<div class="paragraph"><p>To add a new framework to the app, you need to add the last line in the method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="ss">Motion</span><span class="p">:</span><span class="ss">:Project</span><span class="o">::</span><span class="no">App</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>

  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
  <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Layers&#39;</span>

  <span class="n">app</span><span class="o">.</span><span class="n">frameworks</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;QuartzCore&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next we need to add a View Controller where we will implement a CALayer, lets call it <strong>Layer View Controller</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch layer_view_controller.rb

<span class="nv">$ </span>open layer_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Add the following code to our new file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LayerViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="c1"># Lets create a view for our view controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">255</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># When we create a new instance of a CALayer, the designated initializer</span>
    <span class="c1"># is the following one</span>
    <span class="n">red_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
    <span class="n">red_layer</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span><span class="o">.</span><span class="n">CGColor</span>

    <span class="c1"># A difference from a UIView is that the CALayer uses the frame only</span>
    <span class="c1"># to determine its size, the position is set in the position property</span>
    <span class="c1"># this is required because the Layers has it position in the center of it</span>
    <span class="c1"># instead of top left corner, like the UIView.</span>
    <span class="n">red_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">red_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="c1"># The view has a property called layer, every UIView has a layer inside</span>
    <span class="c1"># it. So we can add our layer as a sublayer of that one.</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">red_layer</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take a moment to understand the changes related to the coordinate system on the CALayer (Hint: Frame &amp; Position)</td>
</tr></table>
</div>
<div class="paragraph"><p>Lets continue opening the Application Delegate and adding the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

  <span class="c1">#Create an instance of Layer View Controller</span>
  <span class="n">layer_view_controller</span> <span class="o">=</span> <span class="no">LayerViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1">#Every window has a root view controller from which it will present its view</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">layer_view_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run the App you must see the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL1.png" alt="Initial Run" />
</div>
<div class="title">Figure 78. Initial Run</div>
</div>
</div>
<div class="sect2">
<h3 id="_changing_layers">Changing Layers</h3>
<div class="paragraph"><p>Lets use a little of REPL to illustrate some points, please look at your terminal at the same time with the simulator, and execute the following:</p></div>
<div class="paragraph"><p>First select the blue view using CMD + click on it, later run this on your console:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer = self.layer.sublayers.objectAtIndex(0)</span>
<span class="o">=</span>&gt; <span class="c">#&lt;CALayer:0x000000&gt;</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Take note that you can not select Layers using the CMD + click</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.backgroundColor = UIColor.colorWithRed(0.957, green:0.824, blue:0.184, alpha:1.0).CGColor</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL2.png" alt="Yellow Square" />
</div>
<div class="title">Figure 79. Yellow Square</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.position = CGPointMake(100, 100)</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL3.png" alt="Yellow Square in a Different Position" />
</div>
<div class="title">Figure 80. Yellow Square in a Different Position</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.cornerRadius = 20</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL4.png" alt="Yellow Square with Rounded Corners" />
</div>
<div class="title">Figure 81. Yellow Square with Rounded Corners</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.borderWidth = 10</span>
<span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.borderColor = UIColor.colorWithRed(0.988, green:0.604, blue:0.153, alpha:1.0).CGColor</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL5.png" alt="Yellow Square with Border" />
</div>
<div class="title">Figure 82. Yellow Square with Border</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.shadowRadius = 5.0</span>
<span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.shadowColor = UIColor.blackColor.CGColor</span>
<span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.shadowOpacity = 0.65</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL6.png" alt="Yellow Square with Shadow" />
</div>
<div class="title">Figure 83. Yellow Square with Shadow</div>
</div>
<div class="paragraph"><p>They are two things important in this part, the first is that you can manipulate the appearance in more ways using a CALayer than a UIView like the Rounded Corners, Shadows, etc. Also if you look closely you must see that when you change some properties of the layer it animates it self, we will look into more deeply later on.</p></div>
</div>
<div class="sect2">
<h3 id="_putting_the_things_together">Putting the things together</h3>
<div class="paragraph"><p>Now that we have see the CALayers in action, is time to do somethings more complicated. Open your LayerViewController and add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open layer_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

<span class="hll">  <span class="c1"># Lets create a view for our view controller</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">layout_background_layer</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_background_layer</span>

  <span class="c1"># We need a new type of layer used to create Gradients</span>
  <span class="vi">@background_layer</span> <span class="o">=</span> <span class="no">CAGradientLayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>

  <span class="c1"># Initialize the colors of the gradient, it can have any number of colors</span>
  <span class="c1"># in this case we will use only three</span>
  <span class="n">top_background_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">131</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">387</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">618</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>
  <span class="n">middle_background_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">255</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>
  <span class="n">bottom_background_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">367</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">692</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>

  <span class="c1"># Set the colors in the layer using an array</span>
  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithObjects</span><span class="p">(</span><span class="n">top_background_color</span><span class="p">,</span>
                                                     <span class="n">middle_background_color</span><span class="p">,</span>
                                                     <span class="n">bottom_background_color</span><span class="p">,</span>
                                                     <span class="kp">nil</span><span class="p">)</span>

  <span class="c1"># Set the colors locations into the array, this means where it will start painting</span>
  <span class="c1"># the color, if you look closely we are telling the layer to paint the top color in</span>
  <span class="c1"># 0.0 which is the top, the middle in 0.5 and 0.0 for the bottom color</span>
  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithObjects</span><span class="p">(</span><span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">),</span>
                                                        <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">),</span>
                                                        <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">),</span>
                                                        <span class="kp">nil</span><span class="p">)</span>

  <span class="c1"># We want this layer to be the background of our app</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">insertSublayer</span><span class="p">(</span><span class="vi">@background_layer</span><span class="p">,</span> <span class="ss">atIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_GradientBackground.png" alt="Background with Gradient" />
</div>
<div class="title">Figure 84. Background with Gradient</div>
</div>
<div class="paragraph"><p>Easy right? We create a nice background for our app using a gradient. Lets continue adding some grass into the composition:</p></div>
<div class="paragraph"><p>Please copy the grass images from the <strong>resources/images</strong> folder into our app resources folder, after that add the following method to our <strong>LayerViewController</strong> class</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
<span class="hll">  <span class="n">layout_grass_layer</span>
</span><span class="k">end</span>

<span class="k">def</span> <span class="nf">layout_grass_layer</span>

  <span class="c1">#Lets instance a new layer for containing our grass image</span>
  <span class="n">grass_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">grass_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>

  <span class="c1">#Load the image into memory</span>
  <span class="n">grassImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgGrass.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">grass_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">grassImage</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">grass_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_GrassLayer.png" alt="Grass Layer" />
</div>
<div class="title">Figure 85. Grass Layer</div>
</div>
<div class="paragraph"><p>Great! Now you see that we are compositing two layers together and learn that you can also include an Image as a content. But how about drawing custom figures? Add the following to the <strong>LayerViewController</strong> class:</p></div>
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
<span class="hll">  <span class="n">layout_sun_layer</span>
</span>  <span class="n">layout_grass_layer</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_sun_layer</span>

  <span class="c1"># Create a new type of layer, in this case CAShapeLayer</span>
  <span class="vi">@sun_layer</span> <span class="o">=</span> <span class="no">CAShapeLayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

  <span class="c1"># Set some color for the figure fill and the stroke</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">fillColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">957</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">824</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">184</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">strokeColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">604</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">153</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>

  <span class="c1"># We need to set a line width of 10 for this particular figure</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">lineWidth</span> <span class="o">=</span> <span class="mi">10</span>


  <span class="c1"># The following part is the path that composes the figure</span>
  <span class="c1"># point by point into the layer</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>

  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">91</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">48</span><span class="o">.</span><span class="mi">53</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">91</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">48</span><span class="o">.</span><span class="mi">53</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">106</span><span class="o">.</span><span class="mo">00</span><span class="p">,</span> <span class="mi">41</span><span class="o">.</span><span class="mi">88</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">114</span><span class="o">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">55</span><span class="o">.</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">130</span><span class="o">.</span><span class="mi">99</span><span class="p">,</span> <span class="mi">57</span><span class="o">.</span><span class="mi">94</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">131</span><span class="o">.</span><span class="mi">11</span><span class="p">,</span> <span class="mi">74</span><span class="o">.</span><span class="mi">21</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">143</span><span class="o">.</span><span class="mi">33</span><span class="p">,</span> <span class="mi">84</span><span class="o">.</span><span class="mi">95</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">134</span><span class="o">.</span><span class="mi">63</span><span class="p">,</span> <span class="mi">98</span><span class="o">.</span><span class="mi">71</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">139</span><span class="o">.</span><span class="mi">10</span><span class="p">,</span> <span class="mi">114</span><span class="o">.</span><span class="mi">35</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">124</span><span class="o">.</span><span class="mi">35</span><span class="p">,</span> <span class="mi">121</span><span class="o">.</span><span class="mi">22</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">119</span><span class="o">.</span><span class="mi">65</span><span class="p">,</span> <span class="mi">136</span><span class="o">.</span><span class="mi">80</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">103</span><span class="o">.</span><span class="mi">53</span><span class="p">,</span> <span class="mi">134</span><span class="o">.</span><span class="mi">60</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">91</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">145</span><span class="o">.</span><span class="mi">17</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">78</span><span class="o">.</span><span class="mi">78</span><span class="p">,</span> <span class="mi">134</span><span class="o">.</span><span class="mi">60</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">62</span><span class="o">.</span><span class="mi">66</span><span class="p">,</span> <span class="mi">136</span><span class="o">.</span><span class="mi">80</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">57</span><span class="o">.</span><span class="mi">96</span><span class="p">,</span> <span class="mi">121</span><span class="o">.</span><span class="mi">22</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">43</span><span class="o">.</span><span class="mi">21</span><span class="p">,</span> <span class="mi">114</span><span class="o">.</span><span class="mi">35</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">47</span><span class="o">.</span><span class="mi">68</span><span class="p">,</span> <span class="mi">98</span><span class="o">.</span><span class="mi">71</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">38</span><span class="o">.</span><span class="mi">98</span><span class="p">,</span> <span class="mi">84</span><span class="o">.</span><span class="mi">95</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">51</span><span class="o">.</span><span class="mi">20</span><span class="p">,</span> <span class="mi">74</span><span class="o">.</span><span class="mi">21</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">51</span><span class="o">.</span><span class="mi">32</span><span class="p">,</span> <span class="mi">57</span><span class="o">.</span><span class="mi">94</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">67</span><span class="o">.</span><span class="mi">41</span><span class="p">,</span> <span class="mi">55</span><span class="o">.</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">76</span><span class="o">.</span><span class="mi">31</span><span class="p">,</span> <span class="mi">41</span><span class="o">.</span><span class="mi">88</span><span class="p">))</span>

  <span class="n">sun_path</span><span class="o">.</span><span class="n">closePath</span>

  <span class="c1"># Set the path into the layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span><span class="p">;</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_SunLayer.png" alt="Sun Layer" />
</div>
<div class="title">Figure 86. Sun Layer</div>
</div>
</div>
<div class="sect2">
<h3 id="_implicit_animations">Implicit Animations</h3>
<div class="paragraph"><p>When you change some properties of a CALayer at run time, what happens is that the properties are modified in an animated way. This properties that trigger animations are called <strong>Animatable Properties</strong>, and some of them are the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
anchorPoint
</p>
</li>
<li>
<p>
backgroundColor
</p>
</li>
<li>
<p>
borderColor
</p>
</li>
<li>
<p>
borderWidth
</p>
</li>
<li>
<p>
bounds
</p>
</li>
<li>
<p>
cornerRadius
</p>
</li>
<li>
<p>
mask
</p>
</li>
<li>
<p>
opacity
</p>
</li>
<li>
<p>
position
</p>
</li>
<li>
<p>
shadowColor
</p>
</li>
<li>
<p>
shadowOffset
</p>
</li>
<li>
<p>
shadowOpacity
</p>
</li>
<li>
<p>
shadowRadius
</p>
</li>
</ul></div>
<div class="paragraph"><p>For this to happen a process works inside of Core Animation called <strong>Interpolation</strong>, the best way to explain it is using a example:</p></div>
<div class="paragraph"><p>Lets say that you implemented a layer, but its needed when the user touches the screen to disappear the layer. Do this is pretty straight forward, just set the opacity property to 0.0. Inside Core Animation the next will happen:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Because we are using a implicit animation, the default time for the whole animation is 0.3
</p>
</li>
<li>
<p>
Core Animation calculates the value at every millisecond that takes to execute the animation. Starting at second 0 with 1.0, 0.1 with 0.65, 0.2 with 0.45, 0.3 with 0.0. This process of determining the values of a property (or properties) at every given time of the animation is called <strong>Interpolation</strong>
</p>
</li>
<li>
<p>
Then the resulting matrix property values and times is executed, giving the effect that the layer is being animated.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If you think it its similar that the old cartoon animation process. Having the mouse drawn frame by frame and flipping them it quickly does the same trick.</p></div>
<div class="paragraph"><p>Enough of theory, lets do this in a practical way. Insert the following to the <strong>LayerViewController</strong> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_grass_layer</span>

<span class="hll">  <span class="c1"># Instantiate a gesture recognizer to handle the user touch</span>
</span><span class="hll">  <span class="n">tap_gesture_recognizer</span> <span class="o">=</span> <span class="no">UITapGestureRecognizer</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                                       <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;view_tap:&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>

  <span class="c1">#Apply the position to our Sun Layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">tap_point_in_view</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now when you touch the screen the sun layer will animate to that particular position. Try another appearance changes or look again in the REPL part of the exercise.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_AnimatedLayer.png" alt="Sun Layer" />
</div>
<div class="title">Figure 87. Animated Layer</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenges_3">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
At the same time the sun layer is moving to a new position, rotate it like it was spinning. (HINT: CGTransformationMatrix)
</p>
</li>
<li>
<p>
Change the background of the application when the sun layer is on top, and on bottom. Like if it was sunrise, dawn and night
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="_chapter_21_core_animation">Chapter 21 - Core Animation</h1>
<div class="paragraph"><p>In this chapter we will continue learning Core Animation implementing more complex animations and transitions.</p></div>
<div class="paragraph"><p>Lets begin! When you need more control on the animation, lets say move the layer along a path, control the duration or some easing, its required that you implement a explicit animation.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Easing</div>
<div class="paragraph"><p>Easing means to control the acceleration or deceleration of the objects in the animation. This is used to simulate real life forces like friction or gravity.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Next we will look into the most basic type of explicit animations, CABasicAnimation</p></div>
<div class="sect1">
<h2 id="_cabasicanimation">CABasicAnimation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Its a single key-frame animation, this means that you can only set the initial and final step of such application. An proper example will illustrate this better:</p></div>
<div class="paragraph"><p>You need to move a layer from point A to point B. The initial step is A and the final is B, this is case of a single key-frame, but if you need to move from point A passing through point C, then point D and finally B this is a multi key-frame, which will cover it later.</p></div>
<div class="paragraph"><p>In this perspective this kind of explicit animations are a lot like the implicit ones, the difference is that you can have more control on it like:</p></div>
<div class="ulist"><ul>
<li>
<p>
Setting some delay on the animation
</p>
</li>
<li>
<p>
Know when the animation finished
</p>
</li>
<li>
<p>
Animation duration
</p>
</li>
<li>
<p>
Combine multiple animations at once
</p>
</li>
<li>
<p>
Reverse the animation on finish
</p>
</li>
<li>
<p>
Repeat the animation indefinitely
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first thing we can do is change the sun move animation which is implicit to a explicit one, for this lets open our <strong>Layer</strong> project, and edit the <strong>view_tap</strong> method to look like the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


<span class="hll">  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
</span><span class="hll">  <span class="c1"># to set which property we want to animate. In this case the property</span>
</span><span class="hll">  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
</span><span class="hll">  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set the animation duration</span>
</span><span class="hll">  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># We need to set the initial value of the animation and the final one,</span>
</span><span class="hll">  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</span><span class="hll">  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
</span><span class="hll">  <span class="c1"># name for it, in this case position_animation. The name is used</span>
</span><span class="hll">  <span class="c1"># if later we need to access the animation again in another part of the code</span>
</span><span class="hll">  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationBlinkToStart.png" alt="Animation Blinking to Start" />
</div>
<div class="title">Figure 88. Animation Blinking to Start</div>
</div>
<div class="paragraph"><p>Uh? What happen? The sun move to the position we touch, but at the end of the animation it return to its initial value. This happens because the animation is independent of the layer that is running into, it will move the layer to the touch position but at the end if you don&#8217;t change the layer property it will return to the initial state.</p></div>
<div class="paragraph"><p>Try the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>


<span class="hll">  <span class="c1"># Change the layer property that we want to be animated, the position of</span>
</span><span class="hll">  <span class="c1"># this line is important. It must be before the addAnimation message.</span>
</span><span class="hll">  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">tap_point_in_view</span>
</span>
  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationComplete.png" alt="Animation Complete" />
</div>
<div class="title">Figure 89. Animation Complete</div>
</div>
<div class="paragraph"><p>Now it works as expected! The animation is pretty slow because we set to it 1 second, try changing it for more fun.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Interpolation</div>
<div class="paragraph"><p>Did you notice that close the distance of the animation is more slow? This is because it has to cover less distance in the same duration.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Lets try something new, reverse the animation once is finished. This is accomplished with the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Tell the animation that we need to reverse at finish</span>
</span><span class="hll">  <span class="n">animation</span><span class="o">.</span><span class="n">autoreverses</span> <span class="o">=</span> <span class="kp">true</span>
</span>
  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationReturningToStartingPoint.png" alt="Animation Returning to Starting Point" />
</div>
<div class="title">Figure 90. Animation Returning to Starting Point</div>
</div>
<div class="paragraph"><p>If we want to make that cycle of moving and returning happen 100 times?</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Tell the animation that we need to reverse at finish</span>
</span><span class="hll">  <span class="n">animation</span><span class="o">.</span><span class="n">autoreverses</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set the repeat count to 100</span>
</span><span class="hll">  <span class="n">animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="mi">100</span>
</span>
  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationLoop.png" alt="Animation Loop" />
</div>
<div class="title">Figure 91. Animation Loop</div>
</div>
<div class="paragraph"><p>What about combining two animations: a spinning one with the moving one</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


<span class="hll">  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
</span><span class="hll">  <span class="c1"># to set which property we want to animate. In this case the property</span>
</span><span class="hll">  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
</span><span class="hll">  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set the animation duration</span>
</span><span class="hll">  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># We need to set the initial value of the animation and the final one</span>
</span><span class="hll">  <span class="n">translation_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</span><span class="hll">  <span class="n">translation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Change the layer property that we want to be animated, the position of</span>
</span><span class="hll">  <span class="c1"># this line is important. It must be before the addAnimation message.</span>
</span><span class="hll">  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">tap_point_in_view</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
</span><span class="hll">  <span class="c1"># name for it, in this case position animation. The name is used</span>
</span><span class="hll">  <span class="c1"># if later we need to access the animation again in another part of the code</span>
</span><span class="hll">  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;translation_animation&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
</span><span class="hll">  <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
</span><span class="hll">  <span class="c1"># y axis</span>
</span><span class="hll">  <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
</span><span class="hll">  <span class="c1"># thats why the conversion PI * 2</span>
</span><span class="hll">  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="ss">Math</span><span class="p">:</span><span class="ss">:PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set the duration according with the other animation</span>
</span><span class="hll">  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the animation to the layer</span>
</span><span class="hll">  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;rotation_animation&#39;</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationSpinning.png" alt="Animation Spinning and Moving" />
</div>
<div class="title">Figure 92. Animation Spinning and Moving</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_moving_the_clouds">Moving the clouds</h2>
<div class="sectionbody">
<div class="paragraph"><p>The sun looks a little lonely right? What about adding some clouds and make them move across the screen?</p></div>
<div class="paragraph"><p>The first step is adding the images of the clouds, please copy them from <strong>resources/images</strong> folder into the resources folder of the app.</p></div>
<div class="paragraph"><p>Next lets add the layers into our view, in the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1"># Instantiate a gesture recognizer to handle the user touch</span>
  <span class="n">tap_gesture_recognizer</span> <span class="o">=</span> <span class="no">UITapGestureRecognizer</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                                                       <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;view_tap:&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
<span class="hll">  <span class="n">layout_cloud_layers</span>
</span>  <span class="n">layout_grass_layer</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">layout_cloud_layers</span>

  <span class="c1">#Lets instance a new layer for our first cloud image</span>
  <span class="n">first_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">82</span><span class="p">)</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="c1">#Load the image into memory</span>
  <span class="n">first_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud1.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">first_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="p">)</span>


  <span class="c1"># New layer for our second cloud image</span>
  <span class="n">second_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud2.png&quot;</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">second_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">second_cloud_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run now the application, you should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunAndClouds.png" alt="Sun & Clouds" />
</div>
<div class="title">Figure 93. Sun &amp; Clouds</div>
</div>
<div class="paragraph"><p>Pretty but not amazing!, Now lets add some animation to the clouds:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_cloud_layers</span>

  <span class="c1"># Lets instance a new layer for our first cloud image</span>
  <span class="n">first_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">82</span><span class="p">)</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">153</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="c1"># Load the image into memory</span>
  <span class="n">first_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud1.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">first_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="p">)</span>


<span class="hll">  <span class="c1"># Instanciate a new animation for the first cloud move</span>
</span><span class="hll">  <span class="n">first_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">   <span class="c1"># Set the animation duration</span>
</span><span class="hll">  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">7</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># We need to set the initial value of the animation and the final one</span>
</span><span class="hll">  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Final position for the first cloud</span>
</span><span class="hll">  <span class="n">first_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">473</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_final_position</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
</span><span class="hll">  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">first_cloud_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
</span>


  <span class="c1"># New layer for our second cloud image</span>
  <span class="n">second_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">185</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud2.png&quot;</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">second_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">second_cloud_layer</span><span class="p">)</span>


<span class="hll">  <span class="c1"># Instanciate a new animation for the second cloud move</span>
</span><span class="hll">  <span class="n">second_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set the animation duration</span>
</span><span class="hll">  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># We need to set the initial value of the animation and the final one</span>
</span><span class="hll">  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Final position for the second cloud</span>
</span><span class="hll">  <span class="n">second_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">505</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">second_cloud_final_position</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
</span><span class="hll">  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>
</span><span class="hll">
</span><span class="hll">  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">second_cloud_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take notice that the cloud position changed</td>
</tr></table>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationClouds.png" alt="Cloud Animation" />
</div>
<div class="title">Figure 94. Cloud Animation</div>
</div>
<div class="paragraph"><p>Yes, it looks kind of good. But the animation is too linear the clouds does not look like the real life, what we can do is adding some easing with a timing function. The objective is when the cloud appear on the screen go faster and then it decelerate until its finished. This kind of easing is called EasyOut:</p></div>
<div class="paragraph"><p>Lets apply it to the code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_cloud_layers</span>

  <span class="c1"># Lets instance a new layer for our first cloud image</span>
  <span class="n">first_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">82</span><span class="p">)</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">153</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="c1"># Load the image into memory</span>
  <span class="n">first_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud1.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">first_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="p">)</span>


  <span class="c1"># Instanciate a new animation for the first cloud move</span>
  <span class="n">first_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

   <span class="c1"># Set the animation duration</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">7</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

  <span class="c1"># Final position for the first cloud</span>
  <span class="n">first_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">473</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_final_position</span><span class="p">)</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

<span class="hll">  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
</span><span class="hll">  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseOut</span><span class="p">)</span>
</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">first_cloud_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>



  <span class="c1"># New layer for our second cloud image</span>
  <span class="n">second_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">185</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud2.png&quot;</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">second_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">second_cloud_layer</span><span class="p">)</span>


  <span class="c1"># Instanciate a new animation for the second cloud move</span>
  <span class="n">second_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

  <span class="c1"># Final position for the second cloud</span>
  <span class="n">second_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">505</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">second_cloud_final_position</span><span class="p">)</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>


<span class="hll">  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
</span><span class="hll">  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseOut</span><span class="p">)</span>
</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">second_cloud_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationCloudsWithEasing.png" alt="Cloud Animation with Easing" />
</div>
<div class="title">Figure 95. Cloud Animation with Easing</div>
</div>
<div class="paragraph"><p>Subtle right? Thats the idea! It now looks more that the wind blows stronger at the first and then it slows down. But what is really happening?</p></div>
<div class="paragraph"><p>Do you remember the part of the interpolation? We were saying in that moment that it is the calculus between the initial value and the final every millisecond of the sequence. It means that if we move 3 points during 3 seconds, it will move one point per second right?</p></div>
<div class="paragraph"><p>Yes it does if our timing function is linear (Which is the default), but if we change that to a EasyIn what is really happening is that in the first second it moves 1.5 points, in the second 1 point and in the final second .5 points. Thats makes the illusion of decelerating</p></div>
<div class="paragraph"><p>In iOS they are 4 default easing available for the timing functions:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_Easings.png" alt="iOS Easings" />
</div>
<div class="title">Figure 96. iOS Easings</div>
</div>
<div class="paragraph"><p>Also if you don&#8217;t like anyone, you can implement your custom timing function.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_cakeyframeanimation">CAKeyFrameAnimation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Until this part we have created single key-frame animations, from a value to value, without intermediates. But what happens when we need to set more points into a moving animation, by example the arc that makes the sun in the sky during the day?</p></div>
<div class="paragraph"><p>If we start on the left bottom corner on the screen and use a CABasicAnimation to move the sun to the right bottom, it will move in a straight line, so we will need to add a middle point in top middle of the screen. This is done using a CAKeyFrameAnimation:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_cloud_layers</span>
  <span class="n">layout_grass_layer</span>
<span class="hll">  <span class="n">load_sun_animation</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">load_sun_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># We need to have an array for containing all the positions</span>
  <span class="n">values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


  <span class="c1"># Initial Sun Position</span>
  <span class="n">initial_sun_position</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_sun_position</span><span class="p">)</span>

  <span class="c1"># Middle Sun Position</span>
  <span class="n">middle_sun_position</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">155</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
  <span class="n">values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">middle_sun_position</span><span class="p">)</span>

  <span class="n">final_sun_position</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_sun_position</span><span class="p">)</span>


  <span class="n">translation_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunStraightAnimation.png" alt="Sun Straight Animation" />
</div>
<div class="title">Figure 97. Sun Straight Animation</div>
</div>
<div class="paragraph"><p>We are improving! But the sun does not move in a straight line, so lets change does points into an arc:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


<span class="hll">  <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
</span><span class="hll">  <span class="c1"># animation to cover, is better this way using lines and curves</span>
</span><span class="hll">  <span class="c1"># than setting every point by ourselfs</span>
</span><span class="hll">  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
</span><span class="hll">  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
</span><span class="hll">  <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
</span><span class="hll">                           <span class="ss">controlPoint1</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
</span><span class="hll">                           <span class="ss">controlPoint2</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Assign the path to the animation</span>
</span><span class="hll">  <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>
</span>
  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunArcAnimation.png" alt="Sun Arc Animation" />
</div>
<div class="title">Figure 98. Sun Arc Animation</div>
</div>
<div class="paragraph"><p>Great! Now this is working, but how about combining the translation animation with a spinning one? (CABasicAnimation &amp; CAKeyframeAnimation):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

 <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
 <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

 <span class="c1"># Set the animation duration</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


 <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
 <span class="c1"># animation to cover, is better this way using lines and curves</span>
 <span class="c1"># than setting every point by ourselves</span>
 <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                          <span class="ss">controlPoint1</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                          <span class="ss">controlPoint2</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


 <span class="c1"># Assign the path to the animation</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

 <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>


 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>


<span class="hll"> <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
</span><span class="hll"> <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
</span><span class="hll"> <span class="c1"># y axis</span>
</span><span class="hll"> <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
</span><span class="hll"> <span class="c1"># thats why the conversion PI * 2</span>
</span><span class="hll"> <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="ss">Math</span><span class="p">:</span><span class="ss">:PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Set the duration according with the other animation</span>
</span><span class="hll"> <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
</span><span class="hll"> <span class="n">rotation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Add the animation to the layer</span>
</span><span class="hll"> <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;rotation_animation&#39;</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>But this is not the end of it, what about changing the colors of the sky according to the position of the sun? For this we will need to animate the background layer in the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

 <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
 <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

 <span class="c1"># Set the animation duration</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


 <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
 <span class="c1"># animation to cover, is better this way using lines and curves</span>
 <span class="c1"># than setting every point by ourselfs</span>
 <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                          <span class="ss">controlPoint1</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                          <span class="ss">controlPoint2</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


 <span class="c1"># Assign the path to the animation</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

 <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>


 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>


 <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
 <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
 <span class="c1"># y axis</span>
 <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>

 <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
 <span class="c1"># thats why the conversion PI * 2</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="ss">Math</span><span class="p">:</span><span class="ss">:PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

 <span class="c1"># Set the duration according with the other animation</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Add the animation to the layer</span>
 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;rotation_animation&#39;</span><span class="p">)</span>


<span class="hll"> <span class="c1"># We need to create an array of the color gradients thar we want the</span>
</span><span class="hll"> <span class="c1"># background transition into</span>
</span><span class="hll"> <span class="n">animation_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Because we are using a gradient, we need to have a 3 pair of colors for</span>
</span><span class="hll"> <span class="c1"># each transition</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Morning Colors</span>
</span><span class="hll"> <span class="n">initial_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll"> <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">07</span><span class="mi">8</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">463</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll"> <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll"> <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Mid Day Colors</span>
</span><span class="hll"> <span class="n">mid_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll"> <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">388</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">714</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll"> <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll"> <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Dawn Day Colors</span>
</span><span class="hll"> <span class="n">final_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll"> <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">094</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">086</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll"> <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll"> <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll"> <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_colors</span><span class="p">)</span>
</span><span class="hll"> <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">mid_colors</span><span class="p">)</span>
</span><span class="hll"> <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_colors</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Create a new instance of CAKeyframeAnimation with the property</span>
</span><span class="hll"> <span class="c1"># of colors</span>
</span><span class="hll"> <span class="n">gradient_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Set the animation duration</span>
</span><span class="hll"> <span class="n">gradient_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Set the matrix of gradient colors into the animation</span>
</span><span class="hll"> <span class="n">gradient_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">animation_colors</span>
</span><span class="hll">
</span><span class="hll"> <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
</span><span class="hll"> <span class="n">gradient_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>
</span><span class="hll"> <span class="n">gradient_animation</span><span class="o">.</span><span class="n">fillMode</span> <span class="o">=</span> <span class="no">KCAFillModeForwards</span>
</span><span class="hll">
</span><span class="hll"> <span class="vi">@background_layer</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">final_colors</span>
</span><span class="hll"> <span class="vi">@background_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">gradient_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;colors_animation&#39;</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunSunsetAnimation.png" alt="Sun Sunset Animation" />
</div>
<div class="title">Figure 99. Sun Sunset Animation</div>
</div>
<div class="paragraph"><p>It looks pretty good! But we are missing the night part right? Thats the next part of the exercise</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_ready_set_action">Ready, Set, Action!</h2>
<div class="sectionbody">
<div class="paragraph"><p>Do you remember when we talk about know when a animation finish? We will need that part to present our night scene! The way to know when the animation finished is using the delegate pattern, lets implement it!</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


  <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
  <span class="c1"># animation to cover, is better this way using lines and curves</span>
  <span class="c1"># than setting every point by ourselfs</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                           <span class="ss">controlPoint1</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                           <span class="ss">controlPoint2</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


  <span class="c1"># Assign the path to the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

<span class="hll">  <span class="c1"># We assign self as delegate of the animation</span>
</span><span class="hll">  <span class="n">translation_animation</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
</span><span class="hll">  <span class="n">translation_animation</span><span class="o">.</span><span class="n">removedOnCompletion</span> <span class="o">=</span> <span class="kp">false</span>
</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">)</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>


  <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
  <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
  <span class="c1"># y axis</span>
  <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>

  <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
  <span class="c1"># thats why the conversion PI * 2</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="ss">Math</span><span class="p">:</span><span class="ss">:PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

  <span class="c1"># Set the duration according with the other animation</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

   <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Add the animation to the layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;rotation_animation&#39;</span><span class="p">)</span>


  <span class="c1"># We need to create an array of the color gradients thar we want the</span>
  <span class="c1"># background transition into</span>
  <span class="n">animation_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Because we are using a gradient, we need to have a 3 pair of colors for</span>
  <span class="c1"># each transition</span>


  <span class="c1"># Last Night Color</span>
  <span class="n">last_night_color</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">last_night_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithWhite</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_night_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_night_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="c1"># Morning Colors</span>
  <span class="n">initial_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">07</span><span class="mi">8</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">463</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="c1"># Mid Day Colors</span>
  <span class="n">mid_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">388</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">714</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="c1"># Dawn Day Colors</span>
  <span class="n">final_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">094</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">086</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">last_night_color</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_colors</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">mid_colors</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_colors</span><span class="p">)</span>


  <span class="c1"># Create a new instance of CAKeyframeAnimation with the property</span>
  <span class="c1"># of colors</span>
  <span class="n">gradient_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># Set the matrix of gradient colors into the animation</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">animation_colors</span>

  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">final_colors</span>

  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">gradient_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;colors_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">animationDidStop</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="ss">finished</span><span class="p">:</span><span class="n">flag</span><span class="p">)</span>

  <span class="n">load_sun_animation</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If you look close at the code, we don&#8217;t change pretty much right? Only we remove the repeatCount and assign the view controller as delegate of the animation, this is for when the animation finishes we invoke the method <strong>load_sun_animation</strong> again to continue the loop</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Also we add one more color into the background transition, this last is important for the day break transition.</td>
</tr></table>
</div>
<div class="paragraph"><p>For the next step please copy the <strong>bgMoon.png</strong> from the <strong>resources/images</strong> folder into our application resources folder.</p></div>
<div class="paragraph"><p>Lets add a new layer to include the new moon image:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_cloud_layers</span>
<span class="hll">  <span class="n">layout_moon_layer</span>
</span>  <span class="n">layout_grass_layer</span>
  <span class="n">load_sun_animation</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_moon_layer</span>

  <span class="c1"># Lets instance a new layer for our first cloud image</span>
  <span class="vi">@moon_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

  <span class="c1"># Load the image into memory</span>
  <span class="n">moon_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgMoon.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">moon_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="vi">@moon_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are close! Lets implement the moon animation adding the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_moon_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


  <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
  <span class="c1"># animation to cover, is better this way using lines and curves</span>
  <span class="c1"># than setting every point by ourselfs</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                           <span class="ss">controlPoint1</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                           <span class="ss">controlPoint2</span><span class="p">:</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


  <span class="c1"># Assign the path to the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="c1"># We assign self as delegate of the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">removedOnCompletion</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">)</span>

  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>


  <span class="c1"># We need to create an array of the color gradients thar we want the</span>
  <span class="c1"># background transition into</span>
  <span class="n">animation_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Because we are using a gradient, we need to have a 3 pair of colors for</span>
  <span class="c1"># each transition</span>

  <span class="c1"># The last gradient used in the sun animation</span>
  <span class="n">last_day_color</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">last_day_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">094</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">086</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_day_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_day_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


  <span class="c1"># Night Colors</span>
  <span class="n">initial_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="mi">8</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">169</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">302</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">365</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">627</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">365</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">627</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


  <span class="c1"># Midnight Colors</span>
  <span class="n">final_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithWhite</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">last_day_color</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_colors</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_colors</span><span class="p">)</span>


  <span class="c1"># Create a new instance of CAKeyframeAnimation with the property</span>
  <span class="c1"># of colors</span>
  <span class="n">gradient_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># Set the matrix of gradient colors into the animation</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">animation_colors</span>

  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">gradient_animation</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s1">&#39;colors_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we have the sun and the moon layers and animations, so as last part we need to transition between animations to simulate night and day. The best we can do at this point is on the animation delegate, invoke the moon animation if the sun ended and otherwise. This is implemented the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># CAAnimation delegate call</span>
<span class="k">def</span> <span class="nf">animationDidStop</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="ss">finished</span><span class="p">:</span><span class="n">flag</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Using the key of the addAnimation we can get the animation and compare</span>
</span><span class="hll">  <span class="c1"># it against the one that finish to know if it is the sun or the moon one</span>
</span><span class="hll">  <span class="k">if</span> <span class="n">animation</span> <span class="o">==</span> <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">animationForKey</span><span class="p">(</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">load_moon_animation</span>
</span><span class="hll">  <span class="k">else</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">load_sun_animation</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Interesting how can we retrieve the animation instance from a layer using the same keypath used when we add it. Thats the way can we determinate which application was finished!</p></div>
<div class="paragraph"><p>Now run the application and enjoy!</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunAndMoonAnimation.png" alt="Sun & Moon Animation" />
</div>
<div class="title">Figure 100. Sun &amp; Moon Animation</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenges_4">Challenges</h2>
<div class="sectionbody">
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the <strong>resources/images</strong> folder are a couple of star images, the challenge is make a animation with them moving from top to bottom, only when the moon is rising. And remove them with another animation when the sun is appears
</p>
</li>
<li>
<p>
Change the past animation to look like shooting stars, enter and leaving the screen
</p>
</li>
</ol></div>
</div>
</div>
<h1 id="_day_5">Day 5</h1>
<h1 id="_chapter_22_settings">Chapter 22 - Settings</h1>
<div class="paragraph"><p>In this chapter you are going to learn how to use <strong>NSUserDefaults</strong> to store values in our app. Storing values in an app is a common functionality. CocoaTouch offers different alternatives to accomplish that task, <strong>User Defaults</strong> is the easiest one of them.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project_5">Setting up the project</h2>
<div class="sectionbody">
<div class="paragraph"><p>We are going to use the <strong>Cocoaheads</strong> app as an example. Open the folder <strong>22-Settings/resources/code/Cocoaheads</strong>. You will find the project as we finished it in chapter 14.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch22-Settings/ch22_01_app.png" alt="Current Application" />
</div>
<div class="title">Figure 101. Current Application</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_task">The Task</h2>
<div class="sectionbody">
<div class="paragraph"><p>As you may remember, we have build a <strong>Login</strong> view controller: <strong>sign_in_view_controller.rb</strong>. We want to add the functionality to store the username of the logged user. Also we want to change the login button of the the <strong>next_event_view_controller.rb</strong> to a logout button when the user is logged in.</p></div>
<div class="sect2">
<h3 id="_storing_the_logged_user">Storing the logged user</h3>
<div class="paragraph"><p>First, we will create a Model to add this functionality. In the <strong>models</strong> folder create a file named <strong>user.rb</strong> and declare the <strong>User</strong> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span><span class="p">:</span> <span class="n">username</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>iOS creates a default <strong>NSUserDefaults</strong> per user, but when an app writes data to it, it is sandboxed. Thus, other apps can not access that data.</p></div>
<div class="paragraph"><p>To work with NSUserDefaults we ask for the default instance using the method <strong>standardUserDefaults</strong>. In the <strong>User</strong> class add this method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">logIn</span>

  <span class="no">NSUserDefaults</span><span class="o">.</span><span class="n">standardUserDefaults</span><span class="o">.</span><span class="n">setObject</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
    <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;loggedUser&quot;</span><span class="p">)</span>

  <span class="no">NSUserDefaults</span><span class="o">.</span><span class="n">standardUserDefaults</span><span class="o">.</span><span class="n">setBool</span><span class="p">(</span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;isUserLogged&quot;</span><span class="p">)</span>
  <span class="no">NSUserDefaults</span><span class="o">.</span><span class="n">standardUserDefaults</span><span class="o">.</span><span class="n">synchronize</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see we are storing two things: the first one is a String with the username of the user and the second one is a Boolean to set that there is a user logged in the app. As you can see is very similar as working with Hashes. We pass a value and a String that is its key. Finally, we call <strong>synchronize</strong>. NSUserDefaults caches the values in memory and periodically flushes them to its persistent store on disk. You can force this flush by calling directly to <strong>synchronize</strong>. Although, you should do this only on those times where your app needs that the data is persisted immediately and you can not wait until the automatic flush happens.</p></div>
<div class="paragraph"><p>Now, lets create our user and call this method on our <strong>LoginViewController</strong> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">login_user</span>

  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">text</span>
  <span class="n">user</span><span class="o">.</span><span class="n">logIn</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And call this method from the <strong>sign_in</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span>

  <span class="k">if</span> <span class="n">isFormValid</span>
    <span class="n">close</span>
    <span class="n">login_user</span>
  <span class="k">else</span>
    <span class="n">showAlert</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="ss">title</span><span class="p">:</span><span class="s2">&quot;Please, fill all the fields.&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app and login with a user.</p></div>
</div>
<div class="sect2">
<h3 id="_reading_from_user_defaults">Reading from User Defaults</h3>
<div class="paragraph"><p>So, we are saving the user information on User Defaults. Now we need to read it. Open the <strong>User</strong> class and add this class method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">isLogged?</span>

  <span class="no">NSUserDefaults</span><span class="o">.</span><span class="n">standardUserDefaults</span><span class="o">.</span><span class="n">boolForKey</span><span class="p">(</span><span class="s2">&quot;isUserLogged&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we can add the behavior to our <strong>next_event_view_controller.rb</strong>. First, in the <strong>viewDidLoad</strong> store the Sign In button in an instance variable:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">imageViewWithHeader</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">imageViewWithBackground</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">imageViewWithTitleBackground</span><span class="p">)</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>
  <span class="vi">@days_left_view</span> <span class="o">=</span> <span class="n">viewWithDaysLeft</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@next_event_name_label</span><span class="p">)</span>
  <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">mock_event</span>
  <span class="vi">@button_for_sign_in</span> <span class="o">=</span> <span class="n">buttonForSignIn</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@button_for_sign_in</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">buttonForSignUp</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@days_left_view</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">buttonToChangeDaysLeft</span><span class="p">)</span>

  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="vi">@event</span><span class="o">.</span><span class="n">name</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now add the method to change the button. We check if the user is logged, and then we change the title of the button. We also need to remove the selector that was called when the user taps on the button, because is pointing to the <strong>sign_in</strong> method. Finally we add a new selector pointing to a <strong>sign_out</strong> method.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">changeSignInButtonIfUserIsLogged</span>

  <span class="k">if</span> <span class="no">User</span><span class="o">.</span><span class="n">isLogged?</span>
    <span class="vi">@button_for_sign_in</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Logout&quot;</span><span class="p">,</span>
      <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="vi">@button_for_sign_in</span><span class="o">.</span><span class="n">removeTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="ss">action</span><span class="p">:</span><span class="s2">&quot;sign_in&quot;</span><span class="p">,</span>
      <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
    <span class="vi">@button_for_sign_in</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;sign_out:&#39;</span><span class="p">,</span>
      <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">sign_out</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now if you run your app, since the NSUserDefaults has stored that a user has logged in, you should see that the button has the string <strong>Logout</strong> in its title:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch22-Settings/ch22_02_logout.png" alt="Application Logout" />
</div>
<div class="title">Figure 102. Application Logout</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenges_5">Challenges</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the <strong>User</strong> class, implement a method called <strong>logout</strong> that method should remove the
object with key <strong>loggedUser</strong> from the User Defaults and set as a <strong>false</strong> the Boolean with key <strong>isUserLogged</strong>. Call this method from the <strong>sign_out</strong> method in NextViewController</p></div>
</div>
</div>
<h1 id="_chapter_23_web_services">Chapter 23 - Web Services</h1>
<div class="paragraph"><p>The ability to consume remote web services from mobile apps is a core component of today&#8217;s applications. Normally you will connect to web services to perform tasks like synchonize data, authenticate users or consume a third party API (think in stuff like the Facebook API or the Instagram API).</p></div>
<div class="paragraph"><p>We have been working with local data in our Cocoaheads app. In this exercise you are going to learn how to consume remote web services.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project_6">Setting Up the Project</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open the folder <strong>23-WebServices/resources/code/Cocoaheads</strong>. You will find the project as we finished it in chapter 22. During this workshop we&#8217;ll need a webapp with our services. This webapp is included in the folder <strong>web_services</strong>.</p></div>
<div class="paragraph"><p>The instructor will run the webapp in its computer and he will provide you with the correct URL to invoke, but you can run the webapp by yourself using the Ruby framwework <strong>Sinatra</strong> if you prefer it. Please, refer to Appendix A for instructions on how to to that.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch23-WebServices/ch23_01_app.png" alt="Current Application" />
</div>
<div class="title">Figure 103. Current Application</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_task_2">The Task</h2>
<div class="sectionbody">
<div class="paragraph"><p>We have implemented a <strong>News</strong> section using a UITableViewController. This section retrieves the array of news from the <strong>News</strong> model class, which in turn takes its data from a <strong>plist</strong> file. In this chapter we are going to improve this section by getting the news list from an external web service.</p></div>
<div class="sect2">
<h3 id="_consuming_a_web_service">Consuming a web service</h3>
<div class="paragraph"><p>Open the <strong>News</strong> class. Add this class method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">latest_news</span><span class="p">(</span><span class="n">completion_block</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The method will receive a block in which it will respond the result of the web service invocation.</p></div>
<div class="paragraph"><p>Now add a constant at the beginning of the class with the URL of the web server. The instructor should give you this URL. In this example we will consume a local service:</p></div>
<div class="paragraph"><p><strong>NEWS_SERVICE_BASE_URL = "http://localhost:4567"</strong></p></div>
<div class="paragraph"><p>Then, in the <strong>self.latest_news</strong> method we are going to build first a NSURL instance that points to the service:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">latest_news</span><span class="p">(</span><span class="n">completion_block</span><span class="p">)</span>

    <span class="n">news_url</span> <span class="o">=</span> <span class="no">NSURL</span><span class="o">.</span><span class="n">URLWithString</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">NEWS_SERVICE_BASE_URL</span><span class="si">}</span><span class="s2">/news.json&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next, we need to build an instance of <strong>NSMutableURLRequest</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">latest_news</span><span class="p">(</span><span class="n">completion_block</span><span class="p">)</span>

    <span class="n">news_url</span> <span class="o">=</span> <span class="no">NSURL</span><span class="o">.</span><span class="n">URLWithString</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">NEWS_SERVICE_BASE_URL</span><span class="si">}</span><span class="s2">/news.json&quot;</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="no">NSMutableURLRequest</span><span class="o">.</span><span class="n">requestWithURL</span><span class="p">(</span><span class="n">news_url</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">setTimeoutInterval</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">setHTTPMethod</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see we can define some <strong>attributes</strong> of our request, such as the time out in seconds and the HTTP method to use.</p></div>
<div class="paragraph"><p>Now we are ready to send the request to the web service. Web services work using an approach of <strong>Request-Reply</strong>. We send the request to a given web service and wait. Once the Web Service finishes, it will reply with an answer. During that time the only thing we can do is to wait, we don&#8217;t have control of the remote service. Here we have two options:</p></div>
<div class="ulist"><ul>
<li>
<p>
Block the whole app execution until the web service responds.
</p>
</li>
<li>
<p>
Send the request and forget about it, avoiding blocking the app execution. Once the service responds we process the result.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The correct way to handle web services is to use the second option. <strong>NSURLConnection</strong>, the class of CocoaTouch to send requests to web services, can handle both. But the first option that blocks the whole app, is not even worth to be reviewed. So we will stick with the second one. <strong>Modify</strong> the <strong>self.latest_news</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">latest_news</span><span class="p">(</span><span class="n">completion_block</span><span class="p">)</span>
  <span class="n">news_url</span> <span class="o">=</span> <span class="no">NSURL</span><span class="o">.</span><span class="n">URLWithString</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">NEWS_SERVICE_BASE_URL</span><span class="si">}</span><span class="s2">/news.json&quot;</span><span class="p">)</span>
  <span class="n">request</span> <span class="o">=</span> <span class="no">NSMutableURLRequest</span><span class="o">.</span><span class="n">requestWithURL</span><span class="p">(</span><span class="n">news_url</span><span class="p">)</span>
  <span class="n">request</span><span class="o">.</span><span class="n">setTimeoutInterval</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
  <span class="n">request</span><span class="o">.</span><span class="n">setHTTPMethod</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">)</span>

  <span class="n">queue</span> <span class="o">=</span> <span class="no">NSOperationQueue</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="no">NSURLConnection</span><span class="o">.</span><span class="n">sendAsynchronousRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
    <span class="ss">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
    <span class="ss">completionHandler</span><span class="p">:</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">error</span><span class="o">|</span>

    <span class="k">end</span>
  <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We send and <strong>Asynchronous</strong> request to the service using a <strong>NSOperationQueue</strong>. This block of code will be executed in a background Queue defined by the NSOperationQueue. This is a way to handle background tasks. We will review more about this topic in Chapter 26. Once the web service has a result, either a succesful response, a timeout or an error, the <strong>completionHandler</strong> block in invoked. This block receives three parameters:</p></div>
<div class="ulist"><ul>
<li>
<p>
response: An object with an instance of <strong>NSURLResponse</strong>.
</p>
</li>
<li>
<p>
data: The response returned by the service as a <strong>NSData</strong> object.
</p>
</li>
<li>
<p>
error: An <strong>NSError</strong> with the error, if any, returned by the service.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We can now process the result. Our service returns an Array of <strong>News</strong> items in JSON format. We need to parse it. <strong>CocoaTouch</strong> provides us with the class <strong>NSJSONSerialization</strong> to parse JSON objects. This class parses JSON data into <strong>NSArray</strong>, for JSON arrays, and into <strong>NSDictionary</strong> for JSON objects. Thus, we need to convert from thess <strong>NSDictionary*s to instances of *News</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">NSURLConnection</span><span class="o">.</span><span class="n">sendAsynchronousRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                        <span class="ss">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">,</span>
  <span class="ss">completionHandler</span><span class="p">:</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">error</span><span class="o">|</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span>
      <span class="nb">p</span> <span class="s2">&quot;No news were found in the server&quot;</span>
      <span class="n">completion_block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">[]</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="k">elsif</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span>

      <span class="n">error_ptr</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>
      <span class="n">news</span> <span class="o">=</span> <span class="no">NSJSONSerialization</span><span class="o">.</span><span class="n">JSONObjectWithData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="ss">options</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="ss">error</span><span class="p">:</span><span class="n">error_ptr</span><span class="p">)</span>
      <span class="k">unless</span> <span class="n">news</span>
        <span class="k">raise</span> <span class="n">error_ptr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
      <span class="k">end</span>
      <span class="n">completion_block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">news_hashes_to_news</span><span class="p">(</span><span class="n">news</span><span class="p">),</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="k">elsif</span><span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="o">.</span><span class="n">nil?</span><span class="p">)</span>
      <span class="nb">p</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">completion_block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">[]</span><span class="p">,</span><span class="s2">&quot;There was an error connecting to the server.&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>We have three possible results:</p></div>
<div class="ulist"><ul>
<li>
<p>
If the server returned and empty result, we return an empty array.
</p>
</li>
<li>
<p>
If there is no error and the data object is not nil, the service returned the news. We parse them from JSON and then we use the method <strong>news_hashes_to_news</strong> to convert the news hashes to instances of <strong>News</strong>. As you can see we are invoking the <strong>completion_block</strong> parameter of our method to return the result: an Array of <strong>News</strong> item. The second parameter of the <strong>completion_block</strong> is an Error message, we return an empty error in this case.
</p>
</li>
<li>
<p>
If there was an error, we return an error message.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Next, we need to implement the method <strong>news_hashes_to_news</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">news_hashes_to_news</span><span class="p">(</span><span class="n">news_hashes</span><span class="p">)</span>

  <span class="n">news_array</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>

  <span class="n">news_hashes</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>

    <span class="n">news</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">new</span>
    <span class="n">news</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">brief</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;brief&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;text&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;image&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span>
    <span class="n">news_array</span> <span class="o">&lt;&lt;</span> <span class="n">news</span>
  <span class="p">}</span>

  <span class="n">news_array</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are ready to invoke the service from the <strong>NewsViewController</strong> Open the file <strong>news_view_controller.rb</strong>. We are going to send the request to the service, and once the service responds we will update the <strong>UITableView</strong> with the news. We should indicate to the user that we are waiting a result from the service. A normal approach is to render a Spinner in the screen. In Cocoa Touch we use the <strong>UIActivityIndicatorView</strong> to do that.</p></div>
<div class="paragraph"><p>Our first task it to write an method that shows the UIActivityIndicatorView:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupActivityIndicatorView</span>

  <span class="vi">@activityIndicator</span> <span class="o">=</span> <span class="no">UIActivityIndicatorView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithActivityIndicatorStyle</span><span class="p">(</span><span class="no">UIActivityIndicatorViewStyleGray</span><span class="p">)</span>
  <span class="vi">@activityIndicator</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">320</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="vi">@activityIndicator</span><span class="o">.</span><span class="n">hidesWhenStopped</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@activityIndicator</span><span class="p">)</span>
  <span class="vi">@activityIndicator</span><span class="o">.</span><span class="n">startAnimating</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We add it to the View and then invoke <strong>startAnimating</strong>, that message will start the spinning animation of our Activity Indicator.</p></div>
<div class="paragraph"><p>Now we are ready to invoke the remote service:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_latest_news</span>
  <span class="n">setupActivityIndicatorView</span>

  <span class="no">News</span><span class="o">.</span><span class="n">latest_news</span><span class="p">(</span><span class="nb">lambda</span> <span class="k">do</span><span class="o">|</span><span class="n">news</span><span class="p">,</span> <span class="n">error</span><span class="o">|</span>

  <span class="vi">@activityIndicator</span><span class="o">.</span><span class="n">stopAnimating</span>
    <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">nil?</span>

      <span class="n">refreshTableWithNews</span> <span class="n">news</span>
    <span class="k">else</span>

      <span class="n">showErrorMessage</span> <span class="n">error</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">refreshTableWithNews</span><span class="p">(</span><span class="n">news</span><span class="p">)</span>

  <span class="vi">@news</span> <span class="o">=</span> <span class="n">news</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">showErrorMessage</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;Error </span><span class="si">#{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We first show our Activity Indicator, then we invoke the <strong>latest_news</strong> method and pass a block as a parameter. If there was no error, we refresh the table view with the news. If there was an error we pass it to the <strong>showErrorMessage</strong> that prints it on the console.</p></div>
<div class="paragraph"><p>Call this method from the <strong>viewWillAppear:</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@news</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="n">load_latest_news</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now run your app, remember that the web service should be running:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch23-WebServices/ch23_02_activityindicator.png" alt="Activity Indicator" />
</div>
<div class="title">Figure 104. Activity Indicator</div>
</div>
<div class="paragraph"><p>You will see the Activity Indicator and if you touch the screen, you&#8217;ll see that the Table is refreshed with the latest news from the service. Why is the table view not refreshed automatically? Because we are running this operation in a background task. And the UI should be updated only in the Main thread. We are going to fix this, <strong>modify</strong> the method <strong>load_latest_news</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_latest_news</span>
  <span class="n">setupActivityIndicatorView</span>

  <span class="no">News</span><span class="o">.</span><span class="n">latest_news</span><span class="p">(</span><span class="nb">lambda</span> <span class="k">do</span><span class="o">|</span><span class="n">news</span><span class="p">,</span> <span class="n">error</span><span class="o">|</span>

    <span class="vi">@activityIndicator</span><span class="o">.</span><span class="n">stopAnimating</span>

    <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">nil?</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s2">&quot;refreshTableWithNews:&quot;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="n">news</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
    <span class="k">else</span>

      <span class="n">showErrorMessage</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>By using the <strong>performSelectorOnMainThread:withObject:waitUntilDone</strong> message, we are executing the <strong>refreshTableWithNews</strong> method on the Main Thread, the one that handles the UI. Now the TableView will be refreshed immediately after the service responds:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch23-WebServices/ch23_03_table.png" alt="News Table View" />
</div>
<div class="title">Figure 105. News Table View</div>
</div>
<div class="paragraph"><p>We are done with this task, if you have time you could do the challenges.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenges_6">Challenges</h2>
<div class="sectionbody">
<div class="paragraph"><p>Implement the <strong>showErrorMessage</strong> method. This method should show an UIAlertView with the message. Call this method from the <strong>load_latest_news</strong>, remember to execute it from the Main Thread, since it updates the UI. To test it, change the url of the web service to an non existing one, such as:</p></div>
<div class="paragraph"><p>NEWS_SERVICE_BASE_URL = "http://dontexists:4567"</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch23-WebServices/ch23_04_error.png" alt="Error Message" />
</div>
<div class="title">Figure 106. Error Message</div>
</div>
<div class="paragraph"><p>As you can see, if there are no news or if there is an error, the UIActivityIndicator remains on the screen until you touch it. Why? because we are not calling the  <strong>stopAnimating</strong> method from the Main Thread, correct this.</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch23-WebServices/ch23_05_activitystopped.png" alt="Activity Indicator Stopped" />
</div>
<div class="title">Figure 107. Activity Indicator Stopped</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix_a_starting_the_web_server">Appendix A: Starting the web server</h2>
<div class="sectionbody">
<div class="paragraph"><p>The web services are implemented using the Ruby framework <strong>Sinatra</strong>. If you want to run them in your local computer, you should follow these steps:</p></div>
<div class="paragraph"><p>Prerequisites:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
You need a Ruby environment. The simplest way to install it is with <a href="http://rvm.io">http://rvm.io</a> Follow the instructions on the site to install it.
</p>
</li>
<li>
<p>
You need Ruby Gems, follow this <a href="https://rvm.io/rubies/rubygems/">https://rvm.io/rubies/rubygems/</a> instructions to install them.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Steps:
1. Install Sinatra:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>gem install sinatra
</pre></div></div></div>
<div class="paragraph"><p>Run the server:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>ruby -rubygems app.rb
</pre></div></div></div>
<div class="paragraph"><p>In the console you will see the port in which the server is running. Use this port in your app. The server is <strong>localhost</strong>. In this case the complete url is <strong>http://localhost:4567</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">==</span> Sinatra/1.3.3 has taken the stage on 4567 <span class="k">for </span>development with backup from Thin
&gt;&gt; WEBrick 1.3.1
&gt;&gt; Listening on 0.0.0.0:4567, CTRL+C to stop
</pre></div></div></div>
</div>
</div>
<h1 id="_chapter_24_core_data">Chapter 24 - Core Data</h1>
<div class="paragraph"><p>Core Data is an object graph manager with lifecycle, searching and persistence features. What these means is that is a object manager that will allow us to create and destroy objects, make and validate relationships between them and finally search for specific objects using predicates.</p></div>
<div class="paragraph"><p>Contrary as many think Core Data is not a database and the best example of it is that Core Data can be used totally in-memory without any form of persistence. But of course the main feature of Core Data is the persistence so lets take a little look on the differences between it and a database:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The primary function of Core Data is object management, the primary function of a Database is storing and fetching data
</p>
</li>
<li>
<p>
Core Data works using objects stored in memory (Which can be persisted on disk), which can have behavior and attributes. Instead of the database than only stores the plain data
</p>
</li>
<li>
<p>
The databases can work on the data without load it into memory, Core Data can not do it: The objects to manipulate must be loaded first into memory before we can alter them
</p>
</li>
<li>
<p>
Core Data requires a save process before it write all the changes (New, Alter or Deleted objects) into disk
</p>
</li>
<li>
<p>
The data integrity and relationships are managed in the database by using features like "unique" keys. In Core Data they are managed by business logic inside our app
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Core Data is not fully multi-threaded, if you have the need to use them in such scenarios please consider that some of its objects like NSManagedContext and NSManagedObject are single threaded.</td>
</tr></table>
</div>
<div class="sect1">
<h2 id="_remember_the_movies">Remember the Movies</h2>
<div class="sectionbody">
<div class="paragraph"><p>With all the possibilities today for watching a movie (Streaming, Online Rent, Physical Rent, Theaters, etc) some times we can forget if we have already watched a movie or in another way remember those recommendations of friends and family. Lets create an app for that! (Using Core Data ;)</p></div>
<div class="sect2">
<h3 id="_core_data_model">Core Data Model</h3>
<div class="paragraph"><p>Please create a new project called <strong>Remember the Movies</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create <span class="s2">&quot;Remember the Movies&quot;</span>

<span class="nv">$ </span><span class="nb">cd</span> <span class="s2">&quot;Remember the Movies&quot;</span>

<span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>mkdir extensions
</pre></div></div></div>
<div class="paragraph"><p>Before we can start coding our project is needed for us to copy some Core Data Object extensions, these extensions are designed to make our Core Data implementation more easy and simple. Please copy all the files from <strong>resources/extensions</strong> to our <strong>extensions folder</strong></p></div>
<div class="paragraph"><p>Now is time to code our model for the app, starting with the <strong>Director</strong> object:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mkdir model

<span class="nv">$ </span><span class="nb">cd </span>model

<span class="nv">$ </span>touch director.rb

<span class="nv">$ </span>open director.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Please note that the Director Model object is child</span>
<span class="c1"># of the class NSManagedObject</span>
<span class="k">class</span> <span class="nc">Director</span> <span class="o">&lt;</span> <span class="no">NSManagedObject</span>

  <span class="c1"># Core Data attributes for the object, this attributes will be used</span>
  <span class="c1"># for all the operations like Persisting and Searching</span>
  <span class="vi">@attributes</span> <span class="o">||=</span> <span class="o">[</span>

    <span class="c1"># We have to define the names and types of the attributes, also</span>
    <span class="c1"># you can set a default value or if it is required</span>

    <span class="c1">#Attribute Name, Type, Default Value, Is Optional, Is Transient, Is Indexed</span>
    <span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="no">NSStringAttributeType</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span>
  <span class="o">]</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Did you notice that our <strong>Director model</strong> is child of <strong>NSManagedObject</strong>? Core Data needs to add some methods to the object so it can work with it, so the way that these work is using inheritance, according to these every object that we want Core Data to track must inherit from NSManagedObject</p></div>
<div class="paragraph"><p>Lets continue creating the <strong>Movie</strong> model class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch movie.rb

<span class="nv">$ </span>open movie.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Movie</span> <span class="o">&lt;</span> <span class="no">NSManagedObject</span>

  <span class="c1"># Core Data attributes for the object, this attributes will be used</span>
  <span class="c1"># for all the operations like Persisting and Searching</span>
  <span class="vi">@attributes</span> <span class="o">||=</span> <span class="o">[</span>

    <span class="c1"># We have to define the names and types of the attributes, also</span>
    <span class="c1"># you can set a default value or if it is required</span>

    <span class="c1">#Attribute Name, Type, Default Value, Is Optional, Is Transient, Is Indexed</span>
    <span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="no">NSStringAttributeType</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s1">&#39;release_year&#39;</span><span class="p">,</span> <span class="no">NSInteger32AttributeType</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s1">&#39;studio&#39;</span><span class="p">,</span> <span class="no">NSStringAttributeType</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span>

  <span class="o">]</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Yes! Now we got a object for representing the Movie, but as you already notice the attributes can have many types. The more important ones are:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
NSInteger32AttributeType
</p>
</li>
<li>
<p>
NSDoubleAttributeType
</p>
</li>
<li>
<p>
NSStringAttributeType
</p>
</li>
<li>
<p>
NSBooleanAttributeType
</p>
</li>
<li>
<p>
NSDateAttributeType
</p>
</li>
<li>
<p>
NSBinaryDataAttributeType
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now lets add an a relationship between the <strong>Director</strong> and the <strong>Movie</strong>, for these we need to edit both files:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open movie.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Movie</span> <span class="o">&lt;</span> <span class="no">NSManagedObject</span>

  <span class="c1"># Core Data attributes for the object, this attributes will be used</span>
  <span class="c1"># for all the operations like Persisting and Searching</span>
  <span class="vi">@attributes</span> <span class="o">||=</span> <span class="o">[</span>

    <span class="c1"># We have to define the names and types of the attributes, also</span>
    <span class="c1"># you can set a default value or if it is required</span>

    <span class="c1">#Attribute Name, Type, Default Value, Is Optional, Is Transient, Is Indexed</span>
    <span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="no">NSStringAttributeType</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s1">&#39;release_year&#39;</span><span class="p">,</span> <span class="no">NSInteger32AttributeType</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span><span class="p">,</span>
    <span class="o">[</span><span class="s1">&#39;studio&#39;</span><span class="p">,</span> <span class="no">NSStringAttributeType</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span>

  <span class="o">]</span>

<span class="hll">  <span class="c1"># In Core Data we can have relationship between objects, so lets add one</span>
</span><span class="hll">  <span class="c1"># to the Director Object</span>
</span><span class="hll">  <span class="vi">@relationships</span> <span class="o">||=</span> <span class="o">[</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># IMPORTANT: In Core Data is required to have a circular relationships between</span>
</span><span class="hll">    <span class="c1"># the two objects. In these case we are adding a Relationship from Movie to Director</span>
</span><span class="hll">    <span class="c1"># but also we will need one from Director to Movie, these relationship is called Inverse</span>
</span><span class="hll">    <span class="c1"># Relationship</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Relationship Name, Relationship Class, Inverse Relationship, Is Optional, Is Indexed,</span>
</span><span class="hll">    <span class="c1"># Is Ordered, Min Count, Max Count, Delete Rule</span>
</span><span class="hll">    <span class="o">[</span><span class="s1">&#39;director&#39;</span><span class="p">,</span> <span class="s1">&#39;Director&#39;</span><span class="p">,</span> <span class="s1">&#39;movie&#39;</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSNullifyDeleteRule</span><span class="o">]</span>
</span><span class="hll">  <span class="o">]</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">The relationships in Core Data are circular, what these means is that if we want to create a relationship from Movie to Director we also need another one from Director to Movie</td>
</tr></table>
</div>
<div class="paragraph"><p>Based on these lets open our Director class to add the Inverse Relationship:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open director.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Please note that the Director Model object is child</span>
<span class="c1"># of the class NSManagedObject</span>
<span class="k">class</span> <span class="nc">Director</span> <span class="o">&lt;</span> <span class="no">NSManagedObject</span>

  <span class="c1"># Core Data attributes for the object, this attributes will be used</span>
  <span class="c1"># for all the operations like Persisting and Searching</span>
  <span class="vi">@attributes</span> <span class="o">||=</span> <span class="o">[</span>

    <span class="c1"># We have to define the names and types of the attributes, also</span>
    <span class="c1"># you can set a default value or if it is required</span>

    <span class="c1">#Attribute Name, Type, Default Value, Is Optional, Is Transient, Is Indexed</span>
    <span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="no">NSStringAttributeType</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">false</span><span class="o">]</span>
  <span class="o">]</span>


<span class="hll">  <span class="c1"># In Core Data we can have relationship between objects, so lets add one</span>
</span><span class="hll">  <span class="c1"># to the Movie Object</span>
</span><span class="hll">  <span class="vi">@relationships</span> <span class="o">||=</span> <span class="o">[</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># IMPORTANT: In Core Data is required to have a circular relationships between</span>
</span><span class="hll">    <span class="c1"># the two objects. So lets create the inverse relationship from Director to Movie</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Relationship Name, Relationship Class, Inverse Relationship, Is Optional, Is Indexed,</span>
</span><span class="hll">    <span class="c1"># Is Ordered, Min Count, Max Count, Delete Rule</span>
</span><span class="hll">    <span class="o">[</span><span class="s1">&#39;movie&#39;</span><span class="p">,</span> <span class="s1">&#39;Movie&#39;</span><span class="p">,</span> <span class="s1">&#39;director&#39;</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="kp">false</span><span class="p">,</span> <span class="kp">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">NSIntegerMax</span><span class="p">,</span> <span class="no">NSCascadeDeleteRule</span><span class="o">]</span>
</span><span class="hll">  <span class="o">]</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Continuing on the app lets open our <strong>app_delegate.rb</strong> and add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="c1"># Lets keep all of our Core Data Objects in here</span>
  <span class="no">ManageObjectClasses</span> <span class="o">=</span> <span class="o">[</span><span class="no">Director</span><span class="p">,</span> <span class="no">Movie</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

    <span class="n">initialize_core_data</span>

    <span class="kp">true</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">initialize_core_data</span>

    <span class="c1"># First we need to create the NSManagedObjectModel with</span>
    <span class="c1"># all the entities and their relationships. You can think of</span>
    <span class="c1"># these object as a reference of the objects for Core Data</span>
    <span class="c1"># to use</span>
    <span class="n">managed_object_model</span> <span class="o">=</span> <span class="no">NSManagedObjectModel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="n">managed_object_model</span><span class="o">.</span><span class="n">entities</span> <span class="o">=</span> <span class="no">ManageObjectClasses</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">.</span><span class="n">entity</span> <span class="p">}</span>
    <span class="n">managed_object_model</span><span class="o">.</span><span class="n">entities</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">entity</span><span class="o">|</span> <span class="n">entity</span><span class="o">.</span><span class="n">wireRelationships</span> <span class="p">}</span>

    <span class="c1"># The next object needed is the NSPersistentStoreCoordinator</span>
    <span class="c1"># which will allow Core Data to persist the information.</span>
    <span class="c1">#</span>
    <span class="c1"># IMPORT: The NSPersistentStoreCoordinator is not the file or</span>
    <span class="c1"># the database, is just the enabler to write on them</span>
    <span class="n">persistent_store_coordinator</span> <span class="o">=</span> <span class="no">NSPersistentStoreCoordinator</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithManagedObjectModel</span><span class="p">(</span><span class="n">managed_object_model</span><span class="p">)</span>

    <span class="c1"># Now lets get a URL for where do we want Core Data to create</span>
    <span class="c1"># the persist file, in this case a SQLite Database File</span>
    <span class="n">persistent_store_file_url</span> <span class="o">=</span> <span class="no">NSURL</span><span class="o">.</span><span class="n">fileURLWithPath</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">NSHomeDirectory</span><span class="p">(),</span>
                                                                <span class="s1">&#39;Documents&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;RememberTheMovies.sqlite&#39;</span><span class="p">))</span>


    <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

    <span class="c1"># Add a new Persistent Store to our Persistent Store Coordinator</span>
    <span class="c1"># which these means is that we are telling the Persistent Store</span>
    <span class="c1"># Coordinator where to perform the save of our objects.</span>
    <span class="c1">#</span>
    <span class="c1"># In these case we are setting that our objects must be stored in</span>
    <span class="c1"># a SQLite database in the path we already created previously</span>
    <span class="k">unless</span> <span class="n">persistent_store_coordinator</span><span class="o">.</span><span class="n">addPersistentStoreWithType</span><span class="p">(</span><span class="no">NSSQLiteStoreType</span><span class="p">,</span>
                                                                   <span class="ss">configuration</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
                                                                   <span class="ss">URL</span><span class="p">:</span> <span class="n">persistent_store_file_url</span><span class="p">,</span>
                                                                   <span class="ss">options</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
                                                                   <span class="ss">error</span><span class="p">:</span> <span class="n">error_pointer</span><span class="p">)</span>

      <span class="c1"># In case that we can&#39;t initialize the Persistance Store File</span>
      <span class="k">raise</span> <span class="s2">&quot;Can not initialize Core Data Persistance Store Coordinator: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="c1"># Finally our most important object the Managed Object Context</span>
    <span class="c1"># this object is the responsible for creating, destroying and</span>
    <span class="c1"># fetching the objects</span>
    <span class="c1">#</span>
    <span class="c1"># Of course for it to work we need to assign who is coordinating</span>
    <span class="c1"># the object persistence</span>
    <span class="vi">@managed_object_context</span> <span class="o">=</span> <span class="no">NSManagedObjectContext</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">persistentStoreCoordinator</span> <span class="o">=</span> <span class="n">persistent_store_coordinator</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great! With these code we initialize Core Data in our app using Sqlite as persistence and adding our new Model Objects to it</p></div>
<div class="paragraph"><p>The final step is to add the <strong>Core Data Framework</strong> to our project, this is done editing the <strong>RakeFile</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open RakeFile
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;/Library/RubyMotion/lib&quot;</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">&#39;motion/project&#39;</span>

<span class="ss">Motion</span><span class="p">:</span><span class="ss">:Project</span><span class="o">::</span><span class="no">App</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
  <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Remember the Movies&#39;</span>

<span class="hll">  <span class="n">app</span><span class="o">.</span><span class="n">frameworks</span> <span class="o">+=</span> <span class="o">[</span><span class="s1">&#39;CoreData&#39;</span><span class="o">]</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run our app you should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_InitialCoreData.png" alt="Initial Core Data Set Up" />
</div>
<div class="title">Figure 108. Initial Core Data Set Up</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you make some changes to the Model objects after you initialize the Core Data Persistent Store, its needed to clean the project using <strong>rake clean</strong> and reset the content and settings of the simulator using the <strong>iOS Simulator</strong> menu</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_some_views_for_some_records">Some Views for Some Records</h3>
<div class="paragraph"><p>Lets start adding some view controllers to our app so we can visualize and add new data, lets begin creating a new view controller called <strong>movies_view_controller.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch movies_view_controller.rb

<span class="nv">$ </span>open movies_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MoviesViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="kp">attr_accessor</span> <span class="ss">:managed_object_context</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="c1"># Create a new Bar Button Item with the Add System Default</span>
    <span class="n">add_movie_bar_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithBarButtonSystemItem</span><span class="p">(</span><span class="no">UIBarButtonSystemItemAdd</span><span class="p">,</span>
                                                                                  <span class="ss">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span>
                                                                                  <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;add_new_movie&#39;</span><span class="p">)</span>

    <span class="c1"># Add the Bar Button Item to the Navigation Bar</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">add_movie_bar_button_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Lets load our new controller into the window, please open the <strong>app_delegate.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

  <span class="n">initialize_core_data</span>

<span class="hll">  <span class="c1"># Create a new instance of our Movies View Controller</span>
</span><span class="hll">  <span class="n">movies_view_controller</span> <span class="o">=</span> <span class="no">MoviesViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># We need to pass the Managed Object Context to the next controller</span>
</span><span class="hll">  <span class="c1"># so we can use it later for creating, fetching or deleting objects</span>
</span><span class="hll">  <span class="n">movies_view_controller</span><span class="o">.</span><span class="n">managed_object_context</span> <span class="o">=</span> <span class="vi">@managed_object_context</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add it as a root view controller of a UINavigationController</span>
</span><span class="hll">  <span class="n">navigation_controller</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="n">movies_view_controller</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Create a new UIWindow and add our UINavigationController to it</span>
</span><span class="hll">  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
</span><span class="hll">  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">navigation_controller</span>
</span><span class="hll">  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run our app we should se the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_InitialMoviesViewController.png" alt="Initial Movies View Controller" />
</div>
<div class="title">Figure 109. Initial Movies View Controller</div>
</div>
<div class="paragraph"><p>Awesome! The next step is to create a new view controller called <strong>Add Movie View Controller</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch add_movie_view_controller.rb

<span class="nv">$ </span>open add_movie_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddMovieViewController</span> <span class="o">&lt;</span> <span class="no">UITableViewController</span>

  <span class="kp">attr_accessor</span> <span class="ss">:managed_object_context</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="c1"># Set up the title for the View Controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Add Movie&#39;</span>

    <span class="c1"># Create a new Table View for showing the Text Fields</span>
    <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                                 <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>

    <span class="c1"># Set up the view controller as a Data Source</span>
    <span class="c1"># of the table view</span>
    <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>

    <span class="c1"># Add the table view as view of the view controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>
  <span class="k">end</span>


  <span class="c1"># UITableView Data Source</span>

  <span class="k">def</span> <span class="nf">numberOfSectionsInTableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">)</span>

    <span class="c1"># Lets set two sections one for the Movie General</span>
    <span class="c1"># Data and another for a list of Directors</span>
    <span class="mi">2</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">titleForHeaderInSection</span><span class="p">:</span> <span class="n">section</span><span class="p">)</span>

    <span class="c1"># Create a new variable to store our header title</span>
    <span class="n">title_for_header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>


    <span class="c1"># If the section is the Directors One</span>
    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="mi">1</span>

      <span class="c1"># Set the title to the title variable</span>
      <span class="n">title_for_header</span> <span class="o">=</span> <span class="s1">&#39;Choose a Director...&#39;</span>
    <span class="k">end</span>

    <span class="c1"># Return the title variable</span>
    <span class="n">title_for_header</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">numberOfRowsInSection</span><span class="p">:</span> <span class="n">section</span><span class="p">)</span>

    <span class="c1"># Lets create a new instance variable for storing</span>
    <span class="c1"># the number of rows in the section</span>
    <span class="n">number_of_rows</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># If the section is General Data</span>
    <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="mi">0</span>

      <span class="c1"># We need two rows</span>
      <span class="n">number_of_rows</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">else</span>

      <span class="c1"># If the section is Directors we need only one</span>
      <span class="n">number_of_rows</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">end</span>

    <span class="c1"># Return the number of rows for the section</span>
    <span class="n">number_of_rows</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

    <span class="c1"># If the section is General Data</span>
    <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">0</span>

      <span class="c1"># Return a General Data Cell</span>
      <span class="n">general_information_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">index_path</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
    <span class="k">else</span>

      <span class="c1"># Return a Add Director Cell</span>
      <span class="n">add_director_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">general_information_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">index_path</span><span class="p">:</span> <span class="n">index_path</span><span class="p">)</span>

    <span class="c1"># Create a cell identifier for the General Information Cell</span>
    <span class="n">cell_identifier</span> <span class="o">=</span> <span class="s1">&#39;GeneralInformationCell&#39;</span>

    <span class="c1"># Dequeue a cell with the identifier</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="n">cell_identifier</span><span class="p">)</span>


    <span class="c1"># If we are not cells to use we need to create one</span>
    <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="kp">nil</span>

      <span class="c1"># Lets create a new UITableViewCell with the identifier</span>
      <span class="n">cell</span> <span class="o">=</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="n">cell_identifier</span><span class="p">)</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">selectionStyle</span> <span class="o">=</span> <span class="no">UITableViewCellSelectionStyleNone</span>

      <span class="c1"># Instantiate a new UITextField for editing some values</span>
      <span class="n">cell_text_field</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
      <span class="n">cell_text_field</span><span class="o">.</span><span class="n">autocorrectionType</span> <span class="o">=</span> <span class="no">UITextAutocorrectionTypeNo</span><span class="p">;</span>
      <span class="n">cell_text_field</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">235</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">325</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">506</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>

      <span class="c1"># Set the view controller as delegate of the Text Field</span>
      <span class="n">cell_text_field</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

      <span class="c1"># Add the Text Field into the cell view</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">cell_text_field</span><span class="p">)</span>

      <span class="c1"># If the row is the first one</span>
      <span class="k">if</span> <span class="n">index_path</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="n">cell_text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s1">&#39;Required&#39;</span>

        <span class="c1"># Assign the cell_text_field as name_text_field</span>
        <span class="vi">@name_text_field</span> <span class="o">=</span> <span class="n">cell_text_field</span>
      <span class="k">else</span>

        <span class="n">cell_text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s1">&#39;Optional&#39;</span>

        <span class="c1"># Assign the cell_text_field as release_year_text_field</span>
        <span class="vi">@release_year_text_field</span> <span class="o">=</span> <span class="n">cell_text_field</span>
      <span class="k">end</span>
    <span class="k">end</span>


    <span class="c1"># If the row is the first one</span>
    <span class="k">if</span> <span class="n">index_path</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span>

      <span class="c1"># Set the title to Name</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Name&#39;</span>
    <span class="k">else</span>

      <span class="c1"># Else set the title to Year</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span>
    <span class="k">end</span>

    <span class="n">cell</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">add_director_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">)</span>

    <span class="c1">#Create a cell identifier for the Add Director Cell</span>
    <span class="n">cell_identifier</span> <span class="o">=</span> <span class="s1">&#39;AddDirectorCell&#39;</span>

    <span class="c1"># Dequeue a cell with the identifier</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="n">cell_identifier</span><span class="p">)</span>


    <span class="c1"># If we are not cells to use we need to create one</span>
    <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="kp">nil</span>

      <span class="c1"># Lets create a new UITableViewCell with the identifier</span>
      <span class="n">cell</span> <span class="o">=</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="n">cell_identifier</span><span class="p">)</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">accessoryType</span> <span class="o">=</span> <span class="no">UITableViewCellAccessoryDisclosureIndicator</span>
    <span class="k">end</span>

    <span class="c1"># Add text to the cell</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Add Director...&#39;</span>

    <span class="n">cell</span>
  <span class="k">end</span>


  <span class="c1"># UITextField Delegate</span>
  <span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textField</span><span class="p">)</span>

    <span class="c1"># Resign the UITextField as first responder to hide</span>
    <span class="c1"># the keyboard</span>
    <span class="n">textField</span><span class="o">.</span><span class="n">resignFirstResponder</span>

    <span class="kp">true</span>
  <span class="k">end</span>


<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great now that we have our <strong>add_movie_view_controller.rb</strong> lets  present it using our <strong>movies_view_controller.rb</strong>, so lets open it and add the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open movies_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_new_movie</span>

  <span class="c1"># Create a new AddMovieViewController</span>
  <span class="n">add_movie_view_controller</span> <span class="o">=</span> <span class="no">AddMovieViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># We need to pass the Managed Object Context to the next controller</span>
  <span class="c1"># so we can use it later for creating, fetching or deleting objects</span>
  <span class="n">add_movie_view_controller</span><span class="o">.</span><span class="n">managed_object_context</span> <span class="o">=</span> <span class="vi">@managed_object_context</span>


  <span class="c1"># Push it using the Navigation Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">add_movie_view_controller</span><span class="p">,</span>
                                               <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now if we run the app and select the plus button we should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_InitialAddMovieViewController.png" alt="Initial Add Movie View Controller" />
</div>
<div class="title">Figure 110. Initial Add Movie View Controller</div>
</div>
<div class="paragraph"><p>Before we can start adding movies is required to add a Director first, so lets create a view controller called <strong>add_director_view_controller.rb</strong> for this task:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch add_director_view_controller.rb

<span class="nv">$ </span>open add_director_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddDirectorViewController</span> <span class="o">&lt;</span> <span class="no">UITableViewController</span>

  <span class="kp">attr_accessor</span> <span class="ss">:managed_object_context</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="c1"># Set up the title for the View Controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Add Director&#39;</span>

    <span class="c1"># Create a new Table View for showing the Text Fields</span>
    <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                                 <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>

    <span class="c1"># Set up the view controller as a Data Source</span>
    <span class="c1"># of the table view</span>
    <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>

    <span class="c1"># Add the table view as view of the view controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>
  <span class="k">end</span>


  <span class="c1"># UITableView Data Source</span>

  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">numberOfRowsInSection</span><span class="p">:</span> <span class="n">section</span><span class="p">)</span>

    <span class="c1"># Because the Director only has one attribute, we only</span>
    <span class="c1"># need one cell</span>
    <span class="mi">1</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

    <span class="c1"># Create a cell identifier for the General Information Cell</span>
    <span class="n">cell_identifier</span> <span class="o">=</span> <span class="s1">&#39;GeneralInformationCell&#39;</span>

    <span class="c1"># Dequeue a cell with the identifier</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="n">cell_identifier</span><span class="p">)</span>


    <span class="c1"># If we are not cells to use we need to create one</span>
    <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="kp">nil</span>

      <span class="c1"># Lets create a new UITableViewCell with the identifier</span>
      <span class="n">cell</span> <span class="o">=</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="n">cell_identifier</span><span class="p">)</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">selectionStyle</span> <span class="o">=</span> <span class="no">UITableViewCellSelectionStyleNone</span>

      <span class="c1"># Instantiate a new UITextField for editing the name of the</span>
      <span class="c1"># new director</span>
      <span class="vi">@name_text_field</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
      <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">autocorrectionType</span> <span class="o">=</span> <span class="no">UITextAutocorrectionTypeNo</span><span class="p">;</span>
      <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s1">&#39;Required&#39;</span>
      <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">235</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">325</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">506</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>

      <span class="c1"># Set the view controller as delegate of the Text Field</span>
      <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

      <span class="c1"># Add the Text Field into the cell view</span>
      <span class="n">cell</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@name_text_field</span><span class="p">)</span>

    <span class="k">end</span>


    <span class="c1"># Set the title to Name</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Name&#39;</span>

    <span class="n">cell</span>
  <span class="k">end</span>


  <span class="c1"># UITextField Delegate</span>
  <span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textField</span><span class="p">)</span>

    <span class="c1"># Resign the UITextField as first responder to hide</span>
    <span class="c1"># the keyboard</span>
    <span class="n">textField</span><span class="o">.</span><span class="n">resignFirstResponder</span>

    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great! The only thing left to do is present the <strong>add_director_view_controller.rb</strong> when the user select the <strong>Add Director..</strong> cell. For this we need to open our <strong>add_movie_view_controller.rb</strong> and edit the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open add_movie_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Set up the title for the View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Add Movie&#39;</span>

  <span class="c1"># Create a new Table View for showing the Text Fields</span>
  <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                               <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>

  <span class="c1"># Set up the view controller as a Data Source</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>

<span class="hll">  <span class="c1"># Set up the view controller as a Delegate</span>
</span><span class="hll">  <span class="c1"># of the table view</span>
</span><span class="hll">  <span class="n">table_view</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
</span>
  <span class="c1"># Add the table view as view of the view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>
<span class="k">end</span>


<span class="c1"># UITableView Delegate</span>

<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

  <span class="c1"># If the section is the Directors one</span>
  <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Create a new AddDirectorViewController</span>
    <span class="n">add_director_view_controller</span> <span class="o">=</span> <span class="no">AddDirectorViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="c1"># We need to pass the Managed Object Context to the next controller</span>
    <span class="c1"># so we can use it later for creating, fetching or deleting objects</span>
    <span class="n">add_director_view_controller</span><span class="o">.</span><span class="n">managed_object_context</span> <span class="o">=</span> <span class="vi">@managed_object_context</span>

    <span class="c1"># Push it using the Navigation Controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">add_director_view_controller</span><span class="p">,</span>
                                                 <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now our <strong>AddDirectorViewController</strong> is visible:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_InitialAddDirectorViewController.png" alt="Initial Add Director View Controller" />
</div>
<div class="title">Figure 111. Initial Add Director View Controller</div>
</div>
</div>
<div class="sect2">
<h3 id="_new_objects">New Objects</h3>
<div class="paragraph"><p>Lets create our first Core Data Object in this case <strong>Director</strong>, please open your <strong>add_director_view_controller.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open add_director_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Set up the title for the View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Add Director&#39;</span>

  <span class="c1"># Create a new Table View for showing the Text Fields</span>
  <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                               <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>

  <span class="c1"># Set up the view controller as a Data Source</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="c1"># Add the table view as view of the view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>

<span class="hll">  <span class="c1"># Add new Bar Button Item to the Navigation Bar for saving</span>
</span><span class="hll">  <span class="n">save_bar_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s1">&#39;Save&#39;</span><span class="p">,</span>
</span><span class="hll">                                                             <span class="ss">style</span><span class="p">:</span> <span class="no">UIBarButtonItemStyleDone</span><span class="p">,</span>
</span><span class="hll">                                                             <span class="ss">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                             <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;save_new_director&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the Bar Button Item to the Navigation Bar</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">save_bar_button_item</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Disable the Save button until the user add some text</span>
</span><span class="hll">  <span class="c1"># into the UITextView</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">save_new_director</span>

  <span class="c1"># Using Core Data create a new instance of the object Director</span>
  <span class="n">director</span> <span class="o">=</span> <span class="no">NSEntityDescription</span><span class="o">.</span><span class="n">insertNewObjectForEntityForName</span><span class="p">(</span><span class="no">Director</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                 <span class="ss">inManagedObjectContext</span><span class="p">:</span> <span class="vi">@managed_object_context</span><span class="p">)</span>

  <span class="c1"># Assign the text of the UITextField to the director name</span>
  <span class="n">director</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">text</span>


  <span class="c1"># Create a new pointer for managing the errors</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Lets persist the new Director object, saving the managed</span>
  <span class="c1"># object context that contains it</span>
  <span class="k">unless</span> <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">error_pointer</span><span class="p">)</span>

    <span class="c1"># In case we can not save it</span>
    <span class="k">raise</span> <span class="s2">&quot;Error saving a new Director: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="c1"># Pop the Director View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">popViewControllerAnimated</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">textField</span><span class="p">(</span><span class="n">textField</span><span class="p">,</span> <span class="ss">shouldChangeCharactersInRange</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span> <span class="ss">replacementString</span><span class="p">:</span> <span class="n">string</span><span class="p">)</span>

  <span class="c1"># Calculate the final length of the text in the UITextField</span>
  <span class="n">text_length</span> <span class="o">=</span> <span class="n">textField</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">range</span><span class="o">.</span><span class="n">length</span>


  <span class="c1"># If the length of the text is greater than 0</span>
  <span class="k">if</span> <span class="n">text_length</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Enable the save button</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
  <span class="k">else</span>

    <span class="c1"># Else disable the save button</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
  <span class="k">end</span>

  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we are saving a new Director!</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_SaveANewDirector.png" alt="Save a new Director" />
</div>
<div class="title">Figure 112. Save a new Director</div>
</div>
<div class="paragraph"><p>At least on theory right? If we select the save button we return to the previous screen but we are not seeing any directors added yet. Lets implement these part in our <strong>add_movie_view_controller.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open add_movie_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

<span class="hll">  <span class="c1">#For security lets set up the fetched_directors array</span>
</span><span class="hll">  <span class="vi">@fetched_directors</span> <span class="o">=</span> <span class="o">[]</span>
</span>
  <span class="c1"># Set up the title for the View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Add Movie&#39;</span>

  <span class="c1"># Create a new Table View for showing the Text Fields</span>
  <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                               <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>

  <span class="c1"># Set up the view controller as a Data Source</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="c1"># Set up the view controller as a Delegate</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="c1"># Add the table view as view of the view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>


  <span class="c1"># Add new Bar Button Item to the Navigation Bar for saving</span>
  <span class="n">save_bar_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s1">&#39;Save&#39;</span><span class="p">,</span>
                                                             <span class="ss">style</span><span class="p">:</span> <span class="no">UIBarButtonItemStyleDone</span><span class="p">,</span>
                                                             <span class="ss">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span>
                                                             <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;save_new_movie&#39;</span><span class="p">)</span>

  <span class="c1"># Add the Bar Button Item to the Navigation Bar</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">save_bar_button_item</span>

  <span class="c1"># Disable the Save button until the user add some text</span>
  <span class="c1"># into the text views and select a Director from the list</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>

  <span class="c1"># Using a NSFetchRequest object we can ask Core Data</span>
  <span class="c1"># to fetch specific objects</span>
  <span class="n">fetch_request</span> <span class="o">=</span> <span class="no">NSFetchRequest</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># We need a NSEntityDescription for the Director object</span>
  <span class="c1"># so we can tell Core Data which entity we want to</span>
  <span class="c1"># retrieve</span>
  <span class="n">director_entity</span> <span class="o">=</span> <span class="no">NSEntityDescription</span><span class="o">.</span><span class="n">entityForName</span><span class="p">(</span><span class="no">Director</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                      <span class="ss">inManagedObjectContext</span><span class="p">:</span><span class="vi">@managed_object_context</span><span class="p">)</span>
  <span class="n">fetch_request</span><span class="o">.</span><span class="n">setEntity</span><span class="p">(</span><span class="n">director_entity</span><span class="p">)</span>

  <span class="c1"># Sort the directors by their &quot;name&quot; attribute</span>
  <span class="n">fetch_sort</span> <span class="o">=</span> <span class="no">NSSortDescriptor</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithKey</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                                                  <span class="ss">ascending</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">fetch_request</span><span class="o">.</span><span class="n">setSortDescriptors</span><span class="p">(</span><span class="o">[</span><span class="n">fetch_sort</span><span class="o">]</span><span class="p">)</span>


  <span class="c1"># Create a new pointer for managing the errors</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Using the NSManagedObjectContext execute the fetch</span>
  <span class="c1"># request</span>
  <span class="vi">@fetched_directors</span> <span class="o">=</span> <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">executeFetchRequest</span><span class="p">(</span><span class="n">fetch_request</span><span class="p">,</span>
                                                                   <span class="ss">error</span><span class="p">:</span> <span class="n">error_pointer</span><span class="p">)</span>

  <span class="c1"># If the returning array of the fetch request is nil</span>
  <span class="c1"># means that a problem has occured</span>
  <span class="k">unless</span> <span class="vi">@fetched_directors</span>

    <span class="c1"># In case we can not fetch the directors</span>
    <span class="k">raise</span> <span class="s2">&quot;Error fetching Directors: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">end</span>

  <span class="c1"># Ask the table view to reload its data</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">numberOfRowsInSection</span><span class="p">:</span> <span class="n">section</span><span class="p">)</span>

  <span class="c1"># Lets create a new instance variable for storing</span>
  <span class="c1"># the number of rows in the section</span>
  <span class="n">number_of_rows</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1"># If the section is General Data</span>
  <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># We need two rows</span>
    <span class="n">number_of_rows</span> <span class="o">=</span> <span class="mi">2</span>

  <span class="k">else</span>

<span class="hll">    <span class="c1"># If the section is Directors we need to add one more</span>
</span><span class="hll">    <span class="c1"># to the total of directors fetched because the need of</span>
</span><span class="hll">    <span class="c1"># the &#39;Add Director...&#39; cell</span>
</span><span class="hll">    <span class="n">number_of_rows</span> <span class="o">=</span> <span class="vi">@fetched_directors</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
</span>  <span class="k">end</span>

  <span class="c1"># Return the number of rows for the section</span>
  <span class="n">number_of_rows</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

  <span class="c1"># If the section is General Data</span>
  <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Return a General Data Cell</span>
    <span class="n">general_information_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">index_path</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

<span class="hll">  <span class="c1"># If the section is Directors but is not the &#39;Add Director...&#39;</span>
</span><span class="hll">  <span class="c1"># cell, remember we are adding + 1 to the total fetched directors</span>
</span><span class="hll">  <span class="c1"># count</span>
</span><span class="hll">  <span class="k">elsif</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="vi">@fetched_directors</span><span class="o">.</span><span class="n">count</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Return a Director Cell</span>
</span><span class="hll">    <span class="n">director_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">index_path</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
</span><span class="hll">  <span class="k">else</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Return a Add Director Cell</span>
</span><span class="hll">    <span class="n">add_director_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">)</span>
</span><span class="hll">  <span class="k">end</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">director_cell_for_table_view</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">index_path</span><span class="p">:</span> <span class="n">index_path</span><span class="p">)</span>

  <span class="c1">#Create a cell identifier for the Director Cell</span>
  <span class="n">cell_identifier</span> <span class="o">=</span> <span class="s1">&#39;DirectorCell&#39;</span>

  <span class="c1"># Dequeue a cell with the identifier</span>
  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="n">cell_identifier</span><span class="p">)</span>


  <span class="c1"># If we are not cells to use we need to create one</span>
  <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="kp">nil</span>

    <span class="c1"># Lets create a new UITableViewCell with the identifier</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="n">cell_identifier</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Get the fetched director from the array</span>
  <span class="n">director</span> <span class="o">=</span> <span class="vi">@fetched_directors</span><span class="o">[</span><span class="n">index_path</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>

  <span class="c1"># Add the director name to the cell</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">director</span><span class="o">.</span><span class="n">name</span>

  <span class="n">cell</span>
<span class="k">end</span>


<span class="c1"># UITableView Delegate</span>

<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

<span class="hll">  <span class="c1"># If the section is the Directors one and the cell is the</span>
</span><span class="hll">  <span class="c1"># &#39;Add Director...&#39; one</span>
</span><span class="hll">  <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span>  <span class="o">&amp;&amp;</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">&gt;</span> <span class="vi">@fetched_directors</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Create a new AddDirectorViewController</span>
</span><span class="hll">    <span class="n">add_director_view_controller</span> <span class="o">=</span> <span class="no">AddDirectorViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># We need to pass the Managed Object Context to the next controller</span>
</span><span class="hll">    <span class="c1"># so we can use it later for creating, fetching or deleting objects</span>
</span><span class="hll">    <span class="n">add_director_view_controller</span><span class="o">.</span><span class="n">managed_object_context</span> <span class="o">=</span> <span class="vi">@managed_object_context</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Push it using the Navigation Controller</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">add_director_view_controller</span><span class="p">,</span>
</span><span class="hll">                                                 <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># If the section is Directors but is not the &#39;Add Director...&#39;</span>
</span><span class="hll">  <span class="c1"># cell, remember we are adding + 1 to the total fetched directors</span>
</span><span class="hll">  <span class="c1"># count</span>
</span><span class="hll">  <span class="k">elsif</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="vi">@fetched_directors</span><span class="o">.</span><span class="n">count</span>
</span><span class="hll">
</span><span class="hll">    <span class="vi">@selected_director</span> <span class="o">=</span> <span class="vi">@fetched_directors</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>
</span><span class="hll">  <span class="k">end</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Yes! If we run our app again we should see now all the directors loaded into the <strong>add_movie_view_controller.rb</strong> table view</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_LoadedDirectors.png" alt="Loaded Directors" />
</div>
<div class="title">Figure 113. Loaded Directors</div>
</div>
<div class="paragraph"><p>Finally in these part it will be creating the new movie on our <strong>add_movie_view_controller.rb</strong>, please open it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open add_movie_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Set up the title for the View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Add Movie&#39;</span>

  <span class="c1"># Create a new Table View for showing the Text Fields</span>
  <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                               <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>

  <span class="c1"># Set up the view controller as a Data Source</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="c1"># Set up the view controller as a Delegate</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="c1"># Add the table view as view of the view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>


<span class="hll">  <span class="c1"># Add new Bar Button Item to the Navigation Bar for saving</span>
</span><span class="hll">  <span class="n">save_bar_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s1">&#39;Save&#39;</span><span class="p">,</span>
</span><span class="hll">                                                             <span class="ss">style</span><span class="p">:</span> <span class="no">UIBarButtonItemStyleDone</span><span class="p">,</span>
</span><span class="hll">                                                             <span class="ss">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                             <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;save_new_movie&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the Bar Button Item to the Navigation Bar</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">save_bar_button_item</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Disable the Save button until the user add some text</span>
</span><span class="hll">  <span class="c1"># into the text views and select a Director from the list</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">save_new_movie</span>

  <span class="c1"># Using Core Data create a new instance of the object Movie</span>
  <span class="n">movie</span> <span class="o">=</span> <span class="no">NSEntityDescription</span><span class="o">.</span><span class="n">insertNewObjectForEntityForName</span><span class="p">(</span><span class="no">Movie</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                              <span class="ss">inManagedObjectContext</span><span class="p">:</span> <span class="vi">@managed_object_context</span><span class="p">)</span>

  <span class="c1"># Assign the text of the name text field to the movie</span>
  <span class="c1"># name</span>
  <span class="n">movie</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">text</span>

  <span class="k">if</span> <span class="vi">@release_year_text_field</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="kp">nil</span>

    <span class="c1"># Assign the text of the year text field to the movie</span>
    <span class="c1"># year</span>
    <span class="n">movie</span><span class="o">.</span><span class="n">release_year</span> <span class="o">=</span> <span class="vi">@release_year_text_field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">intValue</span>
  <span class="k">end</span>

  <span class="c1"># Assign the selected director to the movie</span>
  <span class="n">movie</span><span class="o">.</span><span class="n">director</span> <span class="o">=</span> <span class="vi">@selected_director</span>

  <span class="c1"># Create a new pointer for managing the errors</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Lets persist the new Movie object, saving the managed</span>
  <span class="c1"># object context that contains it</span>
  <span class="k">unless</span> <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">error_pointer</span><span class="p">)</span>

  <span class="c1"># In case we can not save it</span>
   <span class="k">raise</span> <span class="s2">&quot;Error saving a new Movie: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="c1"># Pop the Movie View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">popViewControllerAnimated</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">textField</span><span class="p">(</span><span class="n">textField</span><span class="p">,</span> <span class="ss">shouldChangeCharactersInRange</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span> <span class="ss">replacementString</span><span class="p">:</span> <span class="n">string</span><span class="p">)</span>

  <span class="c1"># If the changing text field is the name one and there is already</span>
  <span class="c1"># selected a Director from the list</span>
  <span class="k">if</span> <span class="n">textField</span> <span class="o">==</span> <span class="vi">@name_text_field</span> <span class="o">&amp;&amp;</span> <span class="vi">@selected_director</span> <span class="o">!=</span> <span class="kp">nil</span>

    <span class="c1"># Calculate the final length of the text in the UITextField</span>
    <span class="n">text_length</span> <span class="o">=</span> <span class="n">textField</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">range</span><span class="o">.</span><span class="n">length</span>


    <span class="c1"># If the length of the text is greater than 0</span>
    <span class="k">if</span> <span class="n">text_length</span> <span class="o">&gt;</span> <span class="mi">0</span>

      <span class="c1"># Enable the save button</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
    <span class="k">else</span>

      <span class="c1"># Else disable the save button</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span><span class="p">;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">true</span>
<span class="k">end</span>


<span class="c1"># UITableView Delegate</span>

<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">didSelectRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

  <span class="c1"># If the section is the Directors one and the cell is the</span>
  <span class="c1"># &#39;Add Director...&#39; one</span>
  <span class="k">if</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">&gt;</span> <span class="vi">@fetched_directors</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Create a new AddDirectorViewController</span>
    <span class="n">add_director_view_controller</span> <span class="o">=</span> <span class="no">AddDirectorViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="c1"># We need to pass the Managed Object Context to the next controller</span>
    <span class="c1"># so we can use it later for creating, fetching or deleting objects</span>
    <span class="n">add_director_view_controller</span><span class="o">.</span><span class="n">managed_object_context</span> <span class="o">=</span> <span class="vi">@managed_object_context</span>

    <span class="c1"># Push it using the Navigation Controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">pushViewController</span><span class="p">(</span><span class="n">add_director_view_controller</span><span class="p">,</span>
                                                 <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>

    <span class="c1"># If the section is Directors but is not the &#39;Add Director...&#39;</span>
    <span class="c1"># cell, remember we are adding + 1 to the total fetched directors</span>
    <span class="c1"># count</span>
  <span class="k">elsif</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">&lt;</span> <span class="vi">@fetched_directors</span><span class="o">.</span><span class="n">count</span>

    <span class="vi">@selected_director</span> <span class="o">=</span> <span class="vi">@fetched_directors</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>

<span class="hll">    <span class="c1"># If the length of the text is greater than 0</span>
</span><span class="hll">    <span class="k">if</span> <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="kp">nil</span> <span class="o">&amp;&amp;</span> <span class="vi">@name_text_field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Enable the save button</span>
</span><span class="hll">      <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
</span><span class="hll">    <span class="k">end</span>
</span>  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now the movie save is also working! So we can continue to the last part of the exercise: Searching and Deleting</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_SaveANewMovie.png" alt="Save a new Movie" />
</div>
<div class="title">Figure 114. Save a new Movie</div>
</div>
</div>
<div class="sect2">
<h3 id="_search_and_destroy">Search and Destroy</h3>
<div class="paragraph"><p>Finally we can work on our <strong>movies_view_controller.rb</strong>, the first thing that we should do is to add a UITableViewController to it and load the <strong>Movie</strong> objects into it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open movies_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

<span class="hll">  <span class="c1"># Set up the title for the View Controller</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Movies&#39;</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Create a new Table View for showing the Text Fields</span>
</span><span class="hll">  <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
</span><span class="hll">                                               <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set up the view controller as a Data Source</span>
</span><span class="hll">  <span class="c1"># of the table view</span>
</span><span class="hll">  <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the table view as view of the view controller</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>
</span>

  <span class="c1"># Create a new Bar Button Item with the Add System Default</span>
  <span class="n">add_movie_bar_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithBarButtonSystemItem</span><span class="p">(</span><span class="no">UIBarButtonSystemItemAdd</span><span class="p">,</span>
                                                                                <span class="ss">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span>
                                                                                <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;add_new_movie&#39;</span><span class="p">)</span>

  <span class="c1"># Add the Bar Button Item to the Navigation Bar</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">add_movie_bar_button_item</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>

  <span class="c1"># Fetch the movies from Core Data and update</span>
  <span class="c1"># the table view</span>
  <span class="n">reload_data</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">reload_data</span>

  <span class="c1"># Using a NSFetchRequest object we can ask Core Data</span>
  <span class="c1"># to fetch specific objects</span>
  <span class="n">fetch_request</span> <span class="o">=</span> <span class="no">NSFetchRequest</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># We need a NSEntityDescription for the Movie object</span>
  <span class="c1"># so we can tell Core Data which entity we want to</span>
  <span class="c1"># retrieve</span>
  <span class="n">director_entity</span> <span class="o">=</span> <span class="no">NSEntityDescription</span><span class="o">.</span><span class="n">entityForName</span><span class="p">(</span><span class="no">Movie</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                      <span class="ss">inManagedObjectContext</span><span class="p">:</span><span class="vi">@managed_object_context</span><span class="p">)</span>
  <span class="n">fetch_request</span><span class="o">.</span><span class="n">setEntity</span><span class="p">(</span><span class="n">director_entity</span><span class="p">)</span>

  <span class="c1"># Sort the movies by their &quot;name&quot; attribute</span>
  <span class="n">fetch_sort</span> <span class="o">=</span> <span class="no">NSSortDescriptor</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithKey</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                                                  <span class="ss">ascending</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
  <span class="n">fetch_request</span><span class="o">.</span><span class="n">setSortDescriptors</span><span class="p">(</span><span class="o">[</span><span class="n">fetch_sort</span><span class="o">]</span><span class="p">)</span>

  <span class="c1"># Update the fetch movies array and reload the table view</span>
  <span class="n">update_fetched_movies_with_fetch_request</span><span class="p">(</span><span class="n">fetch_request</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">update_fetched_movies_with_fetch_request</span><span class="p">(</span><span class="n">fetch_request</span><span class="p">)</span>

  <span class="c1"># Create a new pointer for managing the errors</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Using the NSManagedObjectContext execute the fetch</span>
  <span class="c1"># request</span>
  <span class="vi">@fetched_movies</span> <span class="o">=</span> <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">executeFetchRequest</span><span class="p">(</span><span class="n">fetch_request</span><span class="p">,</span>
                                                                <span class="ss">error</span><span class="p">:</span> <span class="n">error_pointer</span><span class="p">)</span>

  <span class="c1"># If the returning array of the fetch request is nil</span>
  <span class="c1"># means that a problem has occured</span>
  <span class="k">unless</span> <span class="vi">@fetched_movies</span>

    <span class="c1"># In case we can not fetch the directors</span>
    <span class="k">raise</span> <span class="s2">&quot;Error fetching Movies: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="k">end</span>

  <span class="c1"># Ask the table view to reload its data</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>


<span class="c1"># UITableView Data Source</span>

<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">numberOfRowsInSection</span><span class="p">:</span> <span class="n">section</span><span class="p">)</span>

  <span class="c1"># Return the count of the fetched movies</span>
  <span class="vi">@fetched_movies</span><span class="o">.</span><span class="n">count</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

  <span class="c1"># Create a cell identifier for the Movie Cell</span>
  <span class="n">cell_identifier</span> <span class="o">=</span> <span class="s1">&#39;MovieCell&#39;</span>

  <span class="c1"># Dequeue a cell with the identifier</span>
  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="n">cell_identifier</span><span class="p">)</span>


  <span class="c1"># If we are not cells to use we need to create one</span>
  <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="kp">nil</span>

    <span class="c1"># Lets create a new UITableViewCell with the identifier</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleValue1</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="n">cell_identifier</span><span class="p">)</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">selectionStyle</span> <span class="o">=</span> <span class="no">UITableViewCellSelectionStyleNone</span>
  <span class="k">end</span>


  <span class="c1"># Get the fetched movie from the array</span>
  <span class="n">movie</span> <span class="o">=</span> <span class="vi">@fetched_movies</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>

  <span class="c1"># Set the title to the movie name</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">name</span>

  <span class="c1"># Set the detail text label to the movie director name</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">director</span><span class="o">.</span><span class="n">name</span>

  <span class="n">cell</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great now we can see the movies that we already add in the <strong>add_movie_view_controller.rb</strong></p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_LoadedMovies.png" alt="Loaded Movies" />
</div>
<div class="title">Figure 115. Loaded Movies</div>
</div>
<div class="paragraph"><p>Now is time to add some search functionality:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Set up the title for the View Controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Movies&#39;</span>

  <span class="c1"># Create a new Table View for showing the Text Fields</span>
  <span class="n">table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                               <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStyleGrouped</span><span class="p">)</span>


<span class="hll">  <span class="c1"># Create a new Search Bar for the user to add some text</span>
</span><span class="hll">  <span class="vi">@search_bar</span> <span class="o">=</span> <span class="no">UISearchBar</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">44</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Set its delegate to movies view controller</span>
</span><span class="hll">  <span class="vi">@search_bar</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the Search Bar to the table view header</span>
</span><span class="hll">  <span class="n">table_view</span><span class="o">.</span><span class="n">setTableHeaderView</span><span class="p">(</span><span class="vi">@search_bar</span><span class="p">)</span>
</span>

  <span class="c1"># Set up the view controller as a Data Source</span>
  <span class="c1"># of the table view</span>
  <span class="n">table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>


  <span class="c1"># Add the table view as view of the view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">table_view</span>


  <span class="c1"># Create a new Bar Button Item with the Add System Default</span>
  <span class="n">add_movie_bar_button_item</span> <span class="o">=</span> <span class="no">UIBarButtonItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithBarButtonSystemItem</span><span class="p">(</span><span class="no">UIBarButtonSystemItemAdd</span><span class="p">,</span>
                                                                                <span class="ss">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span>
                                                                                <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;add_new_movie&#39;</span><span class="p">)</span>

  <span class="c1"># Add the Bar Button Item to the Navigation Bar</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">add_movie_bar_button_item</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">searchBar</span><span class="p">(</span><span class="n">searchBar</span><span class="p">,</span> <span class="ss">textDidChange</span><span class="p">:</span><span class="n">searchText</span><span class="p">)</span>

  <span class="c1"># If the SearchBar text contains text execute the search</span>
  <span class="c1"># in Core Data, if not clean the search results</span>
  <span class="k">if</span> <span class="n">searchBar</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Using a NSFetchRequest object we can ask Core Data</span>
    <span class="c1"># to fetch specific objects</span>
    <span class="n">fetch_request</span> <span class="o">=</span> <span class="no">NSFetchRequest</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="c1"># We need a NSEntityDescription for the Movie object</span>
    <span class="c1"># so we can tell Core Data which entity we want to</span>
    <span class="c1"># retrieve</span>
    <span class="n">director_entity</span> <span class="o">=</span> <span class="no">NSEntityDescription</span><span class="o">.</span><span class="n">entityForName</span><span class="p">(</span><span class="no">Movie</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                        <span class="ss">inManagedObjectContext</span><span class="p">:</span><span class="vi">@managed_object_context</span><span class="p">)</span>
    <span class="n">fetch_request</span><span class="o">.</span><span class="n">setEntity</span><span class="p">(</span><span class="n">director_entity</span><span class="p">)</span>

    <span class="c1"># Sort the movies by their &quot;name&quot; attribute</span>
    <span class="n">fetch_sort</span> <span class="o">=</span> <span class="no">NSSortDescriptor</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithKey</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                                                    <span class="ss">ascending</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
    <span class="n">fetch_request</span><span class="o">.</span><span class="n">setSortDescriptors</span><span class="p">(</span><span class="o">[</span><span class="n">fetch_sort</span><span class="o">]</span><span class="p">)</span>


    <span class="c1"># Create a predicate for our search query, in this case we want</span>
    <span class="c1"># every Movie that contains in the name or in the Directors name</span>
    <span class="c1"># the UISearchBar text</span>
    <span class="n">fetch_predicate</span> <span class="o">=</span> <span class="no">NSPredicate</span><span class="o">.</span><span class="n">predicateWithFormat</span><span class="p">(</span><span class="s2">&quot;name contains[cd] %@ OR director.name contains[cd] %@&quot;</span><span class="p">,</span>
                                                      <span class="ss">argumentArray</span><span class="p">:</span><span class="o">[</span><span class="n">searchBar</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">searchBar</span><span class="o">.</span><span class="n">text</span><span class="o">]</span><span class="p">)</span>

    <span class="c1"># Add the predicate to our NSFetchRequest</span>
    <span class="n">fetch_request</span><span class="o">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="n">fetch_predicate</span>

    <span class="c1"># Update the fetch movies array and reload the table view</span>
    <span class="n">update_fetched_movies_with_fetch_request</span><span class="p">(</span><span class="n">fetch_request</span><span class="p">)</span>

  <span class="k">else</span>

    <span class="c1"># Reload all the movies</span>
    <span class="n">reload_data</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Awesome! Now it search by the Movie Name and the Director Name</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_SearchMovies.png" alt="Search Movies" />
</div>
<div class="title">Figure 116. Search Movies</div>
</div>
<div class="paragraph"><p>The only feature left is the delete one, lets implement it adding the following methods to our <strong>movies_view_controller.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">canEditRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

  <span class="kp">true</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">commitEditingStyle</span><span class="p">:</span> <span class="n">editingStyle</span><span class="p">,</span> <span class="ss">forRowAtIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>

  <span class="c1"># Get the fetched movie from the array</span>
  <span class="n">movie</span> <span class="o">=</span> <span class="vi">@fetched_movies</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>

  <span class="c1"># Ask the NSManagedObjectContext to delete the object</span>
  <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

  <span class="c1"># Create a new pointer for managing the errors</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Lets persist the deleted Movie object, saving the managed</span>
  <span class="c1"># object context that contains it</span>
  <span class="k">unless</span> <span class="vi">@managed_object_context</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">error_pointer</span><span class="p">)</span>

    <span class="c1"># In case we can not save it</span>
    <span class="k">raise</span> <span class="s2">&quot;Error deleting a Movie: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>


  <span class="c1"># Create a new mutable copy of the fetched_movies array</span>
  <span class="n">mutable_fetched_movies</span> <span class="o">=</span> <span class="vi">@fetched_movies</span><span class="o">.</span><span class="n">mutableCopy</span>

  <span class="c1"># Remove the movie from the array</span>
  <span class="n">mutable_fetched_movies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

  <span class="c1"># Assign the modified array to our fetched_movies property</span>
  <span class="vi">@fetched_movies</span> <span class="o">=</span> <span class="n">mutable_fetched_movies</span>

  <span class="c1"># Tell the table view to delete the row</span>
  <span class="n">tableView</span><span class="o">.</span><span class="n">deleteRowsAtIndexPaths</span><span class="p">(</span><span class="o">[</span><span class="n">indexPath</span><span class="o">]</span><span class="p">,</span>
                                   <span class="ss">withRowAnimation</span><span class="p">:</span><span class="no">UITableViewRowAnimationFade</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch24-CoreData/ch24_DeleteMovies.png" alt="Delete Movies" />
</div>
<div class="title">Figure 117. Delete Movies</div>
</div>
<div class="paragraph"><p>Now is finish! In the exercise we look on how to add Model Objects into Core Data, also how to create, fetch and delete instances of them.</p></div>
</div>
<div class="sect2">
<h3 id="_challenges_7">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Add a new relationship to our <strong>Movie</strong> object, this time it should be the <strong>Actor</strong> model. Also you should modify the <strong>add_movie_view_controller.rb</strong> so the user can add actors to the new movies
</p>
</li>
<li>
<p>
Create a custom cell for the <strong>movies_view_controller.rb</strong> so it can show the name and release year of the Movie and the name of the Director
</p>
</li>
<li>
<p>
Add a new attribute to the <strong>Director</strong> object so the user can add the picture of the Director. Modify the <strong>add_new_director.rb</strong> accordingly
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="_chapter_25_third_party_libraries">Chapter 25 - Third Party Libraries</h1>
<div class="paragraph"><p>Integrating Third Party Libraries (Even if they are in Objective-C ;) into our project is pretty simple using CocoaPods. For this application lets make a simple game called asteroids using a library called Cocos2D</p></div>
<div class="sect1">
<h2 id="_cocoapods">CocoaPods</h2>
<div class="sectionbody">
<div class="paragraph"><p>CocoaPods (cocoapods.org) is a dependency library manager for Objective-C projects, much more like bundler is in rails. Using CocoaPods with a RubyMotion project simplifies all the tasks needed to integrate the library: Just add the Pod to the <strong>RakeFile</strong> and then compile the app. It will download the library, also all of its dependencies and then link them to the app.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_cocos_2d">Cocos 2D</h2>
<div class="sectionbody">
<div class="paragraph"><p>Cocos 2D (cocos2d-iphone.org) is a framework made it in Objective-C that will allow us to create a 2D Video Game more easy. In this case it will be a old game called Asteroids, the objective of the game is that using a SpaceShip destroy as many meteors as you can without crashing into them</p></div>
<div class="sect2">
<h3 id="_getting_it_running">Getting it Running</h3>
<div class="paragraph"><p>First we need to install CocoaPods into our MacOSX, this is done running the following commands into our terminal:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo gem install cocoapods

<span class="nv">$ </span>pod setup

<span class="nv">$ </span>sudo gem install motion-cocoapods
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_create_the_app">Create the App</h3>
<div class="paragraph"><p>Lets create a new project called <strong>Asteroids</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Asteroids
</pre></div></div></div>
<div class="paragraph"><p>Then integrate Cocos2D into our project editing our <strong>RakeFile</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>Asteroids

<span class="nv">$ </span>open RakeFile
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;/Library/RubyMotion/lib&quot;</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">&#39;motion/project&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;motion-cocoapods&#39;</span>

<span class="ss">Motion</span><span class="p">:</span><span class="ss">:Project</span><span class="o">::</span><span class="no">App</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
  <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;asteroids&#39;</span>

  <span class="n">app</span><span class="o">.</span><span class="n">pods</span> <span class="k">do</span>

    <span class="n">pod</span> <span class="s1">&#39;cocos2d&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Well! Lets build our project (It can take a couple of seconds because the weight of the Cocos2D library):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>Now please copy the file <strong>RubyMotionSchedule.h</strong> from <strong>resources/code</strong> folder into /vendor/Pods/cocos2d/cocos2d, next delete the file <strong>Pods.bridgesupport</strong> that is on /vendor/Pods and finally clean the project:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake clean

<span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>The Cocos2D library is now integrated into our project! Easy right?</p></div>
</div>
<div class="sect2">
<h3 id="_building_a_game">Building a Game</h3>
<div class="paragraph"><p>The first thing we need to understand is how the video games work, different from a regular application where the code is executed when an event happen (User interaction, Notification, etc) on video games there is always a loop calling methods for different proposes like refreshing screen, calling the game physics or asking something to the AI. Thankfully in Cocos 2D we have an object that its main responsibility is manage the loop, this class is called <strong>CCDirector</strong></p></div>
<div class="paragraph"><p>Before start coding please copy the images from <strong>resources/images</strong> folder into the project resources folder. Now implement the following on our <strong>AppDelegate</strong>:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The CCDirector is the responsible for running the game or pausing it, also it can handle when a phone call or text message happen so it can automatically pause the game</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The number of times the loop runs per second is called FPS (Frames per second), and it depends on how fast the methods are executed in every loop call</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

    <span class="c1"># Create a window to present our director</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Lets create a Cocos 2D view that will be used by the director</span>
    <span class="c1"># to present the game scenes</span>
    <span class="n">gl_view</span> <span class="o">=</span> <span class="no">CCGLView</span><span class="o">.</span><span class="n">viewWithFrame</span><span class="p">(</span><span class="vi">@window</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                     <span class="ss">pixelFormat</span><span class="p">:</span> <span class="no">KEAGLColorFormatRGBA8</span><span class="p">,</span>
                                     <span class="ss">depthFormat</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                     <span class="ss">preserveBackbuffer</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
                                     <span class="ss">sharegroup</span><span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
                                     <span class="ss">multiSampling</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
                                     <span class="ss">numberOfSamples</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>


    <span class="c1"># Get the Director shared instance for customization</span>
    <span class="vi">@director</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span>

    <span class="c1"># Specify that we want to run the game in fullscreen</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">wantsFullScreenLayout</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># Tell the director that we want to present the FPS on</span>
    <span class="c1"># the screen</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">displayStats</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># The prefered speed on our game (FPS)</span>
    <span class="c1"># Note: This is only a prefered value its not garantied you will</span>
    <span class="c1"># get that value</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">animationInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">60</span>

    <span class="c1"># Assign the view used for the director to present the</span>
    <span class="c1"># game scenes</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">gl_view</span>

    <span class="c1"># Create a navigation controller to store our game director and</span>
    <span class="c1"># hide its navigation bar so we can use all the sreen</span>
    <span class="vi">@navigation_controller</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@director</span><span class="p">)</span>
    <span class="vi">@navigation_controller</span><span class="o">.</span><span class="n">navigationBarHidden</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># Assign the navigation controller to the window</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="vi">@navigation_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>


    <span class="c1"># Configuration for our game images, this is very helpful</span>
    <span class="c1"># when you want to use compressed images or with a different</span>
    <span class="c1"># pixel format</span>
    <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">defaultAlphaPixelFormat</span> <span class="o">=</span> <span class="no">KCCTexture2DPixelFormat_RGBA8888</span>
    <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">PVRImagesHavePremultipliedAlpha</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>

    <span class="c1"># Configuration for the names of the images that will be</span>
    <span class="c1"># used on the game</span>
    <span class="n">file_utils</span> <span class="o">=</span> <span class="no">CCFileUtils</span><span class="o">.</span><span class="n">sharedFileUtils</span>
    <span class="n">file_utils</span><span class="o">.</span><span class="n">enableFallbackSuffixes</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="c1"># The retina display images will be named with &quot;-hd&quot; instead of</span>
    <span class="c1"># &quot;@2x&quot;</span>
    <span class="n">file_utils</span><span class="o">.</span><span class="n">setiPhoneRetinaDisplaySuffix</span> <span class="s2">&quot;-hd&quot;</span>

    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_Cocos2DInitialApplication.png" alt="Initial Cocos 2D Application" />
</div>
<div class="title">Figure 118. Initial Cocos 2D Application</div>
</div>
<div class="paragraph"><p>If you look closely in the bottom left part of the screen are a bunch of numbers, they are the FPS of our game. The general idea is that our game have consistently 60.0 but you will look as we advance in the exercise that some times it drops, this is normal.</p></div>
</div>
<div class="sect2">
<h3 id="_scenes">Scenes</h3>
<div class="paragraph"><p>We can understand the <strong>Scenes</strong> as levels on a video game, but also can be used for the initial menus or score boards after. Its main responsibility is to manage all the objects that will appear on the screen when the scene is run. On our game this objects will be the space background, ship and asteroids</p></div>
<div class="paragraph"><p>Lets create a new scene named <strong>space_scene.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mkdir scenes

<span class="nv">$ </span><span class="nb">cd </span>scenes

<span class="nv">$ </span>touch space_scene.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SpaceScene</span> <span class="o">&lt;</span> <span class="no">CCScene</span>

 <span class="k">def</span> <span class="nf">init</span>

   <span class="k">if</span> <span class="k">super</span>


   <span class="k">end</span>

   <span class="nb">self</span>
 <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we have a new empty Scene that will allow us to start presenting the game images but before we get to that part we need to tell the <strong>Director</strong> to run this scene, this is do with the following in our <strong>app_delegate.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>

  <span class="c1"># Create a window to present our director</span>
  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1"># Lets create a Cocos 2D view that will be used by the director</span>
  <span class="c1"># to present the game scenes</span>
  <span class="n">gl_view</span> <span class="o">=</span> <span class="no">CCGLView</span><span class="o">.</span><span class="n">viewWithFrame</span><span class="p">(</span><span class="vi">@window</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>


  <span class="c1"># Get the Director shared instance for customization</span>
  <span class="vi">@director</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span>

  <span class="c1"># Specify that we want to run the game in fullscreen</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">wantsFullScreenLayout</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Tell the director that we want to present the FPS on</span>
  <span class="c1"># the screen</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">displayStats</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># The prefered speed on our game (FPS)</span>
  <span class="c1"># Note: This is only a prefered value its not garantied you will</span>
  <span class="c1"># get that value</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">animationInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">60</span>

  <span class="c1"># Assign the view used for the director to present the</span>
  <span class="c1"># game scenes</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">gl_view</span>

  <span class="c1"># Create a navigation controller to store our game director and</span>
  <span class="c1"># hide its navigation bar so we can use all the sreen</span>
  <span class="vi">@navigation_controller</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@director</span><span class="p">)</span>
  <span class="vi">@navigation_controller</span><span class="o">.</span><span class="n">navigationBarHidden</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Assign the navigation controller to the window</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="vi">@navigation_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>


  <span class="c1"># Configuration for our game images, this is very helpful</span>
  <span class="c1"># when you want to use compressed images or with a different</span>
  <span class="c1"># pixel format</span>
  <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">defaultAlphaPixelFormat</span> <span class="o">=</span> <span class="no">KCCTexture2DPixelFormat_RGBA8888</span>
  <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">PVRImagesHavePremultipliedAlpha</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>

  <span class="c1"># Configuration for the names of the images that will be</span>
  <span class="c1"># used on the game</span>
  <span class="n">file_utils</span> <span class="o">=</span> <span class="no">CCFileUtils</span><span class="o">.</span><span class="n">sharedFileUtils</span>
  <span class="n">file_utils</span><span class="o">.</span><span class="n">enableFallbackSuffixes</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># The retina display images will be named with &quot;-hd&quot; instead of</span>
  <span class="c1"># &quot;@2x&quot;</span>
  <span class="n">file_utils</span><span class="o">.</span><span class="n">setiPhoneRetinaDisplaySuffix</span> <span class="s2">&quot;-hd&quot;</span>

<span class="hll">  <span class="c1"># Tell the director to present the SpaceScene, it works similar to a</span>
</span><span class="hll">  <span class="c1"># navigation controller: Push to present &amp; Pop to dismiss</span>
</span><span class="hll">  <span class="c1">#</span>
</span><span class="hll">  <span class="c1"># If you look closelly to the initialization of the scene we are using</span>
</span><span class="hll">  <span class="c1"># the node method, instead of new or alloc init this is because Cocos 2D</span>
</span><span class="hll">  <span class="c1"># do some memory allocation performance upgrades</span>
</span><span class="hll">  <span class="vi">@director</span><span class="o">.</span><span class="n">pushScene</span><span class="p">(</span><span class="no">SpaceScene</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we can start adding graphical elements to our game!</p></div>
</div>
<div class="sect2">
<h3 id="_layers">Layers</h3>
<div class="paragraph"><p>In Cocos 2D exists some objects to allow us to render graphical components (Sprites, Particles) on the screen, these are named <strong>CCLayers</strong>. But do not exist layers (CALayers) in iOS already?  Yes they are, but this have some differences: One of the more important is that the CCLayers can handle touches too!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">A sprite is a two dimensional image that is integrated in a bigger scene and can be moved on-screen or manipulated as a single unit. On short an image ;)</td>
</tr></table>
</div>
<div class="paragraph"><p>Knowing this lets create our first CCLayer named <strong>background_layer</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mkdir layers

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>touch background_layer.rb

<span class="nv">$ </span>open background_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BackgroundLayer</span> <span class="o">&lt;</span> <span class="no">CCLayer</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="c1"># For testing proposes lets create a CCLabel to present</span>
      <span class="c1"># some text on the screen</span>
      <span class="n">label</span> <span class="o">=</span> <span class="no">CCLabelTTF</span><span class="o">.</span><span class="n">labelWithString</span><span class="p">(</span><span class="s1">&#39;Its so cool to make a game&#39;</span><span class="p">,</span>
                                         <span class="ss">fontName</span><span class="p">:</span><span class="s1">&#39;Marker Felt&#39;</span><span class="p">,</span>
                                         <span class="ss">fontSize</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span>

      <span class="c1"># We need to get the screen size for positioning the label</span>
      <span class="n">window_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

      <span class="c1"># Like the CALayers the position is set in reference to the center</span>
      <span class="c1"># of the label, in this case we want the label to be in the middle</span>
      <span class="c1"># of the screen</span>
      <span class="n">label</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">window_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">window_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

      <span class="c1"># Add the label to the Layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great! Our layer is complete, now lets add it to the scene:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>scenes

<span class="nv">$ </span>open space_scene.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

<span class="hll">    <span class="c1"># Create a new instance of a Background Layer</span>
</span><span class="hll">    <span class="n">background_layer</span> <span class="o">=</span> <span class="no">BackgroundLayer</span><span class="o">.</span><span class="n">node</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add it to the scene</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">background_layer</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If you run the app you should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_Cocos2DLayer.png" alt="Cocos 2D Layer" />
</div>
<div class="title">Figure 119. Cocos 2D Layer</div>
</div>
<div class="paragraph"><p>Now we have all the necessary structure to make the game run: A director, scene and a layer! Its time to change the label into a space background:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open background_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

<span class="hll">    <span class="c1"># Create a new sprite with our background image</span>
</span><span class="hll">    <span class="n">background_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpace.png&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># We need to get the screen size for positioning the sprite</span>
</span><span class="hll">    <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Like the CALayers the position is set in reference to the center</span>
</span><span class="hll">    <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
</span><span class="hll">    <span class="c1"># of the screen</span>
</span><span class="hll">    <span class="n">background_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add the sprite to the Layer</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">background_sprite</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_BackgroundLayer.png" alt="Background Layer" />
</div>
<div class="title">Figure 120. Background Layer</div>
</div>
<div class="paragraph"><p>We have a background for the game! Lets do something more fun: adding the space ship into the scene, for this we need to create a new layer called <strong>game_play_layer.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GamePlayLayer</span> <span class="o">&lt;</span> <span class="no">CCLayer</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="c1"># Create a new sprite instance for drawing our spaceship</span>
      <span class="vi">@space_ship_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpaceShip.png&#39;</span><span class="p">)</span>

      <span class="c1"># We need to get the screen size for positioning the sprite</span>
      <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

      <span class="c1"># Like the CALayers the position is set in reference to the center</span>
      <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
      <span class="c1"># of the screen</span>
      <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

      <span class="c1"># Add the sprite to the Layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="vi">@space_ship_sprite</span><span class="p">)</span>

      <span class="c1"># Enable handle touches on the layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">isTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now that we have our space ship layer its time to add it to the scene:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>scenes

<span class="nv">$ </span>open space_scene.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new instance of a Background Layer</span>
    <span class="n">background_layer</span> <span class="o">=</span> <span class="no">BackgroundLayer</span><span class="o">.</span><span class="n">node</span>

    <span class="c1"># Add it to the scene</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">background_layer</span><span class="p">)</span>


<span class="hll">    <span class="c1"># Create a new instance of a Game Play Layer</span>
</span><span class="hll">    <span class="n">game_play_layer</span> <span class="o">=</span> <span class="no">GamePlayLayer</span><span class="o">.</span><span class="n">node</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add it to the scene</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">game_play_layer</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_StaticSpaceShip.png" alt="Static Space Ship" />
</div>
<div class="title">Figure 121. Static Space Ship</div>
</div>
<div class="paragraph"><p>Awesome! The next step is to allow the user to move the space ship with his touches on the screen. Lets open again our <strong>game_play_layer.rb</strong> and add the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for handling the initial touch of the user</span>
<span class="c1"># Very similar to the way iOS manage it</span>
<span class="k">def</span> <span class="nf">ccTouchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span><span class="n">event</span><span class="p">)</span>

  <span class="c1"># Get any touch of the user</span>
  <span class="n">touch</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span>

  <span class="c1"># Because we are not using a UIView or anything related</span>
  <span class="c1"># we need to use a method to convert the touch position</span>
  <span class="c1"># coordinate space into the layer space</span>
  <span class="n">touch_location</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">convertTouchToNodeSpace</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>

  <span class="c1"># Move the spaceship to the touch position</span>
  <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">touch_location</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_JumpingSpaceShip.png" alt="Jumping Space Ship" />
</div>
<div class="title">Figure 122. Jumping Space Ship</div>
</div>
<div class="paragraph"><p>Yes it moves! But it does without animation, this is because the sprites does not have implicit animations like a CALayer.</p></div>
</div>
<div class="sect2">
<h3 id="_animations_in_the_space">Animations in the Space</h3>
<div class="paragraph"><p>The animations in Cocos 2D are called actions, so lets create a action for the ship so it will move to the location of the touch in a animated way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for handling the initial touch of the user</span>
<span class="c1"># Very similar to the way iOS manage it</span>
<span class="k">def</span> <span class="nf">ccTouchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span><span class="n">event</span><span class="p">)</span>

  <span class="c1"># Get any touch of the user</span>
  <span class="n">touch</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span>

  <span class="c1"># Because we are not using a UIView or anything related</span>
  <span class="c1"># we need to use a method to convert the touch position</span>
  <span class="c1"># coordinate space into the layer space</span>
  <span class="n">touch_location</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">convertTouchToNodeSpace</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>

<span class="hll">  <span class="c1"># We need to create a MoveBy action for the animated movement</span>
</span><span class="hll">  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span>
</span><span class="hll">                                       <span class="ss">position</span><span class="p">:</span><span class="n">touch_location</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Execute the action in our Space Ship Sprite</span>
</span><span class="hll">  <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">We are not really animating the movement, just making it frame by frame using the game FPS. (Interpolation ;)</td>
</tr></table>
</div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_SpaceShipOutsideScreen.png" alt="Space Ship Outside Screen" />
</div>
<div class="title">Figure 123. Space Ship Outside Screen</div>
</div>
<div class="paragraph"><p>Upps! What when wrong? The problem is the actions must receive the number of points of movement in a direction, not a exact position! You can try it! Just assign a <strong>CGPoint(100, 100)</strong> to the position parameter of the action.</p></div>
<div class="paragraph"><p>The fix is the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for handling the initial touch of the user</span>
<span class="c1"># Very similar to the way iOS manage it</span>
<span class="k">def</span> <span class="nf">ccTouchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="ss">withEvent</span><span class="p">:</span><span class="n">event</span><span class="p">)</span>

  <span class="c1"># Get any touch of the user</span>
  <span class="n">touch</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span>

  <span class="c1"># Because we are not using a UIView or anything related</span>
  <span class="c1"># we need to use a method to convert the touch position</span>
  <span class="c1"># coordinate space into the layer space</span>
  <span class="n">touch_location</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">convertTouchToNodeSpace</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Get the current position of the space ship</span>
</span><span class="hll">  <span class="n">current_location</span> <span class="o">=</span> <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Calculate the difference between the two points</span>
</span><span class="hll">  <span class="n">location_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">touch_location</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">current_location</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span class="hll">                                    <span class="n">touch_location</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">current_location</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># We need to create a MoveBy action for the animated movement</span>
</span><span class="hll">  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span>
</span><span class="hll">                                       <span class="ss">position</span><span class="p">:</span><span class="n">location_difference</span><span class="p">)</span>
</span>
  <span class="c1"># Execute the action in our Space Ship Sprite</span>
  <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_MovingSpaceShip.png" alt="Moving Space Ship" />
</div>
<div class="title">Figure 124. Moving Space Ship</div>
</div>
<div class="paragraph"><p>Now is working! We are done with the space ship, the next is to add some asteroids flying into the scene.</p></div>
</div>
<div class="sect2">
<h3 id="_ccsprite">CCSprite</h3>
<div class="paragraph"><p>Now is time to create some asteroids for our game, also its time to learn how to create more complex sprites. Lets begin adding a new class named <strong>asteroid_sprite.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>mkdir sprites

<span class="nv">$ </span><span class="nb">cd </span>sprites

<span class="nv">$ </span>touch asteroid_sprite.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AsteroidSprite</span> <span class="o">&lt;</span> <span class="no">CCSprite</span>

  <span class="c1"># This is the designated initializer of the CCSprite</span>
  <span class="k">def</span> <span class="nf">initWithTexture</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> <span class="ss">rect</span><span class="p">:</span><span class="n">rect</span><span class="p">)</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="nb">self</span>

  <span class="k">end</span>

  <span class="c1"># Method for optimizing the code needed to instantiate</span>
  <span class="c1"># a new asteroid</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">sprite</span>

    <span class="no">AsteroidSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgAsteroid.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Lets add our new sprite to the <strong>game_play_layer.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new sprite instance for drawing our spaceship</span>
    <span class="vi">@space_ship_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpaceShip.png&#39;</span><span class="p">)</span>

    <span class="c1"># We need to get the screen size for positioning the sprite</span>
    <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

    <span class="c1"># Like the CALayers the position is set in reference to the center</span>
    <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
    <span class="c1"># of the screen</span>
    <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add the sprite to the Layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="vi">@space_ship_sprite</span><span class="p">)</span>

    <span class="c1"># Enable handle touches on the layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">isTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>

<span class="hll">    <span class="c1"># Add an asteroid sprite to our layer</span>
</span><span class="hll">    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="no">AsteroidSprite</span><span class="o">.</span><span class="n">sprite</span><span class="p">)</span>
</span>  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_BigAsteroid.png" alt="Big Asteroid" />
</div>
<div class="title">Figure 125. Big Asteroid</div>
</div>
<div class="paragraph"><p>Easy right? But we have a problem the asteroid is too big: Imagine five of them flying into the screen, impossible to dodge!</p></div>
<div class="paragraph"><p>So lets create something more complex, the idea is to have asteroids of different sizes moving across the screen. So lets use some randoms for determinate the size of the asteroid:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>sprites

<span class="nv">$ </span>open asteroid_sprite.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kp">attr_accessor</span> <span class="ss">:state</span>

<span class="c1"># This is the designated initializer of the CCSprite</span>
<span class="k">def</span> <span class="nf">initWithTexture</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> <span class="ss">rect</span><span class="p">:</span><span class="n">rect</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">super</span>
<span class="hll">    <span class="vi">@state</span> <span class="o">=</span> <span class="ss">:spawning</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">spawn</span>
</span>  <span class="k">end</span>

  <span class="nb">self</span>

<span class="k">end</span>

<span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_RandomSizeAsteroid.png" alt="Random Size Asteroid" />
</div>
<div class="title">Figure 126. Random Size Asteroid</div>
</div>
<div class="paragraph"><p>Great! Now the size of the asteroid is completely random, to test it run the app multiple times!</p></div>
<div class="paragraph"><p>For make the illusion that the asteroids are coming from the space we need to set the initial position of it outside the screen and then move it across the screen. Again some randoms we will help us, lets add the following method to our file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for calculating positions around the screen</span>
<span class="k">def</span> <span class="nf">position_outside_screen</span>

  <span class="c1"># Instantiate a new random</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>

  <span class="c1"># Generate a new random that we will use to determinate</span>
  <span class="c1"># in which screen side is the point</span>
  <span class="n">screen_side</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span><span class="p">)</span>

  <span class="c1"># We need to get the screen size for positioning the sprite</span>
  <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

  <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1"># According to the side of the screen generate the coordinates</span>
  <span class="c1"># also we need to take in count the size of the sprite, so it</span>
  <span class="c1"># can be completely outside the screen</span>

  <span class="c1"># Top Side</span>
  <span class="k">if</span> <span class="n">screen_side</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span>

  <span class="c1"># Left Side</span>
  <span class="k">elsif</span> <span class="n">screen_side</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

  <span class="c1"># Right Side</span>
  <span class="k">elsif</span> <span class="n">screen_side</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="n">x</span> <span class="o">=</span> <span class="mi">320</span> <span class="o">+</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

  <span class="c1"># Bottom Side</span>
  <span class="k">else</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">480</span> <span class="o">+</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span>

  <span class="k">end</span>

  <span class="no">CGPointMake</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now lets use this method for assign an initial position to our asteroid and create an action for its movement across the screen:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


<span class="hll">  <span class="c1"># Generate an initial and final position for the asteroid</span>
</span><span class="hll">  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
</span><span class="hll">  <span class="n">final_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Calculate the difference between the two positions</span>
</span><span class="hll">  <span class="n">position_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">final_position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span class="hll">                                    <span class="n">final_position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Lets use another random that we will use for the movement speed</span>
</span><span class="hll">  <span class="n">action_speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Create a Move By Action for its movement across the screen</span>
</span><span class="hll">  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
</span><span class="hll">                                       <span class="ss">position</span><span class="p">:</span><span class="n">position_difference</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Assign the initial position</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">initial_position</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Run the movement action</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_FlyingAsteroid.png" alt="Flying Asteroid" />
</div>
<div class="title">Figure 127. Flying Asteroid</div>
</div>
<div class="paragraph"><p>You should see the asteroid fly across the screen! If you don&#8217;t please run it a couple of times remember we are using randoms! (The asteroid can fly too fast or in the edges of the screen, this is part of the magic ;)</p></div>
<div class="paragraph"><p>But the asteroids does not move like that! They rotate:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


  <span class="c1"># Generate an initial and final position for the asteroid</span>
  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
  <span class="n">final_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>

  <span class="c1"># Calculate the difference between the two positions</span>
  <span class="n">position_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">final_position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">final_position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>


  <span class="c1"># Lets use another random that we will use for the movement speed</span>
  <span class="n">action_speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="p">)</span>

  <span class="c1"># Create a Move By Action for its movement across the screen</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                       <span class="ss">position</span><span class="p">:</span><span class="n">position_difference</span><span class="p">)</span>

  <span class="c1"># Assign the initial position</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">initial_position</span>

  <span class="c1"># Run the movement action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Create a spinning action with the same speed that the movement one</span>
</span><span class="hll">  <span class="c1"># also because we want it to spin a couple of times set the angle</span>
</span><span class="hll">  <span class="c1"># to 1000 degrees</span>
</span><span class="hll">  <span class="n">spinning_action</span> <span class="o">=</span> <span class="no">CCRotateTo</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
</span><span class="hll">                                                  <span class="ss">angle</span><span class="p">:</span><span class="mi">1000</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Run the spinning action</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">spinning_action</span><span class="p">)</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_SpinningAsteroid.png" alt="Spinning Asteroid" />
</div>
<div class="title">Figure 128. Spinning Asteroid</div>
</div>
<div class="paragraph"><p>Last part! We need to change the status of the sprite to <strong>:ended</strong> when the movement action ends:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


  <span class="c1"># Generate an initial and final position for the asteroid</span>
  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
  <span class="n">final_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>

  <span class="c1"># Assign the initial position</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">initial_position</span>

  <span class="c1"># Calculate the difference between the two positions</span>
  <span class="n">position_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">final_position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">final_position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>


  <span class="c1"># Lets use another random that we will use for the movement speed</span>
  <span class="n">action_speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span>

  <span class="c1"># Create a Move By Action for its movement across the screen</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                       <span class="ss">position</span><span class="p">:</span><span class="n">position_difference</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Instantiate a Call Function to excecute a method when the movement</span>
</span><span class="hll">  <span class="c1"># action finished</span>
</span><span class="hll">  <span class="n">finish_callback_action</span> <span class="o">=</span> <span class="no">CCCallFuncND</span><span class="o">.</span><span class="n">actionWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                         <span class="ss">selector</span><span class="p">:</span><span class="s1">&#39;movement_action_ended&#39;</span><span class="p">,</span>
</span><span class="hll">                                                         <span class="ss">data</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Chain the both actions using a sequence</span>
</span><span class="hll">  <span class="n">movement_action_sequence</span> <span class="o">=</span> <span class="no">CCSequence</span><span class="o">.</span><span class="n">actionsWithArray</span><span class="p">(</span><span class="o">[</span><span class="n">action</span><span class="p">,</span> <span class="n">finish_callback_action</span><span class="o">]</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Run the movement action sequence</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">movement_action_sequence</span><span class="p">)</span>
</span>

  <span class="c1"># Create a spinning action with the same speed that the movement one</span>
  <span class="c1"># also because we want it to spin a couple of times set the angle</span>
  <span class="c1"># to 1000 degrees</span>
  <span class="n">spinning_action</span> <span class="o">=</span> <span class="no">CCRotateTo</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                                  <span class="ss">angle</span><span class="p">:</span><span class="mi">1000</span><span class="p">)</span>

  <span class="c1"># Run the spinning action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">spinning_action</span><span class="p">)</span>

<span class="k">end</span>

<span class="c1"># Action Movement Callback Method</span>
<span class="k">def</span> <span class="nf">movement_action_ended</span>

  <span class="vi">@state</span> <span class="o">=</span> <span class="ss">:ended</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now our asteroid sprite is finished! So for the game makes sense it should be multiple asteroids flying across the screen right? Thats next!</p></div>
</div>
<div class="sect2">
<h3 id="_fps_asteroid">FPS + Asteroid</h3>
<div class="paragraph"><p>Do you remember that at the beginning of the exercise we talk about that the director executes a method multiple times a second to let us do some work like talk to the AI, Physics or refreshing the screen? Lets use this method for maintain a constant number of asteroids on the screen: creating them and then when it movement finishes destroy them.</p></div>
<div class="paragraph"><p>Lets open again our <strong>GamePlayLayer</strong> and subscribe to the loop notification:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new sprite instance for drawing our spaceship</span>
    <span class="vi">@space_ship_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpaceShip.png&#39;</span><span class="p">)</span>

    <span class="c1"># We need to get the screen size for positioning the sprite</span>
    <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

    <span class="c1"># Like the CALayers the position is set in reference to the center</span>
    <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
    <span class="c1"># of the screen</span>
    <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add the sprite to the Layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="vi">@space_ship_sprite</span><span class="p">)</span>

    <span class="c1"># Enable handle touches on the layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">isTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>

<span class="hll">    <span class="c1">#Create an array for storing our asteroid sprites</span>
</span><span class="hll">    <span class="vi">@asteroids</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Subscribe to the loop call</span>
</span><span class="hll">    <span class="n">scheduleUpdate</span>
</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>

<span class="c1"># Loop callback method</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take a closer look to the code because we remove the add of the initial asteroid sprite and add an array for storing the asteroid sprites</td>
</tr></table>
</div>
<div class="paragraph"><p>Now is time to add some asteroids to our game, implement the following on the <strong>update</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Loop callback method</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

<span class="hll">  <span class="n">spawn_asteroids</span>
</span><span class="k">end</span>


<span class="k">def</span> <span class="nf">spawn_asteroids</span>

  <span class="c1"># Delete the asteroids that are on ended state</span>
  <span class="vi">@asteroids</span><span class="o">.</span><span class="n">delete_if</span> <span class="p">{</span> <span class="o">|</span> <span class="n">asteroid</span> <span class="o">|</span>

    <span class="c1"># If the asteroid is on ended state</span>
    <span class="k">if</span> <span class="n">asteroid</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="ss">:ended</span>

      <span class="c1"># Remove from the layer also</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">asteroid</span><span class="p">,</span> <span class="ss">cleanup</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>

      <span class="kp">true</span>
    <span class="k">end</span>
  <span class="p">}</span>

  <span class="c1"># Calculate the number of asteroids missing, taking</span>
  <span class="c1"># in count that we should have 15 moving around</span>
  <span class="n">missing_asteroids</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">-</span> <span class="vi">@asteroids</span><span class="o">.</span><span class="n">count</span>

  <span class="c1"># Iterate to create the missing asteroids</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="n">.missing_asteroids</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Create an asteroid sprite</span>
    <span class="n">asteroid_sprite</span> <span class="o">=</span> <span class="no">AsteroidSprite</span><span class="o">.</span><span class="n">sprite</span>

    <span class="c1"># Add it to the layer and to the array</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">asteroid_sprite</span><span class="p">)</span>
    <span class="vi">@asteroids</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">asteroid_sprite</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_MultipleAsteroids.png" alt="Multiple Asteroids" />
</div>
<div class="title">Figure 129. Multiple Asteroids</div>
</div>
<div class="paragraph"><p>Awesome! Now the scene is complete, but is something missing right? Detect when the ship crashes with an asteroid!</p></div>
</div>
<div class="sect2">
<h3 id="_please_don_8217_t_crash">Please don&#8217;t crash!</h3>
<div class="paragraph"><p>The last part of our exercise is to detect when the asteroid crashes with our space ship! For this lets add the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Loop callback method</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

  <span class="n">spawn_asteroids</span>
<span class="hll">  <span class="n">check_for_collisions</span>
</span><span class="k">end</span>

<span class="k">def</span> <span class="nf">check_for_collisions</span>

  <span class="c1"># Iterate all the asteroids in the scene</span>
  <span class="vi">@asteroids</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">asteroid</span> <span class="o">|</span>

    <span class="c1"># If any asteroid frame intersect the space ship frame</span>
    <span class="c1"># is a collision</span>
    <span class="k">if</span> <span class="no">CGRectIntersectsRect</span><span class="p">(</span><span class="n">asteroid</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">,</span> <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>

      <span class="c1"># Create a new sprite instance for our explosion</span>
      <span class="n">explosion_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgBoom.jpeg&#39;</span><span class="p">)</span>

      <span class="c1"># Set the sprite in the same exact position of the</span>
      <span class="c1"># space ship</span>
      <span class="n">explosion_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span>

      <span class="c1"># Add the explosion sprite into our layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">explosion_sprite</span><span class="p">)</span>

      <span class="c1"># Pause the game</span>
      <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">pause</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch25-ThirdPartyLibraries/ch25_PleaseDontCrash.png" alt="Please Don't Crash" />
</div>
<div class="title">Figure 130. Please Don&#8217;t Crash</div>
</div>
<div class="paragraph"><p>Great! Now our little game is complete, if the user crashes into an asteroid the space ship explodes and the game is ended</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Even if you are a master moving your ship sometimes it will crash without touching any asteroid, this is because collision detection is more like an art and it depends on more advanced techniques like physics or sprite sheets to be pixel perfect. But that subjects are not in the scope of this course :'(</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_challenges_8">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Add a "Game Over" scene to the game when a collision happen, remember that the CCDirector can push new scenes into the screen
</p>
</li>
<li>
<p>
Detect when the user touches an asteroid so you can remove it from the screen, clearing the way for our space ship to move
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="_chapter_26_concurrency">Chapter 26 - Concurrency</h1>
<div class="paragraph"><p>When we create an app some times we need to implement some operations that take to long time in executing like unzip a file, retrieve images on a web server or encryption. There is not a problem on the long time, the problem is that we run such operations on the main thread: Because the main thread is responsible for refreshing the User Interface and if we hang it executing a long time operation the app will look unresponsive because is unable for updating the Interface</p></div>
<div class="paragraph"><p>The main solution to this problem is run the long time operations on a another thread right? Yes it does, but adds a lot more constrains to our code like:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
For changing anything on the User Interface we still need to do it on the main thread
</p>
</li>
<li>
<p>
Some Cocoa Frameworks and 3rd Party are not multi-thread
</p>
</li>
</ol></div>
<div class="paragraph"><p>In this exercise we will tackle that extra complexity using two Multi-threading technologies available in iOS: <strong>Gran Central Dispatch</strong> and <strong>NSOperation</strong></p></div>
<div class="sect1">
<h2 id="_the_operation_that_takes_too_long">The Operation That Takes Too Long</h2>
<div class="sectionbody">
<div class="paragraph"><p>We proudly announce that in this exercise we will make another Photo Filter app! (Like they are not enough of them in the store yet ;)</p></div>
<div class="paragraph"><p>For this purpose also we need to use the Image Framework available in iOS called <strong>Core Image</strong> that will provide the Filters in a more easy way that implement them ourselves</p></div>
<div class="paragraph"><p>So lets start building our app!</p></div>
<div class="sect2">
<h3 id="_rubystagram">Rubystagram</h3>
<div class="paragraph"><p>Lets begin creating our project, running this on the terminal</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Rubystagram

<span class="nv">$ </span><span class="nb">cd </span>app
</pre></div></div></div>
<div class="paragraph"><p>And now lets create a new view controller named <strong>PhotoViewController</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch photo_view_controller.rb

<span class="nv">$ </span>open photo_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>We need to add the ability to this controller to take photos from the camera or choose one from the photo library, please insert the following lines to it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="c1"># Create a new view for our controller and add a nice</span>
    <span class="c1"># background color</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="c1"># Add a Background Image for the app using a UIImageView</span>
    <span class="n">background_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">background_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgBackground.png&quot;</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_view</span><span class="p">)</span>

    <span class="c1"># Layout the image picker for the user to take</span>
    <span class="c1"># or select a photo</span>
    <span class="n">layout_image_picker_controller</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">layout_image_picker_controller</span>

    <span class="c1"># We need a instance of the UIImagePickerController</span>
    <span class="vi">@image_picker_controller</span> <span class="o">=</span> <span class="no">UIImagePickerController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


    <span class="c1"># For this to work on the simulator we need to ask the</span>
    <span class="c1"># UIImagePickerController if we have a camera available</span>
    <span class="k">if</span> <span class="no">UIImagePickerController</span><span class="o">.</span><span class="n">isSourceTypeAvailable</span><span class="p">(</span><span class="no">UIImagePickerControllerSourceTypeCamera</span><span class="p">)</span>

      <span class="c1"># If we have a camera lets use it</span>
      <span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">setSourceType</span><span class="p">(</span><span class="no">UIImagePickerControllerSourceTypeCamera</span><span class="p">)</span>

    <span class="k">else</span>

      <span class="c1"># If we don&#39;t lets present the Photo Library</span>
      <span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">setSourceType</span><span class="p">(</span><span class="no">UIImagePickerControllerSourceTypePhotoLibrary</span><span class="p">)</span>

    <span class="k">end</span>


    <span class="c1"># Set the frame of the Picker Controller to the same</span>
    <span class="c1"># as our controller view</span>
    <span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>

    <span class="c1"># Assign the controller as a delegate of the Image</span>
    <span class="c1"># Picker</span>
    <span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

    <span class="c1"># Add the Image Picker view as subview of our controller</span>
    <span class="c1"># view</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="c1"># Image Picker Controller callback, this method is invoked</span>
  <span class="c1"># when the user selects an image</span>
  <span class="k">def</span> <span class="nf">imagePickerController</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="ss">didFinishPickingMediaWithInfo</span><span class="p">:</span> <span class="n">info</span><span class="p">)</span>

    <span class="c1"># Remove the Image Picker from our Controller View</span>
    <span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeFromSuperview</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You should see this when running the app from the simulator:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_ImagePicker.png" alt="Image Picker" />
</div>
<div class="title">Figure 131. Image Picker</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you don&#8217;t have any images available in the Photo Library, you can always navigate to a Photo Website (Like flickr.com) using the Safari on the Simulator and save any of them long clicking it :)</td>
</tr></table>
</div>
<div class="paragraph"><p>And after we select the photo, you should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_InitialAnimation.png" alt="Initial Application" />
</div>
<div class="title">Figure 132. Initial Application</div>
</div>
<div class="paragraph"><p>The next step will be adding the user selected image to the controller&#8217;s view, please add the following lines to the <strong>photo_view_controller.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Create a new view for our controller and add a nice</span>
  <span class="c1"># background color</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Add a Background Image for the app using a UIImageView</span>
  <span class="n">background_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="n">background_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgBackground.png&quot;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_view</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Layout an image view for us to draw the user</span>
</span><span class="hll">  <span class="c1"># selected image</span>
</span><span class="hll">  <span class="n">layout_photo_image_view</span>
</span>
  <span class="c1"># Layout the image picker for the user to take</span>
  <span class="c1"># or select a photo</span>
  <span class="n">layout_image_picker_controller</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_photo_image_view</span>

  <span class="c1"># Instance a new UIImageView to create a frame for the</span>
  <span class="c1"># photo image view</span>
  <span class="n">photo_image_view_frame</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">295</span><span class="p">,</span> <span class="mi">355</span><span class="p">))</span>
  <span class="n">photo_image_view_frame</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgPhotoFrame.png&quot;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">photo_image_view_frame</span><span class="p">)</span>

  <span class="c1"># Create a new instance of a UIViewController named</span>
  <span class="c1"># photo_image_view and for avoiding that the image will look</span>
  <span class="c1"># streched set its content mode to UIViewContentModeScaleAspectFill</span>
  <span class="vi">@photo_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="mi">316</span><span class="p">))</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">contentMode</span> <span class="o">=</span> <span class="no">UIViewContentModeScaleAspectFill</span><span class="p">;</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">clipsToBounds</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>


  <span class="c1"># Add the photo image view to the controller view</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@photo_image_view</span><span class="p">)</span>
<span class="k">end</span>


<span class="c1"># Image Picker Controller callback, this method is invoked</span>
<span class="c1"># when the user selects an image</span>
<span class="k">def</span> <span class="nf">imagePickerController</span><span class="p">(</span><span class="n">picker</span><span class="p">,</span> <span class="ss">didFinishPickingMediaWithInfo</span><span class="p">:</span> <span class="n">info</span><span class="p">)</span>

  <span class="c1"># Remove the Image Picker from our Controller View</span>
  <span class="vi">@image_picker_controller</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">removeFromSuperview</span>

<span class="hll">  <span class="c1"># Save the user selected image</span>
</span><span class="hll">  <span class="vi">@selected_image</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">objectForKey</span><span class="p">(</span><span class="no">UIImagePickerControllerOriginalImage</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the user selected image to our photo image view</span>
</span><span class="hll">  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@selected_image</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_PhotoView.png" alt="Photo View" />
</div>
<div class="title">Figure 133. Photo View</div>
</div>
<div class="paragraph"><p>The last part of our initial project is to add some buttons for the user to select the photo filters, please add the following to our <strong>PhotoViewController</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_filter_buttons</span>

  <span class="c1"># First button for the Pixellate Filter</span>
  <span class="n">pixellate_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">pixellate_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span>
  <span class="n">pixellate_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgPixellateDisabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">pixellate_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgPixellateEnabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span><span class="p">)</span>

  <span class="n">pixellate_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                             <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;add_pixellate_filter&#39;</span><span class="p">,</span>
                             <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">pixellate_button</span><span class="p">)</span>


  <span class="c1"># Second button for the Sepia Filter</span>
  <span class="n">sepia_tone_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">sepia_tone_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span>
  <span class="n">sepia_tone_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgSepiaDisabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">sepia_tone_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgSepiaEnabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span><span class="p">)</span>

  <span class="n">sepia_tone_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                              <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;add_sepia_tone_filter&#39;</span><span class="p">,</span>
                              <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">sepia_tone_button</span><span class="p">)</span>


  <span class="c1"># Third button for Color Monochrome Filter</span>
  <span class="n">color_monochrome_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">color_monochrome_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span>
  <span class="n">color_monochrome_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgMonocolorDisabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">color_monochrome_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgMonocolorEnabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span><span class="p">)</span>

  <span class="n">color_monochrome_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                    <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;add_color_monochrome_filter&#39;</span><span class="p">,</span>
                                    <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">color_monochrome_button</span><span class="p">)</span>


  <span class="c1"># Fourth button for Gaussian Blur Filter</span>
  <span class="n">gaussian_blur_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">gaussian_blur_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">235</span><span class="p">,</span> <span class="mi">385</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span>
  <span class="n">gaussian_blur_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgBlurDisabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
  <span class="n">gaussian_blur_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgBlurEnabled.png&#39;</span><span class="p">),</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateHighlighted</span><span class="p">)</span>

  <span class="n">gaussian_blur_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                 <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;add_gaussian_blur_filter&#39;</span><span class="p">,</span>
                                 <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">gaussian_blur_button</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_FilterButtons.png" alt="Filter Buttons" />
</div>
<div class="title">Figure 134. Filter Buttons</div>
</div>
</div>
<div class="sect2">
<h3 id="_filters_filters_filters">Filters, Filters, Filters</h3>
<div class="paragraph"><p>Its time to create a new object for apply those filters to the image, this object will be called <strong>photo_filter_controller.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch photo_filter_controller.rb

<span class="nv">$ </span>open photo_filter_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Now please insert the following methods into the class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoFilterController</span>

  <span class="c1"># Method for generating the Image Filters</span>
  <span class="k">def</span> <span class="nf">image_for_filter</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span>
                       <span class="n">image</span><span class="p">,</span>
                       <span class="n">intensity</span><span class="p">)</span>

    <span class="c1"># Assign the filter and intensity into a property</span>
    <span class="c1"># for later use</span>
    <span class="vi">@current_filter</span> <span class="o">=</span> <span class="n">filter</span>
    <span class="vi">@current_intensity</span> <span class="o">=</span> <span class="n">intensity</span>

    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">image</span>

    <span class="c1"># Determinate the kind of filter using the symbol</span>
    <span class="k">case</span> <span class="n">filter</span>

      <span class="k">when</span> <span class="ss">:pixellate</span>

        <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">image_for_pixellate_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                                    <span class="n">intensity</span><span class="p">)</span>

      <span class="k">when</span> <span class="ss">:sepia_tone</span>

        <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">image_for_sepia_tone_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                                     <span class="n">intensity</span><span class="p">)</span>

      <span class="k">when</span> <span class="ss">:color_monochrome</span>

        <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">image_for_color_monochrome_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                                           <span class="n">intensity</span><span class="p">)</span>

      <span class="k">when</span> <span class="ss">:gaussian_blur</span>

         <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">image_for_gaussian_blur_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                                         <span class="n">intensity</span><span class="p">)</span>

    <span class="k">end</span>

    <span class="c1"># Return the Filtered Image</span>
    <span class="n">filtered_image</span>
  <span class="k">end</span>


  <span class="c1"># Method for adding the Pixellate Filter to the Image</span>
  <span class="k">def</span> <span class="nf">image_for_pixellate_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

    <span class="c1"># Create an instance of an CIImage so Core Image</span>
    <span class="c1"># can work with it</span>
    <span class="n">image_to_filter</span> <span class="o">=</span> <span class="no">CIImage</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Get a new Core Image Context</span>
    <span class="n">core_image_context</span> <span class="o">=</span> <span class="no">CIContext</span><span class="o">.</span><span class="n">contextWithOptions</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>

    <span class="c1"># Create the filter</span>
    <span class="n">filter</span> <span class="o">=</span> <span class="no">CIFilter</span><span class="o">.</span><span class="n">filterWithName</span><span class="p">(</span><span class="s2">&quot;CIPixellate&quot;</span><span class="p">)</span>

    <span class="c1"># Set the default values to the filter</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setDefaults</span>

    <span class="c1"># Add the settings for the filter like the scale,</span>
    <span class="c1"># intensity, etc.</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">image_to_filter</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">KCIInputImageKey</span><span class="p">)</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;inputScale&quot;</span><span class="p">)</span>

    <span class="c1"># Get the output of the filter to create our return</span>
    <span class="c1"># images</span>
    <span class="n">filter_output</span> <span class="o">=</span> <span class="n">filter</span><span class="o">.</span><span class="n">outputImage</span>

    <span class="c1"># Using the filter output create a new CIImage</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">core_image_context</span><span class="o">.</span><span class="n">createCGImage</span><span class="p">(</span><span class="n">filter_output</span><span class="p">,</span>
                                                      <span class="ss">fromRect</span><span class="p">:</span><span class="n">filter_output</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>

    <span class="c1"># Return a new UIImage from the CIImage created with</span>
    <span class="c1"># the filter</span>
    <span class="no">UIImage</span><span class="o">.</span><span class="n">imageWithCGImage</span><span class="p">(</span><span class="n">filtered_image</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="c1"># Method for adding the Sepia Tone Filter to the Image</span>
  <span class="k">def</span> <span class="nf">image_for_sepia_tone_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>

    <span class="c1"># Create an instance of an CIImage so Core Image</span>
    <span class="c1"># can work with it</span>
    <span class="n">image_to_filter</span> <span class="o">=</span> <span class="no">CIImage</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Get a new Core Image Context</span>
    <span class="n">core_image_context</span> <span class="o">=</span> <span class="no">CIContext</span><span class="o">.</span><span class="n">contextWithOptions</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>

    <span class="c1"># Create the filter</span>
    <span class="n">filter</span> <span class="o">=</span> <span class="no">CIFilter</span><span class="o">.</span><span class="n">filterWithName</span><span class="p">(</span><span class="s2">&quot;CISepiaTone&quot;</span><span class="p">)</span>

    <span class="c1"># Set the default values to the filter</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setDefaults</span>

    <span class="c1"># Add the settings for the filter like the scale,</span>
    <span class="c1"># intensity, etc.</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">image_to_filter</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">KCIInputImageKey</span><span class="p">)</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;inputIntensity&quot;</span><span class="p">)</span>

    <span class="c1"># Get the output of the filter to create our return</span>
    <span class="c1"># images</span>
    <span class="n">filter_output</span> <span class="o">=</span> <span class="n">filter</span><span class="o">.</span><span class="n">outputImage</span>

    <span class="c1"># Using the filter output create a new CIImage</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">core_image_context</span><span class="o">.</span><span class="n">createCGImage</span><span class="p">(</span><span class="n">filter_output</span><span class="p">,</span>
                                                      <span class="ss">fromRect</span><span class="p">:</span><span class="n">filter_output</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>

    <span class="c1"># Return a new UIImage from the CIImage created with</span>
    <span class="c1"># the filter</span>
    <span class="no">UIImage</span><span class="o">.</span><span class="n">imageWithCGImage</span><span class="p">(</span><span class="n">filtered_image</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="c1"># Method for adding the Color Monochrome Filter to the Image</span>
  <span class="k">def</span> <span class="nf">image_for_color_monochrome_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>

    <span class="c1"># Create an instance of an CIImage so Core Image</span>
    <span class="c1"># can work with it</span>
    <span class="n">image_to_filter</span> <span class="o">=</span> <span class="no">CIImage</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Get a new Core Image Context</span>
    <span class="n">core_image_context</span> <span class="o">=</span> <span class="no">CIContext</span><span class="o">.</span><span class="n">contextWithOptions</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>

    <span class="c1"># Create the filter</span>
    <span class="n">filter</span> <span class="o">=</span> <span class="no">CIFilter</span><span class="o">.</span><span class="n">filterWithName</span><span class="p">(</span><span class="s2">&quot;CIColorMonochrome&quot;</span><span class="p">)</span>

    <span class="c1"># Set the default values to the filter</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setDefaults</span>

    <span class="c1"># Add the settings for the filter like the scale,</span>
    <span class="c1"># intensity, etc.</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">image_to_filter</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">KCIInputImageKey</span><span class="p">)</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="no">CIColor</span><span class="o">.</span><span class="n">colorWithString</span><span class="p">(</span><span class="s1">&#39;1.000 0.000 0.113 1.000&#39;</span><span class="p">),</span> <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;inputColor&quot;</span><span class="p">)</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;inputIntensity&quot;</span><span class="p">)</span>

    <span class="c1"># Get the output of the filter to create our return</span>
    <span class="c1"># images</span>
    <span class="n">filter_output</span> <span class="o">=</span> <span class="n">filter</span><span class="o">.</span><span class="n">outputImage</span>

    <span class="c1"># Using the filter output create a new CIImage</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">core_image_context</span><span class="o">.</span><span class="n">createCGImage</span><span class="p">(</span><span class="n">filter_output</span><span class="p">,</span>
                                                      <span class="ss">fromRect</span><span class="p">:</span><span class="n">filter_output</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>

    <span class="c1"># Return a new UIImage from the CIImage created with</span>
    <span class="c1"># the filter</span>
    <span class="no">UIImage</span><span class="o">.</span><span class="n">imageWithCGImage</span><span class="p">(</span><span class="n">filtered_image</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="c1"># Method for adding the Gaussian Blur Filter to the Image</span>
  <span class="k">def</span> <span class="nf">image_for_gaussian_blur_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>

    <span class="c1"># Create an instance of an CIImage so Core Image</span>
    <span class="c1"># can work with it</span>
    <span class="n">image_to_filter</span> <span class="o">=</span> <span class="no">CIImage</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Get a new Core Image Context</span>
    <span class="n">core_image_context</span> <span class="o">=</span> <span class="no">CIContext</span><span class="o">.</span><span class="n">contextWithOptions</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>

    <span class="c1"># Create the filter</span>
    <span class="n">filter</span> <span class="o">=</span> <span class="no">CIFilter</span><span class="o">.</span><span class="n">filterWithName</span><span class="p">(</span><span class="s2">&quot;CIGaussianBlur&quot;</span><span class="p">)</span>

    <span class="c1"># Set the default values to the filter</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setDefaults</span>

    <span class="c1"># Add the settings for the filter like the scale,</span>
    <span class="c1"># intensity, etc.</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">image_to_filter</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="no">KCIInputImageKey</span><span class="p">)</span>
    <span class="n">filter</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="ss">forKey</span><span class="p">:</span><span class="s2">&quot;inputRadius&quot;</span><span class="p">)</span>

    <span class="c1"># Get the output of the filter to create our return</span>
    <span class="c1"># images</span>
    <span class="n">filter_output</span> <span class="o">=</span> <span class="n">filter</span><span class="o">.</span><span class="n">outputImage</span>

    <span class="c1"># Using the filter output create a new CIImage</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">core_image_context</span><span class="o">.</span><span class="n">createCGImage</span><span class="p">(</span><span class="n">filter_output</span><span class="p">,</span>
                                                      <span class="ss">fromRect</span><span class="p">:</span><span class="n">filter_output</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>

    <span class="c1"># Return a new UIImage from the CIImage created with</span>
    <span class="c1"># the filter</span>
    <span class="no">UIImage</span><span class="o">.</span><span class="n">imageWithCGImage</span><span class="p">(</span><span class="n">filtered_image</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Yes! Now we have a class that can add filters to our images using Core Image. Its time to connect the view filter buttons to this new class. Please open the <strong>photo_view_controller.rb</strong> file and set the following methods:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open photo_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Create a new view for our controller and add a nice</span>
  <span class="c1"># background color</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Add a Background Image for the app using a UIImageView</span>
  <span class="n">background_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="n">background_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgBackground.png&quot;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_view</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Create a new instance of the Photo Filter Controller</span>
</span><span class="hll">  <span class="vi">@photo_filter_controller</span> <span class="o">=</span> <span class="no">PhotoFilterController</span><span class="o">.</span><span class="n">new</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Layout four buttons for the user to select</span>
</span><span class="hll">  <span class="c1"># the Photo Filters</span>
</span><span class="hll">  <span class="n">layout_filter_buttons</span>
</span>

  <span class="c1"># Layout an image view for us to draw the user</span>
  <span class="c1"># selected image</span>
  <span class="n">layout_photo_image_view</span>


  <span class="c1"># Layout the image picker for the user to take</span>
  <span class="c1"># or select a photo</span>
  <span class="n">layout_image_picker_controller</span>
<span class="k">end</span>

<span class="c1"># Pixellate Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_pixellate_filter</span>

  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:pixellate</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># Sepia Tone Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_sepia_tone_filter</span>

  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:sepia_tone</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># Color Monochrome Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_color_monochrome_filter</span>

  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:color_monochrome</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># Gaussian Blur Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_gaussian_blur_filter</span>

  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:gaussian_blur</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Right! If we run the app we should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_FirstFilter.png" alt="First Filter" />
</div>
<div class="title">Figure 135. First Filter</div>
</div>
<div class="paragraph"><p>The filters are working but it takes some time to change filters right? It will be better if we show the user a <strong>UIActivityView</strong> indicating that we are working on the new filter, to add it please insert the following into the <strong>photo_view_controller.rb</strong> class:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you are testing on the iOS Simulator the operation can be much faster than in the real device, also take note that some of your possible future users will not have the latest iPhone available either. So if an operation takes a little in the simulator possible it will take a lot on a device like an iPhone 3Gs</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Create a new view for our controller and add a nice</span>
  <span class="c1"># background color</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Add a Background Image for the app using a UIImageView</span>
  <span class="n">background_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="n">background_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgBackground.png&quot;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_view</span><span class="p">)</span>


  <span class="c1"># Layout four buttons for the user to select</span>
  <span class="c1"># the Photo Filters</span>
  <span class="n">layout_filter_buttons</span>

  <span class="c1"># Layout an image view for us to draw the user</span>
  <span class="c1"># selected image</span>
  <span class="n">layout_photo_image_view</span>

<span class="hll">  <span class="c1"># Layout an activity indicator that will tell the</span>
</span><span class="hll">  <span class="c1"># user that we are working on something</span>
</span><span class="hll">  <span class="n">layout_activity_indicator</span>
</span>
  <span class="c1"># Layout the image picker for the user to take</span>
  <span class="c1"># or select a photo</span>
  <span class="n">layout_image_picker_controller</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_activity_indicator</span>

  <span class="c1"># Create a new instance of the UIActivityIndicator View</span>
  <span class="vi">@activity_indicator</span> <span class="o">=</span> <span class="no">UIActivityIndicatorView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithActivityIndicatorStyle</span><span class="p">(</span><span class="no">UIActivityIndicatorViewStyleWhiteLarge</span><span class="p">)</span>

  <span class="c1"># Set the center as the same of the Photo Image View</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">center</span>

  <span class="c1"># Set some properties like the color and that we need to</span>
  <span class="c1"># hide when its not animating</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="ss">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">431</span><span class="p">,</span> <span class="ss">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">hidesWhenStopped</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Add the activity indicator to our view</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@activity_indicator</span><span class="p">)</span>
<span class="k">end</span>


<span class="c1"># Pixellate Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_pixellate_filter</span>

<span class="hll">  <span class="c1"># Start the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>
</span>
  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:pixellate</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Stop the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span>
<span class="k">end</span>

<span class="c1"># Sepia Tone Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_sepia_tone_filter</span>

<span class="hll">  <span class="c1"># Start the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>
</span>
  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:sepia_tone</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Stop the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span>
<span class="k">end</span>

<span class="c1"># Color Monochrome Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_color_monochrome_filter</span>

<span class="hll">  <span class="c1"># Start the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>
</span>
  <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:color_monochrome</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Stop the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span>
<span class="k">end</span>

<span class="c1"># Gaussian Blur Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_gaussian_blur_filter</span>

<span class="hll">  <span class="c1"># Start the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>
</span>
 <span class="c1"># Generate a new Filtered Image and set it to our photo</span>
  <span class="c1"># image view</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:gaussian_blur</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Stop the activity animator</span>
</span><span class="hll">  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_FilteringActivityIndicator.png" alt="Filter with Activity Indicator" />
</div>
<div class="title">Figure 136. Filter with Activity Indicator</div>
</div>
<div class="paragraph"><p>If we run this on the device it will be more easy to distinguish  that the activity indicator is also getting freeze at the time we select a new filter to apply. We are hanging the main thread right now and the app feels a little unresponsive!</p></div>
</div>
<div class="sect2">
<h3 id="_gran_central_dispatch_gcd">Gran Central Dispatch (GCD)</h3>
<div class="paragraph"><p>The gran central dispatch is a group to technology improvements (On the Language, Runtime and Frameworks) that will allow us to execute concurrent code on multicore hardware. That means that we can run our code on multiple threads but also on multiple cores for free!</p></div>
<div class="paragraph"><p><strong>Gran Central Dispatch</strong> uses internal queues to know where the code is supposed to run: On the Main Thread or Secondary Threads depending on the Priority. This is the interesting part: We don&#8217;t manage the thread it self, we just assign our code to run on a specific queue and GDC will create and destroy the threads when it need them.</p></div>
<div class="paragraph"><p>Also you will notice on the following part of the exercise that is the most simple way to implement concurrent operations! So let&#8217;s begin with a little test consisting of moving the creation of the Pixellate Filtered Image to <strong>Gran Central Dispatch</strong>, open your <strong>photo_view_controller.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open photo_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Pixellate Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_pixellate_filter</span>

  <span class="c1"># Start the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>

<span class="hll">  <span class="c1"># Get a GCD Queue in this case a High one, but the options are</span>
</span><span class="hll">  <span class="c1"># :high, :low, :default, :default</span>
</span><span class="hll">  <span class="n">high_priority_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">concurrent</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="ss">:high</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Send a block to be executed asynchronously on the High Priority</span>
</span><span class="hll">  <span class="c1"># Queue</span>
</span><span class="hll">  <span class="c1">#</span>
</span><span class="hll">  <span class="c1"># The code inside the block will be run in another thread</span>
</span><span class="hll">  <span class="n">high_priority_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Generate the Filtered Image</span>
</span><span class="hll">    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:pixellate</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># We need to excecute the Photo Image View change on the</span>
</span><span class="hll">    <span class="c1"># main thread, because we are modifying the User Interface</span>
</span><span class="hll">    <span class="c1">#</span>
</span><span class="hll">    <span class="c1"># For this we can also use GCD getting the Main Thread queue,</span>
</span><span class="hll">    <span class="c1"># remember we are running on another thread</span>
</span><span class="hll">    <span class="n">main_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">main</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Only for testing propouses let&#39;s sleep the thread a little</span>
</span><span class="hll">    <span class="c1"># bit</span>
</span><span class="hll">    <span class="nb">sleep</span> <span class="mi">1</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Now we can excecute any code on the Main Thread using the Main</span>
</span><span class="hll">    <span class="c1"># Queue</span>
</span><span class="hll">    <span class="n">main_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Set the Filtered Image to our Photo Image View</span>
</span><span class="hll">      <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Stop the activity animator</span>
</span><span class="hll">      <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we select Pixellate Filter now the Activity Indicator is showing properly to the user and the Filtering operation is running on another Thread using GDC. That was easy right? We implement concurrent code on our application that simple and almost for free!</p></div>
<div class="paragraph"><p>Now its time to implement it on all the Filtering Operations:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Pixellate Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_pixellate_filter</span>

  <span class="c1"># Start the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>

  <span class="c1"># Get a GCD Queue in this case a High one, but the options are</span>
  <span class="c1"># :high, :low, :default, :default</span>
  <span class="n">high_priority_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">concurrent</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="ss">:high</span><span class="p">)</span>

  <span class="c1"># Send a block to be executed asynchronously on the High Priority</span>
  <span class="c1"># Queue</span>
  <span class="c1">#</span>
  <span class="c1"># The code inside the block will be run in another thread</span>
  <span class="n">high_priority_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>

    <span class="c1"># Generate the Filtered Image</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:pixellate</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># We need to excecute the Photo Image View change on the</span>
    <span class="c1"># main thread, because we are modifying the User Interface</span>
    <span class="c1">#</span>
    <span class="c1"># For this we can also use GCD getting the Main Thread queue,</span>
    <span class="c1"># remember we are running on another thread</span>
    <span class="n">main_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">main</span>

    <span class="c1"># Now we can excecute any code on the Main Thread using the Main</span>
    <span class="c1"># Queue</span>
    <span class="n">main_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>

      <span class="c1"># Set the Filtered Image to our Photo Image View</span>
      <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>

      <span class="c1"># Stop the activity animator</span>
      <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># Sepia Tone Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_sepia_tone_filter</span>

  <span class="c1"># Start the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>

<span class="hll">  <span class="c1"># Get a GCD Queue in this case a High one, but the options are</span>
</span><span class="hll">  <span class="c1"># :high, :low, :default, :default</span>
</span><span class="hll">  <span class="n">high_priority_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">concurrent</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="ss">:high</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Send a block to be executed asynchronously on the High Priority</span>
</span><span class="hll">  <span class="c1"># Queue</span>
</span><span class="hll">  <span class="c1">#</span>
</span><span class="hll">  <span class="c1"># The code inside the block will be run in another thread</span>
</span><span class="hll">  <span class="n">high_priority_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Generate the Filtered Image</span>
</span><span class="hll">    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:sepia_tone</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># We need to excecute the Photo Image View change on the</span>
</span><span class="hll">    <span class="c1"># main thread, because we are modifying the User Interface</span>
</span><span class="hll">    <span class="c1">#</span>
</span><span class="hll">    <span class="c1"># For this we can also use GCD getting the Main Thread queue,</span>
</span><span class="hll">    <span class="c1"># remember we are running on another thread</span>
</span><span class="hll">    <span class="n">main_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">main</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Now we can excecute any code on the Main Thread using the Main</span>
</span><span class="hll">    <span class="c1"># Queue</span>
</span><span class="hll">    <span class="n">main_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Set the Filtered Image to our Photo Image View</span>
</span><span class="hll">      <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Stop the activity animator</span>
</span><span class="hll">      <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="k">end</span>

<span class="c1"># Color Monochrome Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_color_monochrome_filter</span>

  <span class="c1"># Start the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>

<span class="hll">  <span class="c1"># Get a GCD Queue in this case a High one, but the options are</span>
</span><span class="hll">  <span class="c1"># :high, :low, :default, :default</span>
</span><span class="hll">  <span class="n">high_priority_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">concurrent</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="ss">:high</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Send a block to be executed asynchronously on the High Priority</span>
</span><span class="hll">  <span class="c1"># Queue</span>
</span><span class="hll">  <span class="c1">#</span>
</span><span class="hll">  <span class="c1"># The code inside the block will be run in another thread</span>
</span><span class="hll">  <span class="n">high_priority_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Generate the Filtered Image</span>
</span><span class="hll">    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:color_monochrome</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># We need to excecute the Photo Image View change on the</span>
</span><span class="hll">    <span class="c1"># main thread, because we are modifying the User Interface</span>
</span><span class="hll">    <span class="c1">#</span>
</span><span class="hll">    <span class="c1"># For this we can also use GCD getting the Main Thread queue,</span>
</span><span class="hll">    <span class="c1"># remember we are running on another thread</span>
</span><span class="hll">    <span class="n">main_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">main</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Now we can excecute any code on the Main Thread using the Main</span>
</span><span class="hll">    <span class="c1"># Queue</span>
</span><span class="hll">    <span class="n">main_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Set the Filtered Image to our Photo Image View</span>
</span><span class="hll">      <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Stop the activity animator</span>
</span><span class="hll">      <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="k">end</span>

<span class="c1"># Gaussian Blur Filter Button Callback</span>
<span class="k">def</span> <span class="nf">add_gaussian_blur_filter</span>

  <span class="c1"># Start the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>

<span class="hll">  <span class="c1"># Get a GCD Queue in this case a High one, but the options are</span>
</span><span class="hll">  <span class="c1"># :high, :low, :default, :default</span>
</span><span class="hll">  <span class="n">high_priority_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">concurrent</span><span class="p">(</span><span class="n">priority</span><span class="o">=</span><span class="ss">:high</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Send a block to be executed asynchronously on the High Priority</span>
</span><span class="hll">  <span class="c1"># Queue</span>
</span><span class="hll">  <span class="c1">#</span>
</span><span class="hll">  <span class="c1"># The code inside the block will be run in another thread</span>
</span><span class="hll">  <span class="n">high_priority_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Generate the Filtered Image</span>
</span><span class="hll">    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">image_for_filter</span><span class="p">(</span><span class="ss">:gaussian_blur</span><span class="p">,</span> <span class="vi">@selected_image</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># We need to execute the Photo Image View change on the</span>
</span><span class="hll">    <span class="c1"># main thread, because we are modifying the User Interface</span>
</span><span class="hll">    <span class="c1">#</span>
</span><span class="hll">    <span class="c1"># For this we can also use GCD getting the Main Thread queue,</span>
</span><span class="hll">    <span class="c1"># remember we are running on another thread</span>
</span><span class="hll">    <span class="n">main_queue</span> <span class="o">=</span> <span class="ss">Dispatch</span><span class="p">:</span><span class="ss">:Queue</span><span class="o">.</span><span class="n">main</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Now we can execute any code on the Main Thread using the Main</span>
</span><span class="hll">    <span class="c1"># Queue</span>
</span><span class="hll">    <span class="n">main_queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Set the Filtered Image to our Photo Image View</span>
</span><span class="hll">      <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>
</span><span class="hll">
</span><span class="hll">      <span class="c1"># Stop the activity animator</span>
</span><span class="hll">      <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_FilteringGCD.png" alt="Filter with Gran Central Dispatch" />
</div>
<div class="title">Figure 137. Filter with Gran Central Dispatch</div>
</div>
<div class="paragraph"><p>Now all of them are working using GCD! But something is missing… how about control the intensity of the filters?, thats the next part of our exercise</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">We already remove the thread sleep ;)</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_add_filters_to_your_taste">Add Filters to Your Taste</h3>
<div class="paragraph"><p>Before we can change the intensity of the filters some changes are needed in the <strong>photo_filter_controller.rb</strong>, lets open it and change the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open photo_filter_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for increasing the intensity of</span>
<span class="c1"># the current filter</span>
<span class="k">def</span> <span class="nf">filtered_image_with_increased_intensity</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

  <span class="vi">@current_intensity</span> <span class="o">||=</span> <span class="mi">0</span>

  <span class="n">image_for_filter</span><span class="p">(</span><span class="vi">@current_filter</span><span class="p">,</span>
                   <span class="n">image</span><span class="p">,</span>
                   <span class="vi">@current_intensity</span> <span class="o">+</span> <span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">end</span>


<span class="c1"># Method for reducing the intensity of</span>
<span class="c1"># the current filter</span>
<span class="k">def</span> <span class="nf">filtered_image_with_decreased_intensity</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

  <span class="vi">@current_intensity</span> <span class="o">||=</span> <span class="mi">0</span>

  <span class="n">image_for_filter</span><span class="p">(</span><span class="vi">@current_filter</span><span class="p">,</span>
                   <span class="n">image</span><span class="p">,</span>
                   <span class="vi">@current_intensity</span> <span class="o">-</span> <span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are now ready to increase and decrease the intensity of the filter, but how we allow the user to do that? I have an idea… when the user drag his finger up or down we change the intensity accordingly!</p></div>
<div class="paragraph"><p>Lets open our <strong>photo_view_controller.rb</strong> and add a gesture recognizer for us to detect the User drag:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open photo_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Create a new view for our controller and add a nice</span>
  <span class="c1"># background color</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Add a Background Image for the app using a UIImageView</span>
  <span class="n">background_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="n">background_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgBackground.png&quot;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_view</span><span class="p">)</span>

<span class="hll">  <span class="c1"># Create a new UIPanGestureRecognizer to detect the</span>
</span><span class="hll">  <span class="c1"># user drag on the view</span>
</span><span class="hll">  <span class="n">pan_gesture_recognizer</span> <span class="o">=</span> <span class="no">UIPanGestureRecognizer</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                                       <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;pan_gesture_was_recognizer:&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Add the Pan Gesture Recognizer to the controller</span>
</span><span class="hll">  <span class="c1"># view</span>
</span><span class="hll">  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">pan_gesture_recognizer</span><span class="p">)</span>
</span>
  <span class="c1"># Layout four buttons for the user to select</span>
  <span class="c1"># the Photo Filters</span>
  <span class="n">layout_filter_buttons</span>

  <span class="c1"># Layout an image view for us to draw the user</span>
  <span class="c1"># selected image</span>
  <span class="n">layout_photo_image_view</span>

  <span class="c1"># Layout an activity indicator that will tell the</span>
  <span class="c1"># user that we are working on something</span>
  <span class="n">layout_activity_indicator</span>

  <span class="c1"># Layout the image picker for the user to take</span>
  <span class="c1"># or select a photo</span>
  <span class="n">layout_image_picker_controller</span>
<span class="k">end</span>

<span class="c1"># Pan Gesture Recognizer Callback</span>
<span class="k">def</span> <span class="nf">pan_gesture_was_recognizer</span><span class="p">(</span><span class="n">pan_gesture_recognizer</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Yeah, now we have a gesture recognizer implemented. Lets add the logic to increase or decrease the intensity of the Image Filter:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Pan Gesture Recognizer Callback</span>
<span class="k">def</span> <span class="nf">pan_gesture_was_recognizer</span><span class="p">(</span><span class="n">pan_gesture_recognizer</span><span class="p">)</span>

  <span class="c1"># Start the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">startAnimating</span>

  <span class="c1"># We need the velocity of the gesture to determinate</span>
  <span class="c1"># de direction of the touch drag</span>
  <span class="n">gesture_velocity</span> <span class="o">=</span> <span class="n">pan_gesture_recognizer</span><span class="o">.</span><span class="n">velocityInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>

  <span class="c1"># If the velocity is less than zero means that the</span>
  <span class="c1"># user is dragging up</span>
  <span class="k">if</span><span class="p">(</span><span class="n">gesture_velocity</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Generate the Filtered Image</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">filtered_image_with_increased_intensity</span><span class="p">(</span><span class="vi">@selected_image</span><span class="p">)</span>

    <span class="c1"># Set the Filtered Image to our Photo Image View</span>
    <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>

  <span class="c1"># And if the velocity is more than zero, the user</span>
  <span class="c1"># is dragging down</span>
  <span class="k">else</span>

    <span class="c1"># Generate the Filtered Image</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">filtered_image_with_decreased_intensity</span><span class="p">(</span><span class="vi">@selected_image</span><span class="p">)</span>

    <span class="c1"># Set the Filtered Image to our Photo Image View</span>
    <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filtered_image</span>

  <span class="k">end</span>

  <span class="c1"># Stop the activity animator</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">stopAnimating</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_FilterIntensity.png" alt="Filter Intensity" />
</div>
<div class="title">Figure 138. Filter Intensity</div>
</div>
<div class="paragraph"><p>Great! If you run the app and you drag your fingers up and down on the screen the intensity of the filter will increase or decrease accordingly. But the same as before we are hanging the main thread and the activity indicator view is not appearing on the screen.</p></div>
</div>
<div class="sect2">
<h3 id="_nsoperation">NSOperation</h3>
<div class="paragraph"><p>Its time to use another technology for concurrent operations, in this case <strong>NSOperation</strong>. As the same as GCD the NSOperations use queues to execute the code in other threads, but the main difference is that you can create custom NSOperation classes to have more control or simply use one of the predeterminate classes as <strong>NSInvocationOperation</strong>.</p></div>
<div class="paragraph"><p>Lets implement it for our intensity filter change, lets continue changing our <strong>photo_view_controller.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Create a new view for our controller and add a nice</span>
  <span class="c1"># background color</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Add a Background Image for the app using a UIImageView</span>
  <span class="n">background_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="n">background_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgBackground.png&quot;</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_view</span><span class="p">)</span>

  <span class="c1"># Create a new UIPanGestureRecognizer to detect the</span>
  <span class="c1"># user drag on the view</span>
  <span class="n">pan_gesture_recognizer</span> <span class="o">=</span> <span class="no">UIPanGestureRecognizer</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                                                       <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;pan_gesture_was_recognizer:&#39;</span><span class="p">)</span>

  <span class="c1"># Add the Pan Gesture Recognizer to the controller</span>
  <span class="c1"># view</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">pan_gesture_recognizer</span><span class="p">)</span>


<span class="hll">  <span class="c1"># Create a new instance of the Photo Filter Controller</span>
</span><span class="hll">  <span class="vi">@photo_filter_controller</span> <span class="o">=</span> <span class="no">PhotoFilterController</span><span class="o">.</span><span class="n">new</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># Create a new NSOperationQueue for excecuting the</span>
</span><span class="hll">  <span class="c1"># filter intensity changes</span>
</span><span class="hll">  <span class="vi">@filter_intensity_queue</span> <span class="o">=</span> <span class="no">NSOperationQueue</span><span class="o">.</span><span class="n">new</span>
</span>

  <span class="c1"># Layout four buttons for the user to select</span>
  <span class="c1"># the Photo Filters</span>
  <span class="n">layout_filter_buttons</span>

  <span class="c1"># Layout an image view for us to draw the user</span>
  <span class="c1"># selected image</span>
  <span class="n">layout_photo_image_view</span>

  <span class="c1"># Layout an activity indicator that will tell the</span>
  <span class="c1"># user that we are working on something</span>
  <span class="n">layout_activity_indicator</span>

  <span class="c1"># Layout the image picker for the user to take</span>
  <span class="c1"># or select a photo</span>
  <span class="n">layout_image_picker_controller</span>
<span class="k">end</span>


<span class="c1"># Pan Gesture Recognizer Callback</span>
<span class="k">def</span> <span class="nf">pan_gesture_was_recognizer</span><span class="p">(</span><span class="n">pan_gesture_recognizer</span><span class="p">)</span>
<span class="hll">
</span><span class="hll">  <span class="c1"># We need the velocity of the gesture to determinate</span>
</span><span class="hll">  <span class="c1"># de direction of the touch drag</span>
</span><span class="hll">  <span class="n">gesture_velocity</span> <span class="o">=</span> <span class="n">pan_gesture_recognizer</span><span class="o">.</span><span class="n">velocityInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># If the velocity is less than cero means that the</span>
</span><span class="hll">  <span class="c1"># user is dragging up</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">gesture_velocity</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Create a NSInvocationOperation that will allow us to run some method</span>
</span><span class="hll">    <span class="c1"># on another thread</span>
</span><span class="hll">    <span class="n">increase_image_filter_operation</span> <span class="o">=</span> <span class="no">NSInvocationOperation</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                                                 <span class="ss">selector</span><span class="p">:</span><span class="s1">&#39;increase_image_filter&#39;</span><span class="p">,</span>
</span><span class="hll">                                                                                 <span class="ss">object</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add the Invocation Operation to the NSOperationQueue</span>
</span><span class="hll">    <span class="vi">@filter_intensity_queue</span><span class="o">.</span><span class="n">addOperation</span><span class="p">(</span><span class="n">increase_image_filter_operation</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1"># And if the velocity is more than cero, the user</span>
</span><span class="hll">  <span class="c1"># is dragging down</span>
</span><span class="hll">  <span class="k">else</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Create a NSInvocationOperation that will allow us to run some method</span>
</span><span class="hll">    <span class="c1"># on another thread</span>
</span><span class="hll">    <span class="n">increase_image_filter_operation</span> <span class="o">=</span> <span class="no">NSInvocationOperation</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
</span><span class="hll">                                                                                 <span class="ss">selector</span><span class="p">:</span><span class="s1">&#39;decrease_image_filter&#39;</span><span class="p">,</span>
</span><span class="hll">                                                                                 <span class="ss">object</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># Add the Invocation Operation to the NSOperationQueue</span>
</span><span class="hll">    <span class="vi">@filter_intensity_queue</span><span class="o">.</span><span class="n">addOperation</span><span class="p">(</span><span class="n">increase_image_filter_operation</span><span class="p">)</span>
</span><span class="hll">
</span>  <span class="k">end</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">increase_image_filter</span>

  <span class="c1"># Execute the activity animator start on the Main Thread</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s1">&#39;startAnimating&#39;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>

  <span class="c1"># Generate the Filtered Image</span>
  <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">filtered_image_with_increased_intensity</span><span class="p">(</span><span class="vi">@selected_image</span><span class="p">)</span>

  <span class="c1"># Execute the change of the image in the Photo Image View on the Main Thread</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s1">&#39;setImage:&#39;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="n">filtered_image</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>

  <span class="c1"># Execute the activity animator stop on the Main Thread</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s1">&#39;stopAnimating&#39;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">decrease_image_filter</span>

  <span class="c1"># Execute the activity animator start on the Main Thread</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s1">&#39;startAnimating&#39;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>

  <span class="c1"># Generate the Filtered Image</span>
  <span class="n">filtered_image</span> <span class="o">=</span> <span class="vi">@photo_filter_controller</span><span class="o">.</span><span class="n">filtered_image_with_decreased_intensity</span><span class="p">(</span><span class="vi">@selected_image</span><span class="p">)</span>

  <span class="c1"># Execute the change of the image in the Photo Image View on the Main Thread</span>
  <span class="vi">@photo_image_view</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s1">&#39;setImage:&#39;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="n">filtered_image</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>

  <span class="c1"># Execute the activity animator stop on the Main Thread</span>
  <span class="vi">@activity_indicator</span><span class="o">.</span><span class="n">performSelectorOnMainThread</span><span class="p">(</span><span class="s1">&#39;stopAnimating&#39;</span><span class="p">,</span> <span class="ss">withObject</span><span class="p">:</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">waitUntilDone</span><span class="p">:</span><span class="kp">false</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch26-Concurrency/ch26_FilterIntensityNSOperation.png" alt="Filter Intensity with NSOperation" />
</div>
<div class="title">Figure 139. Filter Intensity with NSOperation</div>
</div>
<div class="paragraph"><p>Awesome! Now we add concurrent operations using NSOperation and also fix the activity indicator view.</p></div>
<div class="paragraph"><p>Our Image Filtering application is now complete!</p></div>
</div>
<div class="sect2">
<h3 id="_challenges_9">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Clear and Stop the NSOperation queue when you change between filters, so it will not apply the queued increased or decreased operations to the new filter
</p>
</li>
<li>
<p>
Add some buttons to our Application for increasing and decreasing the Intensity of the Image Filter, please use <strong>Gran Central Dispatch</strong> for the concurrent operations
</p>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Version 0.1<br />
Last updated 2013-01-21 16:31:34 CST
</div>
</div>
</body>
</html>
